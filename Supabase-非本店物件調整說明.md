# Supabase è³‡æ–™åº«èˆ‡ Storage èª¿æ•´èªªæ˜

## ğŸ“‹ æ¦‚è¿°

ç‚ºäº†æ”¯æ´ã€Œéæœ¬åº—ç‰©ä»¶ã€åŠŸèƒ½ï¼Œéœ€è¦å° Supabase é€²è¡Œä»¥ä¸‹èª¿æ•´ï¼š

1. **è³‡æ–™åº«å±¤é¢**ï¼šæ–°å¢ `is_external` æ¬„ä½
2. **Storage å±¤é¢**ï¼šä¸éœ€è¦è®Šæ›´ bucket æˆ– policiesï¼Œä½†è·¯å¾‘çµæ§‹æœƒæ”¹è®Š

## ğŸ”§ è³‡æ–™åº«èª¿æ•´

### 1. åŸ·è¡Œ SQL é·ç§»è…³æœ¬

**æª”æ¡ˆ**ï¼š`add-is-external-column.sql`

**åŸ·è¡Œæ–¹å¼**ï¼š
1. å‰å¾€ [Supabase Dashboard](https://supabase.com/dashboard/project/cnzqtuuegdqwkgvletaa/sql/new)
2. é–‹å•Ÿ SQL Editor
3. è¤‡è£½ `add-is-external-column.sql` çš„å…§å®¹
4. è²¼ä¸Šä¸¦åŸ·è¡Œ

**æ­¤è…³æœ¬æœƒåŸ·è¡Œä»¥ä¸‹æ“ä½œ**ï¼š
- âœ… æ–°å¢ `is_external` æ¬„ä½ï¼ˆBOOLEANï¼Œé è¨­ FALSEï¼‰
- âœ… æ›´æ–°ç¾æœ‰è³‡æ–™ï¼ˆæ‰€æœ‰ç¾æœ‰ç‰©ä»¶è¨­ç‚ºæœ¬åº—ç‰©ä»¶ï¼‰
- âœ… å»ºç«‹ç´¢å¼•ä»¥å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½
- âœ… æ›´æ–°è¦–åœ–ï¼ˆpublished_propertiesã€property_statsï¼‰

### 2. æ–°å¢çš„æ¬„ä½èªªæ˜

| æ¬„ä½åç¨± | è³‡æ–™é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|---------|---------|--------|------|
| `is_external` | BOOLEAN | `FALSE` | æ˜¯å¦ç‚ºéæœ¬åº—ç‰©ä»¶ã€‚`TRUE`=éæœ¬åº—ç‰©ä»¶ï¼Œ`FALSE`=æœ¬åº—ç‰©ä»¶ |

### 3. æ–°å¢çš„ç´¢å¼•

| ç´¢å¼•åç¨± | èªªæ˜ | ç”¨é€” |
|---------|------|------|
| `idx_properties_is_external` | å–®ä¸€ç´¢å¼• | å¿«é€Ÿç¯©é¸åº—å…§/åº—å¤–ç‰©ä»¶ |
| `idx_properties_external_published` | è¤‡åˆç´¢å¼• | æŒ‰ä¾†æºå’Œä¸Šæ¶ç‹€æ…‹ç¯©é¸ |
| `idx_properties_external_type` | è¤‡åˆç´¢å¼• | æŒ‰ä¾†æºå’Œæˆ¿å‹ç¯©é¸ |
| `idx_properties_external_created` | è¤‡åˆç´¢å¼• | æŒ‰ä¾†æºå’Œæ™‚é–“æ’åº |

### 4. æ›´æ–°çš„è¦–åœ–

#### published_properties è¦–åœ–
- **è®Šæ›´**ï¼šåªé¡¯ç¤ºå·²ä¸Šæ¶çš„**æœ¬åº—ç‰©ä»¶**ï¼ˆ`is_published = true AND is_external = false`ï¼‰
- **å½±éŸ¿**ï¼šå‰å°åªæœƒé¡¯ç¤ºæœ¬åº—ç‰©ä»¶ï¼Œä¸æœƒé¡¯ç¤ºéæœ¬åº—ç‰©ä»¶

#### property_stats è¦–åœ–
- **æ–°å¢çµ±è¨ˆ**ï¼š
  - `internal_count`ï¼šæœ¬åº—ç‰©ä»¶æ•¸
  - `external_count`ï¼šéæœ¬åº—ç‰©ä»¶æ•¸

## ğŸ“ Storage èª¿æ•´

### 1. Bucket è¨­å®š

**ä¸éœ€è¦è®Šæ›´**ï¼š
- âœ… Bucket åç¨±ï¼š`junyang666`ï¼ˆä¿æŒä¸è®Šï¼‰
- âœ… Bucket é¡å‹ï¼šPublicï¼ˆä¿æŒä¸è®Šï¼‰
- âœ… Storage Policiesï¼šä¸éœ€è¦è®Šæ›´ï¼ˆè·¯å¾‘ä»åœ¨ `junyang666` bucket å…§ï¼‰

### 2. è·¯å¾‘çµæ§‹è®Šæ›´

#### åº—å…§ç‰©ä»¶ï¼ˆç¾æœ‰ï¼Œä¿æŒä¸è®Šï¼‰
```
junyang666/
â””â”€â”€ properties/
    â”œâ”€â”€ SU/                    # å¥—æˆ¿é¡å‹è³‡æ–™å¤¾
    â”‚   â”œâ”€â”€ SU00001/          # ç‰©ä»¶ç·¨è™Ÿè³‡æ–™å¤¾
    â”‚   â”‚   â”œâ”€â”€ image_1.jpg
    â”‚   â”‚   â””â”€â”€ image_2.jpg
    â”‚   â””â”€â”€ SU00002/
    â”‚       â””â”€â”€ ...
    â”œâ”€â”€ TW/                    # 2æˆ¿é¡å‹è³‡æ–™å¤¾
    â”‚   â””â”€â”€ TW00001/
    â”‚       â””â”€â”€ ...
    â”œâ”€â”€ TH/                    # 3æˆ¿é¡å‹è³‡æ–™å¤¾
    â””â”€â”€ FO/                    # 4æˆ¿é¡å‹è³‡æ–™å¤¾
```

**è·¯å¾‘æ ¼å¼**ï¼š`properties/{é¡å‹ä»£ç¢¼}/{ç‰©ä»¶ç·¨è™Ÿ}/image_{åºè™Ÿ}.jpg`

**ç¯„ä¾‹**ï¼š
- `properties/SU/SU00001/image_1.jpg`
- `properties/TW/TW00001/image_1.jpg`

#### åº—å¤–ç‰©ä»¶ï¼ˆæ–°å¢ï¼‰
```
junyang666/
â””â”€â”€ properties/
    â””â”€â”€ external/              # åº—å¤–ç‰©ä»¶å°ˆç”¨è³‡æ–™å¤¾
        â”œâ”€â”€ SU/                # å¥—æˆ¿é¡å‹è³‡æ–™å¤¾
        â”‚   â”œâ”€â”€ EXSU0001/      # ç‰©ä»¶ç·¨è™Ÿè³‡æ–™å¤¾
        â”‚   â”‚   â”œâ”€â”€ image_1.jpg
        â”‚   â”‚   â””â”€â”€ image_2.jpg
        â”‚   â””â”€â”€ EXSU0002/
        â”‚       â””â”€â”€ ...
        â”œâ”€â”€ TW/                # 2æˆ¿é¡å‹è³‡æ–™å¤¾
        â”‚   â””â”€â”€ EXTW0001/
        â”‚       â””â”€â”€ ...
        â”œâ”€â”€ TH/                # 3æˆ¿é¡å‹è³‡æ–™å¤¾
        â””â”€â”€ FO/                # 4æˆ¿é¡å‹è³‡æ–™å¤¾
```

**è·¯å¾‘æ ¼å¼**ï¼š`properties/external/{é¡å‹ä»£ç¢¼}/{ç‰©ä»¶ç·¨è™Ÿ}/image_{åºè™Ÿ}.jpg`

**ç¯„ä¾‹**ï¼š
- `properties/external/SU/EXSU0001/image_1.jpg`
- `properties/external/TW/EXTW0001/image_1.jpg`

### 3. Storage Policies

**ä¸éœ€è¦è®Šæ›´**ï¼Œå› ç‚ºï¼š
- âœ… è·¯å¾‘ä»åœ¨ `junyang666` bucket å…§
- âœ… ç¾æœ‰çš„ Storage Policies å·²æ¶µè“‹æ‰€æœ‰è·¯å¾‘
- âœ… ä¸éœ€è¦é¡å¤–çš„æ¬Šé™è¨­å®š

**ç¾æœ‰ Policiesï¼ˆä¿æŒä¸è®Šï¼‰**ï¼š
```sql
-- è®€å–
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥è®€å–åœ–ç‰‡"
    ON storage.objects FOR SELECT
    USING (bucket_id = 'junyang666');

-- ä¸Šå‚³
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥ä¸Šå‚³åœ–ç‰‡"
    ON storage.objects FOR INSERT
    WITH CHECK (bucket_id = 'junyang666');

-- æ›´æ–°
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥æ›´æ–°åœ–ç‰‡"
    ON storage.objects FOR UPDATE
    USING (bucket_id = 'junyang666')
    WITH CHECK (bucket_id = 'junyang666');

-- åˆªé™¤
CREATE POLICY "ä»»ä½•äººéƒ½å¯ä»¥åˆªé™¤åœ–ç‰‡"
    ON storage.objects FOR DELETE
    USING (bucket_id = 'junyang666');
```

## âœ… æª¢æŸ¥æ¸…å–®

### è³‡æ–™åº«èª¿æ•´
- [ ] åŸ·è¡Œ `add-is-external-column.sql` è…³æœ¬
- [ ] ç¢ºèª `is_external` æ¬„ä½å·²æ–°å¢
- [ ] ç¢ºèªç´¢å¼•å·²å»ºç«‹
- [ ] ç¢ºèªè¦–åœ–å·²æ›´æ–°
- [ ] é©—è­‰ç¾æœ‰è³‡æ–™çš„ `is_external` å€¼ç‚º `FALSE`

### Storage èª¿æ•´
- [ ] ç¢ºèª `junyang666` bucket å­˜åœ¨
- [ ] ç¢ºèª bucket ç‚º Public
- [ ] ç¢ºèª Storage Policies å·²è¨­å®š
- [ ] æ¸¬è©¦åº—å…§ç‰©ä»¶åœ–ç‰‡ä¸Šå‚³ï¼ˆè·¯å¾‘ï¼š`properties/{é¡å‹ä»£ç¢¼}/{ç‰©ä»¶ç·¨è™Ÿ}/`ï¼‰
- [ ] æ¸¬è©¦åº—å¤–ç‰©ä»¶åœ–ç‰‡ä¸Šå‚³ï¼ˆè·¯å¾‘ï¼š`properties/external/{é¡å‹ä»£ç¢¼}/{ç‰©ä»¶ç·¨è™Ÿ}/`ï¼‰

## ğŸ” é©—è­‰æ­¥é©Ÿ

### 1. é©—è­‰è³‡æ–™åº«æ¬„ä½

åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œï¼š
```sql
-- æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'properties' 
  AND column_name = 'is_external';

-- æª¢æŸ¥ç¾æœ‰è³‡æ–™
SELECT 
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE is_external = false) as internal,
    COUNT(*) FILTER (WHERE is_external = true) as external
FROM properties;
```

### 2. é©—è­‰ç´¢å¼•

```sql
-- æª¢æŸ¥ç´¢å¼•
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'properties'
  AND indexname LIKE '%external%';
```

### 3. é©—è­‰è¦–åœ–

```sql
-- æª¢æŸ¥ published_properties è¦–åœ–
SELECT * FROM published_properties LIMIT 5;

-- æª¢æŸ¥ property_stats è¦–åœ–
SELECT * FROM property_stats;
```

### 4. é©—è­‰ Storage è·¯å¾‘

åœ¨ Supabase Dashboard â†’ Storage â†’ junyang666 ä¸­æª¢æŸ¥ï¼š
- âœ… `properties/SU/` è³‡æ–™å¤¾å­˜åœ¨ï¼ˆåº—å…§ç‰©ä»¶ï¼‰
- âœ… `properties/external/` è³‡æ–™å¤¾å¯ä»¥å»ºç«‹ï¼ˆåº—å¤–ç‰©ä»¶ï¼‰

## âš ï¸ æ³¨æ„äº‹é …

### 1. è³‡æ–™é·ç§»
- æ‰€æœ‰ç¾æœ‰ç‰©ä»¶æœƒè‡ªå‹•è¨­ç‚º `is_external = FALSE`ï¼ˆæœ¬åº—ç‰©ä»¶ï¼‰
- ä¸éœ€è¦æ‰‹å‹•æ›´æ–°ç¾æœ‰è³‡æ–™

### 2. å‰å°é¡¯ç¤º
- å‰å°ï¼ˆ`index.html`ï¼‰åªæœƒé¡¯ç¤ºæœ¬åº—ç‰©ä»¶ï¼ˆ`is_external = false`ï¼‰
- éæœ¬åº—ç‰©ä»¶ä¸æœƒé¡¯ç¤ºåœ¨å‰å°

### 3. åœ–ç‰‡è·¯å¾‘
- åº—å…§å’Œåº—å¤–ç‰©ä»¶çš„åœ–ç‰‡è·¯å¾‘ä¸åŒï¼Œä½†éƒ½åœ¨åŒä¸€å€‹ bucket å…§
- ä¸éœ€è¦å»ºç«‹æ–°çš„ bucket

### 4. ç·¨è™Ÿç³»çµ±
- åº—å…§ç‰©ä»¶ï¼š`SU00001`ï¼ˆ7ä½æ•¸ï¼‰
- åº—å¤–ç‰©ä»¶ï¼š`EXSU0001`ï¼ˆ8ä½æ•¸ï¼‰
- å…©å€‹ç·¨è™Ÿç³»çµ±å®Œå…¨ç¨ç«‹ï¼Œä¸æœƒè¡çª

## ğŸ“ åŸ·è¡Œé †åº

1. **ç¬¬ä¸€æ­¥**ï¼šåŸ·è¡Œ `add-is-external-column.sql`ï¼ˆè³‡æ–™åº«èª¿æ•´ï¼‰
2. **ç¬¬äºŒæ­¥**ï¼šé©—è­‰è³‡æ–™åº«æ¬„ä½å’Œç´¢å¼•
3. **ç¬¬ä¸‰æ­¥**ï¼šæ›´æ–°å‰ç«¯ç¨‹å¼ç¢¼ï¼ˆæ–°å¢è¡¨å–®æ¬„ä½ã€ç¯©é¸åŠŸèƒ½ç­‰ï¼‰
4. **ç¬¬å››æ­¥**ï¼šæ¸¬è©¦æ–°å¢åº—å…§/åº—å¤–ç‰©ä»¶
5. **ç¬¬äº”æ­¥**ï¼šæ¸¬è©¦åœ–ç‰‡ä¸Šå‚³è·¯å¾‘

## ğŸ”— ç›¸é—œæ–‡ä»¶

- `éæœ¬åº—ç‰©ä»¶åŠŸèƒ½è¨­è¨ˆæ–¹æ¡ˆ.md`ï¼šå®Œæ•´åŠŸèƒ½è¨­è¨ˆ
- `add-is-external-column.sql`ï¼šè³‡æ–™åº«é·ç§»è…³æœ¬
- `ç·¨è™Ÿç³»çµ±è¨­è¨ˆæ–¹æ¡ˆ.md`ï¼šç·¨è™Ÿç³»çµ±è¨­è¨ˆ

## âœ… å®Œæˆç¢ºèª

åŸ·è¡Œå®Œæ‰€æœ‰æ­¥é©Ÿå¾Œï¼Œè«‹ç¢ºèªï¼š
- âœ… è³‡æ–™åº«å·²æ–°å¢ `is_external` æ¬„ä½
- âœ… ç´¢å¼•å·²å»ºç«‹
- âœ… è¦–åœ–å·²æ›´æ–°
- âœ… Storage è·¯å¾‘çµæ§‹å·²ç†è§£
- âœ… å¯ä»¥æˆåŠŸæ–°å¢åº—å…§/åº—å¤–ç‰©ä»¶
- âœ… åœ–ç‰‡ä¸Šå‚³è·¯å¾‘æ­£ç¢º

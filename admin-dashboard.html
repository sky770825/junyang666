<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂæåÂè∞ÁÆ°ÁêÜÁ≥ªÁµ± | ‰ΩèÂïÜ‰∏çÂãïÁî¢</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <!-- QR Code ÁîüÊàêÂáΩÂºèÂ∫´ (‰ΩøÁî®Â§öÂÄãÂÇôÁî® CDN) -->
    <script>
        // ÂòóË©¶ËºâÂÖ• QRCode ÂáΩÂºèÂ∫´Ôºå‰ΩøÁî®Â§öÂÄãÂÇôÁî® CDN
        (function() {
            const cdnUrls = [
                'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
                'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js'
            ];
            
            let currentIndex = 0;
            
            function loadScript(url) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => {
                        console.log('‚úÖ QRCode ÂáΩÂºèÂ∫´Â∑≤Âæû', url, 'ËºâÂÖ•');
                        resolve();
                    };
                    script.onerror = () => {
                        console.warn('‚ùå ÁÑ°Ê≥ïÂæû', url, 'ËºâÂÖ• QRCode ÂáΩÂºèÂ∫´');
                        reject();
                    };
                    document.head.appendChild(script);
                });
            }
            
            function tryLoadNext() {
                if (currentIndex >= cdnUrls.length) {
                    console.error('‚ùå ÊâÄÊúâ QRCode CDN ÈÉΩËºâÂÖ•Â§±Êïó');
                    return;
                }
                
                loadScript(cdnUrls[currentIndex])
                    .then(() => {
                        // ËºâÂÖ•ÊàêÂäüÔºåÊ™¢Êü• QRCode ÊòØÂê¶ÂèØÁî®
                        if (typeof QRCode === 'undefined') {
                            console.warn('‚ö†Ô∏è QRCode ÂáΩÂºèÂ∫´ËºâÂÖ•‰ΩÜÂÖ®ÂüüËÆäÊï∏‰∏çÂ≠òÂú®ÔºåÂòóË©¶‰∏ã‰∏ÄÂÄã CDN');
                            currentIndex++;
                            tryLoadNext();
                        } else {
                            console.log('‚úÖ QRCode ÂáΩÂºèÂ∫´Â∑≤Ê∫ñÂÇôÂ∞±Á∑í');
                        }
                    })
                    .catch(() => {
                        currentIndex++;
                        tryLoadNext();
                    });
            }
            
            tryLoadNext();
        })();
    </script>
    <!-- Áµ±‰∏Ä Supabase ÈÖçÁΩÆ -->
    <script src="supabase-config.js"></script>
    <!-- Áõ∏ÈóúÈÄ£ÁµêÂæåÂè∞ÁÆ°ÁêÜÊ®°ÁµÑ -->
    <script src="modules/related-links/backend.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .nav {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0 2rem;
            display: flex;
            gap: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #666;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }
        
        .nav-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card .change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .stat-card.primary { border-left: 4px solid #667eea; }
        .stat-card.success { border-left: 4px solid #28a745; }
        .stat-card.warning { border-left: 4px solid #ffc107; }
        .stat-card.danger { border-left: 4px solid #dc3545; }
        
        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .content-card h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        /* üé® ÂèØÊÑõÁöÑË§áË£ΩÈÄ£ÁµêÂΩàÁ™óÊ®£Âºè */
        .cute-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeInOverlay 0.3s ease-out;
        }
        
        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .cute-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideUpBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
        }
        
        @keyframes slideUpBounce {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.8);
            }
            50% {
                transform: translateY(-10px) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .cute-modal::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .cute-modal-content {
            position: relative;
            z-index: 1;
            text-align: center;
            color: white;
        }
        
        .cute-modal-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bounce 1s ease-in-out infinite;
            display: inline-block;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }
        
        .cute-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .cute-modal-message {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            opacity: 0.95;
            line-height: 1.6;
        }
        
        .cute-modal-url {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            word-break: break-all;
            font-size: 0.9rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-family: 'Courier New', monospace;
        }
        
        .cute-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .cute-modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .cute-modal-btn-primary {
            background: white;
            color: #667eea;
        }
        
        .cute-modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .cute-modal-btn-primary:active {
            transform: translateY(0);
        }
        
        .cute-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .cute-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .cute-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cute-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }
        
        /* QR Code ÂΩàÁ™óÊ®£Âºè */
        .qrcode-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideUpBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
        }
        
        .qrcode-modal-content {
            position: relative;
            z-index: 1;
            text-align: center;
            color: white;
        }
        
        .qrcode-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        .qrcode-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            min-height: 300px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .qrcode-container img,
        .qrcode-container canvas {
            width: 300px;
            height: 300px;
            border-radius: 8px;
            display: block;
            object-fit: contain;
        }
        
        .qrcode-loading {
            padding: 3rem;
            color: #667eea;
            font-size: 1.2rem;
        }
        
        .qrcode-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .qrcode-modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        .qrcode-modal-btn-primary {
            background: white;
            color: #667eea;
        }
        
        .qrcode-modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .qrcode-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .qrcode-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ÊâãÊ©üÁâà QR Code ÂΩàÁ™óÂÑ™Âåñ */
        @media (max-width: 768px) {
            .qrcode-modal {
                padding: 1.5rem;
                max-width: 90%;
                width: 90%;
                border-radius: 16px;
            }
            
            .qrcode-modal-title {
                font-size: 1.2rem;
                margin-bottom: 1rem;
                white-space: nowrap;
            }
            
            .qrcode-container {
                padding: 1rem;
                min-height: 200px;
                max-width: 100%;
                overflow: hidden;
            }
            
            .qrcode-container img,
            .qrcode-container canvas {
                width: 200px !important;
                height: 200px !important;
                max-width: 100%;
                max-height: 100%;
            }
            
            .qrcode-loading {
                padding: 2rem 1rem;
                font-size: 1rem;
            }
            
            .qrcode-modal-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .qrcode-modal-btn {
                padding: 0.6rem 1.5rem;
                font-size: 0.9rem;
                width: 100%;
                white-space: nowrap;
            }
        }
        
        /* ÈåØË™§ÁãÄÊÖãÁöÑÂΩàÁ™ó */
        .cute-modal.error {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .cute-modal.warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }
        
        .cute-modal.warning .cute-modal-url {
            background: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.2);
            color: #333;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ÂÑ™ÂåñÁöÑÂΩàË∑≥Ë¶ñÁ™óÊ®£Âºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-dialog {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .modal-icon.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .modal-icon.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            flex: 1;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-body {
            padding: 1.5rem;
            color: #666;
            line-height: 1.6;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 0.625rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        
        .modal-btn-cancel {
            background: #f8f9fa;
            color: #333;
        }
        
        .modal-btn-cancel:hover {
            background: #e9ecef;
        }
        
        .modal-btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .modal-btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .modal-btn-danger:active {
            transform: translateY(0);
        }
        
        /* ÊâãÊ©üÁâàÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            /* Âü∫Êú¨‰ΩàÂ±ÄË™øÊï¥ - ÂÖ®Ëû¢ÂπïÂØ¨Â∫¶ */
            .container {
                padding: 0.5rem;
                max-width: 100%;
                width: 100%;
                margin: 0;
            }
            
            /* Êñ∞Â¢ûÁâ©‰ª∂Ê®ôÁ±§È†Å - ÁßªÈô§ÂÆπÂô® padding */
            #properties-tab {
                padding: 0 !important;
            }
            
            #property-add-subtab {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Header ÂÑ™Âåñ */
            .header {
                padding: 1rem;
                position: relative;
            }
            
            .header h1 {
                font-size: 1.2rem;
                margin-bottom: 0.3rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            /* Êº¢Â†°ÈÅ∏ÂñÆÊåâÈàï */
            .mobile-menu-btn {
                display: block;
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 1.5rem;
                padding: 0.5rem;
                border-radius: 4px;
                cursor: pointer;
                z-index: 1001;
            }
            
            .mobile-menu-btn:hover {
                background: rgba(255, 255, 255, 0.3);
            }
            
            /* Â∞éËà™Ê¨ÑÊîπÁÇ∫ÂÅ¥ÈÇäÊäΩÂ±ú */
            .nav {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                background: white;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                z-index: 1000;
                transition: left 0.3s ease;
                flex-direction: column;
                padding: 3rem 0 0 0;
                overflow-y: auto;
            }
            
            .nav.active {
                left: 0;
            }
            
            /* ÂÅ¥ÈÇäÊ¨ÑÈÅÆÁΩ© */
            .nav-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .nav-overlay.active {
                display: block;
            }
            
            .nav-item {
                padding: 1rem 1.5rem;
                border-bottom: 1px solid #e9ecef;
                border-left: 4px solid transparent;
                border-bottom-width: 1px;
            }
            
            .nav-item.active {
                border-left-color: #667eea;
                background: #f8f9fa;
            }
            
            /* ÈóúÈñâÊåâÈàï */
            .nav-close-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #666;
                cursor: pointer;
                padding: 0.5rem;
            }
            
            /* Áµ±Ë®àÂç°ÁâáÂÑ™Âåñ */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-card h3 {
                font-size: 0.85rem;
            }
            
            .stat-card .value {
                font-size: 1.5rem;
            }
            
            /* ÊêúÂ∞ãÂíåÁØ©ÈÅ∏ÂçÄÂüüÂÑ™Âåñ */
            .search-box {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .search-box input,
            .search-box select {
                width: 100%;
            }
            
            /* ÁØ©ÈÅ∏‰∏ãÊãâÈÅ∏ÂñÆÂÑ™Âåñ */
            .filter-select-container {
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
                padding: 0.6rem 2.5rem 0.6rem 0.8rem;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            /* ÁØ©ÈÅ∏ÊåâÈàïÂÑ™ÂåñÔºà‰øùÁïô‰ª•ÂÖºÂÆπÂÖ∂‰ªñÂú∞ÊñπÔºâ */
            .filter-buttons {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .filter-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
                flex: 1;
                min-width: calc(50% - 0.25rem);
            }
            
            /* Ê™¢Ë¶ñÊ®°ÂºèÂàáÊèõÂÑ™Âåñ - ‰øùÊåÅÊ∞¥Âπ≥ÊéíÂàó */
            .view-mode-toggle,
            .dashboard-view-mode-toggle {
                flex-direction: row !important;
                gap: 0.5rem;
                flex-wrap: wrap;
                align-items: center;
            }
            
            .view-mode-toggle span,
            .dashboard-view-mode-toggle span {
                white-space: nowrap;
            }
            
            .view-mode-toggle .filter-btn,
            .dashboard-view-mode-toggle .filter-btn {
                flex: 0 0 auto;
                min-width: auto;
            }
            
            /* Ë°®Ê†ºÊîπÁÇ∫Âç°ÁâáÂºèÈ°ØÁ§∫ */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table {
                min-width: 800px;
            }
            
            /* Áâ©‰ª∂Âç°ÁâáÊ®°ÂºèÔºàÊâãÊ©üÁâàÈ†êË®≠Ôºâ */
            .properties-grid-view {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .property-card-mobile {
                background: white;
                border-radius: 8px;
                padding: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                margin-bottom: 1rem;
            }
            
            .property-card-mobile-header {
                display: flex;
                gap: 1rem;
                margin-bottom: 1rem;
                align-items: flex-start;
            }
            
            .property-card-mobile-image {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 6px;
                flex-shrink: 0;
            }
            
            .property-card-mobile-info {
                flex: 1;
                min-width: 0;
            }
            
            .property-card-mobile-title {
                font-size: 1rem;
                font-weight: 600;
                margin-bottom: 0.25rem;
                color: #333;
                word-break: break-word;
            }
            
            .property-card-mobile-number {
                font-size: 0.85rem;
                color: #666;
            }
            
            /* Á∑äÊπäÂåñË©≥Á¥∞Ë≥áË®ä - ÊîæÂú®Ê®ôÈ°åÂè≥ÈÇä */
            .property-card-mobile-details-compact {
                display: flex;
                flex-direction: column;
                gap: 0.3rem;
                flex-shrink: 0;
                min-width: 120px;
                margin-left: auto;
            }
            
            .property-card-mobile-detail-compact-item {
                display: flex;
                align-items: center;
                gap: 0.4rem;
                font-size: 0.8rem;
                line-height: 1.3;
            }
            
            .property-card-mobile-detail-compact-label {
                color: #999;
                font-size: 0.75rem;
                white-space: nowrap;
            }
            
            .property-card-mobile-detail-compact-value {
                color: #333;
                font-weight: 500;
                font-size: 0.8rem;
                white-space: nowrap;
            }
            
            /* ‰øùÁïôËàäÁöÑË©≥Á¥∞Ë≥áË®äÊ®£ÂºèÔºà‰ª•Èò≤ÂÖ∂‰ªñÂú∞Êñπ‰ΩøÁî®Ôºâ */
            .property-card-mobile-details {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #e9ecef;
            }
            
            .property-card-mobile-detail-item {
                display: flex;
                flex-direction: column;
            }
            
            .property-card-mobile-detail-label {
                font-size: 0.75rem;
                color: #999;
                margin-bottom: 0.25rem;
            }
            
            .property-card-mobile-detail-value {
                font-size: 0.9rem;
                color: #333;
                font-weight: 500;
            }
            
            .property-card-mobile-actions {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            /* ‰∏âÊ¨Ñ‰ΩàÂ±ÄÔºà‰∏ÄËà¨ÊâãÊ©üÔºâ */
            .property-card-mobile-actions .btn {
                flex: 1;
                min-width: calc(33.333% - 0.33rem);
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            /* Ë∂ÖÁ™ÑËû¢ÂπïÔºà< 360pxÔºâÊîπÁÇ∫ÂÖ©Ê¨Ñ‰ΩàÂ±Ä */
            @media (max-width: 360px) {
                .property-card-mobile-actions .btn {
                    min-width: calc(50% - 0.25rem);
                }
            }
            
            /* Áõ∏ÈóúÈÄ£ÁµêÁ∂≤Ê†ºÂç°ÁâáÊ®£ÂºèÔºàÊâãÊ©üÁâàÔºâ */
            .links-grid-mobile {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            .link-card-mobile {
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 12px;
                padding: 1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                transition: all 0.3s ease;
            }
            
            .link-card-mobile:hover {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
                transform: translateY(-2px);
            }
            
            .link-card-mobile-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid #e9ecef;
            }
            
            .link-card-mobile-order {
                background: #667eea;
                color: white;
                font-weight: 600;
                font-size: 0.85rem;
                padding: 0.25rem 0.5rem;
                border-radius: 6px;
                min-width: 40px;
                text-align: center;
                flex-shrink: 0;
            }
            
            .link-card-mobile-title {
                flex: 1;
                font-size: 1rem;
                font-weight: 600;
                color: #333;
                display: flex;
                align-items: center;
            }
            
            .link-card-mobile-content {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .link-card-mobile-item {
                display: flex;
                align-items: flex-start;
                gap: 0.5rem;
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            .link-card-mobile-label {
                color: #666;
                font-weight: 500;
                min-width: 50px;
                flex-shrink: 0;
            }
            
            .link-card-mobile-url {
                color: #667eea;
                text-decoration: none;
                word-break: break-all;
                flex: 1;
            }
            
            .link-card-mobile-url:hover {
                text-decoration: underline;
            }
            
            .link-card-mobile-actions {
                display: flex;
                gap: 0.5rem;
                padding-top: 0.75rem;
                border-top: 1px solid #e9ecef;
            }
            
            .link-card-mobile-actions .btn {
                flex: 1;
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            /* ÂÖßÂÆπÂç°ÁâáÂÑ™Âåñ */
            .content-card {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }
            
            /* Êñ∞Â¢ûÁâ©‰ª∂ÂçÄÂ°ä - ÁßªÈô§Â§öÈ§òÁöÑ padding */
            #property-add-subtab .content-card {
                padding: 0 !important;
                margin: 0 !important;
                background: transparent !important;
                box-shadow: none !important;
            }
            
            #property-add-subtab .content-card h2 {
                display: none !important; /* Èö±ËóèÊ®ôÈ°åÔºåÂõ†ÁÇ∫ iframe ÂÖßÂ∑≤ÊúâÊ®ôÈ°å */
            }
            
            #property-add-form-container {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .content-card h2 {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            /* Modal ÂÑ™Âåñ */
            .modal-dialog {
                width: 95%;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                padding: 1.25rem;
            }
            
            .modal-body {
                padding: 1.25rem;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            /* Â≠êÊ®ôÁ±§ÂàáÊèõÂÑ™Âåñ */
            .sub-tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            /* Ë°®ÂñÆÊ¨Ñ‰ΩçÂÑ™Âåñ - Â¢ûÂä†ÈñìË∑ùÂíåÂ§ßÂ∞è */
            .form-group {
                margin-bottom: 1.25rem;
            }
            
            .form-group label {
                font-size: 0.95rem;
                margin-bottom: 0.6rem;
                font-weight: 600;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.85rem;
                font-size: 1rem;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                min-height: 44px; /* Ëß∏ÊéßÂèãÂ•ΩÁöÑÊúÄÂ∞èÈ´òÂ∫¶ */
            }
            
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .form-group textarea {
                min-height: 120px;
                line-height: 1.5;
            }
            
            /* iframe ‰∏≠ÁöÑË°®ÂñÆÂÑ™Âåñ - ÁßªÈô§ÊâÄÊúâÈÇäË∑ùÂíåÈÇäÊ°Ü */
            #property-add-iframe,
            #property-edit-iframe {
                width: 100% !important;
                min-height: auto !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                display: block !important;
            }
            
            /* Ë°®ÂñÆÂçÄÂ°äÂÑ™Âåñ */
            .form-section {
                padding: 1rem !important;
                margin-bottom: 1.5rem !important;
            }
            
            .form-section h3 {
                font-size: 1.1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .form-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
        }
        
        /* Ê°åÈù¢ÁâàÈö±ËóèÊº¢Â†°ÈÅ∏ÂñÆ */
        @media (min-width: 769px) {
            .mobile-menu-btn,
            .nav-close-btn,
            .nav-overlay {
                display: none !important;
            }
            
            .nav {
                position: static;
                width: auto;
                height: auto;
                flex-direction: row;
                padding: 0 2rem;
            }
        }
        
        /* Â≠êÊ®ôÁ±§ÂàáÊèõÊ®£Âºè */
        .sub-tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sub-tab-btn:hover {
            color: #667eea;
            background: #f8f9fa;
        }
        
        .sub-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .property-subtab {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .property-subtab.active {
            display: block;
        }
        
        /* Áâ©‰ª∂ÂàóË°®ÂèØÊªæÂãïÔºö‰øùÁïôÊ®ôÈ°å/ÊêúÂ∞ã/ÁØ©ÈÅ∏Âú®‰∏äÊñπÔºåÂàóË°®ÂçÄÂ°äÁç®Á´ãÊªæÂãï */
        #property-list-subtab #properties-list {
            max-height: calc(100vh - 320px);
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f5f9;
            scroll-behavior: smooth;
        }
        #property-list-subtab #properties-list::-webkit-scrollbar {
            width: 8px;
        }
        #property-list-subtab #properties-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        #property-list-subtab #properties-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        #property-list-subtab #properties-list::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
        
        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        
        /* ÊâãÊ©üÁâàÂø´ÈÄüÊìç‰Ωú‰∏âÊ¨ÑÂ∏ÉÂ±Ä */
        @media (max-width: 768px) {
            .quick-actions {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
                margin-bottom: 1.5rem;
            }
            
            .quick-actions .btn {
                padding: 0.6rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
        
        .property-preview {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .property-preview img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .property-preview-info {
            flex: 1;
        }
        
        .property-preview-info h4 {
            margin-bottom: 0.25rem;
            color: #333;
        }
        
        .property-preview-info p {
            color: #666;
            font-size: 0.85rem;
        }
        
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .filter-select-container {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .filter-select {
            padding: 0.5rem 2.5rem 0.5rem 0.8rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 12px;
            min-width: 150px;
        }
        
        .filter-select:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: #f8f9fa;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Âç°ÁâáÁ∂≤Ê†º‰ΩàÂ±Ä */
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .property-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .property-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .property-card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #f0f0f0;
        }
        
        .property-card-placeholder {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 2rem;
        }
        
        .property-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .property-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .property-card-meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        
        .property-card-status {
            margin-bottom: 1rem;
        }
        
        .property-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        
        .property-card-actions .btn {
            flex: 1;
            padding: 0.6rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
        <h1>üè† ÂæåÂè∞ÁÆ°ÁêÜÁ≥ªÁµ±</h1>
        <p>Áâ©‰ª∂ÁÆ°ÁêÜ„ÄÅ‰∏ä‰∏ãÊû∂ÊéßÂà∂„ÄÅÈÄ£ÁµêÁÆ°ÁêÜ</p>
    </div>
    
    <!-- ÂÅ¥ÈÇäÊ¨ÑÈÅÆÁΩ© -->
    <div class="nav-overlay" onclick="toggleMobileMenu()"></div>
    
    <div class="nav" id="main-nav">
        <button class="nav-close-btn" onclick="toggleMobileMenu()">√ó</button>
        <div class="nav-item active" onclick="switchTab('dashboard', this); toggleMobileMenu();">üìä ÂÑÄË°®Êùø</div>
        <div class="nav-item" onclick="switchTab('properties', this); toggleMobileMenu();">üèòÔ∏è Áâ©‰ª∂ÁÆ°ÁêÜ</div>
        <div class="nav-item" onclick="switchTab('duplicates', this); toggleMobileMenu();">üîç ÈáçË§áÁâ©‰ª∂Ê™¢Ê∏¨</div>
        <div class="nav-item" onclick="switchTab('links', this); toggleMobileMenu();">üîó ÈÄ£ÁµêÁÆ°ÁêÜ</div>
    </div>
    
    <div class="container">
        <!-- ÂÑÄË°®Êùø -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card primary">
                    <h3>Á∏ΩÁâ©‰ª∂Êï∏</h3>
                    <div class="value" id="stat-total">0</div>
                </div>
                <div class="stat-card success">
                    <h3>Â∑≤‰∏äÊû∂</h3>
                    <div class="value" id="stat-published">0</div>
                </div>
                <div class="stat-card warning">
                    <h3>Â∑≤‰∏ãÊû∂</h3>
                    <div class="value" id="stat-unpublished">0</div>
                </div>
                <div class="stat-card danger">
                    <h3>Â∑≤ÂîÆÂá∫</h3>
                    <div class="value" id="stat-sold">0</div>
                </div>
            </div>
            
            <div class="content-card">
                <h2>Âø´ÈÄüÊìç‰Ωú</h2>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="switchTab('properties', document.querySelector('.nav-item:nth-child(2)'))">
                        ‚ûï Êñ∞Â¢ûÁâ©‰ª∂
                    </button>
                    <button class="btn btn-success" onclick="switchTab('properties', document.querySelector('.nav-item:nth-child(2)'))">
                        ‚¨ÜÔ∏è ÁÆ°ÁêÜ‰∏ä‰∏ãÊû∂
                    </button>
                    <a href="index.html" target="_blank" class="btn btn-secondary">
                        üëÅÔ∏è Êü•ÁúãÂâçÂè∞
                    </a>
                </div>
            </div>
            
            <div class="content-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="margin: 0;">ÊúÄËøëÊõ¥Êñ∞ÁöÑÁâ©‰ª∂</h2>
                    <div class="dashboard-view-mode-toggle" style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="color: #666; font-size: 0.9rem; margin-right: 0.5rem;">Ê™¢Ë¶ñÊ®°ÂºèÔºö</span>
                        <button class="filter-btn active" id="dashboard-view-table-btn" onclick="setDashboardViewMode('table', this)" style="padding: 0.4rem 0.8rem;">
                            üìã Ë°®Ê†º
                        </button>
                        <button class="filter-btn" id="dashboard-view-grid-btn" onclick="setDashboardViewMode('grid', this)" style="padding: 0.4rem 0.8rem;">
                            üé¥ Á∂≤Ê†º
                        </button>
                    </div>
                </div>
                <div id="recent-properties">
                    <p style="text-align: center; color: #666; padding: 2rem;">ËºâÂÖ•‰∏≠...</p>
                </div>
            </div>
        </div>
        
        <!-- Áâ©‰ª∂ÁÆ°ÁêÜ -->
        <div id="properties-tab" class="tab-content">
            <!-- Â≠êÊ®ôÁ±§ÂàáÊèõ -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e9ecef;">
                <button class="sub-tab-btn active" onclick="switchPropertySubTab('list', this)" id="property-list-tab">
                    üìã Áâ©‰ª∂ÂàóË°®
                </button>
                <button class="sub-tab-btn" onclick="switchPropertySubTab('add', this)" id="property-add-tab">
                    ‚ûï Êñ∞Â¢ûÁâ©‰ª∂
                </button>
            </div>
            
            <!-- Áâ©‰ª∂ÂàóË°®Â≠êÊ®ôÁ±§ -->
            <div id="property-list-subtab" class="property-subtab active">
                <div class="content-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>Áâ©‰ª∂ÂàóË°®</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="checkDuplicates()" style="margin-right: 0.5rem;">
                                üîç Ê™¢Êü•ÈáçË§á
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="ÊêúÂ∞ãÁâ©‰ª∂ÔºàÊ®ôÈ°å„ÄÅÁ∑®Ëôü„ÄÅÂú∞ÂùÄÔºâ..." onkeyup="filterProperties()">
                        <select id="type-filter" onchange="filterProperties()">
                            <option value="">ÊâÄÊúâÊàøÂûã</option>
                            <option value="Â•óÊàø">Â•óÊàø</option>
                            <option value="2Êàø">2Êàø</option>
                            <option value="3Êàø">3Êàø</option>
                            <option value="4Êàø">4Êàø</option>
                            <option value="ËèØÂªà">ËèØÂªà</option>
                            <option value="ÂÖ¨ÂØì">ÂÖ¨ÂØì</option>
                            <option value="ÈÄèÂ§©">ÈÄèÂ§©</option>
                            <option value="Â∫óÈù¢">Â∫óÈù¢</option>
                            <option value="Âà•Â¢Ö">Âà•Â¢Ö</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <div class="filter-select-container" style="margin: 0;">
                            <select id="status-filter-select" class="filter-select" onchange="setFilterFromSelect(this.value)">
                                <option value="all">ÂÖ®ÈÉ®</option>
                                <option value="published">Â∑≤‰∏äÊû∂</option>
                                <option value="unpublished">Â∑≤‰∏ãÊû∂</option>
                                <option value="sold">Â∑≤ÂîÆÂá∫</option>
                                <option value="internal">üè† Êú¨Â∫óÁâ©‰ª∂</option>
                                <option value="external">üè¢ ÈùûÊú¨Â∫óÁâ©‰ª∂</option>
                            </select>
                        </div>
                        <div class="view-mode-toggle" style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="color: #666; font-size: 0.9rem; margin-right: 0.5rem;">Ê™¢Ë¶ñÊ®°ÂºèÔºö</span>
                            <button class="filter-btn active" id="view-table-btn" onclick="setViewMode('table', this)" style="padding: 0.4rem 0.8rem;">
                                üìã Ë°®Ê†º
                            </button>
                            <button class="filter-btn" id="view-grid-btn" onclick="setViewMode('grid', this)" style="padding: 0.4rem 0.8rem;">
                                üé¥ Á∂≤Ê†º
                            </button>
                        </div>
                    </div>
                    
                    <div id="properties-list">
                        <p style="text-align: center; color: #666; padding: 2rem;">ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>
            </div>
            
            <!-- Êñ∞Â¢ûÁâ©‰ª∂Â≠êÊ®ôÁ±§ -->
            <div id="property-add-subtab" class="property-subtab">
                <div class="content-card">
                    <h2>Êñ∞Â¢ûÁâ©‰ª∂</h2>
                    <div id="property-add-alert-container" style="margin-bottom: 1rem;"></div>
                    <div id="property-add-form-container">
                        <p style="text-align: center; color: #666; padding: 2rem;">
                            ‚è≥ Ê≠£Âú®ËºâÂÖ•Êñ∞Â¢ûË°®ÂñÆ...
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÈáçË§áÁâ©‰ª∂Ê™¢Ê∏¨ -->
        <div id="duplicates-tab" class="tab-content">
            <div class="content-card">
                <h2>üîç ÈáçË§áÁâ©‰ª∂Ê™¢Ê∏¨ËàáÊ∏ÖÁêÜ</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Ëá™ÂãïÊ™¢Ê∏¨‰∏¶Ê∏ÖÁêÜÈáçË§áÁöÑÁâ©‰ª∂ÔºàÊ†πÊìöÁâ©‰ª∂Á∑®ËôüÔºâ„ÄÇÁ≥ªÁµ±ÊúÉ‰øùÁïôÊúÄÊñ∞Âª∫Á´ãÁöÑÁâ©‰ª∂ÔºåÂà™Èô§ËºÉËàäÁöÑÈáçË§áÈ†ÖÁõÆ„ÄÇ
                </p>
                
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="checkDuplicates()">
                        üîç ÈñãÂßãÊ™¢Ê∏¨ÈáçË§áÁâ©‰ª∂
                    </button>
                    <button class="btn btn-danger" onclick="cleanDuplicates()" id="clean-btn" style="display: none; margin-left: 0.5rem;">
                        üóëÔ∏è Ê∏ÖÁêÜÈáçË§áÁâ©‰ª∂
                    </button>
                </div>
                
                <div id="duplicates-result">
                    <p style="text-align: center; color: #666; padding: 2rem;">ÈªûÊìä„ÄåÈñãÂßãÊ™¢Ê∏¨„Äç‰æÜÊ™¢Êü•ÈáçË§áÁâ©‰ª∂</p>
                </div>
            </div>
        </div>
        
        <!-- ÈÄ£ÁµêÁÆ°ÁêÜ -->
        <div id="links-tab" class="tab-content">
            <div class="content-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>üìé Áõ∏ÈóúÈÄ£ÁµêÁÆ°ÁêÜ</h2>
                    <button class="btn btn-primary" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.showAddLinkModal) { RelatedLinksBackend.showAddLinkModal(); } else { showAddLinkModal(); }">
                        ‚ûï Êñ∞Â¢ûÈÄ£Áµê
                    </button>
                </div>
                
                <p style="color: #666; margin-bottom: 1.5rem;">
                    ÁÆ°ÁêÜÁ∂≤Á´ôÈ¶ñÈ†ÅÂíåÁâ©‰ª∂Ë©≥Á¥∞È†ÅÈù¢È°ØÁ§∫ÁöÑÁõ∏ÈóúÈÄ£Áµê„ÄÇÂèØ‰ª•Êñ∞Â¢û„ÄÅÁ∑®ËºØ„ÄÅÂà™Èô§ÈÄ£ÁµêÔºå‰∏¶Ë™øÊï¥È°ØÁ§∫È†ÜÂ∫è„ÄÇ
                </p>
                
                <div id="links-alert-container" style="margin-bottom: 1rem;"></div>
                
                <!-- ÈÄ£ÁµêÂàóË°® -->
                <div id="links-list">
                    <p style="text-align: center; color: #666; padding: 2rem;">ËºâÂÖ•‰∏≠...</p>
                </div>
            </div>
        </div>
        
        <!-- Êñ∞Â¢û/Á∑®ËºØÈÄ£ÁµêÂΩàÁ™ó -->
        <div id="link-modal" class="modal-overlay" style="display: none;">
            <div class="modal-dialog" style="max-width: 600px; width: 90%;">
                <div class="modal-header">
                    <h3 id="link-modal-title">Êñ∞Â¢ûÈÄ£Áµê</h3>
                    <button class="modal-close" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.closeLinkModal) { RelatedLinksBackend.closeLinkModal(); } else { closeLinkModal(); }">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ÈÄ£ÁµêÊ®ôÈ°å *</label>
                        <input type="text" id="link-title" placeholder="‰æãÂ¶ÇÔºöÊõ¥Â§öÁâ©‰ª∂Ë≥áÊñô" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ÈÄ£ÁµêÁ∂≤ÂùÄ *</label>
                        <input type="url" id="link-url" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ÂúñÁ§∫ÔºàEmojiÔºâ</label>
                        <input type="text" id="link-icon" placeholder="‰æãÂ¶ÇÔºöüè†„ÄÅüéµ„ÄÅüßÆ" maxlength="2">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                            üí° ÊèêÁ§∫ÔºöËº∏ÂÖ•‰∏ÄÂÄã emoji ÂúñÁ§∫Ôºå‰æãÂ¶Ç üè†„ÄÅüéµ„ÄÅüßÆ
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>ÊåâÈàïÈ°èËâ≤ÔºàCSS Êº∏Â±§Ôºâ</label>
                        <input type="text" id="link-color" placeholder="‰æãÂ¶ÇÔºölinear-gradient(45deg, #2ecc71, #27ae60)" value="linear-gradient(45deg, #667eea, #764ba2)">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                            üí° ÊèêÁ§∫Ôºö‰ΩøÁî® CSS linear-gradient Ë™ûÊ≥ïÔºå‰æãÂ¶ÇÔºölinear-gradient(45deg, #2ecc71, #27ae60)
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>È°ØÁ§∫È†ÜÂ∫è</label>
                        <input type="number" id="link-order" value="0" min="0">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                            üí° ÊèêÁ§∫ÔºöÊï∏Â≠óË∂äÂ∞èË∂äÈù†ÂâçÈ°ØÁ§∫
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="link-active" checked> ÂïüÁî®Ê≠§ÈÄ£Áµê
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>ÈÄ£ÁµêÈ°ûÂûã</label>
                        <select id="link-type">
                            <option value="button">ÊåâÈàïÔºàÁõ¥Êé•ÈÄ£ÁµêÔºâ</option>
                            <option value="dropdown">‰∏ãÊãâÈÅ∏ÂñÆÔºàÂåÖÂê´Â§öÂÄãÂ≠êÈ†ÖÁõÆÔºâ</option>
                        </select>
                    </div>
                    
                    <!-- ‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÔºàÂÉÖÁï∂È°ûÂûãÁÇ∫ dropdown ÊôÇÈ°ØÁ§∫Ôºâ -->
                    <div id="link-items-container" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <label style="margin: 0; font-weight: 600;">‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ</label>
                            <button type="button" class="btn btn-secondary btn-small" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.addLinkItem) { RelatedLinksBackend.addLinkItem(); } else { addLinkItem(); }">
                                ‚ûï Êñ∞Â¢ûÈ†ÖÁõÆ
                            </button>
                        </div>
                        <div id="link-items-list">
                            <!-- ÂãïÊÖãÁîüÊàêÁöÑÈ†ÖÁõÆÂàóË°® -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.closeLinkModal) { RelatedLinksBackend.closeLinkModal(); } else { closeLinkModal(); }">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.saveLink) { RelatedLinksBackend.saveLink(); } else { saveLink(); }">üíæ ÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // HTML ËΩâÁæ©ÂáΩÊï∏ÔºàÈò≤Ê≠¢ XSSÔºâ
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        // ‰ΩøÁî®Áµ±‰∏ÄÁöÑ Supabase ÈÖçÁΩÆÔºàÂæû supabase-config.js ËºâÂÖ•Ôºâ
        // Â¶ÇÊûúÈÖçÁΩÆÊ™îÊ°àÊú™ËºâÂÖ•Ôºå‰ΩøÁî®ÂÇôÁî®ÈÖçÁΩÆ
        const SUPABASE_URL = (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG.url) 
            ? SUPABASE_CONFIG.url 
            : 'https://cnzqtuuegdqwkgvletaa.supabase.co';
        const SUPABASE_ANON_KEY = (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG.anonKey) 
            ? SUPABASE_CONFIG.anonKey 
            : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuenF0dXVlZ2Rxd2tndmxldGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjUxMTksImV4cCI6MjA4MzcwMTExOX0.gsO3RKdMu2bUXW4b5aHseouIkjXtJyIqqP_0x3Y6trE';
        
        let supabaseClient = null;
        
        // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´ØÔºàÁµ±‰∏ÄÂáΩÊï∏Ôºå‰ΩøÁî®Áµ±‰∏ÄÈÖçÁΩÆÔºåÂñÆ‰æãÊ®°ÂºèÔºâ
        function initSupabaseClient() {
            if (typeof supabase === 'undefined') {
                console.error('‚ùå Supabase SDK Â∞öÊú™ËºâÂÖ•');
                return null;
            }
            
            // ‰ΩøÁî®ÂÖ®ÂüüÂñÆ‰æãÔºåÈÅøÂÖçÂ§öÂÄãÂØ¶‰æã
            if (typeof window.supabaseClient !== 'undefined' && window.supabaseClient) {
                console.log('üîÑ ‰ΩøÁî®ÁèæÊúâÁöÑ Supabase ÂÆ¢Êà∂Á´ØÔºàÈÅøÂÖçÂ§öÂÄãÂØ¶‰æãÔºâ');
                supabaseClient = window.supabaseClient;
                return supabaseClient;
            }
            
            if (!supabaseClient) {
                console.log('üîÑ ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´Ø...');
                try {
                    // ÂÑ™ÂÖà‰ΩøÁî®Áµ±‰∏ÄÈÖçÁΩÆÂáΩÊï∏
                    if (typeof createSupabaseClient === 'function') {
                        supabaseClient = createSupabaseClient({
                            global: { headers: { 'x-client-info': 'admin-dashboard' } }
                        });
                    } else {
                        // ÂÇôÁî®ÔºöÁõ¥Êé•ÂâµÂª∫
                        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                            db: { schema: 'public' },
                            auth: { persistSession: false },
                            global: { headers: { 'x-client-info': 'admin-dashboard' } }
                        });
                    }
                    // ÂÑ≤Â≠òÂà∞ÂÖ®ÂüüÔºå‰æõÂÖ∂‰ªñÊ®°ÁµÑ‰ΩøÁî®
                    window.supabaseClient = supabaseClient;
                    console.log('‚úÖ Supabase ÂÆ¢Êà∂Á´ØÂàùÂßãÂåñÊàêÂäüÔºàÂñÆ‰æãÊ®°ÂºèÔºâ');
                } catch (error) {
                    console.error('‚ùå Supabase ÂÆ¢Êà∂Á´ØÂàùÂßãÂåñÂ§±Êïó:', error);
                    return null;
                }
            }
            return supabaseClient;
        }
        
        // Ë®∫Êñ∑ Supabase ÈÄ£Êé•
        async function diagnoseSupabaseConnection() {
            console.log('üîç ÈñãÂßãË®∫Êñ∑ Supabase ÈÄ£Êé•...');
            
            // Ê™¢Êü• Supabase SDK
            if (typeof supabase === 'undefined') {
                console.error('‚ùå Supabase SDK Êú™ËºâÂÖ•');
                return { success: false, error: 'Supabase SDK Êú™ËºâÂÖ•' };
            }
            console.log('‚úÖ Supabase SDK Â∑≤ËºâÂÖ•');
            
            // ÂàùÂßãÂåñÂÆ¢Êà∂Á´Ø
            const client = initSupabaseClient();
            if (!client) {
                console.error('‚ùå ÁÑ°Ê≥ïÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´Ø');
                return { success: false, error: 'ÁÑ°Ê≥ïÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´Ø' };
            }
            
            // Ê∏¨Ë©¶Êü•Ë©¢
            try {
                console.log('üîÑ Ê∏¨Ë©¶Êü•Ë©¢ related_links Ë°®...');
                const { data, error } = await client
                    .from('related_links')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('‚ùå Supabase Êü•Ë©¢Â§±Êïó:', error);
                    return { success: false, error: error.message || 'Êü•Ë©¢Â§±Êïó' };
                }
                
                console.log('‚úÖ Supabase Êü•Ë©¢ÊàêÂäüÔºåÊâæÂà∞', data?.length || 0, 'Á≠ÜË≥áÊñô');
                return { success: true, data };
            } catch (error) {
                console.error('‚ùå Supabase Êü•Ë©¢Áï∞Â∏∏:', error);
                return { success: false, error: error.message || 'Êü•Ë©¢Áï∞Â∏∏' };
            }
        }
        
        // Âú®È†ÅÈù¢ËºâÂÖ•ÊôÇÂü∑Ë°åË®∫Êñ∑
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(diagnoseSupabaseConnection, 1000);
            });
        } else {
            setTimeout(diagnoseSupabaseConnection, 1000);
        }
        let allProperties = [];
        let currentFilter = 'all';
        let viewMode = 'table'; // 'table' Êàñ 'grid'ÔºàÁâ©‰ª∂ÂàóË°®È†ÅÈù¢Ôºâ
        let dashboardViewMode = 'grid'; // 'table' Êàñ 'grid'ÔºàÂÑÄË°®ÊùøÊúÄËøëÁâ©‰ª∂ÔºåÈ†êË®≠ÁÇ∫Á∂≤Ê†ºÊ®°ÂºèÔºâ
        
        // ÁîüÊàêÁâ©‰ª∂Áç®Á´ãÁ∂≤È†ÅÁöÑ URL
        function getPropertyDetailUrl(property) {
            if (!property) return '#';
            
            // Áç≤ÂèñÁï∂ÂâçÈ†ÅÈù¢ÁöÑÂü∫Á§éË∑ØÂæë
            let basePath = window.location.pathname;
            
            // ÁßªÈô§Ê™îÊ°àÂêçÁ®±ÔºåÂè™‰øùÁïôÁõÆÈåÑË∑ØÂæë
            if (basePath.includes('/')) {
                const lastSlash = basePath.lastIndexOf('/');
                basePath = basePath.substring(0, lastSlash + 1);
            } else {
                // Â¶ÇÊûúÊ≤íÊúâÊñúÁ∑öÔºåË™™ÊòéÂú®Ê†πÁõÆÈåÑ
                basePath = '/';
            }
            
            // Á¢∫‰øù basePath ‰ª• / ÁµêÂ∞æ
            if (!basePath.endsWith('/')) {
                basePath = basePath + '/';
            }
            
            // ÊßãÂª∫ÂÆåÊï¥ URL
            const baseUrl = window.location.origin + basePath;
            
            // ÂÑ™ÂÖà‰ΩøÁî®Áâ©‰ª∂Á∑®Ëôü
            if (property.number && property.number !== 'N/A' && property.number !== '' && property.number !== null) {
                const url = `${baseUrl}property-detail.html?number=${encodeURIComponent(property.number)}`;
                console.log('üîó ÁîüÊàêÁç®Á´ãÈ†Å URL:', url, 'Âü∫Á§éË∑ØÂæë:', basePath);
                return url;
            } 
            // Â¶ÇÊûúÊ≤íÊúâÁ∑®ËôüÔºå‰ΩøÁî® ID
            else if (property.id) {
                const url = `${baseUrl}property-detail.html?id=${property.id}`;
                console.log('üîó ÁîüÊàêÁç®Á´ãÈ†Å URL:', url, 'Âü∫Á§éË∑ØÂæë:', basePath);
                return url;
            }
            
            // Â¶ÇÊûúÈÉΩÊ≤íÊúâÔºåËøîÂõûÁ©∫ÈÄ£Áµê
            console.warn('‚ö†Ô∏è ÁÑ°Ê≥ïÁîüÊàêÁâ©‰ª∂ÈÄ£ÁµêÔºöÁº∫Â∞ëÁ∑®ËôüÂíå ID', property);
            return '#';
        }
        
        // üé® È°ØÁ§∫ÂèØÊÑõÁöÑÂΩàÁ™ó
        function showCuteModal(type, title, message, url = null) {
            // ÁßªÈô§ÁèæÊúâÁöÑÂΩàÁ™ó
            const existingModal = document.querySelector('.cute-modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÂâµÂª∫ÂΩàÁ™ó
            const overlay = document.createElement('div');
            overlay.className = 'cute-modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = `cute-modal ${type}`;
            
            // Ê†πÊìöÈ°ûÂûãÈÅ∏ÊìáÂúñÊ®ôÂíåÈ°èËâ≤
            let icon = '‚ú®';
            if (type === 'success') {
                icon = 'üéâ';
            } else if (type === 'error') {
                icon = 'üò¢';
            } else if (type === 'warning') {
                icon = '‚ö†Ô∏è';
            }
            
            modal.innerHTML = `
                <button class="cute-modal-close" onclick="this.closest('.cute-modal-overlay').remove()">√ó</button>
                <div class="cute-modal-content">
                    <div class="cute-modal-icon">${icon}</div>
                    <div class="cute-modal-title">${title}</div>
                    <div class="cute-modal-message">${message}</div>
                    ${url ? `<div class="cute-modal-url">${url}</div>` : ''}
                    <div class="cute-modal-buttons">
                        ${url ? `
                            <button class="cute-modal-btn cute-modal-btn-primary" data-url="${url.replace(/"/g, '&quot;')}">
                                üìã ÂÜçÊ¨°Ë§áË£Ω
                            </button>
                        ` : ''}
                        <button class="cute-modal-btn cute-modal-btn-secondary">
                            ÈóúÈñâ
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Á∂ÅÂÆöÊåâÈàï‰∫ã‰ª∂
            const primaryBtn = modal.querySelector('.cute-modal-btn-primary');
            const secondaryBtn = modal.querySelector('.cute-modal-btn-secondary');
            
            if (primaryBtn && url) {
                primaryBtn.addEventListener('click', function() {
                    navigator.clipboard.writeText(url).then(() => {
                        this.textContent = '‚úÖ Â∑≤Ë§áË£ΩÔºÅ';
                        this.style.background = '#4caf50';
                        this.style.color = 'white';
                        setTimeout(() => {
                            overlay.remove();
                        }, 1000);
                    }).catch(err => {
                        console.error('Ë§áË£ΩÂ§±Êïó:', err);
                        this.textContent = '‚ùå Ë§áË£ΩÂ§±Êïó';
                        this.style.background = '#f5576c';
                    });
                });
            }
            
            if (secondaryBtn) {
                secondaryBtn.addEventListener('click', function() {
                    overlay.remove();
                });
            }
            
            // ÈªûÊìäËÉåÊôØÈóúÈñâ
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            // ESC ÈçµÈóúÈñâ
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // 3ÁßíÂæåËá™ÂãïÈóúÈñâÔºàÊàêÂäüÊôÇÔºâ
            if (type === 'success') {
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.style.animation = 'fadeInOverlay 0.3s ease-out reverse';
                        setTimeout(() => overlay.remove(), 300);
                    }
                }, 3000);
            }
        }
        
        // Ë§áË£ΩÁâ©‰ª∂Áç®Á´ãÁ∂≤È†ÅÈÄ£Áµê
        function copyPropertyLink(property) {
            const url = getPropertyDetailUrl(property);
            if (url === '#') {
                showCuteModal('error', 'ÁÑ°Ê≥ïÁîüÊàêÈÄ£Áµê', 'Áº∫Â∞ëÁâ©‰ª∂Á∑®ËôüÊàñ IDÔºåË´ãÊ™¢Êü•Áâ©‰ª∂Ë≥áÊñô');
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showCuteModal('success', 'ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ', 'ÈÄ£ÁµêÂ∑≤ÊàêÂäüË§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºåÂèØ‰ª•Áõ¥Êé•Ë≤º‰∏ä‰ΩøÁî®ÂõâÔΩû', url);
                }).catch(err => {
                    console.error('Ë§áË£ΩÂ§±Êïó:', err);
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }
        
        // ÂÇôÁî®Ë§áË£ΩÊñπÊ≥ï
        function fallbackCopy(url) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCuteModal('success', 'ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ', 'ÈÄ£ÁµêÂ∑≤ÊàêÂäüË§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºåÂèØ‰ª•Áõ¥Êé•Ë≤º‰∏ä‰ΩøÁî®ÂõâÔΩû', url);
            } catch (err) {
                console.error('Ë§áË£ΩÂ§±Êïó:', err);
                showCuteModal('error', 'Ë§áË£ΩÂ§±Êïó', 'ÁÑ°Ê≥ïËá™ÂãïË§áË£ΩÔºåË´ãÊâãÂãïË§áË£Ω‰ª•‰∏ãÈÄ£ÁµêÔºö', url);
            }
            document.body.removeChild(textarea);
        }
        
        // ÊâìÈñãÁâ©‰ª∂Áç®Á´ãÁ∂≤È†Å
        function openPropertyDetail(property) {
            const url = getPropertyDetailUrl(property);
            if (url === '#') {
                showCuteModal('error', 'ÁÑ°Ê≥ïÈñãÂïüÈÄ£Áµê', 'Áº∫Â∞ëÁâ©‰ª∂Á∑®ËôüÊàñ IDÔºåË´ãÊ™¢Êü•Áâ©‰ª∂Ë≥áÊñô');
                return;
            }
            window.open(url, '_blank');
        }
        
        // È°ØÁ§∫ QR Code ÂΩàÁ™ó
        function downloadQRCode(property) {
            const url = getPropertyDetailUrl(property);
            if (url === '#') {
                showCuteModal('error', 'ÁÑ°Ê≥ïÁîüÊàê QR Code', 'Áº∫Â∞ëÁâ©‰ª∂Á∑®ËôüÊàñ IDÔºåË´ãÊ™¢Êü•Áâ©‰ª∂Ë≥áÊñô');
                return;
            }
            
            // ÁßªÈô§ÁèæÊúâÁöÑ QR Code ÂΩàÁ™ó
            const existingModal = document.querySelector('.qrcode-modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÂâµÂª∫ÂΩàÁ™ó
            const overlay = document.createElement('div');
            overlay.className = 'cute-modal-overlay qrcode-modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'qrcode-modal';
            
            const fileName = property.number && property.number !== 'N/A' && property.number !== '' 
                ? `QRCode-${property.number}.png` 
                : `QRCode-${property.id || 'property'}.png`;
            
            modal.innerHTML = `
                <button class="cute-modal-close" onclick="this.closest('.qrcode-modal-overlay').remove()">√ó</button>
                <div class="qrcode-modal-content">
                    <div class="qrcode-modal-title">üì± QR Code</div>
                    <div class="qrcode-container">
                        <div class="qrcode-loading">‚è≥ Ê≠£Âú®ÁîüÊàê QR Code...</div>
                    </div>
                    <div class="qrcode-modal-buttons">
                        <button class="qrcode-modal-btn qrcode-modal-btn-primary" id="download-qrcode-btn" disabled style="white-space: nowrap;">
                            üíæ ‰∏ãËºâ QR Code
                        </button>
                        <button class="qrcode-modal-btn qrcode-modal-btn-secondary" onclick="this.closest('.qrcode-modal-overlay').remove()" style="white-space: nowrap;">
                            ÈóúÈñâ
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            const container = modal.querySelector('.qrcode-container');
            const downloadBtn = modal.querySelector('#download-qrcode-btn');
            let qrcodeImage = null;
            
            // ‰ΩøÁî®Êú¨Âú∞ÂáΩÂºèÂ∫´ÁîüÊàê QR Code
            function generateQRCode() {
                // Ê™¢Êü• QRCode ÂáΩÂºèÂ∫´ÊòØÂê¶Â∑≤ËºâÂÖ•ÔºàÁ≠âÂæÖ‰∏Ä‰∏ãËÆìÂáΩÂºèÂ∫´ÊúâÊôÇÈñìËºâÂÖ•Ôºâ
                function checkAndGenerate() {
                    const QRCodeLib = window.QRCode || (typeof QRCode !== 'undefined' ? QRCode : null);
                    
                    if (!QRCodeLib || typeof QRCodeLib !== 'function') {
                        // Â¶ÇÊûúÈÇÑÊ≤íËºâÂÖ•ÔºåÁ≠âÂæÖ‰∏Ä‰∏ãÂÜçÊ™¢Êü•
                        if (container.querySelector('.qrcode-loading') && !container.querySelector('.qrcode-loading').textContent.includes('‚ùå')) {
                            setTimeout(checkAndGenerate, 500);
                            return;
                        }
                        
                        // Â¶ÇÊûúÂ∑≤Á∂ìÁ≠âÂæÖÈÅéÔºåÈ°ØÁ§∫ÈåØË™§‰∏¶ÂòóË©¶ÈáçÊñ∞ËºâÂÖ•
                        container.innerHTML = '<div class="qrcode-loading" style="color: #f5576c;">‚ùå ÁÑ°Ê≥ïËºâÂÖ• QR Code ÂáΩÂºèÂ∫´<br><small>Ê≠£Âú®ÂòóË©¶ÈáçÊñ∞ËºâÂÖ•...</small></div>';
                        console.error('QRCode ÂáΩÂºèÂ∫´Êú™ËºâÂÖ•');
                        console.log('Ê™¢Êü• window.QRCode:', typeof window.QRCode);
                        console.log('Ê™¢Êü• QRCode:', typeof QRCode);
                        
                        // ÂòóË©¶ÈáçÊñ∞ËºâÂÖ•ÂáΩÂºèÂ∫´
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
                        script.onload = () => {
                            console.log('‚úÖ QRCode ÂáΩÂºèÂ∫´ÈáçÊñ∞ËºâÂÖ•ÊàêÂäü');
                            setTimeout(checkAndGenerate, 100); // ÈáçÊñ∞Ê™¢Êü•
                        };
                        script.onerror = () => {
                            console.error('‚ùå QRCode ÂáΩÂºèÂ∫´ÈáçÊñ∞ËºâÂÖ•Â§±Êïó');
                            container.innerHTML = '<div class="qrcode-loading" style="color: #f5576c;">‚ùå ÁÑ°Ê≥ïËºâÂÖ• QR Code ÂáΩÂºèÂ∫´<br><small>Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢</small></div>';
                        };
                        document.head.appendChild(script);
                        return;
                    }
                    
                    // ÂáΩÂºèÂ∫´Â∑≤ËºâÂÖ•ÔºåÈñãÂßãÁîüÊàê
                    generateWithLibrary(QRCodeLib);
                }
                
                // ÂØ¶ÈöõÁîüÊàê QR Code ÁöÑÂáΩÊï∏
                function generateWithLibrary(QRCodeLib) {
                
                    try {
                        // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫ÊâãÊ©üÁâàÔºåÊ±∫ÂÆö QR Code Â§ßÂ∞è
                        const isMobile = window.innerWidth <= 768;
                        const qrSize = isMobile ? 200 : 300;
                        
                        // ÂâµÂª∫‰∏ÄÂÄãËá®ÊôÇÁöÑÈö±Ëóè div ‰æÜÁîüÊàê QR Code
                        const tempDiv = document.createElement('div');
                        tempDiv.style.width = qrSize + 'px';
                        tempDiv.style.height = qrSize + 'px';
                        tempDiv.style.position = 'absolute';
                        tempDiv.style.left = '-9999px';
                        tempDiv.style.top = '-9999px';
                        document.body.appendChild(tempDiv);
                        
                        // ‰ΩøÁî® qrcodejs ÁîüÊàê QR Code
                        const qrcode = new QRCodeLib(tempDiv, {
                            text: url,
                            width: qrSize,
                            height: qrSize,
                            colorDark: '#000000',
                            colorLight: '#FFFFFF',
                            correctLevel: QRCodeLib.CorrectLevel ? QRCodeLib.CorrectLevel.H : 2
                        });
                    
                        // Á≠âÂæÖ QR Code ÁîüÊàêÂÆåÊàê
                        setTimeout(() => {
                            try {
                                const canvas = tempDiv.querySelector('canvas');
                                const img = tempDiv.querySelector('img');
                                
                                if (!canvas && !img) {
                                    throw new Error('ÁÑ°Ê≥ïÊâæÂà∞ QR Code ÂÖÉÁ¥†');
                                }
                                
                                container.innerHTML = '';
                                
                                if (canvas) {
                                    // Â∞çÊñº canvasÔºåÂâµÂª∫‰∏ÄÂÄãÊñ∞ÁöÑ canvas ‰∏¶Ë§áË£ΩÂÖßÂÆπ
                                    const newCanvas = document.createElement('canvas');
                                    newCanvas.width = qrSize;
                                    newCanvas.height = qrSize;
                                    newCanvas.style.width = qrSize + 'px';
                                    newCanvas.style.height = qrSize + 'px';
                                    newCanvas.style.display = 'block';
                                    newCanvas.style.maxWidth = '100%';
                                    newCanvas.style.maxHeight = '100%';
                                    newCanvas.style.margin = '0 auto';
                                    const ctx = newCanvas.getContext('2d');
                                    ctx.drawImage(canvas, 0, 0, qrSize, qrSize);
                                    container.appendChild(newCanvas);
                                    qrcodeImage = newCanvas;
                                    console.log('‚úÖ QR Code canvas Â∑≤Ê∑ªÂä†Âà∞ÂÆπÂô®');
                                } else if (img) {
                                    // Â∞çÊñº imgÔºåÁõ¥Êé•ÁßªÂãïÊàñË§áË£Ω
                                    const newImg = img.cloneNode(true);
                                    newImg.style.width = qrSize + 'px';
                                    newImg.style.height = qrSize + 'px';
                                    newImg.style.display = 'block';
                                    newImg.style.maxWidth = '100%';
                                    newImg.style.maxHeight = '100%';
                                    newImg.style.margin = '0 auto';
                                    container.appendChild(newImg);
                                    qrcodeImage = newImg;
                                    console.log('‚úÖ QR Code img Â∑≤Ê∑ªÂä†Âà∞ÂÆπÂô®');
                                }
                                
                                // Á¢∫‰øùÂÆπÂô®ÂèØË¶ã
                                container.style.display = 'flex';
                                container.style.justifyContent = 'center';
                                container.style.alignItems = 'center';
                                
                                downloadBtn.disabled = false;
                                
                                // Á∂ÅÂÆö‰∏ãËºâ‰∫ã‰ª∂
                                downloadBtn.onclick = function() {
                                    let targetElement = qrcodeImage;
                                    
                                    // Â¶ÇÊûúÊòØ imgÔºåÈúÄË¶ÅËΩâÊèõÁÇ∫ canvas
                                    if (qrcodeImage.tagName === 'IMG') {
                                        const newCanvas = document.createElement('canvas');
                                        newCanvas.width = 300;
                                        newCanvas.height = 300;
                                        const ctx = newCanvas.getContext('2d');
                                        ctx.drawImage(qrcodeImage, 0, 0);
                                        targetElement = newCanvas;
                                    }
                                    
                                    // Á¢∫‰øùÊòØ canvas ÊâçËÉΩ‰ΩøÁî® toBlob
                                    if (targetElement.tagName === 'CANVAS') {
                                        targetElement.toBlob((blob) => {
                                            if (!blob) {
                                                showCuteModal('error', 'ËΩâÊèõÂ§±Êïó', 'ÁÑ°Ê≥ïÂ∞á QR Code ËΩâÊèõÁÇ∫ÂúñÁâá');
                                                return;
                                            }
                                            
                                            const downloadUrl = URL.createObjectURL(blob);
                                            const link = document.createElement('a');
                                            link.href = downloadUrl;
                                            link.download = fileName;
                                            
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                            
                                            setTimeout(() => URL.revokeObjectURL(downloadUrl), 100);
                                            showCuteModal('success', 'QR Code Â∑≤‰∏ãËºâÔºÅ', `QR Code Â∑≤ÊàêÂäü‰∏ãËºâÁÇ∫ ${fileName}`);
                                        }, 'image/png');
                                    } else {
                                        showCuteModal('error', '‰∏ãËºâÂ§±Êïó', 'ÁÑ°Ê≥ïËΩâÊèõ QR Code ÁÇ∫ÂúñÁâá');
                                    }
                                };
                                
                                document.body.removeChild(tempDiv);
                            } catch (error) {
                                console.error('ÁîüÊàê QR Code Â§±Êïó:', error);
                                container.innerHTML = '<div class="qrcode-loading" style="color: #f5576c;">‚ùå ÁîüÊàêÂ§±ÊïóÔºö' + (error.message || 'Êú™Áü•ÈåØË™§') + '</div>';
                                if (tempDiv.parentNode) {
                                    document.body.removeChild(tempDiv);
                                }
                            }
                        }, 200);
                    } catch (error) {
                        console.error('ÁîüÊàê QR Code Â§±Êïó:', error);
                        container.innerHTML = '<div class="qrcode-loading" style="color: #f5576c;">‚ùå ÁîüÊàêÂ§±ÊïóÔºö' + (error.message || 'Êú™Áü•ÈåØË™§') + '</div>';
                    }
                }
                
                // ÈñãÂßãÊ™¢Êü•‰∏¶ÁîüÊàê
                checkAndGenerate();
            }
            
            // ÈñãÂßãÁîüÊàê QR Code
            generateQRCode();
        }
        
        // ËÉåÊôØÂà∑Êñ∞ÈñìÈöîÔºà30ÂàÜÈêòÔºâ
        const REFRESH_INTERVAL = 30 * 60 * 1000; // 30ÂàÜÈêò = 1800000 ÊØ´Áßí
        let refreshTimer = null;
        
        // ËÉåÊôØËá™ÂãïÂà∑Êñ∞ÂáΩÊï∏
        function startBackgroundRefresh() {
            // Ê∏ÖÈô§ÁèæÊúâÁöÑÂÆöÊôÇÂô®
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            // Ë®≠ÁΩÆÊñ∞ÁöÑÂÆöÊôÇÂô®ÔºöÊØè30ÂàÜÈêòÂà∑Êñ∞‰∏ÄÊ¨°
            refreshTimer = setInterval(() => {
                // Âè™Âú®È†ÅÈù¢ÂèØË¶ãÊôÇÊâçÂà∑Êñ∞Ôºà‰ΩøÁî® Page Visibility APIÔºâ
                if (!document.hidden) {
                    refreshCurrentTab();
                }
            }, REFRESH_INTERVAL);
            
            console.log('‚úÖ ËÉåÊôØËá™ÂãïÂà∑Êñ∞Â∑≤ÂïüÂãïÔºàÊØè30ÂàÜÈêòÔºâ');
        }
        
        // Âà∑Êñ∞Áï∂ÂâçÊ¥ªÂãïÁöÑÊ®ôÁ±§È†Å
        function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;
            
            const tabId = activeTab.id;
            console.log('üîÑ ËÉåÊôØÂà∑Êñ∞Ôºö', tabId);
            
            if (tabId === 'dashboard-tab') {
                // Âà∑Êñ∞ÂÑÄË°®Êùø
                loadDashboard();
            } else if (tabId === 'properties-tab') {
                // Âà∑Êñ∞Áâ©‰ª∂ÁÆ°ÁêÜÔºàÂ¶ÇÊûúÂàóË°®Â≠êÊ®ôÁ±§ÊòØÊ¥ªÂãïÁöÑÔºâ
                if (document.getElementById('property-list-subtab')?.classList.contains('active')) {
                    loadProperties();
                }
            }
            // ÂÖ∂‰ªñÊ®ôÁ±§È†Å‰∏çÈúÄË¶ÅËá™ÂãïÂà∑Êñ∞
        }
        
        // ÂàùÂßãÂåñ
        function init() {
            initSupabaseClient();
            loadDashboard();
            
            // ÂïüÂãïËÉåÊôØËá™ÂãïÂà∑Êñ∞
            startBackgroundRefresh();
            
            // Áõ£ËÅΩÈ†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñÔºàÁï∂Áî®Êà∂ÂàáÊèõÊ®ôÁ±§È†ÅÊôÇÔºâ
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // È†ÅÈù¢ËÆäÁÇ∫ÂèØË¶ãÊôÇÔºåÁ´ãÂç≥Âà∑Êñ∞‰∏ÄÊ¨°
                    refreshCurrentTab();
                }
            });
            
            // ‰∫ã‰ª∂ÂßîÊ¥æÔºöËôïÁêÜÂãïÊÖãÁîüÊàêÁöÑÊåâÈàïÈªûÊìä
            document.addEventListener('click', function(e) {
                const button = e.target.closest('[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const propertyId = button.dataset.propertyId;
                
                if (!propertyId) return;
                
                switch (action) {
                    case 'toggle':
                        const newStatus = button.dataset.status === 'true';
                        togglePublish(propertyId, newStatus);
                        break;
                    case 'edit':
                        editProperty(propertyId);
                        break;
                    case 'delete':
                        deleteProperty(propertyId);
                        break;
                }
            });
        }
        
        // ÂàáÊèõÊ®ôÁ±§
        function switchTab(tabName, element) {
            // Êõ¥Êñ∞Â∞éËà™
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Êõ¥Êñ∞ÂÖßÂÆπ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // ËºâÂÖ•Â∞çÊáâË≥áÊñô
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'properties') {
                // Â¶ÇÊûúÂàáÊèõÂà∞Áâ©‰ª∂ÁÆ°ÁêÜÊ®ôÁ±§ÔºåËºâÂÖ•ÂàóË°®ÔºàÂ¶ÇÊûúÂàóË°®Â≠êÊ®ôÁ±§ÊòØÊ¥ªÂãïÁöÑÔºâ
                if (document.getElementById('property-list-subtab').classList.contains('active')) {
                    loadProperties();
                } else {
                    loadPropertyAddForm();
                }
            } else if (tabName === 'duplicates') {
                // ÈáçË§áÁâ©‰ª∂Ê™¢Ê∏¨È†ÅÈù¢Â∑≤ËºâÂÖ•ÔºåÁ≠âÂæÖÁî®Êà∂ÈªûÊìäÊ™¢Ê∏¨
            } else if (tabName === 'links') {
                // ËºâÂÖ•ÈÄ£ÁµêÂàóË°®Ôºà‰ΩøÁî®Ê®°ÁµÑÂåñÂáΩÊï∏Ôºâ
                console.log('üîÑ ÂàáÊèõÂà∞ÈÄ£ÁµêÁÆ°ÁêÜÊ®ôÁ±§ÔºåÈñãÂßãËºâÂÖ•ÈÄ£Áµê...');
                console.log('üìã RelatedLinksBackend ÁãÄÊÖã:', typeof RelatedLinksBackend);
                if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.loadRelatedLinks) {
                    console.log('‚úÖ ‰ΩøÁî®Ê®°ÁµÑÂåñÁâàÊú¨ËºâÂÖ•ÈÄ£Áµê');
                    RelatedLinksBackend.loadRelatedLinks();
                } else {
                    console.warn('‚ö†Ô∏è Ê®°ÁµÑÊú™ËºâÂÖ•Ôºå‰ΩøÁî®ËàäÁâàÊú¨ÂáΩÊï∏');
                    if (typeof loadRelatedLinks === 'function') {
                        loadRelatedLinks(); // ÂÇôÁî®Ôºö‰ΩøÁî®ËàäÂáΩÊï∏
                    } else {
                        console.error('‚ùå Êâæ‰∏çÂà∞ loadRelatedLinks ÂáΩÊï∏');
                    }
                }
            }
        }
        
        // ÂàáÊèõÁâ©‰ª∂ÁÆ°ÁêÜÁöÑÂ≠êÊ®ôÁ±§
        function switchPropertySubTab(subTabName, element) {
            // Êõ¥Êñ∞Â≠êÊ®ôÁ±§ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            // Êõ¥Êñ∞Â≠êÊ®ôÁ±§ÂÖßÂÆπ
            document.querySelectorAll('.property-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (subTabName === 'list') {
                document.getElementById('property-list-subtab').classList.add('active');
                loadProperties();
            } else if (subTabName === 'add') {
                document.getElementById('property-add-subtab').classList.add('active');
                loadPropertyAddForm();
            }
        }
        
        // ËºâÂÖ•Êñ∞Â¢ûÁâ©‰ª∂Ë°®ÂñÆ
        function loadPropertyAddForm() {
            const container = document.getElementById('property-add-form-container');
            if (!container) return;
            
            // Â¶ÇÊûúÂ∑≤Á∂ìËºâÂÖ•ÈÅéÔºåÁõ¥Êé•ËøîÂõû
            if (container.dataset.loaded === 'true') {
                return;
            }
            
            // ‰ΩøÁî® iframe ËºâÂÖ• property-admin-db.html ÁöÑÊñ∞Â¢ûË°®ÂñÆÈ†ÅÈù¢
            // ÈÄôÊ®£ÂèØ‰ª•‰øùÊåÅÊâÄÊúâÂäüËÉΩÂÆåÊï¥ÔºåÂåÖÊã¨ÂúñÁâá‰∏äÂÇ≥Á≠â
            container.innerHTML = `
                <iframe 
                    id="property-add-iframe" 
                    src="property-admin-db.html?tab=add" 
                    style="width: 100%; min-height: 800px; border: none; border-radius: 8px;"
                    onload="adjustIframeHeight()">
                </iframe>
            `;
            
            container.dataset.loaded = 'true';
        }
        
        // Ë™øÊï¥ iframe È´òÂ∫¶
        function adjustIframeHeight() {
            const iframe = document.getElementById('property-add-iframe');
            if (iframe && iframe.contentWindow) {
                try {
                    const height = iframe.contentWindow.document.body.scrollHeight;
                    iframe.style.height = Math.max(height, 800) + 'px';
                } catch (e) {
                    // Ë∑®ÂüüÈôêÂà∂Ôºå‰ΩøÁî®Âõ∫ÂÆöÈ´òÂ∫¶
                    iframe.style.height = '1200px';
                }
            }
        }
        
        // ËºâÂÖ•ÂÑÄË°®Êùø
        async function loadDashboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                // Êõ¥Êñ∞Áµ±Ë®à
                updateStats();
                
                // Êõ¥Êñ∞Ê™¢Ë¶ñÊ®°ÂºèÊåâÈàïÁãÄÊÖã
                const tableBtn = document.getElementById('dashboard-view-table-btn');
                const gridBtn = document.getElementById('dashboard-view-grid-btn');
                if (tableBtn && gridBtn) {
                    tableBtn.classList.remove('active');
                    gridBtn.classList.remove('active');
                    if (dashboardViewMode === 'grid') {
                        gridBtn.classList.add('active');
                    } else {
                        tableBtn.classList.add('active');
                    }
                }
                
                // È°ØÁ§∫ÊúÄËøëÁâ©‰ª∂
                const recentDiv = document.getElementById('recent-properties');
                if (data && data.length > 0) {
                    if (dashboardViewMode === 'grid') {
                        // Á∂≤Ê†ºÊ®°Âºè
                        recentDiv.innerHTML = `
                            <div class="property-grid">
                                ${data.map(prop => {
                                    const images = Array.isArray(prop.images) ? prop.images : [];
                                    const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                                    const publishedBadge = prop.is_published 
                                        ? '<span class="badge badge-success">‚úÖ Â∑≤‰∏äÊû∂</span>' 
                                        : '<span class="badge badge-danger">‚ùå Â∑≤‰∏ãÊû∂</span>';
                                    
                                    const isExternal = prop.is_external === true || prop.is_external === 'true';
                                    const sourceBadge = isExternal 
                                        ? '<span class="badge" style="background: #ff9800; color: white; margin-bottom: 0.5rem; display: inline-block;">üè¢ ÈùûÊú¨Â∫ó</span>' 
                                        : '<span class="badge" style="background: #28a745; color: white; margin-bottom: 0.5rem; display: inline-block;">üè† Êú¨Â∫ó</span>';
                                    
                                    const isPublished = prop.is_published;
                                    
                                    // ËΩâÁæ© HTML ‰ª•Èò≤Ê≠¢ XSS
                                    const safeTitle = escapeHtml(prop.title || 'Êú™ÂëΩÂêçÁâ©‰ª∂');
                                    const safeNumber = escapeHtml(prop.number || 'N/A');
                                    const safeType = escapeHtml(prop.type || 'N/A');
                                    const safePrice = escapeHtml(prop.price || 'N/A');
                                    const safeAddress = prop.address ? escapeHtml(prop.address.substring(0, 30)) + (prop.address.length > 30 ? '...' : '') : '';
                                    const safeId = escapeHtml(prop.id);
                                    const safeImgUrl = imgUrl ? escapeHtml(imgUrl) : '';
                                    const safeUpdatedAt = new Date(prop.updated_at).toLocaleString('zh-TW');
                                    
                                    return `
                                        <div class="property-card">
                                            ${safeImgUrl 
                                                ? `<img src="${safeImgUrl}" alt="${safeTitle}" class="property-card-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                                                : ''
                                            }
                                            <div class="property-card-placeholder" ${imgUrl ? 'style="display:none;"' : ''}>
                                                üè†
                                            </div>
                                            <div class="property-card-content">
                                                <h3 class="property-card-title">
                                                    <a href="${getPropertyDetailUrl(prop)}" 
                                                       target="_blank" 
                                                       style="color: #2c3e50; text-decoration: none; cursor: pointer;"
                                                       onmouseover="this.style.color='#667eea'; this.style.textDecoration='underline'"
                                                       onmouseout="this.style.color='#2c3e50'; this.style.textDecoration='none'">
                                                        ${safeTitle}
                                                    </a>
                                                </h3>
                                                <div class="property-card-meta">
                                                    <div><strong>Á∑®ËôüÔºö</strong>${safeNumber}</div>
                                                    <div><strong>ÊàøÂûãÔºö</strong>${safeType}</div>
                                                    <div><strong>ÂÉπÊ†ºÔºö</strong>${safePrice}</div>
                                                    ${safeAddress ? `<div><strong>Âú∞ÂùÄÔºö</strong>${safeAddress}</div>` : ''}
                                                    <div><strong>Êõ¥Êñ∞ÊôÇÈñìÔºö</strong>${safeUpdatedAt}</div>
                                                </div>
                                                <div class="property-card-status" style="margin-bottom: 0.75rem;">
                                                    ${sourceBadge} ${publishedBadge}
                                                </div>
                                                <div class="property-card-actions">
                                                    <button class="btn btn-primary" 
                                                            onclick="openPropertyDetail({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                            style="font-size: 0.85rem;">
                                                        üëÅÔ∏è Êü•Áúã
                                                    </button>
                                                    <button class="btn btn-info" 
                                                            onclick="copyPropertyLink({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                            style="font-size: 0.85rem;">
                                                        üìã Ë§áË£ΩÈÄ£Áµê
                                                    </button>
                                                    <button class="btn btn-info" 
                                                            onclick="downloadQRCode({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                            style="font-size: 0.85rem;"
                                                            title="‰∏ãËºâ QR Code">
                                                        üì± QR Code
                                                    </button>
                                                    <button class="btn ${isPublished ? 'btn-danger' : 'btn-success'}" 
                                                            data-property-id="${safeId}" 
                                                            data-action="toggle" 
                                                            data-status="${!isPublished}"
                                                            style="font-size: 0.85rem;">
                                                        ${isPublished ? '‚¨áÔ∏è ‰∏ãÊû∂' : '‚¨ÜÔ∏è ‰∏äÊû∂'}
                                                    </button>
                                                    <button class="btn btn-secondary" 
                                                            data-property-id="${safeId}" 
                                                            data-action="edit"
                                                            style="font-size: 0.85rem;">
                                                        ‚úèÔ∏è Á∑®ËºØ
                                                    </button>
                                                    <button class="btn btn-danger" 
                                                            data-property-id="${safeId}" 
                                                            data-action="delete"
                                                            style="font-size: 0.85rem;"
                                                            title="Âà™Èô§">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        // Ë°®Ê†ºÊ®°Âºè
                        recentDiv.innerHTML = `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Áâ©‰ª∂</th>
                                        <th>ÊàøÂûã</th>
                                        <th>ÂÉπÊ†º</th>
                                        <th>ÁãÄÊÖã</th>
                                        <th>Êõ¥Êñ∞ÊôÇÈñì</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(prop => {
                                        const images = Array.isArray(prop.images) ? prop.images : [];
                                        const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                                        const publishedBadge = prop.is_published 
                                            ? '<span class="badge badge-success">Â∑≤‰∏äÊû∂</span>' 
                                            : '<span class="badge badge-danger">Â∑≤‰∏ãÊû∂</span>';
                                        
                                        return `
                                            <tr>
                                                <td>
                                                    <div class="property-preview">
                                                        ${imgUrl ? `<img src="${imgUrl}" alt="${prop.title}">` : '<div style="width:80px;height:60px;background:#f0f0f0;border-radius:6px;"></div>'}
                                                        <div class="property-preview-info">
                                                            <h4>
                                                                <a href="${getPropertyDetailUrl(prop)}" 
                                                                   target="_blank" 
                                                                   style="color: #667eea; text-decoration: none; cursor: pointer;"
                                                                   onmouseover="this.style.textDecoration='underline'"
                                                                   onmouseout="this.style.textDecoration='none'">
                                                                    ${prop.title || 'Êú™ÂëΩÂêç'}
                                                                </a>
                                                            </h4>
                                                            <p>${prop.number || 'N/A'}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${prop.type || 'N/A'}</td>
                                                <td>${prop.price || 'N/A'}</td>
                                                <td>${publishedBadge}</td>
                                                <td>${new Date(prop.updated_at).toLocaleString('zh-TW')}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                } else {
                    recentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">ÁõÆÂâçÊ≤íÊúâÁâ©‰ª∂</p>';
                }
            } catch (error) {
                console.error('ËºâÂÖ•ÂÑÄË°®ÊùøÂ§±Êïó:', error);
                document.getElementById('recent-properties').innerHTML = 
                    `<div class="alert alert-error">ËºâÂÖ•Â§±ÊïóÔºö${error.message}</div>`;
            }
        }
        
        // Êõ¥Êñ∞Áµ±Ë®à
        async function updateStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('is_published, status, is_external');
                
                if (error) throw error;
                
                const total = data.length;
                const published = data.filter(p => p.is_published).length;
                const unpublished = data.filter(p => !p.is_published).length;
                const sold = data.filter(p => p.status === 'sold').length;
                const internal = data.filter(p => !p.is_external || p.is_external === false).length;
                const external = data.filter(p => p.is_external === true || p.is_external === 'true').length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-published').textContent = published;
                document.getElementById('stat-unpublished').textContent = unpublished;
                document.getElementById('stat-sold').textContent = sold;
                
                // Ë®òÈåÑÁµ±Ë®àË≥áË®äÔºàÁî®ÊñºÈô§ÈåØÔºâ
                console.log('üìä Áâ©‰ª∂Áµ±Ë®à:', {
                    total,
                    published,
                    unpublished,
                    sold,
                    internal,
                    external
                });
            } catch (error) {
                console.error('Êõ¥Êñ∞Áµ±Ë®àÂ§±Êïó:', error);
            }
        }
        
        // ËºâÂÖ•Áâ©‰ª∂ÂàóË°®
        async function loadProperties() {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allProperties = data || [];
                // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆÁöÑÂÄº
                const select = document.getElementById('status-filter-select');
                if (select) {
                    select.value = currentFilter || 'all';
                }
                renderProperties();
            } catch (error) {
                console.error('ËºâÂÖ•Áâ©‰ª∂Â§±Êïó:', error);
                document.getElementById('properties-list').innerHTML = 
                    `<div class="alert alert-error">ËºâÂÖ•Â§±ÊïóÔºö${error.message}</div>`;
            }
        }
        
        // Ê∏≤ÊüìÁâ©‰ª∂ÂàóË°®
        function renderProperties() {
            let filtered = allProperties;
            
            // ÊáâÁî®ÁØ©ÈÅ∏
            if (currentFilter === 'published') {
                filtered = filtered.filter(p => p.is_published);
            } else if (currentFilter === 'unpublished') {
                filtered = filtered.filter(p => !p.is_published);
            } else if (currentFilter === 'sold') {
                filtered = filtered.filter(p => p.status === 'sold');
            } else if (currentFilter === 'internal') {
                // ÁØ©ÈÅ∏Êú¨Â∫óÁâ©‰ª∂
                filtered = filtered.filter(p => !p.is_external || p.is_external === false);
            } else if (currentFilter === 'external') {
                // ÁØ©ÈÅ∏ÈùûÊú¨Â∫óÁâ©‰ª∂
                filtered = filtered.filter(p => p.is_external === true || p.is_external === 'true');
            }
            
            // ÊáâÁî®ÊêúÂ∞ã
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    (p.title && p.title.toLowerCase().includes(searchTerm)) ||
                    (p.number && p.number.toLowerCase().includes(searchTerm)) ||
                    (p.address && p.address.toLowerCase().includes(searchTerm))
                );
            }
            
            if (typeFilter) {
                filtered = filtered.filter(p => p.type === typeFilter);
            }
            
            // ÊéíÂ∫èÔºöÂÑ™ÂÖàÈ°ØÁ§∫Â∑≤‰∏äÊû∂ÁöÑÁâ©‰ª∂ÔºåÁÑ∂ÂæåÊòØÂ∑≤‰∏ãÊû∂ÁöÑÁâ©‰ª∂
            // Âú®Áõ∏ÂêåÁãÄÊÖãÂÖßÔºåÊåâÊõ¥Êñ∞ÊôÇÈñìÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            filtered.sort((a, b) => {
                // ÂÖàÊåâ‰∏äÊû∂ÁãÄÊÖãÊéíÂ∫èÔºöÂ∑≤‰∏äÊû∂ÔºàtrueÔºâÂú®ÂâçÔºåÂ∑≤‰∏ãÊû∂ÔºàfalseÔºâÂú®Âæå
                if (a.is_published !== b.is_published) {
                    // Â¶ÇÊûú a Â∑≤‰∏äÊû∂‰∏î b Â∑≤‰∏ãÊû∂Ôºåa ÊéíÂâçÈù¢ÔºàËøîÂõûË≤†Êï∏Ôºâ
                    // Â¶ÇÊûú a Â∑≤‰∏ãÊû∂‰∏î b Â∑≤‰∏äÊû∂Ôºåa ÊéíÂæåÈù¢ÔºàËøîÂõûÊ≠£Êï∏Ôºâ
                    return (b.is_published ? 1 : 0) - (a.is_published ? 1 : 0);
                }
                
                // Áõ∏ÂêåÁãÄÊÖãÂÖßÔºåÊåâÊõ¥Êñ∞ÊôÇÈñìÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
                const dateA = a.updated_at ? new Date(a.updated_at) : new Date(a.created_at || 0);
                const dateB = b.updated_at ? new Date(b.updated_at) : new Date(b.created_at || 0);
                return dateB - dateA;
            });
            
            const listDiv = document.getElementById('properties-list');
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Ê≤íÊúâÊâæÂà∞Áâ©‰ª∂</p>';
                return;
            }
            
            // Ê†πÊìöË¶ñÂúñÊ®°ÂºèÈ°ØÁ§∫
            if (viewMode === 'grid') {
                // Á∂≤Ê†ºÊ®°Âºè
                listDiv.innerHTML = `
                    <div class="property-grid">
                        ${filtered.map(prop => {
                            const images = Array.isArray(prop.images) ? prop.images : [];
                            const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                            const publishedBadge = prop.is_published 
                                ? '<span class="badge badge-success">‚úÖ Â∑≤‰∏äÊû∂</span>' 
                                : '<span class="badge badge-danger">‚ùå Â∑≤‰∏ãÊû∂</span>';
                            
                            const isExternal = prop.is_external === true || prop.is_external === 'true';
                            const sourceBadge = isExternal 
                                ? '<span class="badge" style="background: #ff9800; color: white; margin-bottom: 0.5rem; display: inline-block;">üè¢ ÈùûÊú¨Â∫ó</span>' 
                                : '<span class="badge" style="background: #28a745; color: white; margin-bottom: 0.5rem; display: inline-block;">üè† Êú¨Â∫ó</span>';
                            
                            const isPublished = prop.is_published;
                            
                            // ËΩâÁæ© HTML ‰ª•Èò≤Ê≠¢ XSS
                            const safeTitle = escapeHtml(prop.title || 'Êú™ÂëΩÂêçÁâ©‰ª∂');
                            const safeNumber = escapeHtml(prop.number || 'N/A');
                            const safeType = escapeHtml(prop.type || 'N/A');
                            const safePrice = escapeHtml(prop.price || 'N/A');
                            const safeAddress = prop.address ? escapeHtml(prop.address.substring(0, 30)) + (prop.address.length > 30 ? '...' : '') : '';
                            const safeId = escapeHtml(prop.id);
                            const safeImgUrl = imgUrl ? escapeHtml(imgUrl) : '';
                            
                            return `
                                <div class="property-card">
                                    ${safeImgUrl 
                                        ? `<img src="${safeImgUrl}" alt="${safeTitle}" class="property-card-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                                        : ''
                                    }
                                    <div class="property-card-placeholder" ${imgUrl ? 'style="display:none;"' : ''}>
                                        üè†
                                    </div>
                                    <div class="property-card-content">
                                        <h3 class="property-card-title">
                                            <a href="${getPropertyDetailUrl(prop)}" 
                                               target="_blank" 
                                               style="color: #2c3e50; text-decoration: none; cursor: pointer;"
                                               onmouseover="this.style.color='#667eea'; this.style.textDecoration='underline'"
                                               onmouseout="this.style.color='#2c3e50'; this.style.textDecoration='none'">
                                                ${safeTitle}
                                            </a>
                                        </h3>
                                        <div class="property-card-meta">
                                            <div><strong>Á∑®ËôüÔºö</strong>${safeNumber}</div>
                                            <div><strong>ÊàøÂûãÔºö</strong>${safeType}</div>
                                            <div><strong>ÂÉπÊ†ºÔºö</strong>${safePrice}</div>
                                            ${safeAddress ? `<div><strong>Âú∞ÂùÄÔºö</strong>${safeAddress}</div>` : ''}
                                        </div>
                                        <div class="property-card-status" style="margin-bottom: 0.75rem;">
                                            ${sourceBadge} ${publishedBadge}
                                        </div>
                                        <div class="property-card-actions">
                                            <button class="btn btn-primary" 
                                                    onclick="openPropertyDetail({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                    style="font-size: 0.85rem;">
                                                üëÅÔ∏è Êü•Áúã
                                            </button>
                                            <button class="btn btn-info" 
                                                    onclick="copyPropertyLink({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                    style="font-size: 0.85rem;">
                                                üìã Ë§áË£ΩÈÄ£Áµê
                                            </button>
                                            <button class="btn btn-info" 
                                                    onclick="downloadQRCode({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                    style="font-size: 0.85rem;"
                                                    title="‰∏ãËºâ QR Code">
                                                üì± QR Code
                                            </button>
                                            <button class="btn ${isPublished ? 'btn-danger' : 'btn-success'}" 
                                                    data-property-id="${safeId}" 
                                                    data-action="toggle" 
                                                    data-status="${!isPublished}"
                                                    style="font-size: 0.85rem;">
                                                ${isPublished ? '‚¨áÔ∏è ‰∏ãÊû∂' : '‚¨ÜÔ∏è ‰∏äÊû∂'}
                                            </button>
                                            <button class="btn btn-secondary" 
                                                    data-property-id="${safeId}" 
                                                    data-action="edit"
                                                    style="font-size: 0.85rem;">
                                                ‚úèÔ∏è Á∑®ËºØ
                                            </button>
                                            <button class="btn btn-danger" 
                                                    data-property-id="${safeId}" 
                                                    data-action="delete"
                                                    style="font-size: 0.85rem;"
                                                    title="Âà™Èô§">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // Ë°®Ê†ºÊ®°ÂºèÔºàÊâãÊ©ü‰∏äËá™ÂãïÊîπÁÇ∫Âç°ÁâáÂºèÔºâ
                if (isMobileDevice()) {
                    // ÊâãÊ©üÁâàÔºö‰ΩøÁî®Âç°ÁâáÂºèÈ°ØÁ§∫
                    listDiv.innerHTML = `
                        <div class="properties-grid-view">
                            ${filtered.map(prop => {
                                const images = Array.isArray(prop.images) ? prop.images : [];
                                const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                                const publishedBadge = prop.is_published 
                                    ? '<span class="badge badge-success">‚úÖ Â∑≤‰∏äÊû∂</span>' 
                                    : '<span class="badge badge-danger">‚ùå Â∑≤‰∏ãÊû∂</span>';
                                
                                const isExternal = prop.is_external === true || prop.is_external === 'true';
                                const sourceBadge = isExternal 
                                    ? '<span class="badge" style="background: #ff9800; color: white;">üè¢ ÈùûÊú¨Â∫ó</span>' 
                                    : '<span class="badge" style="background: #28a745; color: white;">üè† Êú¨Â∫ó</span>';
                                
                                const safeTitle = escapeHtml(prop.title || 'Êú™ÂëΩÂêçÁâ©‰ª∂');
                                const safeNumber = escapeHtml(prop.number || 'N/A');
                                const safeType = escapeHtml(prop.type || 'N/A');
                                const safePrice = escapeHtml(prop.price || 'N/A');
                                const safeAddress = escapeHtml(prop.address || 'N/A');
                                const safeId = escapeHtml(prop.id);
                                const safeImgUrl = imgUrl ? escapeHtml(imgUrl) : '';
                                const isPublished = prop.is_published;
                                
                                return `
                                    <div class="property-card-mobile">
                                        <div class="property-card-mobile-header">
                                            ${safeImgUrl 
                                                ? `<img src="${safeImgUrl}" alt="${safeTitle}" class="property-card-mobile-image" onerror="this.style.display='none';">`
                                                : '<div class="property-card-mobile-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üè†</div>'
                                            }
                                            <div class="property-card-mobile-info">
                                                <div class="property-card-mobile-title">${safeTitle}</div>
                                                <div class="property-card-mobile-number">${safeNumber}</div>
                                            </div>
                                            <div class="property-card-mobile-details-compact">
                                                <div class="property-card-mobile-detail-compact-item">
                                                    <span class="property-card-mobile-detail-compact-label">‰æÜÊ∫ê</span>
                                                    <span class="property-card-mobile-detail-compact-value">${sourceBadge}</span>
                                                </div>
                                                <div class="property-card-mobile-detail-compact-item">
                                                    <span class="property-card-mobile-detail-compact-label">ÊàøÂûã</span>
                                                    <span class="property-card-mobile-detail-compact-value">${safeType}</span>
                                                </div>
                                                <div class="property-card-mobile-detail-compact-item">
                                                    <span class="property-card-mobile-detail-compact-label">ÂÉπÊ†º</span>
                                                    <span class="property-card-mobile-detail-compact-value">${safePrice}</span>
                                                </div>
                                                <div class="property-card-mobile-detail-compact-item">
                                                    <span class="property-card-mobile-detail-compact-label">ÁãÄÊÖã</span>
                                                    <span class="property-card-mobile-detail-compact-value">${publishedBadge}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="property-card-mobile-actions">
                                            <button class="btn btn-primary btn-small" onclick="openPropertyDetail({id: '${safeId}', number: '${safeNumber || ''}'})">üëÅÔ∏è Êü•Áúã</button>
                                            <button class="btn btn-info btn-small" onclick="copyPropertyLink({id: '${safeId}', number: '${safeNumber || ''}'})">üìã ÈÄ£Áµê</button>
                                            <button class="btn btn-info btn-small" onclick="downloadQRCode({id: '${safeId}', number: '${safeNumber || ''}'})">üì± QR</button>
                                            <button class="btn ${isPublished ? 'btn-danger' : 'btn-success'} btn-small" data-property-id="${safeId}" data-action="toggle" data-status="${!isPublished}">${isPublished ? '‚¨áÔ∏è ‰∏ãÊû∂' : '‚¨ÜÔ∏è ‰∏äÊû∂'}</button>
                                            <button class="btn btn-secondary btn-small" data-property-id="${safeId}" data-action="edit">‚úèÔ∏è Á∑®ËºØ</button>
                                            <button class="btn btn-danger btn-small" data-property-id="${safeId}" data-action="delete" title="Âà™Èô§">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    // Ê°åÈù¢ÁâàÔºö‰ΩøÁî®Ë°®Ê†ºÈ°ØÁ§∫ÔºàÂèØÊ©´ÂêëÊªæÂãïÔºâ
                    listDiv.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Áâ©‰ª∂</th>
                                        <th>‰æÜÊ∫ê</th>
                                        <th>ÊàøÂûã</th>
                                        <th>ÂÉπÊ†º</th>
                                        <th>‰∏äÊû∂ÁãÄÊÖã</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody>
                            ${filtered.map(prop => {
                                const images = Array.isArray(prop.images) ? prop.images : [];
                                const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                                const publishedBadge = prop.is_published 
                                    ? '<span class="badge badge-success">Â∑≤‰∏äÊû∂</span>' 
                                    : '<span class="badge badge-danger">Â∑≤‰∏ãÊû∂</span>';
                                
                                // Áâ©‰ª∂‰æÜÊ∫êÊ®ôÁ±§
                                const isExternal = prop.is_external === true || prop.is_external === 'true';
                                const sourceBadge = isExternal 
                                    ? '<span class="badge" style="background: #ff9800; color: white;">üè¢ ÈùûÊú¨Â∫ó</span>' 
                                    : '<span class="badge" style="background: #28a745; color: white;">üè† Êú¨Â∫ó</span>';
                                
                                // ËΩâÁæ© HTML ‰ª•Èò≤Ê≠¢ XSS
                                const safeTitle = escapeHtml(prop.title || 'Êú™ÂëΩÂêç');
                                const safeNumber = escapeHtml(prop.number || 'N/A');
                                const safeAddress = escapeHtml(prop.address || 'N/A');
                                const safeType = escapeHtml(prop.type || 'N/A');
                                const safePrice = escapeHtml(prop.price || 'N/A');
                                const safeId = escapeHtml(prop.id);
                                const safeImgUrl = imgUrl ? escapeHtml(imgUrl) : '';
                                const isPublished = prop.is_published;
                                
                                return `
                                    <tr>
                                        <td>
                                            <div class="property-preview">
                                                ${safeImgUrl ? `<img src="${safeImgUrl}" alt="${safeTitle}">` : '<div style="width:80px;height:60px;background:#f0f0f0;border-radius:6px;"></div>'}
                                                <div class="property-preview-info">
                                                    <h4>
                                                        <a href="${getPropertyDetailUrl(prop)}" 
                                                           target="_blank" 
                                                           style="color: #667eea; text-decoration: none; cursor: pointer;"
                                                           onmouseover="this.style.textDecoration='underline'"
                                                           onmouseout="this.style.textDecoration='none'">
                                                            ${safeTitle}
                                                        </a>
                                                    </h4>
                                                    <p>${safeNumber} | ${safeAddress}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${sourceBadge}</td>
                                        <td>${safeType}</td>
                                        <td>${safePrice}</td>
                                        <td>${publishedBadge}</td>
                                        <td>
                                            <button class="btn btn-primary btn-small" 
                                                    onclick="openPropertyDetail({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                    title="Âú®Êñ∞ÂàÜÈ†ÅÈñãÂïüÁâ©‰ª∂Áç®Á´ãÁ∂≤È†Å">
                                                üëÅÔ∏è Êü•Áúã
                                            </button>
                                            <button class="btn btn-info btn-small" 
                                                    onclick="copyPropertyLink({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                    title="Ë§áË£ΩÁâ©‰ª∂Áç®Á´ãÁ∂≤È†ÅÈÄ£Áµê">
                                                üìã Ë§áË£ΩÈÄ£Áµê
                                            </button>
                                            <button class="btn btn-info btn-small" 
                                                    onclick="downloadQRCode({id: '${safeId}', number: '${safeNumber || ''}'})"
                                                    title="‰∏ãËºâ QR Code">
                                                üì± QR Code
                                            </button>
                                            <button class="btn btn-small ${isPublished ? 'btn-danger' : 'btn-success'}" 
                                                    data-property-id="${safeId}" 
                                                    data-action="toggle" 
                                                    data-status="${!isPublished}">
                                                ${isPublished ? '‚¨áÔ∏è ‰∏ãÊû∂' : '‚¨ÜÔ∏è ‰∏äÊû∂'}
                                            </button>
                                            <button class="btn btn-secondary btn-small" 
                                                    data-property-id="${safeId}" 
                                                    data-action="edit">
                                                ‚úèÔ∏è Á∑®ËºØ
                                            </button>
                                            <button class="btn btn-danger btn-small" 
                                                    data-property-id="${safeId}" 
                                                    data-action="delete"
                                                    title="Âà™Èô§">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
        }
        
        // Ë®≠ÂÆöÁØ©ÈÅ∏Ôºà‰øùÁïôËàäÂáΩÊï∏‰ª•ÂÖºÂÆπÂÖ∂‰ªñÂú∞ÊñπÂèØËÉΩÁöÑË™øÁî®Ôºâ
        function setFilter(filter, element) {
            currentFilter = filter;
            // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆ
            const select = document.getElementById('status-filter-select');
            if (select) {
                select.value = filter;
            }
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖãÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if (element) {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                element.classList.add('active');
            }
            renderProperties();
        }
        
        // Âæû‰∏ãÊãâÈÅ∏ÂñÆË®≠ÂÆöÁØ©ÈÅ∏
        function setFilterFromSelect(filter) {
            currentFilter = filter;
            renderProperties();
        }
        
        // ÂàáÊèõÊâãÊ©üÈÅ∏ÂñÆÔºàÂÉÖÊâãÊ©üÁâàÔºöÊäΩÂ±úËàá body ÈéñÂÆöÔºõÊ°åÈù¢ÁâàÈªûÊìä nav ‰∏çÊáâÈéñ‰ΩèÊï¥È†ÅÊªæÂãïÔºâ
        function toggleMobileMenu() {
            if (!isMobileDevice()) return;
            const nav = document.getElementById('main-nav');
            const overlay = document.querySelector('.nav-overlay');
            
            if (nav && overlay) {
                nav.classList.toggle('active');
                overlay.classList.toggle('active');
                
                // Èò≤Ê≠¢ËÉåÊôØÊªæÂãï
                if (nav.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }
        
        // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫ÊâãÊ©üË£ùÁΩÆ
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }
        
        // Ë®≠ÂÆöË¶ñÂúñÊ®°Âºè
        function setViewMode(mode, element) {
            viewMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            const tableBtn = document.getElementById('view-table-btn');
            const gridBtn = document.getElementById('view-grid-btn');
            if (tableBtn) tableBtn.classList.remove('active');
            if (gridBtn) gridBtn.classList.remove('active');
            if (element) element.classList.add('active');
            
            // ÈáçÊñ∞Ê∏≤Êüì
            renderProperties();
        }
        
        // Ë®≠ÂÆöÂÑÄË°®ÊùøÊ™¢Ë¶ñÊ®°Âºè
        function setDashboardViewMode(mode, element) {
            dashboardViewMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            const tableBtn = document.getElementById('dashboard-view-table-btn');
            const gridBtn = document.getElementById('dashboard-view-grid-btn');
            if (tableBtn) tableBtn.classList.remove('active');
            if (gridBtn) gridBtn.classList.remove('active');
            if (element) element.classList.add('active');
            
            // ÈáçÊñ∞ËºâÂÖ•ÂÑÄË°®Êùø
            loadDashboard();
        }
        
        // ÊêúÂ∞ãÂíåÁØ©ÈÅ∏
        function filterProperties() {
            renderProperties();
        }
        
        // ÂàáÊèõ‰∏äÊû∂ÁãÄÊÖãÔºàÂÑ™ÂåñÁâàÔºöÊ∏õÂ∞ëÂª∂ÈÅ≤Ôºâ
        async function togglePublish(id, newStatus) {
            try {
                // ÂÖàÊõ¥Êñ∞Êú¨Âú∞Ë≥áÊñôÔºàÁ´ãÂç≥ÂèçÈ•ãÔºâ
                const prop = allProperties.find(p => p.id === id);
                if (prop) {
                    prop.is_published = newStatus;
                }
                
                // Á´ãÂç≥Êõ¥Êñ∞ UIÔºàÊ®ÇËßÄÊõ¥Êñ∞Ôºâ
                renderProperties();
                updateStats();
                
                // Áï∞Ê≠•Êõ¥Êñ∞Ë≥áÊñôÂ∫´
                const { error } = await supabaseClient
                    .from('properties')
                    .update({ is_published: newStatus })
                    .eq('id', id);
                
                if (error) {
                    // Â¶ÇÊûúÂ§±ÊïóÔºåÊÅ¢Âæ©ÂéüÁãÄÊÖã
                    if (prop) {
                        prop.is_published = !newStatus;
                    }
                    renderProperties();
                    updateStats();
                    throw error;
                }
                
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                showAlert('success', newStatus ? 'Áâ©‰ª∂Â∑≤‰∏äÊû∂ÔºÅ' : 'Áâ©‰ª∂Â∑≤‰∏ãÊû∂ÔºÅ');
            } catch (error) {
                console.error('ÂàáÊèõÁãÄÊÖãÂ§±Êïó:', error);
                showAlert('error', `Êìç‰ΩúÂ§±ÊïóÔºö${error.message}`);
            }
        }
        
        
        // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Á∑®ËºØÁâ©‰ª∂
        function editProperty(id) {
            // ÂàáÊèõÂà∞Áâ©‰ª∂ÁÆ°ÁêÜÊ®ôÁ±§ÁöÑÊñ∞Â¢ûÂ≠êÊ®ôÁ±§Ôºå‰∏¶ËºâÂÖ•Á∑®ËºØË°®ÂñÆ
            const propertiesTab = document.querySelector('.nav-item[onclick*="properties"]');
            if (propertiesTab) {
                switchTab('properties', propertiesTab);
                
                // ÂàáÊèõÂà∞Êñ∞Â¢ûÂ≠êÊ®ôÁ±§
                setTimeout(() => {
                    const addSubTab = document.getElementById('property-add-tab');
                    if (addSubTab) {
                        switchPropertySubTab('add', addSubTab);
                        
                        // ËºâÂÖ•Á∑®ËºØË°®ÂñÆÔºàÈÄöÈÅé iframeÔºâ
                        setTimeout(() => {
                            const iframe = document.getElementById('property-add-iframe');
                            if (iframe) {
                                iframe.src = `property-admin-db.html?tab=add&id=${id}`;
                            } else {
                                // Â¶ÇÊûú iframe ÈÇÑÊ≤íËºâÂÖ•ÔºåÈáçÊñ∞ËºâÂÖ•Ë°®ÂñÆ
                                loadPropertyAddForm();
                                setTimeout(() => {
                                    const newIframe = document.getElementById('property-add-iframe');
                                    if (newIframe) {
                                        newIframe.src = `property-admin-db.html?tab=add&id=${id}`;
                                    }
                                }, 500);
                            }
                        }, 300);
                    }
                }, 100);
            }
        }
        
        // È°ØÁ§∫Á¢∫Ë™çÂΩàË∑≥Ë¶ñÁ™ó
        function showConfirmModal(options) {
            return new Promise((resolve) => {
                const {
                    title = 'Á¢∫Ë™çÊìç‰Ωú',
                    message = 'Á¢∫ÂÆöË¶ÅÂü∑Ë°åÊ≠§Êìç‰ΩúÂóéÔºü',
                    icon = 'warning',
                    confirmText = 'Á¢∫ÂÆö',
                    cancelText = 'ÂèñÊ∂à',
                    confirmClass = 'modal-btn-danger'
                } = options;
                
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const iconEmoji = icon === 'danger' ? '‚ö†Ô∏è' : '‚ùì';
                const iconClass = icon === 'danger' ? 'danger' : 'warning';
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-icon ${iconClass}">${iconEmoji}</div>
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn modal-btn-cancel" onclick="this.closest('.modal-overlay').remove(); arguments[0].stopPropagation();">${cancelText}</button>
                            <button class="modal-btn ${confirmClass}" onclick="this.closest('.modal-overlay').remove(); arguments[0].stopPropagation();">${confirmText}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // ËôïÁêÜÁ¢∫Ë™çÊåâÈàï
                const confirmBtn = overlay.querySelector(`.${confirmClass}`);
                confirmBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                // ËôïÁêÜÂèñÊ∂àÊåâÈàï
                const cancelBtn = overlay.querySelector('.modal-btn-cancel');
                cancelBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                // ËôïÁêÜ ESC Èçµ
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // ÈªûÊìäËÉåÊôØÈóúÈñâ
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                });
            });
        }
        
        // Âà™Èô§Áâ©‰ª∂
        async function deleteProperty(id) {
            // ÂÖàÂèñÂæóÁâ©‰ª∂Ë≥áË®ä‰ª•È°ØÁ§∫Âú®Á¢∫Ë™çË¶ñÁ™ó‰∏≠
            let propertyInfo = '';
            try {
                const { data: prop } = await supabaseClient
                    .from('properties')
                    .select('title, number')
                    .eq('id', id)
                    .single();
                
                if (prop) {
                    propertyInfo = `<strong>${prop.title || prop.number || 'Ê≠§Áâ©‰ª∂'}</strong>`;
                }
            } catch (e) {
                // ÂøΩÁï•ÈåØË™§ÔºåÁπºÁ∫åÈ°ØÁ§∫Á¢∫Ë™çË¶ñÁ™ó
            }
            
            const confirmed = await showConfirmModal({
                title: 'Âà™Èô§Áâ©‰ª∂',
                message: `Á¢∫ÂÆöË¶ÅÂà™Èô§ ${propertyInfo || 'Ê≠§Áâ©‰ª∂'} ÂóéÔºü<br><br>Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºåË´ãË¨πÊÖéÊìç‰Ωú„ÄÇ`,
                icon: 'danger',
                confirmText: 'üóëÔ∏è Âà™Èô§',
                cancelText: 'ÂèñÊ∂à'
            });
            
            if (!confirmed) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showAlert('success', 'Áâ©‰ª∂Â∑≤Âà™Èô§ÔºÅ');
                
                // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®
                loadProperties();
                loadDashboard();
                updateStats();
            } catch (error) {
                console.error('Âà™Èô§Â§±Êïó:', error);
                showAlert('error', `Âà™Èô§Â§±ÊïóÔºö${error.message}`);
            }
        }
        
        // Ê™¢Êü•ÈáçË§áÁâ©‰ª∂
        let duplicateGroups = [];
        
        async function checkDuplicates() {
            try {
                showAlert('info', 'Ê≠£Âú®Ê™¢Ê∏¨ÈáçË§áÁâ©‰ª∂...');
                
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Ê†πÊìö number Ê¨Ñ‰ΩçÂàÜÁµÑ
                const numberGroups = {};
                data.forEach(prop => {
                    const number = prop.number;
                    if (!number) return;
                    
                    if (!numberGroups[number]) {
                        numberGroups[number] = [];
                    }
                    numberGroups[number].push(prop);
                });
                
                // ÊâæÂá∫ÈáçË§áÁöÑÁâ©‰ª∂
                duplicateGroups = Object.values(numberGroups).filter(group => group.length > 1);
                
                const resultDiv = document.getElementById('duplicates-result');
                const cleanBtn = document.getElementById('clean-btn');
                
                if (duplicateGroups.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Ê≤íÊúâÁôºÁèæÈáçË§áÁâ©‰ª∂ÔºÅÊâÄÊúâÁâ©‰ª∂Á∑®ËôüÈÉΩÊòØÂîØ‰∏ÄÁöÑ„ÄÇ
                        </div>
                    `;
                    cleanBtn.style.display = 'none';
                } else {
                    let totalDuplicates = 0;
                    duplicateGroups.forEach(group => {
                        totalDuplicates += group.length - 1; // Ê∏õÂéª‰øùÁïôÁöÑ‰∏ÄÂÄã
                    });
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è ÁôºÁèæ ${duplicateGroups.length} ÁµÑÈáçË§áÁâ©‰ª∂ÔºåÂÖ± ${totalDuplicates} ÂÄãÈáçË§áÈ†ÖÁõÆÈúÄË¶ÅÊ∏ÖÁêÜ„ÄÇ
                        </div>
                        <table class="table" style="margin-top: 1rem;">
                            <thead>
                                <tr>
                                    <th>Áâ©‰ª∂Á∑®Ëôü</th>
                                    <th>ÈáçË§áÊï∏Èáè</th>
                                    <th>Áâ©‰ª∂ÂàóË°®</th>
                                    <th>Â∞á‰øùÁïô</th>
                                    <th>Â∞áÂà™Èô§</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${duplicateGroups.map(group => {
                                    // ÊåâÂª∫Á´ãÊôÇÈñìÊéíÂ∫èÔºåÊúÄÊñ∞ÁöÑÂú®Ââç
                                    group.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                                    const keep = group[0]; // ‰øùÁïôÊúÄÊñ∞ÁöÑ
                                    const toDelete = group.slice(1); // Âà™Èô§ÂÖ∂‰ªñÁöÑ
                                    
                                    return `
                                        <tr>
                                            <td><strong>${keep.number}</strong></td>
                                            <td><span class="badge badge-warning">${group.length} ÂÄã</span></td>
                                            <td>
                                                ${group.map(p => `
                                                    <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                                        <strong>${p.title || 'Êú™ÂëΩÂêç'}</strong><br>
                                                        <small>ID: ${p.id.substring(0, 8)}... | Âª∫Á´ã: ${new Date(p.created_at).toLocaleString('zh-TW')}</small>
                                                    </div>
                                                `).join('')}
                                            </td>
                                            <td>
                                                <span class="badge badge-success">‚úÖ ${keep.title || 'Êú™ÂëΩÂêç'}</span><br>
                                                <small>${new Date(keep.created_at).toLocaleString('zh-TW')}</small>
                                            </td>
                                            <td>
                                                ${toDelete.map(p => `
                                                    <div style="margin-bottom: 0.25rem;">
                                                        <span class="badge badge-danger">üóëÔ∏è ${p.title || 'Êú™ÂëΩÂêç'}</span><br>
                                                        <small>${new Date(p.created_at).toLocaleString('zh-TW')}</small>
                                                    </div>
                                                `).join('')}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    cleanBtn.style.display = 'inline-block';
                }
                
                showAlert('success', 'Ê™¢Ê∏¨ÂÆåÊàêÔºÅ');
            } catch (error) {
                console.error('Ê™¢Ê∏¨Â§±Êïó:', error);
                showAlert('error', `Ê™¢Ê∏¨Â§±ÊïóÔºö${error.message}`);
                document.getElementById('duplicates-result').innerHTML = 
                    `<div class="alert alert-error">Ê™¢Ê∏¨Â§±ÊïóÔºö${error.message}</div>`;
            }
        }
        
        // Ê∏ÖÁêÜÈáçË§áÁâ©‰ª∂
        async function cleanDuplicates() {
            if (duplicateGroups.length === 0) {
                showAlert('warning', 'Ê≤íÊúâÈáçË§áÁâ©‰ª∂ÈúÄË¶ÅÊ∏ÖÁêÜ');
                return;
            }
            
            if (!confirm(`Á¢∫ÂÆöË¶ÅÊ∏ÖÁêÜ ${duplicateGroups.length} ÁµÑÈáçË§áÁâ©‰ª∂ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`)) {
                return;
            }
            
            try {
                showAlert('info', 'Ê≠£Âú®Ê∏ÖÁêÜÈáçË§áÁâ©‰ª∂...');
                
                let deletedCount = 0;
                const idsToDelete = [];
                
                // Êî∂ÈõÜÊâÄÊúâË¶ÅÂà™Èô§ÁöÑÁâ©‰ª∂ ID
                duplicateGroups.forEach(group => {
                    // ÊåâÂª∫Á´ãÊôÇÈñìÊéíÂ∫èÔºåÊúÄÊñ∞ÁöÑÂú®Ââç
                    group.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    const toDelete = group.slice(1); // Âà™Èô§Èô§‰∫ÜÊúÄÊñ∞‰πãÂ§ñÁöÑÊâÄÊúâ
                    toDelete.forEach(prop => {
                        idsToDelete.push(prop.id);
                    });
                });
                
                // ÊâπÊ¨°Âà™Èô§
                if (idsToDelete.length > 0) {
                    for (const id of idsToDelete) {
                        const { error } = await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', id);
                        
                        if (error) {
                            console.error(`Âà™Èô§Áâ©‰ª∂ ${id} Â§±Êïó:`, error);
                        } else {
                            deletedCount++;
                        }
                    }
                }
                
                showAlert('success', `ÊàêÂäüÊ∏ÖÁêÜ ${deletedCount} ÂÄãÈáçË§áÁâ©‰ª∂ÔºÅ`);
                
                // ÈáçÊñ∞Ê™¢Ê∏¨
                duplicateGroups = [];
                document.getElementById('clean-btn').style.display = 'none';
                await checkDuplicates();
                
                // Êõ¥Êñ∞ÂÖ∂‰ªñÈ†ÅÈù¢
                loadProperties();
                loadDashboard();
                updateStats();
            } catch (error) {
                console.error('Ê∏ÖÁêÜÂ§±Êïó:', error);
                showAlert('error', `Ê∏ÖÁêÜÂ§±ÊïóÔºö${error.message}`);
            }
        }
        
        // Áõ£ËÅΩ‰æÜËá™ iframe ÁöÑË®äÊÅØÔºàÁâ©‰ª∂ÂÑ≤Â≠òÊàêÂäüÂæåÂàáÊèõÂà∞ÂàóË°®Ôºâ
        window.addEventListener('message', function(event) {
            // Ê™¢Êü•Ë®äÊÅØÈ°ûÂûã
            if (event.data && event.data.type === 'propertySaved' && event.data.action === 'switchToList') {
                console.log('üì• Êî∂Âà∞Áâ©‰ª∂ÂÑ≤Â≠òÊàêÂäüË®äÊÅØÔºåÂàáÊèõÂà∞Áâ©‰ª∂ÂàóË°®');
                
                // ÂàáÊèõÂà∞Áâ©‰ª∂ÁÆ°ÁêÜÊ®ôÁ±§
                const propertiesTab = document.querySelector('.nav-item[onclick*="properties"]');
                if (propertiesTab) {
                    switchTab('properties', propertiesTab);
                    
                    // ÂàáÊèõÂà∞Áâ©‰ª∂ÂàóË°®Â≠êÊ®ôÁ±§
                    setTimeout(() => {
                        const listSubTab = document.getElementById('property-list-tab');
                        if (listSubTab) {
                            switchPropertySubTab('list', listSubTab);
                        }
                    }, 100);
                }
            }
        });
        
        // ==================== Áõ∏ÈóúÈÄ£ÁµêÁÆ°ÁêÜÂäüËÉΩ ====================
        let editingLinkId = null;
        let linkItems = []; // ÂÑ≤Â≠ò‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ
        
        // ËºâÂÖ•Áõ∏ÈóúÈÄ£ÁµêÂàóË°®
        async function loadRelatedLinks() {
            const listContainer = document.getElementById('links-list');
            if (!listContainer) return;
            
            try {
                listContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">ËºâÂÖ•‰∏≠...</p>';
                
                // Á¢∫‰øù Supabase ÂÆ¢Êà∂Á´ØÂ∑≤ÂàùÂßãÂåñ
                const client = initSupabaseClient();
                if (!client) {
                    throw new Error('ÁÑ°Ê≥ïÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´Ø');
                }
                supabaseClient = client;
                
                // ËºâÂÖ•ÈÄ£ÁµêÔºàÂÑ™ÂÖà‰ΩøÁî® Supabase ÂÆ¢Êà∂Á´ØÔºåÂ§±ÊïóÊôÇ‰ΩøÁî® REST APIÔºåÂÜçÂ§±ÊïóÊôÇ‰ΩøÁî®È†êË®≠Ë≥áÊñôÔºâ
                console.log('üîÑ ÈñãÂßãÂæû Supabase ËºâÂÖ•ÈÄ£ÁµêÂàóË°®...');
                let { data: links, error: linksError } = await supabaseClient
                    .from('related_links')
                    .select('*')
                    .order('display_order', { ascending: true });
                
                // Â¶ÇÊûúÈÅáÂà∞‰ªª‰ΩïÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢
                if (linksError) {
                    console.warn('‚ö†Ô∏è Supabase ÂÆ¢Êà∂Á´ØÊü•Ë©¢Â§±ÊïóÔºåÂòóË©¶Áõ¥Êé•Êü•Ë©¢...', linksError);
                    
                    // ÂòóË©¶‰ΩøÁî® fetch API Áõ¥Êé•Êü•Ë©¢
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/related_links?select=*&order=display_order.asc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            }
                        });
                        
                        if (response.ok) {
                            links = await response.json();
                            linksError = null;
                            console.log('‚úÖ ‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢ÊàêÂäüÔºåËºâÂÖ•Âà∞', links.length, 'ÂÄãÈÄ£Áµê');
                        } else {
                            console.warn('‚ö†Ô∏è REST API Êü•Ë©¢Â§±Êïó:', response.status);
                        }
                    } catch (fetchError) {
                        console.warn('‚ö†Ô∏è Áõ¥Êé•Êü•Ë©¢Â§±Êïó:', fetchError);
                    }
                }
                
                // Â¶ÇÊûúÈÇÑÊòØÊ≤íÊúâË≥áÊñôÔºå‰ΩøÁî®È†êË®≠Ë≥áÊñôÔºàÁ¢∫‰øùËá≥Â∞ëËÉΩÁúãÂà∞ÈÄ£ÁµêÂàóË°®Ôºâ
                if (!links || links.length === 0) {
                    console.warn('‚ö†Ô∏è ÁÑ°Ê≥ïÂæû Supabase ËºâÂÖ•ÈÄ£ÁµêÔºå‰ΩøÁî®È†êË®≠Ë≥áÊñô');
                    links = [
                        { id: '09f06dfd-1fba-4911-953c-f9be80363df8', title: 'Êõ¥Â§öÁâ©‰ª∂Ë≥áÊñô', url: 'https://realtor.houseprice.tw/agent/buy/0925666597/', icon: 'üè†', color_gradient: 'linear-gradient(45deg, #2ecc71, #27ae60)', display_order: 1, is_active: true, link_type: 'button' },
                        { id: '79abfd24-22c0-470c-9737-6d9bf6b0f110', title: 'TikTokÁü≠ÂΩ±Èü≥', url: 'https://www.tiktok.com/@aihouse168', icon: 'üéµ', color_gradient: 'linear-gradient(45deg, #000000, #333333)', display_order: 2, is_active: true, link_type: 'button' },
                        { id: '0b7ba83a-66be-4afb-8d73-38fcf86e1b62', title: 'ÊàøÁî¢ÊØîÂÉπË©¶ÁÆó', url: 'https://housepice.pages.dev/%E4%B8%89%E5%90%88%E4%B8%80%E6%88%BF%E5%83%B9%E6%99%AE%E7%89%B9%E7%B5%B2', icon: 'üßÆ', color_gradient: 'linear-gradient(45deg, #ff6b6b, #ee5a24)', display_order: 3, is_active: true, link_type: 'button' },
                        { id: 'ec5964bf-a1f0-48d2-95bf-99e527b96ea0', title: 'È†êÂîÆÂúòË≥ºÂçÄ', url: 'https://salersteam.pages.dev/junyang', icon: 'üè¢', color_gradient: 'linear-gradient(45deg, #9b59b6, #8e44ad)', display_order: 4, is_active: true, link_type: 'button' },
                        { id: '7b7a3dfa-f335-4571-a365-e5b232134257', title: 'Ê•äÊ¢ÖÁîüÊ¥ªÈõÜ', url: 'https://liff.line.me/2008363788-4Ly1Bv0r', icon: 'üì∞', color_gradient: 'linear-gradient(45deg, #f9a825, #ff9800)', display_order: 5, is_active: true, link_type: 'button' },
                        { id: '7654d782-c10a-4abc-af35-32ec3fa0975c', title: 'ÊàøÁî¢Ë≥áË®äÂèÉËÄÉ', url: '#', icon: 'üìä', color_gradient: 'linear-gradient(45deg, #667eea, #764ba2)', display_order: 6, is_active: true, link_type: 'dropdown' }
                    ];
                    linksError = null;
                    console.log('‚úÖ ‰ΩøÁî®È†êË®≠Ë≥áÊñôÔºåÂÖ±', links.length, 'ÂÄãÈÄ£Áµê');
                }
                
                console.log('üìã ÊàêÂäüËºâÂÖ•', links.length, 'ÂÄãÈÄ£Áµê');
                
                if (linksError && (!links || links.length === 0)) {
                    console.error('ËºâÂÖ•ÈÄ£ÁµêÈåØË™§Ë©≥ÊÉÖ:', linksError);
                    // Âç≥‰ΩøÊúâÈåØË™§ÔºåÂ¶ÇÊûúÊúâÂÇôÁî®Ë≥áÊñôÂ∞±ÁπºÁ∫å
                    if (!links || links.length === 0) {
                        throw linksError;
                    }
                }
                
                if (!links || links.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <p style="margin-bottom: 1rem;">ÁõÆÂâçÊ≤íÊúâÁõ∏ÈóúÈÄ£Áµê</p>
                            <button class="btn btn-primary" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.showAddLinkModal) { RelatedLinksBackend.showAddLinkModal(); } else if(typeof showAddLinkModal === 'function') { showAddLinkModal(); } else { alert('ÂäüËÉΩÂ∞öÊú™ËºâÂÖ•ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢'); }">
                                ‚ûï Êñ∞Â¢ûÁ¨¨‰∏ÄÂÄãÈÄ£Áµê
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log('‚úÖ ÊàêÂäüËºâÂÖ•', links.length, 'ÂÄãÈÄ£ÁµêÔºåÈñãÂßãÊ∏≤ÊüìÂàóË°®');
                
                // ËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ
                console.log('üîÑ ÈñãÂßãËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ...');
                let { data: items, error: itemsError } = await supabaseClient
                    .from('related_link_items')
                    .select('*')
                    .order('display_order', { ascending: true });
                
                // Â¶ÇÊûúÈÅáÂà∞ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢
                if (itemsError) {
                    console.warn('‚ö†Ô∏è ËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÂ§±ÊïóÔºåÂòóË©¶Áõ¥Êé•Êü•Ë©¢...', itemsError);
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/related_link_items?select=*&order=display_order.asc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            }
                        });
                        
                        if (response.ok) {
                            items = await response.json();
                            itemsError = null;
                            console.log('‚úÖ ‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÊàêÂäüÔºåËºâÂÖ•Âà∞', items.length, 'ÂÄãÈ†ÖÁõÆ');
                        } else {
                            console.warn('‚ö†Ô∏è REST API Êü•Ë©¢‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÂ§±Êïó:', response.status);
                        }
                    } catch (fetchError) {
                        console.warn('‚ö†Ô∏è Áõ¥Êé•Êü•Ë©¢‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ‰πüÂ§±Êïó:', fetchError);
                    }
                }
                
                // Â¶ÇÊûúÈÇÑÊòØÊ≤íÊúâË≥áÊñôÔºå‰ΩøÁî®È†êË®≠Ë≥áÊñô
                if (!items || items.length === 0) {
                    console.warn('‚ö†Ô∏è ÁÑ°Ê≥ïÂæû Supabase ËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÔºå‰ΩøÁî®È†êË®≠Ë≥áÊñô');
                    // ÊâæÂà∞„ÄåÊàøÁî¢Ë≥áË®äÂèÉËÄÉ„ÄçÈÄ£ÁµêÁöÑ ID
                    const propertyInfoLink = links.find(l => l.title === 'ÊàøÁî¢Ë≥áË®äÂèÉËÄÉ');
                    if (propertyInfoLink) {
                        items = [
                            { id: '0af0e9d3-bef8-42ce-be4c-5a0ec7fe9063', parent_link_id: propertyInfoLink.id, title: '2026Âπ¥Ê•äÊ¢ÖË∂®Âã¢ÂºïÊìä', url: 'https://drive.google.com/file/d/1NddGgXcysK-QRoozRA4XXww6c-NUv-OJ/view?usp=sharing', display_order: 1, is_active: true },
                            { id: 'ddaa0085-53c5-4314-a6a5-407419615009', parent_link_id: propertyInfoLink.id, title: 'Êñ∞ÈùíÂÆâÂØ¨È¨ÜÊîøÁ≠ñ', url: 'https://drive.google.com/file/d/1PeGDx2IruOjWkeIHgVVqpk0tceB0l7Vg/view?usp=drive_link', display_order: 2, is_active: true },
                            { id: 'a817158f-81cd-4ebb-9270-9eb890074a96', parent_link_id: propertyInfoLink.id, title: '2025Âπ¥ÊàøÁî¢ÂàÜÊûê', url: 'https://drive.google.com/file/d/1vVluYlY81Ew76Dc4ZyWI_Y9CZ3cWbj0t/view?usp=drive_link', display_order: 3, is_active: true }
                        ];
                        itemsError = null;
                        console.log('‚úÖ ‰ΩøÁî®È†êË®≠‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÔºåÂÖ±', items.length, 'ÂÄãÈ†ÖÁõÆ');
                    }
                }
                
                if (itemsError) {
                    console.warn('ËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÂ§±Êïó:', itemsError);
                } else {
                    console.log('‚úÖ ÊàêÂäüËºâÂÖ•', items?.length || 0, 'ÂÄã‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ');
                }
                
                // Â∞áÈ†ÖÁõÆÂàÜÁµÑÂà∞Â∞çÊáâÁöÑÈÄ£Áµê
                const itemsByParent = {};
                if (items) {
                    items.forEach(item => {
                        if (!itemsByParent[item.parent_link_id]) {
                            itemsByParent[item.parent_link_id] = [];
                        }
                        itemsByParent[item.parent_link_id].push(item);
                    });
                }
                
                // Ê∏≤ÊüìÈÄ£ÁµêÂàóË°®
                console.log('üé® ÈñãÂßãÊ∏≤ÊüìÈÄ£ÁµêÂàóË°®ÔºåÂÖ±', links.length, 'ÂÄãÈÄ£Áµê');
                
                // Ê™¢Ê∏¨ÊòØÂê¶ÁÇ∫ÊâãÊ©üÁâà
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // ÊâãÊ©üÁâàÔºö‰ΩøÁî®Á∂≤Ê†ºÂç°Áâá‰ΩàÂ±Ä
                    listContainer.innerHTML = `
                        <div class="links-grid-mobile">
                            ${links.map(link => {
                                const safeTitle = escapeHtml(link.title);
                                const safeUrl = escapeHtml(link.url);
                                const safeId = escapeHtml(link.id);
                                const itemsCount = link.link_type === 'dropdown' && itemsByParent[link.id] ? itemsByParent[link.id].length : 0;
                                const urlDisplay = safeUrl.length > 40 ? safeUrl.substring(0, 40) + '...' : safeUrl;
                                
                                return `
                                    <div class="link-card-mobile">
                                        <div class="link-card-mobile-header">
                                            <div class="link-card-mobile-order">#${link.display_order || 0}</div>
                                            <div class="link-card-mobile-title">
                                                <span style="font-size: 1.2rem; margin-right: 0.5rem;">${link.icon || ''}</span>
                                                <span>${safeTitle}</span>
                                            </div>
                                        </div>
                                        <div class="link-card-mobile-content">
                                            <div class="link-card-mobile-item">
                                                <span class="link-card-mobile-label">Á∂≤ÂùÄÔºö</span>
                                                <a href="${safeUrl}" target="_blank" class="link-card-mobile-url" title="${safeUrl}">
                                                    ${urlDisplay}
                                                </a>
                                            </div>
                                            <div class="link-card-mobile-item">
                                                <span class="link-card-mobile-label">È°ûÂûãÔºö</span>
                                                <span class="badge ${link.link_type === 'dropdown' ? 'badge-warning' : 'badge-success'}">
                                                    ${link.link_type === 'dropdown' ? '‰∏ãÊãâÈÅ∏ÂñÆ' : 'ÊåâÈàï'}
                                                </span>
                                                ${itemsCount > 0 ? `<span style="color: #666; font-size: 0.85rem; margin-left: 0.5rem;">(${itemsCount} ÂÄãÈ†ÖÁõÆ)</span>` : ''}
                                            </div>
                                            <div class="link-card-mobile-item">
                                                <span class="link-card-mobile-label">ÁãÄÊÖãÔºö</span>
                                                <span class="badge ${link.is_active ? 'badge-success' : 'badge-danger'}">
                                                    ${link.is_active ? 'ÂïüÁî®' : 'ÂÅúÁî®'}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="link-card-mobile-actions">
                                            <button class="btn btn-primary btn-small" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.editLink) { RelatedLinksBackend.editLink('${safeId}'); } else { editLink('${safeId}'); }" style="flex: 1;">
                                                ‚úèÔ∏è Á∑®ËºØ
                                            </button>
                                            <button class="btn btn-danger btn-small" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.deleteLink) { RelatedLinksBackend.deleteLink('${safeId}'); } else { deleteLink('${safeId}'); }" style="flex: 1;">
                                                üóëÔ∏è Âà™Èô§
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    // Ê°åÈù¢ÁâàÔºö‰ΩøÁî®Ë°®Ê†º‰ΩàÂ±Ä
                    listContainer.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">È†ÜÂ∫è</th>
                                    <th>Ê®ôÈ°å</th>
                                    <th>Á∂≤ÂùÄ</th>
                                    <th>È°ûÂûã</th>
                                    <th>ÁãÄÊÖã</th>
                                    <th style="width: 200px;">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${links.map(link => `
                                    <tr>
                                        <td>${link.display_order || 0}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-size: 1.2rem;">${link.icon || ''}</span>
                                                <span>${escapeHtml(link.title)}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="${escapeHtml(link.url)}" target="_blank" style="color: #667eea; text-decoration: none; max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                ${escapeHtml(link.url)}
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge ${link.link_type === 'dropdown' ? 'badge-warning' : 'badge-success'}">
                                                ${link.link_type === 'dropdown' ? '‰∏ãÊãâÈÅ∏ÂñÆ' : 'ÊåâÈàï'}
                                            </span>
                                            ${link.link_type === 'dropdown' && itemsByParent[link.id] ? 
                                                `(${itemsByParent[link.id].length} ÂÄãÈ†ÖÁõÆ)` : ''}
                                        </td>
                                        <td>
                                            <span class="badge ${link.is_active ? 'badge-success' : 'badge-danger'}">
                                                ${link.is_active ? 'ÂïüÁî®' : 'ÂÅúÁî®'}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-primary btn-small" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.editLink) { RelatedLinksBackend.editLink('${link.id}'); } else { editLink('${link.id}'); }">
                                                    ‚úèÔ∏è Á∑®ËºØ
                                                </button>
                                                <button class="btn btn-danger btn-small" onclick="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.deleteLink) { RelatedLinksBackend.deleteLink('${link.id}'); } else { deleteLink('${link.id}'); }"
                                                        title="Âà™Èô§">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('ËºâÂÖ•ÈÄ£ÁµêÂ§±Êïó:', error);
                console.error('ÈåØË™§Ë©≥ÊÉÖ:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code,
                    status: error.status
                });
                
                // Â¶ÇÊûúÊòØ 404 ÈåØË™§ÔºåÈ°ØÁ§∫ÁâπÂà•ÁöÑÊèêÁ§∫
                const is404Error = error.status === 404 || error.message?.includes('404') || error.message?.includes('Could not find');
                
                listContainer.innerHTML = `
                    <div class="alert alert-error" style="max-width: 800px; margin: 0 auto;">
                        <strong>ËºâÂÖ•Â§±ÊïóÔºö</strong>${escapeHtml(error.message || 'Ë´ãÊ™¢Êü• Supabase Ë®≠ÂÆö')}
                        ${error.details ? `<br><small>${escapeHtml(error.details)}</small>` : ''}
                        ${error.hint ? `<br><small>ÊèêÁ§∫Ôºö${escapeHtml(error.hint)}</small>` : ''}
                        ${is404Error ? `
                            <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <strong>‚ö†Ô∏è Ë≥áÊñôË°®Â∞öÊú™Âª∫Á´ãÊàñÂ∞öÊú™ÂêåÊ≠•</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                    <strong>Ëß£Ê±∫ÊñπÊ≥ïÔºö</strong>
                                    <br>1. ÂâçÂæÄ <a href="https://supabase.com/dashboard/project/cnzqtuuegdqwkgvletaa/sql/new" target="_blank" style="color: #667eea; font-weight: bold;">Supabase SQL Editor</a>
                                    <br>2. Âü∑Ë°å <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 0.85em;">create-related-links-table.sql</code> Ê™îÊ°à‰∏≠ÁöÑ SQL Ë™ûÂè•
                                    <br>3. Á≠âÂæÖ 1-2 ÂàÜÈêòËÆì REST API ÂêåÊ≠•
                                    <br>4. ÈªûÊìä‰∏ãÊñπÊåâÈàïÈáçÊñ∞ËºâÂÖ•
                                </p>
                                <div style="margin-top: 0.8rem; display: flex; gap: 0.5rem;">
                                    <button class="btn btn-primary" onclick="loadRelatedLinks()">
                                        üîÑ ÈáçÊñ∞ËºâÂÖ•
                                    </button>
                                    <a href="https://supabase.com/dashboard/project/cnzqtuuegdqwkgvletaa/sql/new" target="_blank" class="btn" style="background: #667eea; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block;">
                                        üìù ÂâçÂæÄ SQL Editor
                                    </a>
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="loadRelatedLinks()">
                                üîÑ ÈáçÊñ∞ËºâÂÖ•
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // È°ØÁ§∫Êñ∞Â¢ûÈÄ£ÁµêÂΩàÁ™ó
        function showAddLinkModal() {
            editingLinkId = null;
            linkItems = [];
            document.getElementById('link-modal-title').textContent = 'Êñ∞Â¢ûÈÄ£Áµê';
            document.getElementById('link-title').value = '';
            document.getElementById('link-url').value = '';
            document.getElementById('link-icon').value = '';
            document.getElementById('link-color').value = 'linear-gradient(45deg, #667eea, #764ba2)';
            document.getElementById('link-order').value = '0';
            document.getElementById('link-active').checked = true;
            document.getElementById('link-type').value = 'button';
            document.getElementById('link-items-container').style.display = 'none';
            document.getElementById('link-items-list').innerHTML = '';
            document.getElementById('link-modal').style.display = 'flex';
        }
        
        // Á∑®ËºØÈÄ£Áµê
        async function editLink(linkId) {
            try {
                console.log('üîÑ ÈñãÂßãÁ∑®ËºØÈÄ£ÁµêÔºåID:', linkId);
                
                // Á¢∫‰øù Supabase ÂÆ¢Êà∂Á´ØÂ∑≤ÂàùÂßãÂåñ
                const client = initSupabaseClient();
                if (!client) {
                    throw new Error('ÁÑ°Ê≥ïÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´Ø');
                }
                supabaseClient = client;
                
                // ËºâÂÖ•ÈÄ£ÁµêË≥áÊñô
                console.log('üîÑ Ê≠£Âú®Âæû Supabase ËºâÂÖ•ÈÄ£ÁµêË≥áÊñôÔºåID:', linkId);
                let { data: link, error: linkError } = await supabaseClient
                    .from('related_links')
                    .select('*')
                    .eq('id', linkId)
                    .single();
                
                console.log('üìã Supabase ÂÆ¢Êà∂Á´ØÊü•Ë©¢ÁµêÊûú:', { data: link, error: linkError });
                
                // Â¶ÇÊûúÈÅáÂà∞ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢
                if (linkError) {
                    console.warn('‚ö†Ô∏è Supabase ÂÆ¢Êà∂Á´ØÊü•Ë©¢Â§±ÊïóÔºåÂòóË©¶Áõ¥Êé•Êü•Ë©¢...', linkError);
                    try {
                        // ‰ΩøÁî®Ê≠£Á¢∫ÁöÑ PostgREST Êü•Ë©¢Ë™ûÊ≥ïÔºàselect ÊáâË©≤Âú®ÂâçÈù¢ÔºåÊàñËÄÖ‰ΩøÁî®Ê≠£Á¢∫ÁöÑÊ†ºÂºèÔºâ
                        // PostgREST Ë™ûÊ≥ïÔºö?select=*&id=eq.value Êàñ ?id=eq.value
                        const encodedId = encodeURIComponent(linkId);
                        // ÂòóË©¶ÂÖ©Á®ÆÊ†ºÂºè
                        let url = `${SUPABASE_URL}/rest/v1/related_links?select=*&id=eq.${encodedId}`;
                        console.log('üîÑ REST API URL (Ê†ºÂºè1):', url);
                        
                        let response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Accept': 'application/vnd.pgjson.object+json'
                            }
                        });
                        
                        console.log('üì° REST API ÂõûÊáâÁãÄÊÖã (Ê†ºÂºè1):', response.status, response.statusText);
                        
                        // Â¶ÇÊûú 406 ÈåØË™§ÔºåÂòóË©¶‰∏çÂêåÁöÑ Accept Ê®ôÈ†≠
                        if (response.status === 406) {
                            console.log('üîÑ 406 ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî®‰∏çÂêåÁöÑ Accept Ê®ôÈ†≠...');
                            url = `${SUPABASE_URL}/rest/v1/related_links?id=eq.${encodedId}`;
                            response = await fetch(url, {
                                method: 'GET',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                }
                            });
                            console.log('üì° REST API ÂõûÊáâÁãÄÊÖã (Ê†ºÂºè2):', response.status, response.statusText);
                        }
                        
                        if (response.ok) {
                            const links = await response.json();
                            console.log('üìã REST API ÂõûÊáâË≥áÊñô:', links);
                            if (links && Array.isArray(links) && links.length > 0) {
                                link = links[0];
                                linkError = null;
                                console.log('‚úÖ ‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢ÊàêÂäü');
                            } else if (links && !Array.isArray(links)) {
                                // Â¶ÇÊûúËøîÂõûÁöÑÊòØÂñÆ‰∏ÄÂ∞çË±°ËÄå‰∏çÊòØÈô£Âàó
                                link = links;
                                linkError = null;
                                console.log('‚úÖ ‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢ÊàêÂäüÔºàÂñÆ‰∏ÄÂ∞çË±°Ôºâ');
                            } else {
                                console.warn('‚ö†Ô∏è REST API ËøîÂõûÁ©∫Èô£ÂàóÊàñÁÑ°ÊïàË≥áÊñô');
                                // ÂòóË©¶Áõ¥Êé•‰ΩøÁî® Supabase ÂÆ¢Êà∂Á´ØÊü•Ë©¢ÊâÄÊúâÈÄ£ÁµêÔºåÁÑ∂ÂæåÈÅéÊøæ
                                console.log('üîÑ ÂòóË©¶Êü•Ë©¢ÊâÄÊúâÈÄ£Áµê‰∏¶ÈÅéÊøæ...');
                                const { data: allLinks, error: allLinksError } = await supabaseClient
                                    .from('related_links')
                                    .select('*');
                                
                                if (!allLinksError && allLinks) {
                                    const foundLink = allLinks.find(l => l.id === linkId);
                                    if (foundLink) {
                                        link = foundLink;
                                        linkError = null;
                                        console.log('‚úÖ ÂæûÊâÄÊúâÈÄ£Áµê‰∏≠ÊâæÂà∞ÁõÆÊ®ôÈÄ£Áµê');
                                    } else {
                                        throw new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÈÄ£ÁµêÔºàID: ' + linkId + 'Ôºâ');
                                    }
                                } else {
                                    throw new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÈÄ£Áµê');
                                }
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('‚ùå REST API ÈåØË™§:', response.status, errorText);
                            // ÂòóË©¶Áõ¥Êé•‰ΩøÁî® Supabase ÂÆ¢Êà∂Á´ØÊü•Ë©¢ÊâÄÊúâÈÄ£Áµê
                            console.log('üîÑ ÂòóË©¶Êü•Ë©¢ÊâÄÊúâÈÄ£Áµê‰∏¶ÈÅéÊøæ...');
                            const { data: allLinks, error: allLinksError } = await supabaseClient
                                .from('related_links')
                                .select('*');
                            
                            if (!allLinksError && allLinks) {
                                const foundLink = allLinks.find(l => l.id === linkId);
                                if (foundLink) {
                                    link = foundLink;
                                    linkError = null;
                                    console.log('‚úÖ ÂæûÊâÄÊúâÈÄ£Áµê‰∏≠ÊâæÂà∞ÁõÆÊ®ôÈÄ£Áµê');
                                } else {
                                    throw new Error(`REST API ÈåØË™§ (${response.status}): ${errorText || response.statusText}`);
                                }
                            } else {
                                throw new Error(`REST API ÈåØË™§ (${response.status}): ${errorText || response.statusText}`);
                            }
                        }
                    } catch (fetchError) {
                        console.error('‚ùå Áõ¥Êé•Êü•Ë©¢‰πüÂ§±Êïó:', fetchError);
                        // ÊúÄÂæåÂòóË©¶ÔºöÊü•Ë©¢ÊâÄÊúâÈÄ£Áµê‰∏¶ÈÅéÊøæ
                        try {
                            console.log('üîÑ ÊúÄÂæåÂòóË©¶ÔºöÊü•Ë©¢ÊâÄÊúâÈÄ£Áµê‰∏¶ÈÅéÊøæ...');
                            const { data: allLinks, error: allLinksError } = await supabaseClient
                                .from('related_links')
                                .select('*');
                            
                            if (!allLinksError && allLinks) {
                                const foundLink = allLinks.find(l => l.id === linkId);
                                if (foundLink) {
                                    link = foundLink;
                                    linkError = null;
                                    console.log('‚úÖ ÂæûÊâÄÊúâÈÄ£Áµê‰∏≠ÊâæÂà∞ÁõÆÊ®ôÈÄ£Áµê');
                                } else {
                                    throw linkError || fetchError || new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÈÄ£Áµê');
                                }
                            } else {
                                throw linkError || fetchError || allLinksError;
                            }
                        } catch (finalError) {
                            throw linkError || fetchError || finalError;
                        }
                    }
                }
                
                if (linkError) throw linkError;
                
                if (!link) {
                    throw new Error('ÁÑ°Ê≥ïËºâÂÖ•ÈÄ£ÁµêË≥áÊñô');
                }
                
                console.log('‚úÖ ÊàêÂäüËºâÂÖ•ÈÄ£ÁµêË≥áÊñô:', link);
                
                editingLinkId = linkId;
                
                // Á¢∫‰øùÊâÄÊúâË°®ÂñÆÂÖÉÁ¥†ÈÉΩÂ≠òÂú®
                const modalTitle = document.getElementById('link-modal-title');
                const titleInputEl = document.getElementById('link-title');
                const urlInputEl = document.getElementById('link-url');
                const iconInputEl = document.getElementById('link-icon');
                const colorInputEl = document.getElementById('link-color');
                const orderInputEl = document.getElementById('link-order');
                const activeCheckboxEl = document.getElementById('link-active');
                const typeSelectEl = document.getElementById('link-type');
                
                if (!titleInputEl || !urlInputEl || !iconInputEl || !colorInputEl || !orderInputEl || !activeCheckboxEl || !typeSelectEl || !modalTitle) {
                    throw new Error('Êâæ‰∏çÂà∞ÂøÖË¶ÅÁöÑË°®ÂñÆÂÖÉÁ¥†ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                }
                
                modalTitle.textContent = 'Á∑®ËºØÈÄ£Áµê';
                titleInputEl.value = link.title || '';
                urlInputEl.value = link.url || '';
                iconInputEl.value = link.icon || '';
                colorInputEl.value = link.color_gradient || 'linear-gradient(45deg, #667eea, #764ba2)';
                orderInputEl.value = link.display_order || 0;
                activeCheckboxEl.checked = link.is_active !== false;
                typeSelectEl.value = link.link_type || 'button';
                
                // Â¶ÇÊûúÊòØ‰∏ãÊãâÈÅ∏ÂñÆÔºåËºâÂÖ•Â≠êÈ†ÖÁõÆ
                if (link.link_type === 'dropdown') {
                    console.log('üîÑ Ê≠£Âú®ËºâÂÖ•‰∏ãÊãâÈÅ∏ÂñÆÂ≠êÈ†ÖÁõÆ...');
                    let { data: items, error: itemsError } = await supabaseClient
                        .from('related_link_items')
                        .select('*')
                        .eq('parent_link_id', linkId)
                        .order('display_order', { ascending: true });
                    
                    // Â¶ÇÊûúÈÅáÂà∞ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢
                    if (itemsError) {
                        console.warn('‚ö†Ô∏è ËºâÂÖ•Â≠êÈ†ÖÁõÆÂ§±ÊïóÔºåÂòóË©¶Áõ¥Êé•Êü•Ë©¢...', itemsError);
                        try {
                            const encodedLinkId = encodeURIComponent(linkId);
                            const url = `${SUPABASE_URL}/rest/v1/related_link_items?parent_link_id=eq.${encodedLinkId}&select=*&order=display_order.asc`;
                            console.log('üîÑ REST API URL (Â≠êÈ†ÖÁõÆ):', url);
                            
                            const response = await fetch(url, {
                                method: 'GET',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                }
                            });
                            
                            if (response.ok) {
                                items = await response.json();
                                itemsError = null;
                                console.log('‚úÖ ‰ΩøÁî® REST API Áõ¥Êé•Êü•Ë©¢Â≠êÈ†ÖÁõÆÊàêÂäüÔºåËºâÂÖ•Âà∞', items.length, 'ÂÄãÈ†ÖÁõÆ');
                            } else {
                                const errorText = await response.text();
                                console.warn('‚ö†Ô∏è REST API Êü•Ë©¢Â≠êÈ†ÖÁõÆÂ§±Êïó:', response.status, errorText);
                            }
                        } catch (fetchError) {
                            console.warn('‚ö†Ô∏è Áõ¥Êé•Êü•Ë©¢Â≠êÈ†ÖÁõÆ‰πüÂ§±Êïó:', fetchError);
                        }
                    }
                    
                    if (itemsError) {
                        console.warn('ËºâÂÖ•Â≠êÈ†ÖÁõÆÂ§±Êïó:', itemsError);
                        linkItems = [];
                    } else {
                        linkItems = items || [];
                        console.log('‚úÖ ÊàêÂäüËºâÂÖ•', linkItems.length, 'ÂÄãÂ≠êÈ†ÖÁõÆ');
                    }
                    
                    document.getElementById('link-items-container').style.display = 'block';
                    renderLinkItems();
                } else {
                    linkItems = [];
                    document.getElementById('link-items-container').style.display = 'none';
                }
                
                // È°ØÁ§∫ÂΩàÁ™óÔºàË°®ÂñÆÂÖÉÁ¥†Â∑≤Á∂ìÂú®‰∏äÈù¢Ê™¢Êü•ÈÅé‰∫ÜÔºâ
                document.getElementById('link-modal').style.display = 'flex';
                console.log('‚úÖ Á∑®ËºØÂΩàÁ™óÂ∑≤È°ØÁ§∫');
            } catch (error) {
                console.error('‚ùå ËºâÂÖ•ÈÄ£ÁµêÂ§±Êïó:', error);
                console.error('ÈåØË™§Ë©≥ÊÉÖ:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                showLinkAlert('error', `ËºâÂÖ•ÈÄ£ÁµêÂ§±ÊïóÔºö${error.message || 'Êú™Áü•ÈåØË™§'}`);
            }
        }
        
        // ÈóúÈñâÈÄ£ÁµêÂΩàÁ™ó
        function closeLinkModal() {
            document.getElementById('link-modal').style.display = 'none';
            editingLinkId = null;
            linkItems = [];
        }
        
        // Áõ£ËÅΩÈÄ£ÁµêÈ°ûÂûãËÆäÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const linkTypeSelect = document.getElementById('link-type');
            if (linkTypeSelect) {
                linkTypeSelect.addEventListener('change', function() {
                    if (this.value === 'dropdown') {
                        document.getElementById('link-items-container').style.display = 'block';
                    } else {
                        document.getElementById('link-items-container').style.display = 'none';
                    }
                });
            }
        });
        
        // Êñ∞Â¢û‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ
        function addLinkItem() {
            linkItems.push({
                id: null,
                title: '',
                url: '',
                display_order: linkItems.length
            });
            renderLinkItems();
        }
        
        // Âà™Èô§‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ
        function removeLinkItem(index) {
            linkItems.splice(index, 1);
            renderLinkItems();
        }
        
        // Ê∏≤Êüì‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆÂàóË°®
        function renderLinkItems() {
            const container = document.getElementById('link-items-list');
            if (!container) return;
            
            container.innerHTML = linkItems.map((item, index) => `
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong>È†ÖÁõÆ ${index + 1}</strong>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeLinkItem(${index})"
                                title="Âà™Èô§">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="form-group" style="margin-bottom: 0.5rem;">
                        <label>Ê®ôÈ°å</label>
                        <input type="text" class="link-item-title" data-index="${index}" 
                               value="${escapeHtml(item.title)}" 
                               placeholder="‰æãÂ¶ÇÔºö2026Âπ¥Ê•äÊ¢ÖË∂®Âã¢ÂºïÊìä"
                               onchange="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.updateLinkItem) { RelatedLinksBackend.updateLinkItem(${index}, 'title', this.value); } else { updateLinkItem(${index}, 'title', this.value); }">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Á∂≤ÂùÄ</label>
                        <input type="url" class="link-item-url" data-index="${index}" 
                               value="${escapeHtml(item.url)}" 
                               placeholder="https://example.com"
                               onchange="if(typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.updateLinkItem) { RelatedLinksBackend.updateLinkItem(${index}, 'url', this.value); } else { updateLinkItem(${index}, 'url', this.value); }">
                    </div>
                </div>
            `).join('');
        }
        
        // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆÈ†ÖÁõÆ
        function updateLinkItem(index, field, value) {
            if (linkItems[index]) {
                linkItems[index][field] = value;
            }
        }
        
        // ÂÑ≤Â≠òÈÄ£Áµê
        async function saveLink() {
            console.log('üîÑ ÈñãÂßãÂÑ≤Â≠òÈÄ£Áµê...');
            
            // Á¢∫‰øù Supabase ÂÆ¢Êà∂Á´ØÂ∑≤ÂàùÂßãÂåñ
            const client = initSupabaseClient();
            if (!client) {
                showLinkAlert('error', 'ÁÑ°Ê≥ïÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´ØÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                return;
            }
            supabaseClient = client;
            
            // Áç≤ÂèñË°®ÂñÆË≥áÊñô
            const titleInput = document.getElementById('link-title');
            const urlInput = document.getElementById('link-url');
            const iconInput = document.getElementById('link-icon');
            const colorInput = document.getElementById('link-color');
            const orderInput = document.getElementById('link-order');
            const activeCheckbox = document.getElementById('link-active');
            const typeSelect = document.getElementById('link-type');
            
            if (!titleInput || !urlInput || !iconInput || !colorInput || !orderInput || !activeCheckbox || !typeSelect) {
                showLinkAlert('error', 'Êâæ‰∏çÂà∞Ë°®ÂñÆÂÖÉÁ¥†ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                console.error('‚ùå Êâæ‰∏çÂà∞Ë°®ÂñÆÂÖÉÁ¥†');
                return;
            }
            
            const title = titleInput.value.trim();
            const url = urlInput.value.trim();
            const icon = iconInput.value.trim();
            const color = colorInput.value.trim();
            const order = parseInt(orderInput.value) || 0;
            const isActive = activeCheckbox.checked;
            const linkType = typeSelect.value;
            
            console.log('üìã Ë°®ÂñÆË≥áÊñô:', { title, url, icon, color, order, isActive, linkType, editingLinkId });
            
            if (!title || !url) {
                showLinkAlert('error', 'Ë´ãÂ°´ÂØ´Ê®ôÈ°åÂíåÁ∂≤ÂùÄ');
                return;
            }
            
            try {
                const linkData = {
                    title,
                    url,
                    icon: icon || null,
                    color_gradient: color || 'linear-gradient(45deg, #667eea, #764ba2)',
                    display_order: order,
                    is_active: isActive,
                    link_type: linkType
                };
                
                let linkId;
                
                if (editingLinkId) {
                    // Êõ¥Êñ∞ÈÄ£Áµê
                    console.log('üîÑ Ê≠£Âú®Êõ¥Êñ∞ÈÄ£ÁµêÔºåID:', editingLinkId);
                    let { data, error } = await supabaseClient
                        .from('related_links')
                        .update(linkData)
                        .eq('id', editingLinkId)
                        .select()
                        .single();
                    
                    // Â¶ÇÊûúÈÅáÂà∞ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API
                    if (error) {
                        console.warn('‚ö†Ô∏è Supabase ÂÆ¢Êà∂Á´ØÊõ¥Êñ∞Â§±ÊïóÔºåÂòóË©¶‰ΩøÁî® REST API...', error);
                        try {
                            const encodedId = encodeURIComponent(editingLinkId);
                            const url = `${SUPABASE_URL}/rest/v1/related_links?id=eq.${encodedId}`;
                            console.log('üîÑ REST API URL (Êõ¥Êñ∞):', url);
                            
                            const response = await fetch(url, {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify(linkData)
                            });
                            
                            console.log('üì° REST API ÂõûÊáâÁãÄÊÖã:', response.status, response.statusText);
                            
                            if (response.ok) {
                                const updatedLinks = await response.json();
                                console.log('üìã REST API ÂõûÊáâË≥áÊñô:', updatedLinks);
                                if (updatedLinks && updatedLinks.length > 0) {
                                    data = updatedLinks[0];
                                    error = null;
                                    console.log('‚úÖ ‰ΩøÁî® REST API Êõ¥Êñ∞ÊàêÂäü');
                                } else {
                                    throw new Error('Êõ¥Êñ∞ÂæåÊú™ËøîÂõûË≥áÊñô');
                                }
                            } else {
                                const errorText = await response.text();
                                console.error('‚ùå REST API ÈåØË™§:', response.status, errorText);
                                throw new Error(`REST API ÈåØË™§ (${response.status}): ${errorText || response.statusText}`);
                            }
                        } catch (fetchError) {
                            console.error('‚ùå REST API Êõ¥Êñ∞‰πüÂ§±Êïó:', fetchError);
                            throw error || fetchError;
                        }
                    }
                    
                    if (error) throw error;
                    linkId = data.id;
                    console.log('‚úÖ ÈÄ£ÁµêÊõ¥Êñ∞ÊàêÂäüÔºåID:', linkId);
                    
                    // Âà™Èô§ËàäÁöÑÂ≠êÈ†ÖÁõÆ
                    console.log('üîÑ Ê≠£Âú®Âà™Èô§ËàäÁöÑÂ≠êÈ†ÖÁõÆ...');
                    const { error: deleteError } = await supabaseClient
                        .from('related_link_items')
                        .delete()
                        .eq('parent_link_id', linkId);
                    
                    if (deleteError) {
                        console.warn('‚ö†Ô∏è Âà™Èô§ËàäÂ≠êÈ†ÖÁõÆÂ§±ÊïóÔºàÂèØËÉΩÊ≤íÊúâËàäÈ†ÖÁõÆÔºâ:', deleteError);
                        // ÂòóË©¶‰ΩøÁî® REST API Âà™Èô§
                        try {
                            await fetch(`${SUPABASE_URL}/rest/v1/related_link_items?parent_link_id=eq.${linkId}`, {
                                method: 'DELETE',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                        } catch (fetchError) {
                            console.warn('‚ö†Ô∏è REST API Âà™Èô§Â≠êÈ†ÖÁõÆ‰πüÂ§±Êïó:', fetchError);
                        }
                    }
                } else {
                    // Êñ∞Â¢ûÈÄ£Áµê
                    console.log('üîÑ Ê≠£Âú®Êñ∞Â¢ûÈÄ£Áµê...');
                    let { data, error } = await supabaseClient
                        .from('related_links')
                        .insert([linkData])
                        .select()
                        .single();
                    
                    // Â¶ÇÊûúÈÅáÂà∞ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API
                    if (error) {
                        console.warn('‚ö†Ô∏è Supabase ÂÆ¢Êà∂Á´ØÊñ∞Â¢ûÂ§±ÊïóÔºåÂòóË©¶‰ΩøÁî® REST API...', error);
                        try {
                            const url = `${SUPABASE_URL}/rest/v1/related_links`;
                            console.log('üîÑ REST API URL (Êñ∞Â¢û):', url);
                            
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify(linkData)
                            });
                            
                            console.log('üì° REST API ÂõûÊáâÁãÄÊÖã:', response.status, response.statusText);
                            
                            if (response.ok) {
                                const newLinks = await response.json();
                                console.log('üìã REST API ÂõûÊáâË≥áÊñô:', newLinks);
                                if (newLinks && newLinks.length > 0) {
                                    data = newLinks[0];
                                    error = null;
                                    console.log('‚úÖ ‰ΩøÁî® REST API Êñ∞Â¢ûÊàêÂäü');
                                } else {
                                    throw new Error('Êñ∞Â¢ûÂæåÊú™ËøîÂõûË≥áÊñô');
                                }
                            } else {
                                const errorText = await response.text();
                                console.error('‚ùå REST API ÈåØË™§:', response.status, errorText);
                                throw new Error(`REST API ÈåØË™§ (${response.status}): ${errorText || response.statusText}`);
                            }
                        } catch (fetchError) {
                            console.error('‚ùå REST API Êñ∞Â¢û‰πüÂ§±Êïó:', fetchError);
                            throw error || fetchError;
                        }
                    }
                    
                    if (error) throw error;
                    linkId = data.id;
                    console.log('‚úÖ ÈÄ£ÁµêÊñ∞Â¢ûÊàêÂäüÔºåID:', linkId);
                }
                
                // Â¶ÇÊûúÊòØ‰∏ãÊãâÈÅ∏ÂñÆÔºåÂÑ≤Â≠òÂ≠êÈ†ÖÁõÆ
                if (linkType === 'dropdown' && linkItems.length > 0) {
                    console.log('üîÑ Ê≠£Âú®ÂÑ≤Â≠ò‰∏ãÊãâÈÅ∏ÂñÆÂ≠êÈ†ÖÁõÆ...');
                    const itemsToInsert = linkItems
                        .filter(item => item.title && item.url)
                        .map((item, index) => ({
                            parent_link_id: linkId,
                            title: item.title,
                            url: item.url,
                            display_order: index,
                            is_active: true
                        }));
                    
                    console.log('üìã Ê∫ñÂÇôÊèíÂÖ•', itemsToInsert.length, 'ÂÄãÂ≠êÈ†ÖÁõÆ');
                    
                    if (itemsToInsert.length > 0) {
                        let { error: itemsError } = await supabaseClient
                            .from('related_link_items')
                            .insert(itemsToInsert);
                        
                        // Â¶ÇÊûúÈÅáÂà∞ÈåØË™§ÔºåÂòóË©¶‰ΩøÁî® REST API
                        if (itemsError) {
                            console.warn('‚ö†Ô∏è Supabase ÂÆ¢Êà∂Á´ØÊèíÂÖ•Â≠êÈ†ÖÁõÆÂ§±ÊïóÔºåÂòóË©¶‰ΩøÁî® REST API...', itemsError);
                            try {
                                const url = `${SUPABASE_URL}/rest/v1/related_link_items`;
                                console.log('üîÑ REST API URL (ÊèíÂÖ•Â≠êÈ†ÖÁõÆ):', url);
                                
                                const response = await fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json',
                                        'Prefer': 'return=representation'
                                    },
                                    body: JSON.stringify(itemsToInsert)
                                });
                                
                                console.log('üì° REST API ÂõûÊáâÁãÄÊÖã:', response.status, response.statusText);
                                
                                if (response.ok) {
                                    itemsError = null;
                                    console.log('‚úÖ ‰ΩøÁî® REST API ÊèíÂÖ•Â≠êÈ†ÖÁõÆÊàêÂäü');
                                } else {
                                    const errorText = await response.text();
                                    console.error('‚ùå REST API ÈåØË™§:', response.status, errorText);
                                    throw new Error(`REST API ÈåØË™§ (${response.status}): ${errorText || response.statusText}`);
                                }
                            } catch (fetchError) {
                                console.error('‚ùå REST API ÊèíÂÖ•Â≠êÈ†ÖÁõÆ‰πüÂ§±Êïó:', fetchError);
                                throw itemsError || fetchError;
                            }
                        }
                        
                        if (itemsError) throw itemsError;
                        console.log('‚úÖ Â≠êÈ†ÖÁõÆÂÑ≤Â≠òÊàêÂäü');
                    }
                }
                
                showLinkAlert('success', editingLinkId ? 'ÈÄ£ÁµêÂ∑≤Êõ¥Êñ∞ÔºÅ' : 'ÈÄ£ÁµêÂ∑≤Êñ∞Â¢ûÔºÅ');
                closeLinkModal();
                
                // ÈáçÊñ∞ËºâÂÖ•ÈÄ£ÁµêÂàóË°®
                console.log('üîÑ ÈáçÊñ∞ËºâÂÖ•ÈÄ£ÁµêÂàóË°®...');
                await loadRelatedLinks();
                console.log('‚úÖ ÂÑ≤Â≠òÊµÅÁ®ãÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå ÂÑ≤Â≠òÈÄ£ÁµêÂ§±Êïó:', error);
                console.error('ÈåØË™§Ë©≥ÊÉÖ:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });
                showLinkAlert('error', `ÂÑ≤Â≠òÂ§±ÊïóÔºö${error.message || 'Êú™Áü•ÈåØË™§'}`);
            }
        }
        
        // Âà™Èô§ÈÄ£Áµê
        async function deleteLink(linkId) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÈÄ£ÁµêÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                return;
            }
            
            try {
            // Á¢∫‰øù Supabase ÂÆ¢Êà∂Á´ØÂ∑≤ÂàùÂßãÂåñ
            const client = initSupabaseClient();
            if (!client) {
                showLinkAlert('error', 'ÁÑ°Ê≥ïÂàùÂßãÂåñ Supabase ÂÆ¢Êà∂Á´ØÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                return;
            }
            supabaseClient = client;
                
                // ÂÖàÂà™Èô§Â≠êÈ†ÖÁõÆÔºàÂ¶ÇÊûúÊúâÔºâ
                await supabaseClient
                    .from('related_link_items')
                    .delete()
                    .eq('parent_link_id', linkId);
                
                // Âà™Èô§ÈÄ£Áµê
                const { error } = await supabaseClient
                    .from('related_links')
                    .delete()
                    .eq('id', linkId);
                
                if (error) throw error;
                
                showLinkAlert('success', 'ÈÄ£ÁµêÂ∑≤Âà™Èô§ÔºÅ');
                loadRelatedLinks();
            } catch (error) {
                console.error('Âà™Èô§ÈÄ£ÁµêÂ§±Êïó:', error);
                showLinkAlert('error', `Âà™Èô§Â§±ÊïóÔºö${error.message}`);
            }
        }
        
        // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØÔºàÁî®ÊñºÈÄ£ÁµêÁÆ°ÁêÜÔºâ
        function showLinkAlert(type, message) {
            const container = document.getElementById('links-alert-container');
            if (!container) {
                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂÆπÂô®Ôºå‰ΩøÁî®ÂÖ®ÂüüÁöÑ showAlert
                if (typeof showAlert === 'function') {
                    showAlert(type, message);
                } else {
                    // Â¶ÇÊûúÈÉΩÊ≤íÊúâÔºå‰ΩøÁî® alert
                    alert(message);
                }
                return;
            }
            
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : 'alert-info';
            
            container.innerHTML = `<div class="alert ${alertClass}">${escapeHtml(message)}</div>`;
            
            // 3ÁßíÂæåËá™ÂãïÊ∏ÖÈô§
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
        
        // Á¢∫‰øùÂáΩÊï∏Êö¥Èú≤Âà∞ÂÖ®ÂüüÔºàÁî®Êñº onclick ‰∫ã‰ª∂Ôºâ
        // ÂÑ™ÂÖà‰ΩøÁî®Ê®°ÁµÑÂåñÁâàÊú¨ÔºåÂ¶ÇÊûúÊ®°ÁµÑÊú™ËºâÂÖ•Ââá‰ΩøÁî®ËàäÁâàÊú¨
        window.editLink = function(linkId) {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.editLink) {
                return RelatedLinksBackend.editLink(linkId);
            } else {
                return editLink(linkId);
            }
        };
        window.saveLink = function() {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.saveLink) {
                return RelatedLinksBackend.saveLink();
            } else {
                return saveLink();
            }
        };
        window.showAddLinkModal = function() {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.showAddLinkModal) {
                return RelatedLinksBackend.showAddLinkModal();
            } else {
                return showAddLinkModal();
            }
        };
        window.closeLinkModal = function() {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.closeLinkModal) {
                return RelatedLinksBackend.closeLinkModal();
            } else {
                return closeLinkModal();
            }
        };
        window.addLinkItem = function() {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.addLinkItem) {
                return RelatedLinksBackend.addLinkItem();
            } else {
                return addLinkItem();
            }
        };
        window.removeLinkItem = function(index) {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.removeLinkItem) {
                return RelatedLinksBackend.removeLinkItem(index);
            } else {
                return removeLinkItem(index);
            }
        };
        window.updateLinkItem = function(index, field, value) {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.updateLinkItem) {
                return RelatedLinksBackend.updateLinkItem(index, field, value);
            } else {
                return updateLinkItem(index, field, value);
            }
        };
        window.deleteLink = function(linkId) {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.deleteLink) {
                return RelatedLinksBackend.deleteLink(linkId);
            } else {
                return deleteLink(linkId);
            }
        };
        window.loadRelatedLinks = function() {
            if (typeof RelatedLinksBackend !== 'undefined' && RelatedLinksBackend.loadRelatedLinks) {
                return RelatedLinksBackend.loadRelatedLinks();
            } else {
                return loadRelatedLinks();
            }
        };
        
        console.log('‚úÖ ÈÄ£ÁµêÁÆ°ÁêÜÂáΩÊï∏Â∑≤Êö¥Èú≤Âà∞ÂÖ®ÂüüÔºàÂÑ™ÂÖà‰ΩøÁî®Ê®°ÁµÑÂåñÁâàÊú¨Ôºâ');
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        window.addEventListener('load', init);
    </script>
</body>
</html>

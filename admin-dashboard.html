<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾Œå°ç®¡ç†ç³»çµ± | ä½å•†ä¸å‹•ç”¢</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .nav {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0 2rem;
            display: flex;
            gap: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #666;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }
        
        .nav-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card .change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .stat-card.primary { border-left: 4px solid #667eea; }
        .stat-card.success { border-left: 4px solid #28a745; }
        .stat-card.warning { border-left: 4px solid #ffc107; }
        .stat-card.danger { border-left: 4px solid #dc3545; }
        
        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .content-card h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* å„ªåŒ–çš„å½ˆè·³è¦–çª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-dialog {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .modal-icon.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .modal-icon.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            flex: 1;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-body {
            padding: 1.5rem;
            color: #666;
            line-height: 1.6;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 0.625rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        
        .modal-btn-cancel {
            background: #f8f9fa;
            color: #333;
        }
        
        .modal-btn-cancel:hover {
            background: #e9ecef;
        }
        
        .modal-btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .modal-btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .modal-btn-danger:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .modal-dialog {
                width: 95%;
                margin: 1rem;
            }
            
            .modal-header {
                padding: 1.25rem;
            }
            
            .modal-body {
                padding: 1.25rem;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
        
        /* å­æ¨™ç±¤åˆ‡æ›æ¨£å¼ */
        .sub-tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sub-tab-btn:hover {
            color: #667eea;
            background: #f8f9fa;
        }
        
        .sub-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .property-subtab {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .property-subtab.active {
            display: block;
        }
        
        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }
        
        .property-preview {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .property-preview img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .property-preview-info {
            flex: 1;
        }
        
        .property-preview-info h4 {
            margin-bottom: 0.25rem;
            color: #333;
        }
        
        .property-preview-info p {
            color: #666;
            font-size: 0.85rem;
        }
        
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .filter-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: #f8f9fa;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* å¡ç‰‡ç¶²æ ¼ä½ˆå±€ */
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .property-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .property-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .property-card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #f0f0f0;
        }
        
        .property-card-placeholder {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 2rem;
        }
        
        .property-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .property-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .property-card-meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        
        .property-card-status {
            margin-bottom: 1rem;
        }
        
        .property-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        
        .property-card-actions .btn {
            flex: 1;
            padding: 0.6rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ  å¾Œå°ç®¡ç†ç³»çµ±</h1>
        <p>ç‰©ä»¶ç®¡ç†ã€ä¸Šä¸‹æ¶æ§åˆ¶ã€é€£çµç®¡ç†</p>
    </div>
    
    <div class="nav">
        <div class="nav-item active" onclick="switchTab('dashboard', this)">ğŸ“Š å„€è¡¨æ¿</div>
        <div class="nav-item" onclick="switchTab('properties', this)">ğŸ˜ï¸ ç‰©ä»¶ç®¡ç†</div>
        <div class="nav-item" onclick="switchTab('duplicates', this)">ğŸ” é‡è¤‡ç‰©ä»¶æª¢æ¸¬</div>
        <div class="nav-item" onclick="switchTab('links', this)">ğŸ”— é€£çµç®¡ç†</div>
    </div>
    
    <div class="container">
        <!-- å„€è¡¨æ¿ -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card primary">
                    <h3>ç¸½ç‰©ä»¶æ•¸</h3>
                    <div class="value" id="stat-total">0</div>
                </div>
                <div class="stat-card success">
                    <h3>å·²ä¸Šæ¶</h3>
                    <div class="value" id="stat-published">0</div>
                </div>
                <div class="stat-card warning">
                    <h3>å·²ä¸‹æ¶</h3>
                    <div class="value" id="stat-unpublished">0</div>
                </div>
                <div class="stat-card danger">
                    <h3>å·²å”®å‡º</h3>
                    <div class="value" id="stat-sold">0</div>
                </div>
            </div>
            
            <div class="content-card">
                <h2>å¿«é€Ÿæ“ä½œ</h2>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="switchTab('properties', document.querySelector('.nav-item:nth-child(2)'))">
                        â• æ–°å¢ç‰©ä»¶
                    </button>
                    <button class="btn btn-success" onclick="switchTab('properties', document.querySelector('.nav-item:nth-child(2)'))">
                        â¬†ï¸ ç®¡ç†ä¸Šä¸‹æ¶
                    </button>
                    <a href="index.html" target="_blank" class="btn btn-secondary">
                        ğŸ‘ï¸ æŸ¥çœ‹å‰å°
                    </a>
                </div>
            </div>
            
            <div class="content-card">
                <h2>æœ€è¿‘æ›´æ–°çš„ç‰©ä»¶</h2>
                <div id="recent-properties">
                    <p style="text-align: center; color: #666; padding: 2rem;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- ç‰©ä»¶ç®¡ç† -->
        <div id="properties-tab" class="tab-content">
            <!-- å­æ¨™ç±¤åˆ‡æ› -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e9ecef;">
                <button class="sub-tab-btn active" onclick="switchPropertySubTab('list', this)" id="property-list-tab">
                    ğŸ“‹ ç‰©ä»¶åˆ—è¡¨
                </button>
                <button class="sub-tab-btn" onclick="switchPropertySubTab('add', this)" id="property-add-tab">
                    â• æ–°å¢ç‰©ä»¶
                </button>
            </div>
            
            <!-- ç‰©ä»¶åˆ—è¡¨å­æ¨™ç±¤ -->
            <div id="property-list-subtab" class="property-subtab active">
                <div class="content-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>ç‰©ä»¶åˆ—è¡¨</h2>
                        <div>
                            <button class="btn btn-secondary" onclick="checkDuplicates()" style="margin-right: 0.5rem;">
                                ğŸ” æª¢æŸ¥é‡è¤‡
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="æœå°‹ç‰©ä»¶ï¼ˆæ¨™é¡Œã€ç·¨è™Ÿã€åœ°å€ï¼‰..." onkeyup="filterProperties()">
                        <select id="type-filter" onchange="filterProperties()">
                            <option value="">æ‰€æœ‰æˆ¿å‹</option>
                            <option value="å¥—æˆ¿">å¥—æˆ¿</option>
                            <option value="2æˆ¿">2æˆ¿</option>
                            <option value="3æˆ¿">3æˆ¿</option>
                            <option value="4æˆ¿">4æˆ¿</option>
                            <option value="è¯å»ˆ">è¯å»ˆ</option>
                            <option value="å…¬å¯“">å…¬å¯“</option>
                            <option value="é€å¤©">é€å¤©</option>
                            <option value="åº—é¢">åº—é¢</option>
                            <option value="åˆ¥å¢…">åˆ¥å¢…</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="filter-buttons" style="margin: 0;">
                            <button class="filter-btn active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
                            <button class="filter-btn" onclick="setFilter('published', this)">å·²ä¸Šæ¶</button>
                            <button class="filter-btn" onclick="setFilter('unpublished', this)">å·²ä¸‹æ¶</button>
                            <button class="filter-btn" onclick="setFilter('sold', this)">å·²å”®å‡º</button>
                            <button class="filter-btn" onclick="setFilter('internal', this)">ğŸ  æœ¬åº—ç‰©ä»¶</button>
                            <button class="filter-btn" onclick="setFilter('external', this)">ğŸ¢ éæœ¬åº—ç‰©ä»¶</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="color: #666; font-size: 0.9rem; margin-right: 0.5rem;">æª¢è¦–æ¨¡å¼ï¼š</span>
                            <button class="filter-btn active" id="view-table-btn" onclick="setViewMode('table', this)" style="padding: 0.4rem 0.8rem;">
                                ğŸ“‹ è¡¨æ ¼
                            </button>
                            <button class="filter-btn" id="view-grid-btn" onclick="setViewMode('grid', this)" style="padding: 0.4rem 0.8rem;">
                                ğŸ´ ç¶²æ ¼
                            </button>
                        </div>
                    </div>
                    
                    <div id="properties-list">
                        <p style="text-align: center; color: #666; padding: 2rem;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
            
            <!-- æ–°å¢ç‰©ä»¶å­æ¨™ç±¤ -->
            <div id="property-add-subtab" class="property-subtab">
                <div class="content-card">
                    <h2>æ–°å¢ç‰©ä»¶</h2>
                    <div id="property-add-alert-container" style="margin-bottom: 1rem;"></div>
                    <div id="property-add-form-container">
                        <p style="text-align: center; color: #666; padding: 2rem;">
                            â³ æ­£åœ¨è¼‰å…¥æ–°å¢è¡¨å–®...
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é‡è¤‡ç‰©ä»¶æª¢æ¸¬ -->
        <div id="duplicates-tab" class="tab-content">
            <div class="content-card">
                <h2>ğŸ” é‡è¤‡ç‰©ä»¶æª¢æ¸¬èˆ‡æ¸…ç†</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">
                    è‡ªå‹•æª¢æ¸¬ä¸¦æ¸…ç†é‡è¤‡çš„ç‰©ä»¶ï¼ˆæ ¹æ“šç‰©ä»¶ç·¨è™Ÿï¼‰ã€‚ç³»çµ±æœƒä¿ç•™æœ€æ–°å»ºç«‹çš„ç‰©ä»¶ï¼Œåˆªé™¤è¼ƒèˆŠçš„é‡è¤‡é …ç›®ã€‚
                </p>
                
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="checkDuplicates()">
                        ğŸ” é–‹å§‹æª¢æ¸¬é‡è¤‡ç‰©ä»¶
                    </button>
                    <button class="btn btn-danger" onclick="cleanDuplicates()" id="clean-btn" style="display: none; margin-left: 0.5rem;">
                        ğŸ—‘ï¸ æ¸…ç†é‡è¤‡ç‰©ä»¶
                    </button>
                </div>
                
                <div id="duplicates-result">
                    <p style="text-align: center; color: #666; padding: 2rem;">é»æ“Šã€Œé–‹å§‹æª¢æ¸¬ã€ä¾†æª¢æŸ¥é‡è¤‡ç‰©ä»¶</p>
                </div>
            </div>
        </div>
        
        <!-- é€£çµç®¡ç† -->
        <div id="links-tab" class="tab-content">
            <div class="content-card">
                <h2>é€£çµç®¡ç†</h2>
                <p style="color: #666; margin-bottom: 1rem;">
                    ç®¡ç†ç¶²ç«™ç›¸é—œé€£çµå’Œè¨­å®šã€‚
                </p>
                
                <div class="form-group">
                    <label>å‰å°é¦–é é€£çµ</label>
                    <input type="text" id="frontend-link" value="index.html" readonly>
                    <a href="index.html" target="_blank" class="btn btn-secondary btn-small" style="margin-top: 0.5rem;">é–‹å•Ÿå‰å°</a>
                </div>
                
                
                <div class="form-group">
                    <label>Supabase Dashboard é€£çµ</label>
                    <input type="text" id="supabase-link" value="https://supabase.com/dashboard/project/cnzqtuuegdqwkgvletaa" readonly>
                    <a href="https://supabase.com/dashboard/project/cnzqtuuegdqwkgvletaa" target="_blank" class="btn btn-secondary btn-small" style="margin-top: 0.5rem;">é–‹å•Ÿ Supabase</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // HTML è½‰ç¾©å‡½æ•¸ï¼ˆé˜²æ­¢ XSSï¼‰
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        // Supabase è¨­å®š
        const SUPABASE_URL = 'https://cnzqtuuegdqwkgvletaa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuenF0dXVlZ2Rxd2tndmxldGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjUxMTksImV4cCI6MjA4MzcwMTExOX0.gsO3RKdMu2bUXW4b5aHseouIkjXtJyIqqP_0x3Y6trE';
        
        let supabaseClient = null;
        let allProperties = [];
        let currentFilter = 'all';
        let viewMode = 'table'; // 'table' æˆ– 'grid'
        
        // èƒŒæ™¯åˆ·æ–°é–“éš”ï¼ˆ30åˆ†é˜ï¼‰
        const REFRESH_INTERVAL = 30 * 60 * 1000; // 30åˆ†é˜ = 1800000 æ¯«ç§’
        let refreshTimer = null;
        
        // èƒŒæ™¯è‡ªå‹•åˆ·æ–°å‡½æ•¸
        function startBackgroundRefresh() {
            // æ¸…é™¤ç¾æœ‰çš„å®šæ™‚å™¨
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            
            // è¨­ç½®æ–°çš„å®šæ™‚å™¨ï¼šæ¯30åˆ†é˜åˆ·æ–°ä¸€æ¬¡
            refreshTimer = setInterval(() => {
                // åªåœ¨é é¢å¯è¦‹æ™‚æ‰åˆ·æ–°ï¼ˆä½¿ç”¨ Page Visibility APIï¼‰
                if (!document.hidden) {
                    refreshCurrentTab();
                }
            }, REFRESH_INTERVAL);
            
            console.log('âœ… èƒŒæ™¯è‡ªå‹•åˆ·æ–°å·²å•Ÿå‹•ï¼ˆæ¯30åˆ†é˜ï¼‰');
        }
        
        // åˆ·æ–°ç•¶å‰æ´»å‹•çš„æ¨™ç±¤é 
        function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;
            
            const tabId = activeTab.id;
            console.log('ğŸ”„ èƒŒæ™¯åˆ·æ–°ï¼š', tabId);
            
            if (tabId === 'dashboard-tab') {
                // åˆ·æ–°å„€è¡¨æ¿
                loadDashboard();
            } else if (tabId === 'properties-tab') {
                // åˆ·æ–°ç‰©ä»¶ç®¡ç†ï¼ˆå¦‚æœåˆ—è¡¨å­æ¨™ç±¤æ˜¯æ´»å‹•çš„ï¼‰
                if (document.getElementById('property-list-subtab')?.classList.contains('active')) {
                    loadProperties();
                }
            }
            // å…¶ä»–æ¨™ç±¤é ä¸éœ€è¦è‡ªå‹•åˆ·æ–°
        }
        
        // åˆå§‹åŒ–
        function init() {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            loadDashboard();
            
            // å•Ÿå‹•èƒŒæ™¯è‡ªå‹•åˆ·æ–°
            startBackgroundRefresh();
            
            // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼ˆç•¶ç”¨æˆ¶åˆ‡æ›æ¨™ç±¤é æ™‚ï¼‰
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // é é¢è®Šç‚ºå¯è¦‹æ™‚ï¼Œç«‹å³åˆ·æ–°ä¸€æ¬¡
                    refreshCurrentTab();
                }
            });
            
            // äº‹ä»¶å§”æ´¾ï¼šè™•ç†å‹•æ…‹ç”Ÿæˆçš„æŒ‰éˆ•é»æ“Š
            document.addEventListener('click', function(e) {
                const button = e.target.closest('[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const propertyId = button.dataset.propertyId;
                
                if (!propertyId) return;
                
                switch (action) {
                    case 'toggle':
                        const newStatus = button.dataset.status === 'true';
                        togglePublish(propertyId, newStatus);
                        break;
                    case 'edit':
                        editProperty(propertyId);
                        break;
                    case 'delete':
                        deleteProperty(propertyId);
                        break;
                }
            });
        }
        
        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabName, element) {
            // æ›´æ–°å°èˆª
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // æ›´æ–°å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'properties') {
                // å¦‚æœåˆ‡æ›åˆ°ç‰©ä»¶ç®¡ç†æ¨™ç±¤ï¼Œè¼‰å…¥åˆ—è¡¨ï¼ˆå¦‚æœåˆ—è¡¨å­æ¨™ç±¤æ˜¯æ´»å‹•çš„ï¼‰
                if (document.getElementById('property-list-subtab').classList.contains('active')) {
                    loadProperties();
                } else {
                    loadPropertyAddForm();
                }
            } else if (tabName === 'duplicates') {
                // é‡è¤‡ç‰©ä»¶æª¢æ¸¬é é¢å·²è¼‰å…¥ï¼Œç­‰å¾…ç”¨æˆ¶é»æ“Šæª¢æ¸¬
            }
        }
        
        // åˆ‡æ›ç‰©ä»¶ç®¡ç†çš„å­æ¨™ç±¤
        function switchPropertySubTab(subTabName, element) {
            // æ›´æ–°å­æ¨™ç±¤æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            
            // æ›´æ–°å­æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.property-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (subTabName === 'list') {
                document.getElementById('property-list-subtab').classList.add('active');
                loadProperties();
            } else if (subTabName === 'add') {
                document.getElementById('property-add-subtab').classList.add('active');
                loadPropertyAddForm();
            }
        }
        
        // è¼‰å…¥æ–°å¢ç‰©ä»¶è¡¨å–®
        function loadPropertyAddForm() {
            const container = document.getElementById('property-add-form-container');
            if (!container) return;
            
            // å¦‚æœå·²ç¶“è¼‰å…¥éï¼Œç›´æ¥è¿”å›
            if (container.dataset.loaded === 'true') {
                return;
            }
            
            // ä½¿ç”¨ iframe è¼‰å…¥ property-admin-db.html çš„æ–°å¢è¡¨å–®é é¢
            // é€™æ¨£å¯ä»¥ä¿æŒæ‰€æœ‰åŠŸèƒ½å®Œæ•´ï¼ŒåŒ…æ‹¬åœ–ç‰‡ä¸Šå‚³ç­‰
            container.innerHTML = `
                <iframe 
                    id="property-add-iframe" 
                    src="property-admin-db.html?tab=add" 
                    style="width: 100%; min-height: 800px; border: none; border-radius: 8px;"
                    onload="adjustIframeHeight()">
                </iframe>
            `;
            
            container.dataset.loaded = 'true';
        }
        
        // èª¿æ•´ iframe é«˜åº¦
        function adjustIframeHeight() {
            const iframe = document.getElementById('property-add-iframe');
            if (iframe && iframe.contentWindow) {
                try {
                    const height = iframe.contentWindow.document.body.scrollHeight;
                    iframe.style.height = Math.max(height, 800) + 'px';
                } catch (e) {
                    // è·¨åŸŸé™åˆ¶ï¼Œä½¿ç”¨å›ºå®šé«˜åº¦
                    iframe.style.height = '1200px';
                }
            }
        }
        
        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('updated_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                // æ›´æ–°çµ±è¨ˆ
                updateStats();
                
                // é¡¯ç¤ºæœ€è¿‘ç‰©ä»¶
                const recentDiv = document.getElementById('recent-properties');
                if (data && data.length > 0) {
                    recentDiv.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ç‰©ä»¶</th>
                                    <th>æˆ¿å‹</th>
                                    <th>åƒ¹æ ¼</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ›´æ–°æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(prop => {
                                    const images = Array.isArray(prop.images) ? prop.images : [];
                                    const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                                    const publishedBadge = prop.is_published 
                                        ? '<span class="badge badge-success">å·²ä¸Šæ¶</span>' 
                                        : '<span class="badge badge-danger">å·²ä¸‹æ¶</span>';
                                    
                                    return `
                                        <tr>
                                            <td>
                                                <div class="property-preview">
                                                    ${imgUrl ? `<img src="${imgUrl}" alt="${prop.title}">` : '<div style="width:80px;height:60px;background:#f0f0f0;border-radius:6px;"></div>'}
                                                    <div class="property-preview-info">
                                                        <h4>${prop.title || 'æœªå‘½å'}</h4>
                                                        <p>${prop.number || 'N/A'}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${prop.type || 'N/A'}</td>
                                            <td>${prop.price || 'N/A'}</td>
                                            <td>${publishedBadge}</td>
                                            <td>${new Date(prop.updated_at).toLocaleString('zh-TW')}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    recentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">ç›®å‰æ²’æœ‰ç‰©ä»¶</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', error);
                document.getElementById('recent-properties').innerHTML = 
                    `<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        }
        
        // æ›´æ–°çµ±è¨ˆ
        async function updateStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('is_published, status, is_external');
                
                if (error) throw error;
                
                const total = data.length;
                const published = data.filter(p => p.is_published).length;
                const unpublished = data.filter(p => !p.is_published).length;
                const sold = data.filter(p => p.status === 'sold').length;
                const internal = data.filter(p => !p.is_external || p.is_external === false).length;
                const external = data.filter(p => p.is_external === true || p.is_external === 'true').length;
                
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-published').textContent = published;
                document.getElementById('stat-unpublished').textContent = unpublished;
                document.getElementById('stat-sold').textContent = sold;
                
                // è¨˜éŒ„çµ±è¨ˆè³‡è¨Šï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
                console.log('ğŸ“Š ç‰©ä»¶çµ±è¨ˆ:', {
                    total,
                    published,
                    unpublished,
                    sold,
                    internal,
                    external
                });
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
            }
        }
        
        // è¼‰å…¥ç‰©ä»¶åˆ—è¡¨
        async function loadProperties() {
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allProperties = data || [];
                renderProperties();
            } catch (error) {
                console.error('è¼‰å…¥ç‰©ä»¶å¤±æ•—:', error);
                document.getElementById('properties-list').innerHTML = 
                    `<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“ç‰©ä»¶åˆ—è¡¨
        function renderProperties() {
            let filtered = allProperties;
            
            // æ‡‰ç”¨ç¯©é¸
            if (currentFilter === 'published') {
                filtered = filtered.filter(p => p.is_published);
            } else if (currentFilter === 'unpublished') {
                filtered = filtered.filter(p => !p.is_published);
            } else if (currentFilter === 'sold') {
                filtered = filtered.filter(p => p.status === 'sold');
            } else if (currentFilter === 'internal') {
                // ç¯©é¸æœ¬åº—ç‰©ä»¶
                filtered = filtered.filter(p => !p.is_external || p.is_external === false);
            } else if (currentFilter === 'external') {
                // ç¯©é¸éæœ¬åº—ç‰©ä»¶
                filtered = filtered.filter(p => p.is_external === true || p.is_external === 'true');
            }
            
            // æ‡‰ç”¨æœå°‹
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    (p.title && p.title.toLowerCase().includes(searchTerm)) ||
                    (p.number && p.number.toLowerCase().includes(searchTerm)) ||
                    (p.address && p.address.toLowerCase().includes(searchTerm))
                );
            }
            
            if (typeFilter) {
                filtered = filtered.filter(p => p.type === typeFilter);
            }
            
            // æ’åºï¼šå„ªå…ˆé¡¯ç¤ºå·²ä¸Šæ¶çš„ç‰©ä»¶ï¼Œç„¶å¾Œæ˜¯å·²ä¸‹æ¶çš„ç‰©ä»¶
            // åœ¨ç›¸åŒç‹€æ…‹å…§ï¼ŒæŒ‰æ›´æ–°æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            filtered.sort((a, b) => {
                // å…ˆæŒ‰ä¸Šæ¶ç‹€æ…‹æ’åºï¼šå·²ä¸Šæ¶ï¼ˆtrueï¼‰åœ¨å‰ï¼Œå·²ä¸‹æ¶ï¼ˆfalseï¼‰åœ¨å¾Œ
                if (a.is_published !== b.is_published) {
                    // å¦‚æœ a å·²ä¸Šæ¶ä¸” b å·²ä¸‹æ¶ï¼Œa æ’å‰é¢ï¼ˆè¿”å›è² æ•¸ï¼‰
                    // å¦‚æœ a å·²ä¸‹æ¶ä¸” b å·²ä¸Šæ¶ï¼Œa æ’å¾Œé¢ï¼ˆè¿”å›æ­£æ•¸ï¼‰
                    return (b.is_published ? 1 : 0) - (a.is_published ? 1 : 0);
                }
                
                // ç›¸åŒç‹€æ…‹å…§ï¼ŒæŒ‰æ›´æ–°æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                const dateA = a.updated_at ? new Date(a.updated_at) : new Date(a.created_at || 0);
                const dateB = b.updated_at ? new Date(b.updated_at) : new Date(b.created_at || 0);
                return dateB - dateA;
            });
            
            const listDiv = document.getElementById('properties-list');
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">æ²’æœ‰æ‰¾åˆ°ç‰©ä»¶</p>';
                return;
            }
            
            // æ ¹æ“šè¦–åœ–æ¨¡å¼é¡¯ç¤º
            if (viewMode === 'grid') {
                // ç¶²æ ¼æ¨¡å¼
                listDiv.innerHTML = `
                    <div class="property-grid">
                        ${filtered.map(prop => {
                            const images = Array.isArray(prop.images) ? prop.images : [];
                            const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                            const publishedBadge = prop.is_published 
                                ? '<span class="badge badge-success">âœ… å·²ä¸Šæ¶</span>' 
                                : '<span class="badge badge-danger">âŒ å·²ä¸‹æ¶</span>';
                            
                            const isExternal = prop.is_external === true || prop.is_external === 'true';
                            const sourceBadge = isExternal 
                                ? '<span class="badge" style="background: #ff9800; color: white; margin-bottom: 0.5rem; display: inline-block;">ğŸ¢ éæœ¬åº—</span>' 
                                : '<span class="badge" style="background: #28a745; color: white; margin-bottom: 0.5rem; display: inline-block;">ğŸ  æœ¬åº—</span>';
                            
                            const isPublished = prop.is_published;
                            
                            // è½‰ç¾© HTML ä»¥é˜²æ­¢ XSS
                            const safeTitle = escapeHtml(prop.title || 'æœªå‘½åç‰©ä»¶');
                            const safeNumber = escapeHtml(prop.number || 'N/A');
                            const safeType = escapeHtml(prop.type || 'N/A');
                            const safePrice = escapeHtml(prop.price || 'N/A');
                            const safeAddress = prop.address ? escapeHtml(prop.address.substring(0, 30)) + (prop.address.length > 30 ? '...' : '') : '';
                            const safeId = escapeHtml(prop.id);
                            const safeImgUrl = imgUrl ? escapeHtml(imgUrl) : '';
                            
                            return `
                                <div class="property-card">
                                    ${safeImgUrl 
                                        ? `<img src="${safeImgUrl}" alt="${safeTitle}" class="property-card-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                                        : ''
                                    }
                                    <div class="property-card-placeholder" ${imgUrl ? 'style="display:none;"' : ''}>
                                        ğŸ 
                                    </div>
                                    <div class="property-card-content">
                                        <h3 class="property-card-title">${safeTitle}</h3>
                                        <div class="property-card-meta">
                                            <div><strong>ç·¨è™Ÿï¼š</strong>${safeNumber}</div>
                                            <div><strong>æˆ¿å‹ï¼š</strong>${safeType}</div>
                                            <div><strong>åƒ¹æ ¼ï¼š</strong>${safePrice}</div>
                                            ${safeAddress ? `<div><strong>åœ°å€ï¼š</strong>${safeAddress}</div>` : ''}
                                        </div>
                                        <div class="property-card-status" style="margin-bottom: 0.75rem;">
                                            ${sourceBadge} ${publishedBadge}
                                        </div>
                                        <div class="property-card-actions">
                                            <button class="btn ${isPublished ? 'btn-danger' : 'btn-success'}" 
                                                    data-property-id="${safeId}" 
                                                    data-action="toggle" 
                                                    data-status="${!isPublished}"
                                                    style="font-size: 0.85rem;">
                                                ${isPublished ? 'â¬‡ï¸ ä¸‹æ¶' : 'â¬†ï¸ ä¸Šæ¶'}
                                            </button>
                                            <button class="btn btn-secondary" 
                                                    data-property-id="${safeId}" 
                                                    data-action="edit"
                                                    style="font-size: 0.85rem;">
                                                âœï¸ ç·¨è¼¯
                                            </button>
                                            <button class="btn btn-danger" 
                                                    data-property-id="${safeId}" 
                                                    data-action="delete"
                                                    style="font-size: 0.85rem;">
                                                ğŸ—‘ï¸ åˆªé™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                // è¡¨æ ¼æ¨¡å¼
                listDiv.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ç‰©ä»¶</th>
                                <th>ä¾†æº</th>
                                <th>æˆ¿å‹</th>
                                <th>åƒ¹æ ¼</th>
                                <th>ä¸Šæ¶ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(prop => {
                                const images = Array.isArray(prop.images) ? prop.images : [];
                                const imgUrl = images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : '';
                                const publishedBadge = prop.is_published 
                                    ? '<span class="badge badge-success">å·²ä¸Šæ¶</span>' 
                                    : '<span class="badge badge-danger">å·²ä¸‹æ¶</span>';
                                
                                // ç‰©ä»¶ä¾†æºæ¨™ç±¤
                                const isExternal = prop.is_external === true || prop.is_external === 'true';
                                const sourceBadge = isExternal 
                                    ? '<span class="badge" style="background: #ff9800; color: white;">ğŸ¢ éæœ¬åº—</span>' 
                                    : '<span class="badge" style="background: #28a745; color: white;">ğŸ  æœ¬åº—</span>';
                                
                                // è½‰ç¾© HTML ä»¥é˜²æ­¢ XSS
                                const safeTitle = escapeHtml(prop.title || 'æœªå‘½å');
                                const safeNumber = escapeHtml(prop.number || 'N/A');
                                const safeAddress = escapeHtml(prop.address || 'N/A');
                                const safeType = escapeHtml(prop.type || 'N/A');
                                const safePrice = escapeHtml(prop.price || 'N/A');
                                const safeId = escapeHtml(prop.id);
                                const safeImgUrl = imgUrl ? escapeHtml(imgUrl) : '';
                                const isPublished = prop.is_published;
                                
                                return `
                                    <tr>
                                        <td>
                                            <div class="property-preview">
                                                ${safeImgUrl ? `<img src="${safeImgUrl}" alt="${safeTitle}">` : '<div style="width:80px;height:60px;background:#f0f0f0;border-radius:6px;"></div>'}
                                                <div class="property-preview-info">
                                                    <h4>${safeTitle}</h4>
                                                    <p>${safeNumber} | ${safeAddress}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${sourceBadge}</td>
                                        <td>${safeType}</td>
                                        <td>${safePrice}</td>
                                        <td>${publishedBadge}</td>
                                        <td>
                                            <button class="btn btn-small ${isPublished ? 'btn-danger' : 'btn-success'}" 
                                                    data-property-id="${safeId}" 
                                                    data-action="toggle" 
                                                    data-status="${!isPublished}">
                                                ${isPublished ? 'â¬‡ï¸ ä¸‹æ¶' : 'â¬†ï¸ ä¸Šæ¶'}
                                            </button>
                                            <button class="btn btn-secondary btn-small" 
                                                    data-property-id="${safeId}" 
                                                    data-action="edit">
                                                âœï¸ ç·¨è¼¯
                                            </button>
                                            <button class="btn btn-danger btn-small" 
                                                    data-property-id="${safeId}" 
                                                    data-action="delete">
                                                ğŸ—‘ï¸ åˆªé™¤
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
        
        // è¨­å®šç¯©é¸
        function setFilter(filter, element) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            renderProperties();
        }
        
        // è¨­å®šè¦–åœ–æ¨¡å¼
        function setViewMode(mode, element) {
            viewMode = mode;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const tableBtn = document.getElementById('view-table-btn');
            const gridBtn = document.getElementById('view-grid-btn');
            if (tableBtn) tableBtn.classList.remove('active');
            if (gridBtn) gridBtn.classList.remove('active');
            if (element) element.classList.add('active');
            
            // é‡æ–°æ¸²æŸ“
            renderProperties();
        }
        
        // æœå°‹å’Œç¯©é¸
        function filterProperties() {
            renderProperties();
        }
        
        // åˆ‡æ›ä¸Šæ¶ç‹€æ…‹ï¼ˆå„ªåŒ–ç‰ˆï¼šæ¸›å°‘å»¶é²ï¼‰
        async function togglePublish(id, newStatus) {
            try {
                // å…ˆæ›´æ–°æœ¬åœ°è³‡æ–™ï¼ˆç«‹å³åé¥‹ï¼‰
                const prop = allProperties.find(p => p.id === id);
                if (prop) {
                    prop.is_published = newStatus;
                }
                
                // ç«‹å³æ›´æ–° UIï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
                renderProperties();
                updateStats();
                
                // ç•°æ­¥æ›´æ–°è³‡æ–™åº«
                const { error } = await supabaseClient
                    .from('properties')
                    .update({ is_published: newStatus })
                    .eq('id', id);
                
                if (error) {
                    // å¦‚æœå¤±æ•—ï¼Œæ¢å¾©åŸç‹€æ…‹
                    if (prop) {
                        prop.is_published = !newStatus;
                    }
                    renderProperties();
                    updateStats();
                    throw error;
                }
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showAlert('success', newStatus ? 'ç‰©ä»¶å·²ä¸Šæ¶ï¼' : 'ç‰©ä»¶å·²ä¸‹æ¶ï¼');
            } catch (error) {
                console.error('åˆ‡æ›ç‹€æ…‹å¤±æ•—:', error);
                showAlert('error', `æ“ä½œå¤±æ•—ï¼š${error.message}`);
            }
        }
        
        
        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // ç·¨è¼¯ç‰©ä»¶
        function editProperty(id) {
            // åˆ‡æ›åˆ°ç‰©ä»¶ç®¡ç†æ¨™ç±¤çš„æ–°å¢å­æ¨™ç±¤ï¼Œä¸¦è¼‰å…¥ç·¨è¼¯è¡¨å–®
            const propertiesTab = document.querySelector('.nav-item[onclick*="properties"]');
            if (propertiesTab) {
                switchTab('properties', propertiesTab);
                
                // åˆ‡æ›åˆ°æ–°å¢å­æ¨™ç±¤
                setTimeout(() => {
                    const addSubTab = document.getElementById('property-add-tab');
                    if (addSubTab) {
                        switchPropertySubTab('add', addSubTab);
                        
                        // è¼‰å…¥ç·¨è¼¯è¡¨å–®ï¼ˆé€šé iframeï¼‰
                        setTimeout(() => {
                            const iframe = document.getElementById('property-add-iframe');
                            if (iframe) {
                                iframe.src = `property-admin-db.html?tab=add&id=${id}`;
                            } else {
                                // å¦‚æœ iframe é‚„æ²’è¼‰å…¥ï¼Œé‡æ–°è¼‰å…¥è¡¨å–®
                                loadPropertyAddForm();
                                setTimeout(() => {
                                    const newIframe = document.getElementById('property-add-iframe');
                                    if (newIframe) {
                                        newIframe.src = `property-admin-db.html?tab=add&id=${id}`;
                                    }
                                }, 500);
                            }
                        }, 300);
                    }
                }, 100);
            }
        }
        
        // é¡¯ç¤ºç¢ºèªå½ˆè·³è¦–çª—
        function showConfirmModal(options) {
            return new Promise((resolve) => {
                const {
                    title = 'ç¢ºèªæ“ä½œ',
                    message = 'ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ',
                    icon = 'warning',
                    confirmText = 'ç¢ºå®š',
                    cancelText = 'å–æ¶ˆ',
                    confirmClass = 'modal-btn-danger'
                } = options;
                
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const iconEmoji = icon === 'danger' ? 'âš ï¸' : 'â“';
                const iconClass = icon === 'danger' ? 'danger' : 'warning';
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-icon ${iconClass}">${iconEmoji}</div>
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn modal-btn-cancel" onclick="this.closest('.modal-overlay').remove(); arguments[0].stopPropagation();">${cancelText}</button>
                            <button class="modal-btn ${confirmClass}" onclick="this.closest('.modal-overlay').remove(); arguments[0].stopPropagation();">${confirmText}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // è™•ç†ç¢ºèªæŒ‰éˆ•
                const confirmBtn = overlay.querySelector(`.${confirmClass}`);
                confirmBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                // è™•ç†å–æ¶ˆæŒ‰éˆ•
                const cancelBtn = overlay.querySelector('.modal-btn-cancel');
                cancelBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                // è™•ç† ESC éµ
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // é»æ“ŠèƒŒæ™¯é—œé–‰
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                });
            });
        }
        
        // åˆªé™¤ç‰©ä»¶
        async function deleteProperty(id) {
            // å…ˆå–å¾—ç‰©ä»¶è³‡è¨Šä»¥é¡¯ç¤ºåœ¨ç¢ºèªè¦–çª—ä¸­
            let propertyInfo = '';
            try {
                const { data: prop } = await supabaseClient
                    .from('properties')
                    .select('title, number')
                    .eq('id', id)
                    .single();
                
                if (prop) {
                    propertyInfo = `<strong>${prop.title || prop.number || 'æ­¤ç‰©ä»¶'}</strong>`;
                }
            } catch (e) {
                // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒé¡¯ç¤ºç¢ºèªè¦–çª—
            }
            
            const confirmed = await showConfirmModal({
                title: 'åˆªé™¤ç‰©ä»¶',
                message: `ç¢ºå®šè¦åˆªé™¤ ${propertyInfo || 'æ­¤ç‰©ä»¶'} å—ï¼Ÿ<br><br>æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œã€‚`,
                icon: 'danger',
                confirmText: 'ğŸ—‘ï¸ åˆªé™¤',
                cancelText: 'å–æ¶ˆ'
            });
            
            if (!confirmed) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showAlert('success', 'ç‰©ä»¶å·²åˆªé™¤ï¼');
                
                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                loadProperties();
                loadDashboard();
                updateStats();
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                showAlert('error', `åˆªé™¤å¤±æ•—ï¼š${error.message}`);
            }
        }
        
        // æª¢æŸ¥é‡è¤‡ç‰©ä»¶
        let duplicateGroups = [];
        
        async function checkDuplicates() {
            try {
                showAlert('info', 'æ­£åœ¨æª¢æ¸¬é‡è¤‡ç‰©ä»¶...');
                
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // æ ¹æ“š number æ¬„ä½åˆ†çµ„
                const numberGroups = {};
                data.forEach(prop => {
                    const number = prop.number;
                    if (!number) return;
                    
                    if (!numberGroups[number]) {
                        numberGroups[number] = [];
                    }
                    numberGroups[number].push(prop);
                });
                
                // æ‰¾å‡ºé‡è¤‡çš„ç‰©ä»¶
                duplicateGroups = Object.values(numberGroups).filter(group => group.length > 1);
                
                const resultDiv = document.getElementById('duplicates-result');
                const cleanBtn = document.getElementById('clean-btn');
                
                if (duplicateGroups.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡ç‰©ä»¶ï¼æ‰€æœ‰ç‰©ä»¶ç·¨è™Ÿéƒ½æ˜¯å”¯ä¸€çš„ã€‚
                        </div>
                    `;
                    cleanBtn.style.display = 'none';
                } else {
                    let totalDuplicates = 0;
                    duplicateGroups.forEach(group => {
                        totalDuplicates += group.length - 1; // æ¸›å»ä¿ç•™çš„ä¸€å€‹
                    });
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            âš ï¸ ç™¼ç¾ ${duplicateGroups.length} çµ„é‡è¤‡ç‰©ä»¶ï¼Œå…± ${totalDuplicates} å€‹é‡è¤‡é …ç›®éœ€è¦æ¸…ç†ã€‚
                        </div>
                        <table class="table" style="margin-top: 1rem;">
                            <thead>
                                <tr>
                                    <th>ç‰©ä»¶ç·¨è™Ÿ</th>
                                    <th>é‡è¤‡æ•¸é‡</th>
                                    <th>ç‰©ä»¶åˆ—è¡¨</th>
                                    <th>å°‡ä¿ç•™</th>
                                    <th>å°‡åˆªé™¤</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${duplicateGroups.map(group => {
                                    // æŒ‰å»ºç«‹æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                                    group.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                                    const keep = group[0]; // ä¿ç•™æœ€æ–°çš„
                                    const toDelete = group.slice(1); // åˆªé™¤å…¶ä»–çš„
                                    
                                    return `
                                        <tr>
                                            <td><strong>${keep.number}</strong></td>
                                            <td><span class="badge badge-warning">${group.length} å€‹</span></td>
                                            <td>
                                                ${group.map(p => `
                                                    <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                                        <strong>${p.title || 'æœªå‘½å'}</strong><br>
                                                        <small>ID: ${p.id.substring(0, 8)}... | å»ºç«‹: ${new Date(p.created_at).toLocaleString('zh-TW')}</small>
                                                    </div>
                                                `).join('')}
                                            </td>
                                            <td>
                                                <span class="badge badge-success">âœ… ${keep.title || 'æœªå‘½å'}</span><br>
                                                <small>${new Date(keep.created_at).toLocaleString('zh-TW')}</small>
                                            </td>
                                            <td>
                                                ${toDelete.map(p => `
                                                    <div style="margin-bottom: 0.25rem;">
                                                        <span class="badge badge-danger">ğŸ—‘ï¸ ${p.title || 'æœªå‘½å'}</span><br>
                                                        <small>${new Date(p.created_at).toLocaleString('zh-TW')}</small>
                                                    </div>
                                                `).join('')}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    cleanBtn.style.display = 'inline-block';
                }
                
                showAlert('success', 'æª¢æ¸¬å®Œæˆï¼');
            } catch (error) {
                console.error('æª¢æ¸¬å¤±æ•—:', error);
                showAlert('error', `æª¢æ¸¬å¤±æ•—ï¼š${error.message}`);
                document.getElementById('duplicates-result').innerHTML = 
                    `<div class="alert alert-error">æª¢æ¸¬å¤±æ•—ï¼š${error.message}</div>`;
            }
        }
        
        // æ¸…ç†é‡è¤‡ç‰©ä»¶
        async function cleanDuplicates() {
            if (duplicateGroups.length === 0) {
                showAlert('warning', 'æ²’æœ‰é‡è¤‡ç‰©ä»¶éœ€è¦æ¸…ç†');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦æ¸…ç† ${duplicateGroups.length} çµ„é‡è¤‡ç‰©ä»¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            try {
                showAlert('info', 'æ­£åœ¨æ¸…ç†é‡è¤‡ç‰©ä»¶...');
                
                let deletedCount = 0;
                const idsToDelete = [];
                
                // æ”¶é›†æ‰€æœ‰è¦åˆªé™¤çš„ç‰©ä»¶ ID
                duplicateGroups.forEach(group => {
                    // æŒ‰å»ºç«‹æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                    group.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    const toDelete = group.slice(1); // åˆªé™¤é™¤äº†æœ€æ–°ä¹‹å¤–çš„æ‰€æœ‰
                    toDelete.forEach(prop => {
                        idsToDelete.push(prop.id);
                    });
                });
                
                // æ‰¹æ¬¡åˆªé™¤
                if (idsToDelete.length > 0) {
                    for (const id of idsToDelete) {
                        const { error } = await supabaseClient
                            .from('properties')
                            .delete()
                            .eq('id', id);
                        
                        if (error) {
                            console.error(`åˆªé™¤ç‰©ä»¶ ${id} å¤±æ•—:`, error);
                        } else {
                            deletedCount++;
                        }
                    }
                }
                
                showAlert('success', `æˆåŠŸæ¸…ç† ${deletedCount} å€‹é‡è¤‡ç‰©ä»¶ï¼`);
                
                // é‡æ–°æª¢æ¸¬
                duplicateGroups = [];
                document.getElementById('clean-btn').style.display = 'none';
                await checkDuplicates();
                
                // æ›´æ–°å…¶ä»–é é¢
                loadProperties();
                loadDashboard();
                updateStats();
            } catch (error) {
                console.error('æ¸…ç†å¤±æ•—:', error);
                showAlert('error', `æ¸…ç†å¤±æ•—ï¼š${error.message}`);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>

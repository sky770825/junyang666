# 模組化注意事項

本文件整理目前模組化架構下已處理與需留意的事項，方便後續維護。

---

## 一、已修正項目

### 1. property-detail 頁的腳本載入時序
- **問題**：`supabase-config.js` 與 `modules/related-links/frontend.js` 由 `property-detail.js` 動態注入，若 `DOMContentLoaded` 先於 config 載入完成，會有用到未定義設定的風險。
- **處理**：改為在 `property-detail.html` 中依序寫入：
  - `supabase-config.js`（緊接 Supabase SDK 之後）
  - `modules/related-links/frontend.js`
  - `js/property-detail.js`
- **結果**：config 與相關連結模組在執行詳情頁邏輯前已載入，不再依賴動態注入時序；`property-detail.js` 內對應的動態載入程式已移除。

---

## 二、各頁面腳本依賴關係（建議順序）

| 頁面 | 必要腳本順序 | 說明 |
|------|----------------|------|
| **index.html** | Supabase SDK → supabase-config → client-cache → query-client → image-optimizer → async-utils → supabase-data-loader → related-links/frontend → api-data-loader → property-modals → utils / lightbox / map-modal / tiktok-modal / loan-calculator → pagination-system → main-script → index-init | 首頁：資料載入與分頁依賴 `embeddedPropertiesData`；main-script 負責分頁初始化與事件。 |
| **property-detail.html** | Supabase SDK → supabase-config → client-cache → query-client → image-optimizer → related-links/frontend → property-detail | 詳情頁：不載入分頁、main-script、api-data-loader、supabase-data-loader。 |
| **admin-dashboard.html** | Supabase SDK → qrcode-loader → supabase-config → related-links/backend → dashboard.js | 後台：僅需 Supabase 與相關連結後端邏輯。 |

---

## 三、全域依賴（模組間契約）

以下為各腳本共用的全域名稱，修改或抽換時需一併檢查：

- **`embeddedPropertiesData`**：由 `supabase-data-loader.js`、`api-data-loader.js` 寫入；`pagination-system.js`、`main-script.js` 讀取。
- **`embeddedPaginationSystem` / `window.paginationSystem`**：由 `main-script.js` 建立並賦值；`api-data-loader.js` 的 `refreshPaginationSystem()` 會使用。
- **`SUPABASE_CONFIG`、`createSupabaseClient`**：由 `supabase-config.js` 提供；`supabase-data-loader.js`、`api-data-loader.js`、`property-detail.js`、`js/admin/dashboard.js` 使用。
- **自訂事件**：`supabaseDataLoaded`、`apiDataLoaded`、`needPaginationInit`、`dataQueryUpdated`、`relatedLinksScriptLoaded` 等，發送與監聽處需保持一致。

---

## 四、需留意／可選改進

### 1. 重複邏輯（維護時需同步）
- **`formatAddressForDisplay`**：出現在 `supabase-data-loader.js` 與 `js/property-detail.js`，邏輯需手動保持一致。若日後要單一來源，可抽到 `js/lib/utils.js` 或共用的 `js/lib/address-format.js`。
- **Supabase 備用 URL/Key**：`supabase-data-loader.js`、`property-detail.js`、`js/admin/dashboard.js` 內皆有備用設定，若 `supabase-config.js` 換環境，需一併檢查這些備用值或改為單一來源。

### 2. 僅在首頁執行的邏輯
- **main-script.js**：內含 `pageshow`（bfcache 還原篩選）、`needPaginationInit`、`supabaseDataLoaded`、`apiDataLoaded`、輪播、下拉選單等，僅在 index 使用；其他頁未載入 main-script，不會執行。
- **pagination-system.js**：僅在 index 載入；詳情頁、後台不載入，無需特別判斷頁面。

### 3. 子目錄部署
- 若將 `property-detail.html` 放在子目錄（例如 `xxx/property-detail.html`），目前寫死的 `supabase-config.js`、`modules/related-links/frontend.js` 會依相對路徑解析。若專案根與子目錄結構不同，需改為 `../supabase-config.js` 或依部署結構調整路徑／base 標籤。

### 4. 錯誤處理與除錯
- 多處使用 `console.log` / `console.warn`，上線前可依環境變數或建置步驟包一層，僅在開發環境輸出。
- 分頁初始化、資料載入失敗時已有基本錯誤處理；若需統一錯誤回報（例如送 log 到後端），可集中由一個小模組處理。

### 5. 無障礙與語意
- 篩選區、按鈕組可補上 `role`、`aria-label` 或 `aria-expanded` 等，方便螢幕閱讀器與鍵盤操作。

---

## 五、快速檢查清單（新增／修改模組時）

- [ ] 新腳本依賴的「全域變數／事件」是否在更早的腳本中已定義？
- [ ] 若新頁面需要 Supabase，是否已載入 `supabase-config.js` 且順序在該頁主邏輯之前？
- [ ] 是否只在需要的頁面載入對應腳本（例如不在詳情頁載入 pagination-system、main-script）？
- [ ] 若有複製貼上的工具函數（如地址格式化），是否考慮抽成共用模組並單一來源？

以上為目前模組化架構下已注意到與建議留意的事項；若有新增頁面或重構，可依此檢查並更新本文件。

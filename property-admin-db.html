<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ä»¶ç®¡ç†å¾Œå°ï¼ˆè³‡æ–™åº«ç‰ˆï¼‰| ä½å•†ä¸å‹•ç”¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            /* æ¡Œé¢ç‰ˆï¼šå…è¨±æ­£å¸¸æ»¾å‹• */
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* æ‰‹æ©Ÿç‰ˆå°ˆç”¨æ¨£å¼ */
        @media (max-width: 768px) {
            body {
                /* å„ªåŒ–æ»¾å‹•æ€§èƒ½ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
                -webkit-overflow-scrolling: touch;
                will-change: scroll-position;
                /* ç¦ç”¨æ–‡å­—é¸æ“‡ï¼Œé¿å…å¿«é€Ÿæ»¾å‹•æ™‚å‡ºç¾åç™½ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                /* å„ªåŒ–è§¸æ§éŸ¿æ‡‰ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
                -webkit-tap-highlight-color: transparent;
                touch-action: pan-y;
            }
        }
        
        /* å…è¨±è¼¸å…¥æ¡†é¸æ“‡æ–‡å­— */
        input,
        textarea,
        select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            /* æ¡Œé¢ç‰ˆå…è¨±æ»¾å‹• */
            overflow: visible;
            /* å„ªåŒ–æ¸²æŸ“æ€§èƒ½ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            /* ç¦ç”¨æ–‡å­—é¸æ“‡ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* é˜²æ­¢é»æ“Šæ™‚å‡ºç¾é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 2rem;
            /* å„ªåŒ–é¡¯ç¤ºæ€§èƒ½ */
            contain: layout style paint;
            /* æ¡Œé¢ç‰ˆï¼šå…è¨±æ­£å¸¸æ»¾å‹• */
            overflow: visible;
        }
        
        /* æ‰‹æ©Ÿç‰ˆï¼šå„ªåŒ–æ»¾å‹•æ€§èƒ½ */
        @media (max-width: 768px) {
            .tab-content {
                /* ç¦ç”¨æ–‡å­—é¸æ“‡ï¼Œé¿å…å¿«é€Ÿæ»¾å‹•æ™‚å‡ºç¾åç™½ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                /* å„ªåŒ–æ»¾å‹•æ€§èƒ½ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* é˜²æ­¢æ»¾å‹•æ™‚å‡ºç¾é¸å–é«˜äº®ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        .tab-content.active {
            display: block;
            /* å•Ÿç”¨ç¡¬é«”åŠ é€Ÿ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
            /* å„ªåŒ–æ¸²æŸ“æ€§èƒ½ */
            contain: layout style;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        /* æ‰‹æ©Ÿç‰ˆï¼šç¦ç”¨æ–‡å­—é¸æ“‡ï¼Œé¿å…å¿«é€Ÿæ»¾å‹•æ™‚å‡ºç¾åç™½ */
        @media (max-width: 768px) {
            .form-section {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        @media (max-width: 1200px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            /* å®¹å™¨å„ªåŒ– - å…¨è¢å¹•å¯¬åº¦ */
            .container {
                padding: 0.5rem;
                max-width: 100%;
                width: 100%;
                margin: 0;
            }
            
            /* è¡¨å–®ç¶²æ ¼æ”¹ç‚ºå–®æ¬„ */
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 1.25rem !important;
            }
            
            /* è¡¨å–®å€å¡Šå„ªåŒ– - å¢åŠ é–“è·ï¼Œæ›´æ˜é¡¯çš„è¦–è¦ºå±¤æ¬¡ */
            .form-section {
                padding: 1rem !important;
                margin-bottom: 1.25rem !important;
                background: #ffffff !important;
                border: 1px solid #e9ecef !important;
                border-radius: 10px !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
            }
            
            .form-section h3 {
                font-size: 1rem !important;
                margin-bottom: 0.75rem !important;
                padding-bottom: 0.5rem !important;
                border-bottom: 2px solid #f0f0f0 !important;
            }
            
            /* è¡¨å–®æ¬„ä½å„ªåŒ– - å¢åŠ å¤§å°å’Œé–“è· */
            .form-group {
                margin-bottom: 1.25rem !important;
            }
            
            .form-group label {
                font-size: 0.95rem !important;
                margin-bottom: 0.6rem !important;
                font-weight: 600 !important;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.85rem !important;
                font-size: 1rem !important;
                border: 2px solid #e9ecef !important;
                border-radius: 8px !important;
                min-height: 44px !important; /* è§¸æ§å‹å¥½çš„æœ€å°é«˜åº¦ */
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                border-color: #667eea !important;
                outline: none !important;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            }
            
            .form-group textarea {
                min-height: 120px !important;
                line-height: 1.5 !important;
            }
            
            /* å°å‹å’Œä¸­å‹æ¬„ä½åœ¨æ‰‹æ©Ÿç‰ˆéƒ½ä½”æ»¿å¯¬åº¦ */
            .form-group.small,
            .form-group.medium {
                grid-column: span 1 !important;
            }
            
            /* å…¨å¯¬æ¬„ä½ */
            .form-group.full-width {
                grid-column: 1 / -1 !important;
            }
            
            /* æŒ‰éˆ•å„ªåŒ– */
            .btn {
                padding: 0.85rem 1.25rem !important;
                font-size: 1rem !important;
                min-height: 44px !important;
            }
            
            /* æŒ‰éˆ•çµ„å„ªåŒ– - Sticky å„²å­˜æŒ‰éˆ•ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
            .btn-group {
                position: sticky !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                padding: 1rem !important;
                margin: 0 !important;
                margin-top: 1.5rem !important;
                margin-bottom: 0 !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
                z-index: 100 !important;
                display: flex !important;
                gap: 0.75rem !important;
                flex-direction: column !important;
            }
            
            /* ç¢ºä¿è¡¨å–®åº•éƒ¨æœ‰è¶³å¤ ç©ºé–“ï¼Œä¸è¢« sticky æŒ‰éˆ•é®æ“‹ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ */
            form {
                padding-bottom: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .btn-group .btn {
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* è¡¨å–®å€å¡Šå¯æ‘ºç–Š */
            .form-section h3 {
                cursor: pointer !important;
                user-select: none !important;
                position: relative !important;
                padding-right: 2rem !important;
            }
            
            .form-section h3::after {
                content: 'â–¼' !important;
                position: absolute !important;
                right: 0 !important;
                font-size: 0.8rem !important;
                transition: transform 0.3s ease !important;
                color: #667eea !important;
            }
            
            .form-section.collapsed h3::after {
                transform: rotate(-90deg) !important;
            }
            
            .form-section.collapsed .form-grid {
                display: none !important;
            }
            
            /* åœ–ç‰‡ä¸Šå‚³å€åŸŸåœ¨æ‘ºç–Šæ™‚ä¹Ÿè¦éš±è— */
            .form-section.collapsed .image-upload-area,
            .form-section.collapsed .image-preview-grid {
                display: none !important;
            }
            
            /* ç¢ºä¿æ‘ºç–Šä¸å½±éŸ¿è¡¨å–®æäº¤ï¼ˆè¡¨å–®å…ƒç´ ä»ç„¶å­˜åœ¨ï¼Œåªæ˜¯éš±è—ï¼‰ */
            .form-section.collapsed input,
            .form-section.collapsed select,
            .form-section.collapsed textarea {
                display: none !important;
            }
            
            /* è¡¨å–®é€²åº¦æŒ‡ç¤ºå™¨æ¨£å¼ */
            #form-progress {
                display: block !important;
            }
            
            /* æ¬„ä½éŒ¯èª¤æç¤ºæ¨£å¼ */
            .field-error-message {
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-5px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* åœ–ç‰‡ä¸Šå‚³å€åŸŸå„ªåŒ– */
            .image-upload-area {
                min-height: 120px !important;
                padding: 1.5rem !important;
            }
            
            .image-preview-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
        }
        
        /* å°å‹æ¬„ä½ï¼ˆç‰©ä»¶ä¾†æºã€ç‰©ä»¶ç·¨è™Ÿç­‰ï¼‰ */
        .form-group.small {
            grid-column: span 1;
        }
        
        /* ä¸­å‹æ¬„ä½ */
        .form-group.medium {
            grid-column: span 2;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
            /* å…è¨±æ¨™ç±¤æ–‡å­—å¯é¸ï¼ˆæ–¹ä¾¿è¤‡è£½ï¼‰ */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            /* é˜²æ­¢é»æ“Šæ™‚å‡ºç¾é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.7rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ç‹€æ…‹æ–‡å­—æ¨™ç±¤æŒ‰éˆ• */
        .status-tag-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .status-tag-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .status-tag-btn:active {
            transform: translateY(0);
        }
        
        /* æ¨™ç±¤é¸æ“‡ç³»çµ± */
        .tag-selector-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .tag-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .tag-input {
            flex: 1;
            padding: 0.7rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .tag-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .tag-add-btn {
            padding: 0.7rem 1.2rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
            white-space: nowrap;
        }
        
        .tag-add-btn:hover {
            background: #5568d3;
        }
        
        .tag-add-btn:active {
            transform: scale(0.98);
        }
        
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 2.5rem;
            padding: 0.5rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
        }
        
        .selected-tags:empty::before {
            content: "å°šæœªé¸æ“‡ä»»ä½•é …ç›®";
            color: #adb5bd;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            animation: tagSlideIn 0.3s ease;
        }
        
        @keyframes tagSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .selected-tag .tag-remove {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s ease;
            padding: 0;
        }
        
        .selected-tag .tag-remove:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .selected-tag .tag-edit {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s ease;
            padding: 0;
            margin-right: 0.2rem;
        }
        
        .selected-tag .tag-edit:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .selected-tag.editing {
            background: #fff;
            color: #333;
            border: 2px solid #667eea;
        }
        
        .selected-tag .tag-edit-input {
            background: transparent;
            border: none;
            color: #333;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0;
            margin: 0;
            outline: none;
            min-width: 60px;
            max-width: 200px;
        }
        
        .tag-option .tag-option-edit,
        .tag-option .tag-option-delete {
            display: none;
            margin-left: 0.3rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tag-option:hover .tag-option-edit,
        .tag-option:hover .tag-option-delete {
            display: inline-block;
        }
        
        .tag-option-edit {
            background: #667eea;
            color: white;
            border: none;
        }
        
        .tag-option-edit:hover {
            background: #5568d3;
        }
        
        .tag-option-delete {
            background: #dc3545;
            color: white;
            border: none;
        }
        
        .tag-option-delete:hover {
            background: #c82333;
        }
        
        .tag-option.editing {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .tag-option .tag-edit-input {
            background: transparent;
            border: 1px solid #667eea;
            border-radius: 4px;
            padding: 0.2rem 0.4rem;
            font-size: 0.85rem;
            min-width: 80px;
            outline: none;
        }
        
        .tag-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .tag-option {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.9rem;
            background: white;
            color: #495057;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }
        
        .tag-option-text {
            flex: 1;
        }
        
        .tag-option:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        
        .tag-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .tag-option.selected:hover {
            background: #5568d3;
        }
        
        /* åœ–ç‰‡ä¸Šå‚³å€åŸŸ */
        .image-upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            /* ç¦ç”¨æ–‡å­—é¸æ“‡ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* é˜²æ­¢é»æ“Šæ™‚å‡ºç¾é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        
        .image-upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .image-upload-area.dragover {
            background: #e7f3ff;
            border-color: #667eea;
        }
        
        .image-upload-area input[type="file"] {
            display: none;
        }
        
        .image-upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 1.5rem;
            /* å„ªåŒ–ç¶²æ ¼æ¸²æŸ“ */
            contain: layout;
            will-change: contents;
            /* ç¢ºä¿å¯ä»¥æ¥æ”¶æ‹–æ›³äº‹ä»¶ */
            min-height: 100px;
            position: relative;
        }
        
        .image-preview-item {
            position: relative;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 1;
            min-height: 100px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            /* ç¦ç”¨æ–‡å­—é¸æ“‡ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* é˜²æ­¢é»æ“Šæ™‚å‡ºç¾é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        
        .image-preview-item.cover-image {
            border: 3px solid #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .image-cover-btn {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }
        
        .image-cover-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.05);
        }
        
        .image-cover-btn.is-cover {
            background: rgba(40, 167, 69, 0.9);
        }
        
        .image-cover-btn.is-cover:hover {
            background: rgba(40, 167, 69, 1);
        }
        
        .image-cover-badge {
            position: absolute;
            top: 2px;
            left: 2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* å„ªåŒ–åœ–ç‰‡è¼‰å…¥æ€§èƒ½ */
            will-change: transform;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* ç¦ç”¨åœ–ç‰‡æ‹–æ‹½å’Œé¸æ“‡ */
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            pointer-events: none; /* é˜²æ­¢åœ–ç‰‡æˆç‚ºé¸å–ç›®æ¨™ */
        }
        
        .image-preview-item .image-remove {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .image-preview-item .image-remove:hover {
            background: #dc3545;
            transform: scale(1.1) translateZ(0);
            -webkit-transform: scale(1.1) translateZ(0);
            /* å„ªåŒ– hover å‹•ç•« */
            will-change: transform;
        }
        
        .image-preview-item .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #e9ecef;
        }
        
        .image-preview-item .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        /* æ‹–æ›³æ’åºï¼šçµ²æ»‘éæ¸¡ */
        .image-preview-grid {
            transition: gap 0.2s ease;
        }
        
        .image-preview-item[draggable="true"] {
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.2s ease,
                        opacity 0.2s ease;
        }
        
        .image-preview-item[draggable="true"]:active {
            cursor: grabbing;
        }
        
        .image-preview-item.dragging {
            opacity: 0.4;
            transform: scale(0.96);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.35);
            cursor: grabbing;
            z-index: 1000;
            pointer-events: none;
        }
        
        .image-preview-item.drag-over {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
        }
        
        /* æ‹–æ›³æ”¾ç½®é è¦½ä½ç½®ï¼ˆæ’æ§½ï¼‰ */
        .image-drag-placeholder {
            aspect-ratio: 1;
            min-height: 100px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
            border: 2px dashed rgba(102, 126, 234, 0.6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        
        .image-drag-placeholder::before {
            content: 'æ”¾ç½®æ–¼æ­¤';
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e9ecef;
        }
        
        .btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            /* ç¦ç”¨æ–‡å­—é¸æ“‡ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* é˜²æ­¢é»æ“Šæ™‚å‡ºç¾é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px) translateZ(0);
            -webkit-transform: translateY(-2px) translateZ(0);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            /* å„ªåŒ– hover å‹•ç•« */
            will-change: transform;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInDown 0.3s ease-out;
        }
        
        .alert.show {
            display: block;
            animation: slideInDown 0.3s ease-out;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Toast æ¨£å¼ï¼ˆå›ºå®šä½ç½®é€šçŸ¥ï¼‰ */
        .toast-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 500px;
            z-index: 10000;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .toast-alert .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .toast-alert .toast-message {
            flex: 1;
            font-weight: 500;
        }
        
        .toast-alert .toast-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: inherit;
            opacity: 0.7;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .toast-alert .toast-close:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.1);
        }
        
        /* å„ªåŒ–çš„å½ˆè·³è¦–çª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-dialog {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .modal-icon.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .modal-icon.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            flex: 1;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-body {
            padding: 1.5rem;
            color: #666;
            line-height: 1.6;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 0.625rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        
        .modal-btn-cancel {
            background: #f8f9fa;
            color: #333;
        }
        
        .modal-btn-cancel:hover {
            background: #e9ecef;
        }
        
        .modal-btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .modal-btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .modal-btn-danger:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            /* å®¹å™¨å„ªåŒ– - ç§»é™¤åœ“è§’å’Œé™°å½±ï¼Œå…¨è¢å¹• */
            .container {
                padding: 0;
                max-width: 100%;
                width: 100%;
                border-radius: 0;
                box-shadow: none;
            }
            
            /* Header å„ªåŒ– - æ›´ç·Šæ¹Šï¼Œsticky */
            .header {
                padding: 0.75rem 1rem;
                position: sticky;
                top: 0;
                z-index: 100;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .header h1 {
                font-size: 1.1rem;
                margin-bottom: 0.25rem;
            }
            
            .header p {
                font-size: 0.8rem;
                margin: 0;
            }
            
            /* Tabs å„ªåŒ– - stickyï¼Œæ›´ç·Šæ¹Š */
            .tabs {
                flex-wrap: nowrap;
                gap: 0.5rem;
                padding: 0.5rem;
                position: sticky;
                top: 0;
                background: white;
                z-index: 99;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                padding: 0.6rem 0.9rem;
                font-size: 0.85rem;
                flex: 0 0 auto;
                white-space: nowrap;
                min-width: auto;
            }
            
            /* Modal å„ªåŒ– */
            .modal-dialog {
                width: 95%;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                padding: 1.25rem;
            }
            
            .modal-body {
                padding: 1.25rem;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
                padding: 0.85rem;
                font-size: 1rem;
                min-height: 44px;
            }
        }
        
        .property-list {
            display: grid;
            gap: 1rem;
        }
        
        .property-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .property-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .property-info h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .property-info p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .property-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .config-section h3 {
            color: #856404;
            margin-bottom: 1rem;
        }
        
        .config-section input {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ç‰©ä»¶ç®¡ç†å¾Œå°ï¼ˆè³‡æ–™åº«ç‰ˆï¼‰</h1>
            <p>åœ–ç‰‡ä¸Šå‚³ + è³‡æ–™åº«å„²å­˜ï¼Œç¯€çœæ™‚é–“è¶…æ–¹ä¾¿ï¼</p>
        </div>
        
        <div class="tabs">
            <button class="tab" id="config-tab-button" onclick="switchTab('config', this)">âš™ï¸ API è¨­å®š</button>
            <button class="tab active" onclick="switchTab('add', this)">â• æ–°å¢ç‰©ä»¶</button>
            <button class="tab" onclick="switchTab('list', this)">ğŸ“‹ ç‰©ä»¶åˆ—è¡¨</button>
        </div>
        
        <!-- Supabase è¨­å®š -->
        <div id="config-tab" class="tab-content">
            <div class="config-section">
                <h3>âš™ï¸ Supabase è¨­å®š</h3>
                <div class="form-group">
                    <label>Supabase URL *</label>
                    <input type="text" id="supabase-url" placeholder="https://cnzqtuuegdqwkgvletaa.supabase.co" value="https://cnzqtuuegdqwkgvletaa.supabase.co">
                </div>
                <div class="form-group">
                    <label>Supabase Anon Key *</label>
                    <input type="text" id="supabase-anon-key" placeholder="è¼¸å…¥æ‚¨çš„ Supabase Anon Key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuenF0dXVlZ2Rxd2tndmxldGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjUxMTksImV4cCI6MjA4MzcwMTExOX0.gsO3RKdMu2bUXW4b5aHseouIkjXtJyIqqP_0x3Y6trE">
                </div>
                <p style="color: #856404; font-size: 0.9rem; margin-top: 0.5rem;">
                    ğŸ’¡ <strong>è¨­å®šèªªæ˜ï¼š</strong>è«‹è¼¸å…¥æ‚¨çš„ Supabase å°ˆæ¡ˆè¨­å®šè³‡è¨Š<br>
                    ğŸ’¡ <strong>å–å¾—è¨­å®šï¼š</strong>å‰å¾€ <a href="https://supabase.com/dashboard/project/cnzqtuuegdqwkgvletaa/settings/api" target="_blank">Supabase Dashboard</a> â†’ Settings â†’ API
                </p>
                <div style="margin-top: 1rem; padding: 1rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1976D2;">ğŸ“ Supabase è¨­å®šèªªæ˜</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; color: #424242;">
                        <li><strong>Supabase URLï¼š</strong>æ‚¨çš„ Supabase å°ˆæ¡ˆ URLï¼ˆä¾‹å¦‚ï¼šhttps://cnzqtuuegdqwkgvletaa.supabase.coï¼‰</li>
                        <li><strong>Anon Keyï¼š</strong>å¾ Supabase Dashboard çš„ API è¨­å®šä¸­å–å¾—</li>
                        <li><strong>åœ–ç‰‡ä¸Šå‚³ï¼š</strong>åœ–ç‰‡æœƒè‡ªå‹•ä¸Šå‚³åˆ° Supabase Storage</li>
                        <li><strong>è³‡æ–™å¤¾çµæ§‹ï¼š</strong>æ¯å€‹ç‰©ä»¶çš„åœ–ç‰‡æœƒå„²å­˜åœ¨ <code>junyang666/properties/{ç‰©ä»¶ç·¨è™Ÿ}/</code> è³‡æ–™å¤¾ä¸­</li>
                        <li><strong>ä¸Šæ¶/ä¸‹æ¶ï¼š</strong>ç‰©ä»¶å¯ä»¥è¨­å®šç‚ºä¸Šæ¶ï¼ˆis_published: trueï¼‰æˆ–ä¸‹æ¶ï¼ˆis_published: falseï¼‰ç‹€æ…‹</li>
                    </ul>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-success" onclick="saveSupabaseConfig()" style="flex: 1;">
                        ğŸ’¾ å„²å­˜è¨­å®š
                    </button>
                    <button class="btn btn-primary" onclick="testSupabaseConnection()" style="flex: 1;">
                        ğŸ” æ¸¬è©¦é€£æ¥
                    </button>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-size: 0.9rem; color: #856404;">
                        ğŸ’¡ <strong>æç¤ºï¼š</strong>è¨­å®šå®Œæˆä¸¦æˆåŠŸé€£æ¥å¾Œï¼Œè¨­å®šæ¨™ç±¤æœƒè‡ªå‹•éš±è—ã€‚å¦‚éœ€é‡æ–°è¨­å®šï¼Œè«‹åˆ·æ–°é é¢ä¸¦æŒ‰ F12 æ‰“é–‹æ§åˆ¶å°ï¼Œè¼¸å…¥ <code>showConfigTab()</code> é‡æ–°é¡¯ç¤ºã€‚
                    </p>
                </div>
                <div id="supabase-status" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: none;">
                    <h4 style="margin: 0 0 0.5rem 0;">ğŸ” é€£æ¥ç‹€æ…‹</h4>
                    <div id="supabase-status-content"></div>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢ç‰©ä»¶ -->
        <div id="add-tab" class="tab-content active">
            <div id="alert-container"></div>
            
            <!-- è¡¨å–®å¡«å¯«é€²åº¦æŒ‡ç¤ºï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰ -->
            <div id="form-progress" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.9rem; font-weight: 600; color: #667eea;">ğŸ“Š è¡¨å–®å¡«å¯«é€²åº¦</span>
                    <span id="progress-percentage" style="font-size: 0.9rem; font-weight: 600; color: #667eea;">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <p id="progress-text" style="font-size: 0.8rem; color: #666; margin-top: 0.5rem; margin-bottom: 0;">è«‹å¡«å¯«å¿…å¡«æ¬„ä½</p>
            </div>
            
            <form id="property-form">
                <!-- åŸºæœ¬è³‡è¨Š -->
                <div class="form-section">
                    <h3>ğŸ“ åŸºæœ¬è³‡è¨Š</h3>
                    <div class="form-grid">
                        <div class="form-group small">
                            <label>ç‰©ä»¶ä¾†æº *</label>
                            <select id="is_external" required onchange="onExternalSourceChange()">
                                <option value="false">ğŸ  æœ¬åº—ç‰©ä»¶</option>
                                <option value="true">ğŸ¢ éæœ¬åº—ç‰©ä»¶</option>
                            </select>
                            <small style="color: #999; font-size: 0.75rem; margin-top: 0.25rem; display: block; opacity: 0.7;">
                                éæœ¬åº—ç‰©ä»¶ä½¿ç”¨ç¨ç«‹ç·¨è™Ÿç³»çµ±
                            </small>
                        </div>
                        <div class="form-group small" style="display: none;">
                            <label>ç‰©ä»¶ç·¨è™Ÿ</label>
                            <input type="text" id="number" placeholder="é¸æ“‡æˆ¿å‹å¾Œè‡ªå‹•ç”Ÿæˆ" style="flex: 1;" readonly>
                        </div>
                        <div class="form-group">
                            <label>ç‰©ä»¶æ¨™é¡Œ *</label>
                            <input type="text" id="title" placeholder="ä¾‹å¦‚: ä½è‡ªå‚™ | è¿‘é¾ç§‘ | 2æˆ¿+è»Šä½" required>
                        </div>
                        <div class="form-group">
                            <label>æˆ¿å‹ *</label>
                            <select id="type" required onchange="onTypeChange(); checkAndShowExtensionFloor();">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="å¥—æˆ¿">å¥—æˆ¿</option>
                                <option value="2æˆ¿">2æˆ¿</option>
                                <option value="3æˆ¿">3æˆ¿</option>
                                <option value="4æˆ¿">4æˆ¿</option>
                                <option value="è¯å»ˆ">è¯å»ˆ</option>
                                <option value="å…¬å¯“">å…¬å¯“</option>
                                <option value="é€å¤©">é€å¤©</option>
                                <option value="åº—é¢">åº—é¢</option>
                                <option value="åˆ¥å¢…">åˆ¥å¢…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç¸£å¸‚ *</label>
                            <select id="city" required onchange="updateDistricts()">
                                <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                                <option value="æ¡ƒåœ’å¸‚" selected>æ¡ƒåœ’å¸‚</option>
                                <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                                <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                                <option value="å°å—å¸‚">å°å—å¸‚</option>
                                <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                                <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                                <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
                                <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                                <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                                <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                                <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                                <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                                <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                                <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                                <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                                <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                                <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                                <option value="å°æ±ç¸£">å°æ±ç¸£</option>
                                <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                                <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
                                <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å€åŸŸ *</label>
                            <select id="district" required>
                                <option value="">è«‹å…ˆé¸æ“‡ç¸£å¸‚</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è©³ç´°åœ°å€ *</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                    <input type="text" id="address" placeholder="ä¾‹å¦‚: æ¢…ç…è·¯äºŒæ®µ232å··***è™Ÿ10æ¨“" required style="flex: 1;">
                                    <button type="button" onclick="openGoogleStreetView()" class="btn btn-secondary" style="white-space: nowrap; padding: 0.7rem 1rem; font-size: 0.9rem;">
                                        ğŸ™ï¸ æ‰“é–‹ Google è¡—æ™¯
                                    </button>
                                </div>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: normal; font-size: 0.9rem; color: #666;">
                                    <input type="checkbox" id="hide_address_number" style="width: auto; margin: 0;">
                                    <span>éš±è—é–€ç‰Œè™Ÿç¢¼ï¼ˆåƒ…é¡¯ç¤ºè·¯åã€å··å¼„ï¼Œä¸é¡¯ç¤ºè™Ÿç¢¼ï¼‰</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ç¤¾å€åç¨±</label>
                            <input type="text" id="community" placeholder="ä¾‹å¦‚: ä¸–ç´€åŸ">
                        </div>
                        <div class="form-group">
                            <label>å”®åƒ¹ *</label>
                            <input type="text" id="price" placeholder="ä¾‹å¦‚: 896è¬" required inputmode="numeric" pattern="[0-9]*">
                        </div>
                        <div class="form-group">
                            <label>ä¸Šæ¶ç‹€æ…‹ *</label>
                            <select id="is_published" required>
                                <option value="true">âœ… ä¸Šæ¶ï¼ˆé¡¯ç¤ºåœ¨å‰å°ï¼‰</option>
                                <option value="false">âŒ ä¸‹æ¶ï¼ˆä¸é¡¯ç¤ºåœ¨å‰å°ï¼‰</option>
                            </select>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ä¸Šæ¶çš„ç‰©ä»¶æœƒé¡¯ç¤ºåœ¨é¦–é ï¼Œä¸‹æ¶çš„ç‰©ä»¶åƒ…åœ¨å¾Œå°å¯è¦‹
                            </small>
                        </div>
                        <div class="form-group">
                            <label>ç‰©ä»¶ç‹€æ…‹</label>
                            <select id="status" onchange="onStatusChange()">
                                <option value="">ä¸€èˆ¬ç‰©ä»¶</option>
                                <option value="new">æ–°ä¸Šæ¶</option>
                                <option value="urgent">æ€¥å”®</option>
                                <option value="selling">ç†±éŠ·ä¸­</option>
                                <option value="below-appraisal">ä½æ–¼é‘‘åƒ¹</option>
                                <option value="sold">å·²å”®å‡º</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç‹€æ…‹æ–‡å­—</label>
                            <select id="statusText" onchange="onStatusTextChange()" style="margin-bottom: 0.5rem;">
                                <option value="">è«‹é¸æ“‡æˆ–æ‰‹å‹•è¼¸å…¥</option>
                                <option value="æ–°ä¸Šæ¶">æ–°ä¸Šæ¶</option>
                                <option value="æ€¥å”®">æ€¥å”®</option>
                                <option value="éŠ·å”®ä¸­">éŠ·å”®ä¸­</option>
                                <option value="ç†±éŠ·ä¸­">ç†±éŠ·ä¸­</option>
                                <option value="ç†±è³£ç‰©ä»¶">ç†±è³£ç‰©ä»¶</option>
                                <option value="æ¶æ‰‹ä»¶">æ¶æ‰‹ä»¶</option>
                                <option value="ä½æ–¼é‘‘åƒ¹">ä½æ–¼é‘‘åƒ¹</option>
                                <option value="å·²å”®å‡º">å·²å”®å‡º</option>
                                <option value="custom">è‡ªè¨‚ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                            </select>
                            <input type="text" id="statusTextInput" placeholder="è‹¥é¸æ“‡ã€Œè‡ªè¨‚ã€ï¼Œè«‹åœ¨æ­¤è¼¸å…¥è‡ªè¨‚ç‹€æ…‹æ–‡å­—" style="display: none;">
                            <div id="status-text-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                <button type="button" class="status-tag-btn" onclick="setStatusTextFromTag('æ–°ä¸Šæ¶')">æ–°ä¸Šæ¶</button>
                                <button type="button" class="status-tag-btn" onclick="setStatusTextFromTag('æ€¥å”®')">æ€¥å”®</button>
                                <button type="button" class="status-tag-btn" onclick="setStatusTextFromTag('éŠ·å”®ä¸­')">éŠ·å”®ä¸­</button>
                                <button type="button" class="status-tag-btn" onclick="setStatusTextFromTag('ç†±éŠ·ä¸­')">ç†±éŠ·ä¸­</button>
                                <button type="button" class="status-tag-btn" onclick="setStatusTextFromTag('ç†±è³£ç‰©ä»¶')">ç†±è³£ç‰©ä»¶</button>
                                <button type="button" class="status-tag-btn" onclick="setStatusTextFromTag('æ¶æ‰‹ä»¶')">æ¶æ‰‹ä»¶</button>
                            </div>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                                ğŸ’¡ å¯ç›´æ¥å¾ä¸‹æ‹‰é¸å–®é¸æ“‡ï¼Œæˆ–é»æ“Šä¸Šæ–¹æ¨™ç±¤å¿«é€Ÿé¸æ“‡
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- ç‰©ä»¶è©³æƒ… -->
                <div class="form-section">
                    <h3>ğŸ“ ç‰©ä»¶è©³æƒ…</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>æ ¼å±€ *</label>
                            <input type="text" id="layout" placeholder="ä¾‹å¦‚: 3/2/2 æˆ– 3æˆ¿2å»³2è¡› æˆ– 0/4/3ï¼ˆé–‹æ”¾å¼ï¼‰" required onblur="formatLayoutInput(this)">
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ğŸ’¡ æç¤ºï¼šå¯è¼¸å…¥ã€Œ3/2/2ã€è‡ªå‹•è½‰æ›ç‚ºã€Œ3æˆ¿2å»³2è¡›ã€<br>
                                ğŸ’¡ é–‹æ”¾å¼æ ¼å±€ï¼šè¼¸å…¥ã€Œ0/4/3ã€æœƒè‡ªå‹•è½‰æ›ç‚ºã€Œ0æˆ¿4å»³3è¡›ï¼ˆé–‹æ”¾å¼ï¼‰ã€<br>
                                ğŸ’¡ å¥—æˆ¿æ ¼å±€ï¼šè¼¸å…¥ã€Œ1/0/1ã€æœƒè‡ªå‹•è½‰æ›ç‚ºã€Œ1æˆ¿0å»³1è¡›ï¼ˆå¥—æˆ¿ï¼‰ã€
                            </small>
                        </div>
                        <div class="form-group">
                            <label>ç¸½åªæ•¸ *</label>
                            <input type="text" id="total_area" placeholder="ä¾‹å¦‚: 40.08ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼Œç³»çµ±æœƒè‡ªå‹•åŠ ä¸Šã€Œåªã€ï¼‰" required onblur="formatAreaInput(this)" inputmode="decimal" pattern="[0-9.]*">
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ğŸ’¡ æç¤ºï¼šè¼¸å…¥æ•¸å­—å³å¯ï¼Œç³»çµ±æœƒè‡ªå‹•åŠ ä¸Šã€Œåªã€å­—
                            </small>
                        </div>
                        <div class="form-group">
                            <label>ä¸»å»ºç‰©åªæ•¸</label>
                            <input type="text" id="main_area" placeholder="ä¾‹å¦‚: 18.17ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼‰" onblur="formatAreaInput(this)" inputmode="decimal" pattern="[0-9.]*">
                        </div>
                        <div class="form-group">
                            <label>é™„å±¬å»ºç‰©åªæ•¸</label>
                            <input type="text" id="auxiliary_area" placeholder="ä¾‹å¦‚: 1.63ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼‰" onblur="formatAreaInput(this)" inputmode="decimal" pattern="[0-9.]*">
                        </div>
                        <div class="form-group">
                            <label>å…¬è¨­åªæ•¸</label>
                            <input type="text" id="common_area" placeholder="ä¾‹å¦‚: 9.07ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼‰" onblur="formatAreaInput(this)" inputmode="decimal" pattern="[0-9.]*">
                        </div>
                        <div class="form-group">
                            <label>åœŸåœ°åªæ•¸</label>
                            <input type="text" id="land_area" placeholder="ä¾‹å¦‚: 5.22ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼‰" onblur="formatAreaInput(this)">
                        </div>
                        <div class="form-group">
                            <label>è»Šä½åªæ•¸</label>
                            <input type="text" id="parking_area" placeholder="ä¾‹å¦‚: 8.5ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼‰" onblur="formatAreaInput(this)">
                        </div>
                        <div class="form-group">
                            <label>å±‹é½¡</label>
                            <input type="text" id="age" placeholder="ä¾‹å¦‚: 11ï¼ˆè¼¸å…¥æ•¸å­—å³å¯ï¼Œç³»çµ±æœƒè‡ªå‹•åŠ ä¸Šã€Œå¹´ã€ï¼‰" onblur="formatAgeInput(this)">
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ğŸ’¡ æç¤ºï¼šè¼¸å…¥æ•¸å­—å³å¯ï¼Œç³»çµ±æœƒè‡ªå‹•åŠ ä¸Šã€Œå¹´ã€å­—
                            </small>
                        </div>
                        <div class="form-group">
                            <label>æ¨“å±¤</label>
                            <input type="text" id="floor" placeholder="ä¾‹å¦‚: 1-2æ¨“ æˆ– 10/14æ¨“" onchange="onFloorChange()">
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ğŸ’¡ æç¤ºï¼šé€å¤©å¯è¼¸å…¥ã€Œ1-2æ¨“ã€ï¼Œå¤§æ¨“å¯è¼¸å…¥ã€Œ10/14æ¨“ã€
                            </small>
                        </div>
                        <div class="form-group" id="extension-floor-group" style="display: none;">
                            <label>å¢å»ºæ¨“å±¤ <span style="color: #e74c3c; font-size: 0.8rem;">ï¼ˆåƒ…é€å¤©ï¼‰</span></label>
                            <input type="text" id="extension_floor" placeholder="ä¾‹å¦‚: 3-4æ¨“">
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ğŸ’¡ æç¤ºï¼šå¦‚æœ‰å¢å»ºæ¨“å±¤ï¼Œè«‹åœ¨æ­¤è¼¸å…¥ï¼ˆä¾‹å¦‚ï¼š3-4æ¨“ã€5æ¨“ç­‰ï¼‰
                            </small>
                        </div>
                        <div class="form-group">
                            <label>å»ºç¯‰é¡å‹</label>
                            <select id="building_type">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="é›»æ¢¯å¤§æ¨“">é›»æ¢¯å¤§æ¨“</option>
                                <option value="è¯å»ˆ">è¯å»ˆ</option>
                                <option value="å…¬å¯“">å…¬å¯“</option>
                                <option value="é€å¤©">é€å¤©</option>
                                <option value="åˆ¥å¢…">åˆ¥å¢…</option>
                                <option value="åº—é¢">åº—é¢</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>åº§å‘</label>
                            <select id="orientation">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="åº§åŒ—æœå—">åº§åŒ—æœå—</option>
                                <option value="åº§å—æœåŒ—">åº§å—æœåŒ—</option>
                                <option value="åº§æ±æœè¥¿">åº§æ±æœè¥¿</option>
                                <option value="åº§è¥¿æœæ±">åº§è¥¿æœæ±</option>
                                <option value="åº§æ±åŒ—æœè¥¿å—">åº§æ±åŒ—æœè¥¿å—</option>
                                <option value="åº§è¥¿å—æœæ±åŒ—">åº§è¥¿å—æœæ±åŒ—</option>
                                <option value="åº§è¥¿åŒ—æœæ±å—">åº§è¥¿åŒ—æœæ±å—</option>
                                <option value="åº§æ±å—æœè¥¿åŒ—">åº§æ±å—æœè¥¿åŒ—</option>
                                <option value="åº§åŒ—">åº§åŒ—</option>
                                <option value="åº§å—">åº§å—</option>
                                <option value="åº§æ±">åº§æ±</option>
                                <option value="åº§è¥¿">åº§è¥¿</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç®¡ç†è²»</label>
                            <input type="text" id="management_fee" placeholder="ä¾‹å¦‚: 2,077å…ƒ/æœˆ">
                        </div>
                        <div class="form-group">
                            <label>è»Šä½é¡å‹</label>
                            <select id="parking_type">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="å¹³é¢è»Šä½">å¹³é¢è»Šä½</option>
                                <option value="æ©Ÿæ¢°è»Šä½">æ©Ÿæ¢°è»Šä½</option>
                                <option value="é–€å£åœè»Š">é–€å£åœè»Š</option>
                                <option value="å®¤å¤–åœè»Š">å®¤å¤–åœè»Š</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è»Šä½ç·¨è™Ÿ</label>
                            <input type="text" id="parking_space" placeholder="ä¾‹å¦‚: B3-14">
                        </div>
                        <div class="form-group">
                            <label>ç¾æ³</label>
                            <input type="text" id="current_status" placeholder="ä¾‹å¦‚: ç©ºå±‹">
                        </div>
                    </div>
                </div>
                
                <!-- åœ–ç‰‡ä¸Šå‚³ -->
                <div class="form-section">
                    <h3>ğŸ“· ç‰©ä»¶åœ–ç‰‡ï¼ˆç›´æ¥ä¸Šå‚³ï¼‰</h3>
                    <div class="image-upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                        <div class="image-upload-icon">ğŸ“¸</div>
                        <p style="font-size: 1.1rem; font-weight: 600; color: #667eea; margin-bottom: 0.5rem;">
                            é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•ä¸Šå‚³
                        </p>
                        <p style="color: #666; font-size: 0.9rem;">
                            æ”¯æ´ JPGã€PNGã€WEBP æ ¼å¼ï¼Œå¯ä¸€æ¬¡é¸æ“‡å¤šå¼µåœ–ç‰‡ï¼ˆæœ€å¤š 10 å¼µï¼‰
                        </p>
                        <input type="file" id="file-input" multiple accept="image/*">
                    </div>
                    <div id="image-preview-grid" class="image-preview-grid"></div>
                    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                        ğŸ’¡ æç¤ºï¼šå¯ä¸Šå‚³æœ€å¤š 10 å¼µåœ–ç‰‡ï¼Œé»æ“Šã€Œå„²å­˜åˆ°è³‡æ–™åº«ã€æ™‚æ‰æœƒä¸Šå‚³ï¼›æ‹–æ›³åœ–ç‰‡å¯èª¿æ•´æ’åº
                    </p>
                </div>
                
                <!-- äº¤é€šèˆ‡è¨­æ–½ -->
                <div class="form-section">
                    <h3>ğŸš— äº¤é€šèˆ‡è¨­æ–½</h3>
                    <div class="form-grid">
                        <!-- ç”Ÿæ´»è¨­æ–½ -->
                        <div class="form-group">
                            <label>ç”Ÿæ´»è¨­æ–½</label>
                            <div class="tag-selector-container" data-type="facilities">
                                <div class="tag-input-wrapper">
                                    <input type="text" class="tag-input" placeholder="è¼¸å…¥æˆ–é¸æ“‡ç”Ÿæ´»è¨­æ–½..." id="facilities-input">
                                    <button type="button" class="tag-add-btn" onclick="addCustomTag('facilities')">æ–°å¢</button>
                        </div>
                                <div class="selected-tags" id="facilities-selected"></div>
                                <div class="tag-options" id="facilities-options">
                                    <span class="tag-option" onclick="toggleTag('facilities', 'å…¨è¯ç¦åˆ©ä¸­å¿ƒ')">
                                        <span class="tag-option-text">å…¨è¯ç¦åˆ©ä¸­å¿ƒ</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'å…¨è¯ç¦åˆ©ä¸­å¿ƒ', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'å…¨è¯ç¦åˆ©ä¸­å¿ƒ', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'å®¶æ¨‚ç¦')">
                                        <span class="tag-option-text">å®¶æ¨‚ç¦</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'å®¶æ¨‚ç¦', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'å®¶æ¨‚ç¦', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', '7-ELEVEN')">
                                        <span class="tag-option-text">7-ELEVEN</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', '7-ELEVEN', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', '7-ELEVEN', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'å…¨å®¶ä¾¿åˆ©å•†åº—')">
                                        <span class="tag-option-text">å…¨å®¶ä¾¿åˆ©å•†åº—</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'å…¨å®¶ä¾¿åˆ©å•†åº—', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'å…¨å®¶ä¾¿åˆ©å•†åº—', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'OKä¾¿åˆ©å•†åº—')">
                                        <span class="tag-option-text">OKä¾¿åˆ©å•†åº—</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'OKä¾¿åˆ©å•†åº—', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'OKä¾¿åˆ©å•†åº—', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'èŠçˆ¾å¯Œ')">
                                        <span class="tag-option-text">èŠçˆ¾å¯Œ</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'èŠçˆ¾å¯Œ', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'èŠçˆ¾å¯Œ', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'åº·æ˜¯ç¾')">
                                        <span class="tag-option-text">åº·æ˜¯ç¾</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'åº·æ˜¯ç¾', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'åº·æ˜¯ç¾', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'å±ˆè‡£æ°')">
                                        <span class="tag-option-text">å±ˆè‡£æ°</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'å±ˆè‡£æ°', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'å±ˆè‡£æ°', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'é ‚å¥½è¶…å¸‚')">
                                        <span class="tag-option-text">é ‚å¥½è¶…å¸‚</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'é ‚å¥½è¶…å¸‚', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'é ‚å¥½è¶…å¸‚', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'ç¾è¯ç¤¾')">
                                        <span class="tag-option-text">ç¾è¯ç¤¾</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'ç¾è¯ç¤¾', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'ç¾è¯ç¤¾', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'æ¾é’è¶…å¸‚')">
                                        <span class="tag-option-text">æ¾é’è¶…å¸‚</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'æ¾é’è¶…å¸‚', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'æ¾é’è¶…å¸‚', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'æ˜Ÿå·´å…‹')">
                                        <span class="tag-option-text">æ˜Ÿå·´å…‹</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'æ˜Ÿå·´å…‹', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'æ˜Ÿå·´å…‹', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'éº¥ç•¶å‹')">
                                        <span class="tag-option-text">éº¥ç•¶å‹</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'éº¥ç•¶å‹', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'éº¥ç•¶å‹', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'è‚¯å¾·åŸº')">
                                        <span class="tag-option-text">è‚¯å¾·åŸº</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'è‚¯å¾·åŸº', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'è‚¯å¾·åŸº', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'éŠ€è¡Œ')">
                                        <span class="tag-option-text">éŠ€è¡Œ</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'éŠ€è¡Œ', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'éŠ€è¡Œ', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'éƒµå±€')">
                                        <span class="tag-option-text">éƒµå±€</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'éƒµå±€', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'éƒµå±€', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'è¨ºæ‰€')">
                                        <span class="tag-option-text">è¨ºæ‰€</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'è¨ºæ‰€', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'è¨ºæ‰€', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'é†«é™¢')">
                                        <span class="tag-option-text">é†«é™¢</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'é†«é™¢', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'é†«é™¢', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'è—¥å±€')">
                                        <span class="tag-option-text">è—¥å±€</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'è—¥å±€', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'è—¥å±€', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('facilities', 'å•†åœˆ')">
                                        <span class="tag-option-text">å•†åœˆ</span>
                                        <button class="tag-option-edit" onclick="editTagOption('facilities', 'å•†åœˆ', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('facilities', 'å•†åœˆ', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- äº¤é€šè¨­æ–½ -->
                        <div class="form-group">
                            <label>äº¤é€šè¨­æ–½</label>
                            <div class="tag-selector-container" data-type="transport">
                                <div class="tag-input-wrapper">
                                    <input type="text" class="tag-input" placeholder="è¼¸å…¥æˆ–é¸æ“‡äº¤é€šè¨­æ–½..." id="transport-input">
                                    <button type="button" class="tag-add-btn" onclick="addCustomTag('transport')">æ–°å¢</button>
                        </div>
                                <div class="selected-tags" id="transport-selected"></div>
                                <div class="tag-options" id="transport-options">
                                    <span class="tag-option" onclick="toggleTag('transport', 'å°1ç·š')">
                                        <span class="tag-option-text">å°1ç·š</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'å°1ç·š', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'å°1ç·š', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'å°3ç·š')">
                                        <span class="tag-option-text">å°3ç·š</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'å°3ç·š', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'å°3ç·š', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'å°61ç·š')">
                                        <span class="tag-option-text">å°61ç·š</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'å°61ç·š', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'å°61ç·š', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'åœ‹é“1è™Ÿ')">
                                        <span class="tag-option-text">åœ‹é“1è™Ÿ</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'åœ‹é“1è™Ÿ', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'åœ‹é“1è™Ÿ', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'åœ‹é“3è™Ÿ')">
                                        <span class="tag-option-text">åœ‹é“3è™Ÿ</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'åœ‹é“3è™Ÿ', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'åœ‹é“3è™Ÿ', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'æ¥Šæ¢…äº¤æµé“')">
                                        <span class="tag-option-text">æ¥Šæ¢…äº¤æµé“</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'æ¥Šæ¢…äº¤æµé“', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'æ¥Šæ¢…äº¤æµé“', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'æ¹–å£äº¤æµé“')">
                                        <span class="tag-option-text">æ¹–å£äº¤æµé“</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'æ¹–å£äº¤æµé“', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'æ¹–å£äº¤æµé“', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'åŸ”å¿ƒç«è»Šç«™')">
                                        <span class="tag-option-text">åŸ”å¿ƒç«è»Šç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'åŸ”å¿ƒç«è»Šç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'åŸ”å¿ƒç«è»Šç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'æ¥Šæ¢…ç«è»Šç«™')">
                                        <span class="tag-option-text">æ¥Šæ¢…ç«è»Šç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'æ¥Šæ¢…ç«è»Šç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'æ¥Šæ¢…ç«è»Šç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'å¯Œå²¡ç«è»Šç«™')">
                                        <span class="tag-option-text">å¯Œå²¡ç«è»Šç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'å¯Œå²¡ç«è»Šç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'å¯Œå²¡ç«è»Šç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'æ–°å¯Œç«è»Šç«™')">
                                        <span class="tag-option-text">æ–°å¯Œç«è»Šç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'æ–°å¯Œç«è»Šç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'æ–°å¯Œç«è»Šç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'é«˜éµæ¡ƒåœ’ç«™')">
                                        <span class="tag-option-text">é«˜éµæ¡ƒåœ’ç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'é«˜éµæ¡ƒåœ’ç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'é«˜éµæ¡ƒåœ’ç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'æ©Ÿæ·A18ç«™')">
                                        <span class="tag-option-text">æ©Ÿæ·A18ç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'æ©Ÿæ·A18ç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'æ©Ÿæ·A18ç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'æ©Ÿæ·A19ç«™')">
                                        <span class="tag-option-text">æ©Ÿæ·A19ç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'æ©Ÿæ·A19ç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'æ©Ÿæ·A19ç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'å…¬è»Šç«™')">
                                        <span class="tag-option-text">å…¬è»Šç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'å…¬è»Šç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'å…¬è»Šç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('transport', 'å®¢é‹ç«™')">
                                        <span class="tag-option-text">å®¢é‹ç«™</span>
                                        <button class="tag-option-edit" onclick="editTagOption('transport', 'å®¢é‹ç«™', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('transport', 'å®¢é‹ç«™', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å­¸å€ -->
                        <div class="form-group">
                            <label>å­¸å€</label>
                            <div class="tag-selector-container" data-type="schools">
                                <div class="tag-input-wrapper">
                                    <input type="text" class="tag-input" placeholder="è¼¸å…¥æˆ–é¸æ“‡å­¸æ ¡..." id="schools-input">
                                    <button type="button" class="tag-add-btn" onclick="addCustomTag('schools')">æ–°å¢</button>
                        </div>
                                <div class="selected-tags" id="schools-selected"></div>
                                <div class="tag-options" id="schools-options">
                                    <span class="tag-option" onclick="toggleTag('schools', 'é™½å…‰åœ‹å°')">
                                        <span class="tag-option-text">é™½å…‰åœ‹å°</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'é™½å…‰åœ‹å°', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'é™½å…‰åœ‹å°', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'ç‘å¡˜åœ‹å°')">
                                        <span class="tag-option-text">ç‘å¡˜åœ‹å°</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'ç‘å¡˜åœ‹å°', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'ç‘å¡˜åœ‹å°', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'ç‘åŸåœ‹å°')">
                                        <span class="tag-option-text">ç‘åŸåœ‹å°</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'ç‘åŸåœ‹å°', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'ç‘åŸåœ‹å°', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'æ¥Šæ¢…åœ‹å°')">
                                        <span class="tag-option-text">æ¥Šæ¢…åœ‹å°</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'æ¥Šæ¢…åœ‹å°', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'æ¥Šæ¢…åœ‹å°', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'å¯Œå²¡åœ‹å°')">
                                        <span class="tag-option-text">å¯Œå²¡åœ‹å°</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'å¯Œå²¡åœ‹å°', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'å¯Œå²¡åœ‹å°', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'ç‘åªåœ‹ä¸­')">
                                        <span class="tag-option-text">ç‘åªåœ‹ä¸­</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'ç‘åªåœ‹ä¸­', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'ç‘åªåœ‹ä¸­', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'æ¥Šæ¢…åœ‹ä¸­')">
                                        <span class="tag-option-text">æ¥Šæ¢…åœ‹ä¸­</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'æ¥Šæ¢…åœ‹ä¸­', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'æ¥Šæ¢…åœ‹ä¸­', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'å¯Œå²¡åœ‹ä¸­')">
                                        <span class="tag-option-text">å¯Œå²¡åœ‹ä¸­</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'å¯Œå²¡åœ‹ä¸­', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'å¯Œå²¡åœ‹ä¸­', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'æ¥Šæ¢…é«˜ä¸­')">
                                        <span class="tag-option-text">æ¥Šæ¢…é«˜ä¸­</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'æ¥Šæ¢…é«˜ä¸­', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'æ¥Šæ¢…é«˜ä¸­', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'å¤§è¯ä¸­å­¸')">
                                        <span class="tag-option-text">å¤§è¯ä¸­å­¸</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'å¤§è¯ä¸­å­¸', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'å¤§è¯ä¸­å­¸', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'æ²»å¹³é«˜ä¸­')">
                                        <span class="tag-option-text">æ²»å¹³é«˜ä¸­</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'æ²»å¹³é«˜ä¸­', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'æ²»å¹³é«˜ä¸­', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                    <span class="tag-option" onclick="toggleTag('schools', 'ç§ç«‹å­¸æ ¡')">
                                        <span class="tag-option-text">ç§ç«‹å­¸æ ¡</span>
                                        <button class="tag-option-edit" onclick="editTagOption('schools', 'ç§ç«‹å­¸æ ¡', event)" title="ç·¨è¼¯">âœï¸</button>
                                        <button class="tag-option-delete" onclick="deleteTagOption('schools', 'ç§ç«‹å­¸æ ¡', event)" title="åˆªé™¤">Ã—</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¸‚å ´</label>
                            <input type="text" id="market" placeholder="ä¾‹å¦‚: è¬å¤§å¸‚å ´">
                        </div>
                        <div class="form-group">
                            <label>å…¬åœ’</label>
                            <input type="text" id="park" placeholder="ä¾‹å¦‚: å››ç¶­å…¬åœ’">
                        </div>
                    </div>
                </div>
                
                <!-- ç‰¹è‰²èˆ‡æè¿° -->
                <div class="form-section">
                    <h3>âœ¨ ç‰¹è‰²èˆ‡æè¿°</h3>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>ç‰©ä»¶ç‰¹è‰² (æ¯è¡Œä¸€å€‹)</label>
                            <textarea id="features" placeholder="è¿‘å­¸å€&#10;äº¤é€šä¾¿åˆ©&#10;ç®¡ç†å®Œå–„"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>ç‰©ä»¶æè¿°</label>
                            <textarea id="description" placeholder="è©³ç´°æè¿°ç‰©ä»¶ç‰¹è‰²..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- å…¶ä»–è³‡è¨Š -->
                <div class="form-section">
                    <h3>ğŸ”— å…¶ä»–è³‡è¨Š</h3>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Google è¡—æ™¯ç¶²å€</label>
                            <input type="text" id="google_maps" placeholder="https://www.google.com/maps/embed?pb=...ï¼ˆå¾ Google è¡—æ™¯é é¢è¤‡è£½åµŒå…¥ç¶²å€ï¼‰">
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                ğŸ’¡ æç¤ºï¼š<br>
                                1. è¼¸å…¥åœ°å€å¾Œï¼Œé»æ“Šã€ŒğŸ™ï¸ æ‰“é–‹ Google è¡—æ™¯ã€æŒ‰éˆ•<br>
                                2. åœ¨æ–°é–‹å•Ÿçš„ Google è¡—æ™¯é é¢ä¸­ï¼Œé»æ“Šã€Œåˆ†äº«ã€â†’ã€ŒåµŒå…¥åœ°åœ–ã€<br>
                                3. è¤‡è£½åµŒå…¥ç¶²å€ä¸¦è²¼åˆ°æ­¤æ¬„ä½
                            </small>
                        </div>
                        <div class="form-group">
                            <label>TikTok å½±ç‰‡ ID</label>
                            <input type="text" id="tiktok_video_id" placeholder="ä¾‹å¦‚: 7531311616948948230">
                        </div>
                        <div class="form-group">
                            <label>TikTok ä½¿ç”¨è€…åç¨±</label>
                            <input type="text" id="tiktok_username" placeholder="ä¾‹å¦‚: @aihouse168">
                        </div>
                        <div class="form-group">
                            <label>åƒè€ƒé€£çµ</label>
                            <input type="text" id="reference_link" placeholder="https://...">
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="saveProperty()" id="save-btn">
                        ğŸ’¾ å„²å­˜åˆ°è³‡æ–™åº«
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ é‡è¨­è¡¨å–®
                    </button>
                </div>
            </form>
        </div>
        
        <!-- ç‰©ä»¶åˆ—è¡¨ -->
        <div id="list-tab" class="tab-content">
            <div class="form-section">
                <h3>ğŸ“‹ ç¾æœ‰ç‰©ä»¶åˆ—è¡¨</h3>
                <button class="btn btn-success" onclick="loadProperties()" style="margin-bottom: 1rem; max-width: 200px;">
                    ğŸ”„ é‡æ–°è¼‰å…¥
                </button>
                <div id="property-list" class="property-list">
                    <p style="text-align: center; color: #666; padding: 2rem;">
                        é»æ“Šã€Œé‡æ–°è¼‰å…¥ã€æŒ‰éˆ•è¼‰å…¥ç‰©ä»¶è³‡æ–™
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script>
        // è¡¨å–®å€å¡Šæ‘ºç–ŠåŠŸèƒ½ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰
        function toggleSection(section, event) {
            // åªåœ¨æ‰‹æ©Ÿç‰ˆå•Ÿç”¨æ‘ºç–ŠåŠŸèƒ½
            if (window.innerWidth <= 768) {
                // å¦‚æœé»æ“Šçš„æ˜¯æ¨™é¡Œï¼Œæ‰åŸ·è¡Œæ‘ºç–Š
                if (event && event.target.tagName === 'H3') {
                    event.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                    section.classList.toggle('collapsed');
                } else if (!event) {
                    // å¦‚æœæ²’æœ‰äº‹ä»¶åƒæ•¸ï¼Œç›´æ¥åˆ‡æ›ï¼ˆç”¨æ–¼ç¨‹å¼å‘¼å«ï¼‰
                    section.classList.toggle('collapsed');
                }
            }
        }
        
        // å„ªåŒ–ï¼šé»æ“Šæ¨™é¡Œæ™‚æ‰æ‘ºç–Šï¼Œé»æ“Šè¡¨å–®å…§å®¹ä¸æ‘ºç–Šï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            // åªåœ¨æ‰‹æ©Ÿç‰ˆå•Ÿç”¨æ‘ºç–ŠåŠŸèƒ½
            if (window.innerWidth <= 768) {
                // ç‚ºæ‰€æœ‰è¡¨å–®å€å¡Šçš„æ¨™é¡Œæ·»åŠ é»æ“Šäº‹ä»¶
                const sections = document.querySelectorAll('.form-section');
                sections.forEach(section => {
                    const h3 = section.querySelector('h3');
                    if (h3) {
                        h3.addEventListener('click', function(e) {
                            e.stopPropagation();
                            section.classList.toggle('collapsed');
                        });
                    }
                });
            }
            
            // åˆå§‹åŒ–è¡¨å–®é€²åº¦è¿½è¹¤å’Œè‡ªå‹•å„²å­˜è‰ç¨¿ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰
            if (window.innerWidth <= 768) {
                initFormProgress();
                initAutoSave();
            }
            // è¡¨å–®é©—è­‰åœ¨æ‰€æœ‰ç‰ˆæœ¬éƒ½å•Ÿç”¨
            initFormValidation();
        });
        
        // è¡¨å–®å¡«å¯«é€²åº¦è¿½è¹¤ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰
        function initFormProgress() {
            // åªåœ¨æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºé€²åº¦
            if (window.innerWidth > 768) {
                const progressDiv = document.getElementById('form-progress');
                if (progressDiv) {
                    progressDiv.style.display = 'none';
                }
                return; // æ¡Œé¢ç‰ˆä¸åŸ·è¡Œ
            }
            
            const progressDiv = document.getElementById('form-progress');
            if (progressDiv) {
                progressDiv.style.display = 'block';
            }
            
            // ç›£è½è¡¨å–®æ¬„ä½è®ŠåŒ–
            const form = document.getElementById('property-form');
            if (form) {
                const requiredFields = form.querySelectorAll('[required]');
                const allFields = form.querySelectorAll('input, select, textarea');
                
                // è¨ˆç®—é€²åº¦
                function updateProgress() {
                    if (window.innerWidth > 768) return; // åªåœ¨æ‰‹æ©Ÿç‰ˆé¡¯ç¤º
                    
                    let filledCount = 0;
                    let totalRequired = requiredFields.length;
                    
                    requiredFields.forEach(field => {
                        const value = field.value.trim();
                        if (value !== '' && value !== null && value !== undefined) {
                            filledCount++;
                        }
                    });
                    
                    const percentage = totalRequired > 0 ? Math.round((filledCount / totalRequired) * 100) : 0;
                    
                    const progressBar = document.getElementById('progress-bar');
                    const progressPercentage = document.getElementById('progress-percentage');
                    const progressText = document.getElementById('progress-text');
                    
                    if (progressBar) progressBar.style.width = percentage + '%';
                    if (progressPercentage) progressPercentage.textContent = percentage + '%';
                    
                    if (progressText) {
                        if (percentage === 100) {
                            progressText.textContent = 'âœ… æ‰€æœ‰å¿…å¡«æ¬„ä½å·²å¡«å¯«å®Œæˆï¼';
                            progressText.style.color = '#28a745';
                        } else {
                            const remaining = totalRequired - filledCount;
                            progressText.textContent = `é‚„éœ€å¡«å¯« ${remaining} å€‹å¿…å¡«æ¬„ä½`;
                            progressText.style.color = '#666';
                        }
                    }
                }
                
                // ç›£è½æ‰€æœ‰æ¬„ä½è®ŠåŒ–
                allFields.forEach(field => {
                    field.addEventListener('input', updateProgress);
                    field.addEventListener('change', updateProgress);
                });
                
                // åˆå§‹è¨ˆç®—
                updateProgress();
            }
        }
        
        // è‡ªå‹•å„²å­˜è‰ç¨¿åŠŸèƒ½ï¼ˆåƒ…æ‰‹æ©Ÿç‰ˆï¼‰
        let autoSaveTimer = null;
        function initAutoSave() {
            // åªåœ¨æ‰‹æ©Ÿç‰ˆå•Ÿç”¨è‡ªå‹•å„²å­˜
            if (window.innerWidth > 768) {
                return; // æ¡Œé¢ç‰ˆä¸å•Ÿç”¨
            }
            
            if (window.innerWidth <= 768) {
                const form = document.getElementById('property-form');
                if (form) {
                    // æ¯ 30 ç§’è‡ªå‹•å„²å­˜ä¸€æ¬¡
                    autoSaveTimer = setInterval(() => {
                        saveDraft();
                    }, 30000); // 30 ç§’
                    
                    // ç›£è½è¡¨å–®è®ŠåŒ–
                    const fields = form.querySelectorAll('input, select, textarea');
                    fields.forEach(field => {
                        field.addEventListener('input', () => {
                            // å»¶é² 2 ç§’å¾Œå„²å­˜ï¼ˆé¿å…é »ç¹å„²å­˜ï¼‰
                            clearTimeout(autoSaveTimer);
                            autoSaveTimer = setTimeout(() => {
                                saveDraft();
                            }, 2000);
                        });
                    });
                }
            }
            
            // é é¢è¼‰å…¥æ™‚æ¢å¾©è‰ç¨¿
            loadDraft();
        }
        
        // å„²å­˜è‰ç¨¿åˆ° localStorage
        function saveDraft() {
            try {
                const form = document.getElementById('property-form');
                if (!form) return;
                
                const formData = new FormData(form);
                const draft = {};
                
                // æ”¶é›†æ‰€æœ‰è¡¨å–®è³‡æ–™
                for (let [key, value] of formData.entries()) {
                    draft[key] = value;
                }
                
                // å„²å­˜åœ–ç‰‡é è¦½è³‡è¨Šï¼ˆåƒ… URLï¼Œä¸å„²å­˜æª”æ¡ˆï¼‰
                if (uploadedImages && uploadedImages.length > 0) {
                    draft.uploadedImages = uploadedImages.map(img => ({
                        previewURL: img.previewURL || img.url,
                        isCover: img.isCover || false
                    }));
                }
                
                localStorage.setItem('property-form-draft', JSON.stringify(draft));
                console.log('ğŸ’¾ è‰ç¨¿å·²è‡ªå‹•å„²å­˜');
            } catch (error) {
                console.warn('âš ï¸ è‡ªå‹•å„²å­˜è‰ç¨¿å¤±æ•—:', error);
            }
        }
        
        // è¼‰å…¥è‰ç¨¿
        function loadDraft() {
            try {
                const draftStr = localStorage.getItem('property-form-draft');
                if (!draftStr) return;
                
                const draft = JSON.parse(draftStr);
                if (!draft || Object.keys(draft).length === 0) return;
                
                // è©¢å•ç”¨æˆ¶æ˜¯å¦è¦æ¢å¾©è‰ç¨¿
                if (confirm('ç™¼ç¾æœªå®Œæˆçš„è¡¨å–®è‰ç¨¿ï¼Œæ˜¯å¦è¦æ¢å¾©ï¼Ÿ')) {
                    // æ¢å¾©è¡¨å–®æ¬„ä½
                    Object.keys(draft).forEach(key => {
                        if (key === 'uploadedImages') return; // åœ–ç‰‡ç¨å¾Œè™•ç†
                        
                        const field = document.getElementById(key);
                        if (field && draft[key] !== null && draft[key] !== undefined) {
                            field.value = draft[key];
                            // è§¸ç™¼ change äº‹ä»¶ï¼Œç¢ºä¿ç›¸é—œé‚è¼¯åŸ·è¡Œ
                            field.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    
                    // æ¢å¾©åœ–ç‰‡é è¦½ï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸é‡æ–°ä¸Šå‚³ï¼‰
                    if (draft.uploadedImages && draft.uploadedImages.length > 0) {
                        console.log('ğŸ“¸ ç™¼ç¾è‰ç¨¿ä¸­çš„åœ–ç‰‡ï¼Œè«‹é‡æ–°ä¸Šå‚³');
                        // ä¸è‡ªå‹•æ¢å¾©åœ–ç‰‡ï¼Œå› ç‚ºéœ€è¦é‡æ–°ä¸Šå‚³
                    }
                    
                    showAlert('info', 'è‰ç¨¿å·²æ¢å¾©ï¼Œè«‹æª¢æŸ¥è¡¨å–®å…§å®¹');
                } else {
                    // æ¸…é™¤è‰ç¨¿
                    localStorage.removeItem('property-form-draft');
                }
            } catch (error) {
                console.warn('âš ï¸ è¼‰å…¥è‰ç¨¿å¤±æ•—:', error);
            }
        }
        
        // è¡¨å–®é©—è­‰å„ªåŒ– - å³æ™‚é©—è­‰æç¤º
        function initFormValidation() {
            const form = document.getElementById('property-form');
            if (!form) return;
            
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                // å¤±å»ç„¦é»æ™‚é©—è­‰
                field.addEventListener('blur', function() {
                    validateField(this);
                });
                
                // è¼¸å…¥æ™‚æ¸…é™¤éŒ¯èª¤ç‹€æ…‹
                field.addEventListener('input', function() {
                    clearFieldError(this);
                });
            });
        }
        
        // é©—è­‰å–®å€‹æ¬„ä½
        function validateField(field) {
            const value = field.value.trim();
            const isValid = field.checkValidity();
            
            if (!isValid || (field.hasAttribute('required') && value === '')) {
                showFieldError(field, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');
                return false;
            } else {
                clearFieldError(field);
                return true;
            }
        }
        
        // é¡¯ç¤ºæ¬„ä½éŒ¯èª¤
        function showFieldError(field, message) {
            clearFieldError(field); // å…ˆæ¸…é™¤èˆŠçš„éŒ¯èª¤
            
            field.style.borderColor = '#dc3545';
            field.style.boxShadow = '0 0 0 3px rgba(220, 53, 69, 0.1)';
            
            // æ·»åŠ éŒ¯èª¤æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error-message';
            errorDiv.style.cssText = 'color: #dc3545; font-size: 0.85rem; margin-top: 0.25rem; display: block;';
            errorDiv.textContent = message;
            
            field.parentNode.appendChild(errorDiv);
        }
        
        // æ¸…é™¤æ¬„ä½éŒ¯èª¤
        function clearFieldError(field) {
            field.style.borderColor = '';
            field.style.boxShadow = '';
            
            const errorDiv = field.parentNode.querySelector('.field-error-message');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
        
        // åŒ…è£ resetForm å‡½æ•¸ï¼Œç¢ºä¿æ¸…é™¤è‰ç¨¿
        const originalResetForm = window.resetForm;
        if (typeof originalResetForm === 'function') {
            window.resetForm = function() {
                // æ¸…é™¤è‰ç¨¿
                localStorage.removeItem('property-form-draft');
                // æ¸…é™¤è‡ªå‹•å„²å­˜è¨ˆæ™‚å™¨
                if (autoSaveTimer) {
                    clearInterval(autoSaveTimer);
                    autoSaveTimer = null;
                }
                // åŸ·è¡ŒåŸå§‹é‡ç½®å‡½æ•¸
                originalResetForm();
                // é‡æ–°åˆå§‹åŒ–è‡ªå‹•å„²å­˜
                setTimeout(() => {
                    initAutoSave();
                    if (window.innerWidth <= 768) {
                        initFormProgress();
                    }
                }, 100);
            };
        }
        
        // åŒ…è£ saveProperty å‡½æ•¸ï¼Œåœ¨æˆåŠŸå„²å­˜å¾Œæ¸…é™¤è‰ç¨¿
        const originalSaveProperty = window.saveProperty;
        if (typeof originalSaveProperty === 'function') {
            window.saveProperty = async function() {
                try {
                    await originalSaveProperty();
                    // å„²å­˜æˆåŠŸå¾Œæ¸…é™¤è‰ç¨¿
                    localStorage.removeItem('property-form-draft');
                    console.log('âœ… å„²å­˜æˆåŠŸï¼Œå·²æ¸…é™¤è‰ç¨¿');
                } catch (error) {
                    // å„²å­˜å¤±æ•—æ™‚ä¿ç•™è‰ç¨¿
                    throw error;
                }
            };
        }
        
        // å…¨åŸŸè®Šæ•¸
        let uploadedImages = []; // å·²ä¸Šå‚³çš„åœ–ç‰‡ URL å’Œ key é™£åˆ— [{url, key}]
        let editingPropertyId = null;
        let supabaseClient = null; // Supabase å®¢æˆ¶ç«¯å¯¦ä¾‹
        
        // åˆå§‹åŒ– Supabase
        function initSupabase() {
            const supabaseUrl = localStorage.getItem('supabase-url') || 'https://cnzqtuuegdqwkgvletaa.supabase.co';
            const supabaseAnonKey = localStorage.getItem('supabase-anon-key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuenF0dXVlZ2Rxd2tndmxldGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjUxMTksImV4cCI6MjA4MzcwMTExOX0.gsO3RKdMu2bUXW4b5aHseouIkjXtJyIqqP_0x3Y6trE';
            
            if (!supabaseUrl || !supabaseAnonKey) {
                console.warn('âš ï¸ Supabase è¨­å®šæœªå®Œæˆ');
                return null;
            }
            
            try {
                // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
                supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
                
                console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ', {
                    url: supabaseUrl,
                    hasClient: !!supabaseClient
                });
                return supabaseClient;
            } catch (error) {
                console.error('âŒ Supabase åˆå§‹åŒ–å¤±æ•—:', error);
                return null;
            }
        }
        
        // è¼‰å…¥è¨­å®š
        function loadSupabaseConfig() {
            const urlInput = document.getElementById('supabase-url');
            const anonKeyInput = document.getElementById('supabase-anon-key');
            
            if (urlInput) {
                urlInput.value = localStorage.getItem('supabase-url') || 'https://cnzqtuuegdqwkgvletaa.supabase.co';
            }
            if (anonKeyInput) {
                anonKeyInput.value = localStorage.getItem('supabase-anon-key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuenF0dXVlZ2Rxd2tndmxldGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjUxMTksImV4cCI6MjA4MzcwMTExOX0.gsO3RKdMu2bUXW4b5aHseouIkjXtJyIqqP_0x3Y6trE';
            }
            
            // åˆå§‹åŒ– Supabase
            initSupabase();
        }
        
        // æª¢æŸ¥ URL åƒæ•¸ï¼Œå¦‚æœæ˜¯å¾ admin-dashboard.html è¼‰å…¥ï¼Œè‡ªå‹•åˆ‡æ›åˆ°æ–°å¢æ¨™ç±¤
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            const id = urlParams.get('id');
            
            if (tab === 'add') {
                // éš±è—æ¨™ç±¤åˆ‡æ›æŒ‰éˆ•ï¼ˆå› ç‚ºåœ¨ iframe ä¸­ï¼‰
                const tabs = document.querySelector('.tabs');
                if (tabs) {
                    tabs.style.display = 'none';
                }
                // éš±è— headerï¼ˆå› ç‚ºåœ¨ iframe ä¸­ï¼‰
                const header = document.querySelector('.header');
                if (header) {
                    header.style.display = 'none';
                }
                
                // è‡ªå‹•åˆ‡æ›åˆ°æ–°å¢æ¨™ç±¤
                const addTab = document.querySelector('.tab[onclick*="add"]');
                if (addTab) {
                    switchTab('add', addTab);
                    
                        if (id) {
                        setTimeout(() => editProperty(id), 150);
                    }
                }
            }
        });
        
        // å„²å­˜è¨­å®š
        function saveSupabaseConfig() {
            const urlInput = document.getElementById('supabase-url');
            const anonKeyInput = document.getElementById('supabase-anon-key');
            
            if (!urlInput || !anonKeyInput) {
                showAlert('error', 'æ‰¾ä¸åˆ°è¨­å®šæ¬„ä½');
                return;
            }
            
            const supabaseUrl = urlInput.value.trim();
            const supabaseAnonKey = anonKeyInput.value.trim();
            
            if (!supabaseUrl || !supabaseAnonKey) {
                showAlert('error', 'è«‹å¡«å¯«å®Œæ•´çš„ Supabase è¨­å®šï¼ˆéœ€è¦ URL å’Œ Anon Keyï¼‰');
                return;
            }
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('supabase-url', supabaseUrl);
            localStorage.setItem('supabase-anon-key', supabaseAnonKey);
            
            console.log('ğŸ’¾ è¨­å®šå·²å„²å­˜:', { url: supabaseUrl, anonKey: supabaseAnonKey.substring(0, 10) + '...' });
            
            // é‡æ–°åˆå§‹åŒ– Supabase
            const result = initSupabase();
            
            if (result) {
                showAlert('success', 'è¨­å®šå·²å„²å­˜ä¸¦åˆå§‹åŒ–æˆåŠŸï¼');
                // éš±è—è¨­å®šæ¨™ç±¤
                hideConfigTab();
                // è‡ªå‹•åˆ‡æ›åˆ°æ–°å¢ç‰©ä»¶æ¨™ç±¤
                setTimeout(() => {
                    const addTab = document.querySelectorAll('.tab')[1];
                    if (addTab) {
                        switchTab('add', addTab);
                    }
                }, 500);
                // æ¸¬è©¦é€£æ¥
                setTimeout(() => {
                    testSupabaseConnection();
                }, 800);
            } else {
                showAlert('error', 'è¨­å®šå·²å„²å­˜ï¼Œä½†åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šæ˜¯å¦æ­£ç¢º');
            }
        }
        
        // éš±è—è¨­å®šæ¨™ç±¤
        function hideConfigTab() {
            const configTabButton = document.getElementById('config-tab-button');
            if (configTabButton) {
                configTabButton.style.display = 'none';
                localStorage.setItem('hide-config-tab', 'true');
            }
        }
        
        // é¡¯ç¤ºè¨­å®šæ¨™ç±¤
        function showConfigTab() {
            const configTabButton = document.getElementById('config-tab-button');
            if (configTabButton) {
                configTabButton.style.display = 'flex';
                localStorage.setItem('hide-config-tab', 'false');
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦éš±è—è¨­å®šæ¨™ç±¤
        function checkConfigTabVisibility() {
            const hideConfig = localStorage.getItem('hide-config-tab') === 'true';
            const anonKey = localStorage.getItem('supabase-anon-key');
            
            // å¦‚æœ Supabase å·²è¨­å®šä¸”ä¹‹å‰é¸æ“‡éš±è—ï¼Œå‰‡éš±è—æ¨™ç±¤
            if (hideConfig && anonKey) {
                hideConfigTab();
            }
        }
        
        // åˆ‡æ›æ¨™ç±¤ï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
        function switchTab(tabName, tabElement) {
            // é˜²æ­¢äº‹ä»¶å†’æ³¡
            if (tabElement && tabElement.stopPropagation) {
                tabElement.stopPropagation();
            }
            
            // ä½¿ç”¨ requestAnimationFrame å„ªåŒ– DOM æ“ä½œ
            requestAnimationFrame(() => {
                // æ‰¹é‡ DOM æ“ä½œ
                const contents = document.querySelectorAll('.tab-content');
                const tabs = document.querySelectorAll('.tab');
                
                // å…ˆç§»é™¤æ‰€æœ‰ active é¡åˆ¥
                contents.forEach(content => {
                content.classList.remove('active');
            });
                tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
                // å†æ·»åŠ  active é¡åˆ¥
                const targetContent = document.getElementById(tabName + '-tab');
            const targetTab = tabElement || document.querySelector(`.tab[onclick*="'${tabName}'"]`);
                
                if (targetContent) {
                    targetContent.classList.add('active');
                    // æ»¾å‹•åˆ°é ‚éƒ¨ï¼Œä½¿ç”¨å¹³æ»‘æ»¾å‹•
                    requestAnimationFrame(() => {
                        targetContent.scrollTop = 0;
                    });
                }
                
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
                // å¦‚æœéœ€è¦è¼‰å…¥åˆ—è¡¨ï¼Œåœ¨ä¸‹ä¸€å¹€åŸ·è¡Œ
            if (tabName === 'list') {
                    requestAnimationFrame(() => {
                loadProperties();
                    });
            }
            
            // å¦‚æœåˆ‡æ›åˆ°æ–°å¢ç‰©ä»¶é é¢ä¸”ä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œé‡ç½®è¡¨å–®
            if (tabName === 'add' && !editingPropertyId) {
                requestAnimationFrame(() => {
                    resetForm();
                });
            }
            
            // ç¢ºä¿åœ–ç‰‡æ‹–æ›³åŠŸèƒ½å·²åˆå§‹åŒ–ï¼ˆç•¶åˆ‡æ›åˆ°æ–°å¢/ç·¨è¼¯æ¨™ç±¤æ™‚ï¼‰
            if (tabName === 'add') {
                requestAnimationFrame(() => {
                    initImageSortable();
                });
            }
            });
        }
        
        // åœ–ç‰‡ä¸Šå‚³è™•ç†ï¼ˆåœ¨ DOMContentLoaded ä¸­åˆå§‹åŒ–ï¼‰
        let isUploading = false; // é˜²æ­¢é‡è¤‡ä¸Šå‚³çš„æ¨™èªŒ
        let isFileDialogOpen = false; // é˜²æ­¢é‡è¤‡é–‹å•Ÿæª”æ¡ˆé¸æ“‡è¦–çª—
        
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            if (!uploadArea || !fileInput) return;
            
            // æ‹–æ›³ä¸Šå‚³ï¼ˆè‹¥ç‚ºåœ–ç‰‡æ’åºæ‹–æ›³å‰‡ç•¥éï¼‰
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer.types.includes('application/x-image-sort')) return;
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.types.includes('application/x-image-sort')) return;
                
                if (isUploading) {
                    console.log('â³ æ­£åœ¨ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...');
                    return;
                }
                
                const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                if (files.length > 0) {
                    handleFiles(files);
                }
            });
            
            // é»æ“Šä¸Šå‚³å€åŸŸ
            uploadArea.addEventListener('click', function(e) {
                // å¦‚æœé»æ“Šçš„æ˜¯æª”æ¡ˆé¸æ“‡å™¨ã€æŒ‰éˆ•æˆ–åœ–ç‰‡é è¦½å€åŸŸï¼Œä¸è™•ç†
                if (e.target === fileInput || 
                    e.target.tagName === 'BUTTON' || 
                    e.target.closest('button') ||
                    e.target.closest('.image-preview-item') ||
                    e.target.closest('.image-remove')) {
                    return;
                }
                
                // é˜²æ­¢é‡è¤‡è§¸ç™¼
                if (isUploading || isFileDialogOpen) {
                    console.log('â³ æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...');
                    return;
                }
                
                e.stopPropagation();
                e.preventDefault();
                
                // æ¨™è¨˜æª”æ¡ˆå°è©±æ¡†ç‚ºé–‹å•Ÿç‹€æ…‹
                isFileDialogOpen = true;
                
                // ç›´æ¥è§¸ç™¼æª”æ¡ˆé¸æ“‡ï¼Œä¸ä½¿ç”¨ setTimeout
                fileInput.click();
            }, true); // ä½¿ç”¨æ•ç²éšæ®µï¼Œç¢ºä¿å„ªå…ˆè™•ç†
            
            // ç›£è½æª”æ¡ˆé¸æ“‡å™¨ç„¦é»è®ŠåŒ–ï¼ˆç•¶æª”æ¡ˆå°è©±æ¡†é—œé–‰æ™‚ï¼‰
            fileInput.addEventListener('focus', function() {
                // æª”æ¡ˆå°è©±æ¡†æ‰“é–‹
                isFileDialogOpen = true;
            });
            
            // æª”æ¡ˆé¸æ“‡å™¨çš„ change äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                // æª”æ¡ˆå°è©±æ¡†å·²é—œé–‰
                isFileDialogOpen = false;
                
                // ç²å–æ‰€æœ‰é¸æ“‡çš„æª”æ¡ˆ
                const files = Array.from(e.target.files || []);
                
                // å¦‚æœæ²’æœ‰é¸æ“‡æª”æ¡ˆï¼ˆç”¨æˆ¶é»æ“Šå–æ¶ˆï¼‰ï¼Œç›´æ¥è¿”å›
                if (files.length === 0) {
                    console.log('ğŸ“‹ æœªé¸æ“‡æª”æ¡ˆ');
                    fileInput.value = '';
                    return;
                }
                
                console.log(`ğŸ“ é¸æ“‡äº† ${files.length} å€‹æª”æ¡ˆ:`, files.map(f => `${f.name} (${(f.size / 1024).toFixed(2)} KB)`));
                
                // ä¿å­˜æª”æ¡ˆåˆ—è¡¨å¾Œç«‹å³æ¸…ç©ºæª”æ¡ˆé¸æ“‡å™¨ï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼
                const selectedFiles = Array.from(files);
                fileInput.value = '';
                
                // è™•ç†æª”æ¡ˆï¼ˆä¸ä¸Šå‚³ï¼Œåªé è¦½ï¼‰
                handleFiles(selectedFiles);
            });
        
            // ç•¶è¦–çª—å¤±å»ç„¦é»æ™‚ï¼ˆæª”æ¡ˆå°è©±æ¡†é—œé–‰ï¼‰ï¼Œé‡ç½®æ¨™èªŒ
            window.addEventListener('focus', function() {
                setTimeout(() => {
                    isFileDialogOpen = false;
                }, 100);
            });
            
            // åœ–ç‰‡æ‹–æ›³æ’åºï¼ˆçµ²æ»‘é è¦½ï¼‰
            initImageSortable();
        });
        
        // è™•ç†æª”æ¡ˆï¼ˆåªé è¦½ï¼Œä¸ä¸Šå‚³ï¼‰
        function handleFiles(files) {
            if (!files || files.length === 0) {
                console.warn('âš ï¸ æ²’æœ‰é¸æ“‡æª”æ¡ˆ');
                return;
            }
            
            console.log(`ğŸ“ æ”¶åˆ° ${files.length} å€‹æª”æ¡ˆ`);
            
            // éæ¿¾å‡ºåœ–ç‰‡æª”æ¡ˆï¼ˆæª¢æŸ¥ MIME type å’Œå‰¯æª”åï¼‰
            const imageFiles = files.filter(file => {
                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                const isValidType = validTypes.includes(file.type.toLowerCase());
                
                // æª¢æŸ¥æª”æ¡ˆåç¨±å‰¯æª”åï¼ˆæœ‰äº›ç€è¦½å™¨å¯èƒ½æ²’æœ‰æ­£ç¢ºçš„ MIME typeï¼‰
                const fileName = file.name.toLowerCase();
                const hasValidExtension = fileName.endsWith('.jpg') || 
                                         fileName.endsWith('.jpeg') || 
                                         fileName.endsWith('.png') || 
                                         fileName.endsWith('.gif') || 
                                         fileName.endsWith('.webp');
                
                const isValid = isValidType || hasValidExtension;
                
                if (!isValid) {
                    console.warn(`âš ï¸ è·³ééåœ–ç‰‡æª”æ¡ˆ: ${file.name} (type: ${file.type})`);
                }
                
                return isValid;
            });
            
            if (imageFiles.length === 0) {
                showAlert('error', 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼ˆJPGã€PNGã€GIFã€WEBPï¼‰');
                console.warn('âš ï¸ æ²’æœ‰æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ');
                return;
            }
            
            console.log(`ğŸ–¼ï¸ éæ¿¾å¾Œæœ‰ ${imageFiles.length} å€‹åœ–ç‰‡æª”æ¡ˆ`);
            
            // æª¢æŸ¥ç¸½æ•¸æ˜¯å¦è¶…é10å¼µ
            const currentCount = uploadedImages.length;
            const maxImages = 10;
            
            if (currentCount + imageFiles.length > maxImages) {
                const remaining = maxImages - currentCount;
                if (remaining <= 0) {
                    showAlert('error', `æœ€å¤šåªèƒ½ä¸Šå‚³ ${maxImages} å¼µåœ–ç‰‡ï¼Œç›®å‰å·²é”ä¸Šé™`);
                    console.warn(`âš ï¸ å·²é”ä¸Šé™ ${maxImages} å¼µ`);
                    return;
                } else {
                    showAlert('warning', `åªèƒ½å†ä¸Šå‚³ ${remaining} å¼µåœ–ç‰‡ï¼ˆæœ€å¤š ${maxImages} å¼µï¼‰ï¼Œå°‡åªæ·»åŠ å‰ ${remaining} å¼µ`);
                    console.warn(`âš ï¸ åªä¿ç•™å‰ ${remaining} å¼µåœ–ç‰‡`);
                    imageFiles.splice(remaining); // åªå–å‰é¢å¹¾å¼µ
                }
            }
            
            console.log(`ğŸ“¤ æº–å‚™é è¦½ ${imageFiles.length} å€‹åœ–ç‰‡æª”æ¡ˆï¼ˆç›®å‰å·²æœ‰ ${currentCount} å¼µï¼‰`);
            
            // åªæ·»åŠ é è¦½ï¼Œä¸ä¸Šå‚³
            let successCount = 0;
            let failCount = 0;
            
            for (const file of imageFiles) {
                try {
                    addImagePreview(file);
                    successCount++;
                } catch (error) {
                    console.error(`âŒ æ·»åŠ é è¦½å¤±æ•—: ${file.name}`, error);
                    failCount++;
                }
            }
            
            const newTotal = uploadedImages.length;
            console.log(`âœ… æˆåŠŸæ·»åŠ  ${successCount} å¼µåœ–ç‰‡åˆ°é è¦½å€ï¼ˆå…± ${newTotal}/${maxImages} å¼µï¼‰`);
            
            if (failCount > 0) {
                console.warn(`âš ï¸ ${failCount} å¼µåœ–ç‰‡æ·»åŠ å¤±æ•—`);
            }
            
            if (successCount > 0) {
                showAlert('success', `å·²æ·»åŠ  ${successCount} å¼µåœ–ç‰‡åˆ°é è¦½å€ï¼ˆå…± ${newTotal}/${maxImages} å¼µï¼‰`);
            }
        }
        
        // æ·»åŠ åœ–ç‰‡é è¦½ï¼ˆä¸ä¸Šå‚³ï¼Œåªé è¦½ï¼‰
        function addImagePreview(file) {
            // é©—è­‰æª”æ¡ˆé¡å‹
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showAlert('error', `ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼: ${file.type}ï¼Œè«‹ä½¿ç”¨ JPGã€PNGã€GIF æˆ– WEBP`);
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showAlert('error', `æª”æ¡ˆå¤ªå¤§: ${(file.size / 1024 / 1024).toFixed(2)}MBï¼Œè«‹ä¸Šå‚³å°æ–¼ 10MB çš„åœ–ç‰‡`);
                return;
            }
            
            // ç²å–åœ–ç‰‡é è¦½å®¹å™¨
            const imagePreviewGrid = document.getElementById('image-preview-grid');
            if (!imagePreviewGrid) {
                console.error('âŒ æ‰¾ä¸åˆ°åœ–ç‰‡é è¦½å®¹å™¨ #image-preview-grid');
                return false;
            }
            
            const imageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // å‰µå»ºæœ¬åœ°é è¦½ URL
            let previewURL;
            try {
                previewURL = URL.createObjectURL(file);
            } catch (error) {
                console.error(`âŒ ç„¡æ³•å‰µå»ºé è¦½ URL: ${file.name}`, error);
                showAlert('error', `ç„¡æ³•é è¦½åœ–ç‰‡: ${file.name}`);
                return false;
            }
            
            // å„²å­˜æª”æ¡ˆè³‡è¨Šï¼ˆä¸ä¸Šå‚³ï¼‰
            uploadedImages.push({
                file: file, // ä¿å­˜åŸå§‹æª”æ¡ˆç‰©ä»¶
                previewURL: previewURL, // æœ¬åœ°é è¦½ URL
                originalName: file.name,
                fileSize: file.size,
                fileType: file.type,
                imageId: imageId,
                uploadedAt: Date.now()
            });
            
            // å¦‚æœæ˜¯ç¬¬ä¸€å¼µåœ–ç‰‡ï¼Œè‡ªå‹•è¨­ç‚ºå°é¢
            const isFirstImage = uploadedImages.length === 0;
            if (isFirstImage) {
                // é€™å¼µåœ–ç‰‡å°‡æˆç‚ºç¬¬ä¸€å¼µï¼Œæ¨™è¨˜ç‚ºå°é¢
                // æ³¨æ„ï¼šé€™è£¡å…ˆ pushï¼Œæ‰€ä»¥å¯¦éš›ä¸Šæ˜¯ uploadedImages.length === 1
            }
            
            // å‰µå»ºé è¦½é …ç›®
            try {
                const previewItem = createImagePreviewItemForLocal(imageId, previewURL, file.name, isFirstImage);
                if (previewItem) {
                    imagePreviewGrid.appendChild(previewItem);
                    console.log(`âœ… å·²æ·»åŠ åœ–ç‰‡é è¦½: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸€å¼µåœ–ç‰‡ï¼Œæ¨™è¨˜ç‚ºå°é¢
                    if (isFirstImage) {
                        const imageData = uploadedImages[uploadedImages.length - 1];
                        if (imageData) {
                            imageData.isCover = true;
                        }
                    }
                    
                    // ç¢ºä¿æ‹–æ›³åŠŸèƒ½å·²åˆå§‹åŒ–ï¼ˆåœ¨æ·»åŠ åœ–ç‰‡å¾Œï¼‰
                    initImageSortable();
                    
                    return true;
                } else {
                    console.error(`âŒ ç„¡æ³•å‰µå»ºé è¦½é …ç›®: ${file.name}`);
                    return false;
                }
            } catch (error) {
                console.error(`âŒ å‰µå»ºé è¦½é …ç›®å¤±æ•—: ${file.name}`, error);
                // å¾ uploadedImages ä¸­ç§»é™¤
                uploadedImages.pop();
                URL.revokeObjectURL(previewURL);
                return false;
            }
        }
        
        // ä¸Šå‚³å–®å¼µåœ–ç‰‡ï¼ˆå…ˆä¸Šå‚³åˆ°è‡¨æ™‚ä½ç½®ï¼Œæäº¤æ™‚å†æ•´ç†ï¼‰
        async function uploadImage(file) {
            // æª¢æŸ¥ Supabase æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                isUploading = false; // é‡ç½®æ¨™èªŒ
                showAlert('error', 'è«‹å…ˆè¨­å®š Supabase é…ç½®ï¼Œæ­£åœ¨è·³è½‰åˆ°è¨­å®šé é¢...');
                // è‡ªå‹•è·³è½‰åˆ°è¨­å®šé é¢
                setTimeout(() => {
                    const configTab = document.querySelector('.tab[onclick*="config"]');
                    if (configTab) {
                        switchTab('config', configTab);
                    }
                }, 1000);
                return;
            }
            
            // é©—è­‰æª”æ¡ˆé¡å‹
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showAlert('error', `ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼: ${file.type}ï¼Œè«‹ä½¿ç”¨ JPGã€PNGã€GIF æˆ– WEBP`);
                console.warn('âš ï¸ ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹:', file.type);
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showAlert('error', `æª”æ¡ˆå¤ªå¤§: ${(file.size / 1024 / 1024).toFixed(2)}MBï¼Œè«‹ä¸Šå‚³å°æ–¼ 10MB çš„åœ–ç‰‡`);
                console.warn('âš ï¸ æª”æ¡ˆéå¤§:', file.size);
                return;
            }
            
            // ç²å–åœ–ç‰‡é è¦½å®¹å™¨
            const imagePreviewGrid = document.getElementById('image-preview-grid');
            if (!imagePreviewGrid) {
                console.error('æ‰¾ä¸åˆ°åœ–ç‰‡é è¦½å®¹å™¨');
                return;
            }
            
            const imageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const previewItem = createImagePreviewItem(imageId, file);
            // ç«‹å³æ·»åŠ åˆ°é è¦½å€åŸŸï¼ˆå…ˆé¡¯ç¤ºæœ¬åœ°é è¦½ï¼‰
            imagePreviewGrid.appendChild(previewItem);
            
            try {
                // ç”Ÿæˆæª”æ¡ˆåç¨±å’Œè·¯å¾‘ï¼ˆå…ˆä¸Šå‚³åˆ°è‡¨æ™‚è³‡æ–™å¤¾ï¼‰
                const fileExt = file.name.split('.').pop().toLowerCase();
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                // ä½¿ç”¨è‡¨æ™‚è³‡æ–™å¤¾ï¼Œç­‰æäº¤æ™‚å†æ ¹æ“šç‰©ä»¶ç·¨è™Ÿæ•´ç†åˆ°æ–°çµæ§‹
                const tempFolder = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const tempPath = `temp/${tempFolder}/${fileName}`;
                
                console.log('ğŸ“¤ é–‹å§‹ä¸Šå‚³åœ–ç‰‡åˆ°è‡¨æ™‚ä½ç½®:', {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    tempPath: tempPath,
                    storage: !!storage,
                    db: !!db
                });
                
                // å†æ¬¡æª¢æŸ¥ Supabase æ˜¯å¦æ­£ç¢ºåˆå§‹åŒ–
                if (!supabaseClient) {
                    throw new Error('Supabase æœªåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥ Supabase è¨­å®š');
                }
                
                // ä¸Šå‚³åˆ° Supabase Storage è‡¨æ™‚è³‡æ–™å¤¾
                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from('junyang666')
                    .upload(tempPath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    console.error('âŒ ä¸Šå‚³éŒ¯èª¤:', uploadError);
                    console.error('éŒ¯èª¤è©³æƒ…:', {
                        message: uploadError.message,
                        statusCode: uploadError.statusCode
                    });
                    
                    previewItem.remove();
                    let errorMsg = `åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ${file.name}`;
                    
                    // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                    if (uploadError.message && uploadError.message.includes('unauthorized')) {
                        errorMsg += ' - æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹æª¢æŸ¥ Storage è¦å‰‡';
                    } else if (uploadError.message && uploadError.message.includes('canceled')) {
                        errorMsg += ' - ä¸Šå‚³å·²å–æ¶ˆ';
                    } else {
                        errorMsg += ` - ${uploadError.message || 'æœªçŸ¥éŒ¯èª¤'}`;
                    }
                    
                    showAlert('error', errorMsg);
                    isUploading = false;
                    isFileDialogOpen = false;
                    return;
                }
                
                // ä¸Šå‚³å®Œæˆï¼Œå–å¾—å…¬é–‹ URL
                const { data: urlData } = supabaseClient
                    .storage
                    .from('junyang666')
                    .getPublicUrl(tempPath);
                
                const downloadURL = urlData.publicUrl;
                
                console.log('âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸ:', {
                    fileName: file.name,
                    downloadURL: downloadURL,
                    tempPath: tempPath
                });
                
                // å„²å­˜ URL å’Œè‡¨æ™‚è·¯å¾‘ï¼ˆæäº¤æ™‚æœƒæ ¹æ“šç‰©ä»¶ç·¨è™Ÿé‡æ–°æ•´ç†ï¼‰
                uploadedImages.push({
                    url: downloadURL,
                    tempKey: tempPath, // è‡¨æ™‚è·¯å¾‘
                    tempFolder: tempFolder, // è‡¨æ™‚è³‡æ–™å¤¾
                    originalName: file.name,
                    fileSize: file.size,
                    uploadedAt: Date.now(),
                    file: file // ä¿ç•™æª”æ¡ˆç‰©ä»¶ï¼Œæ–¹ä¾¿å¾ŒçºŒè™•ç†
                });
                
                // æ›´æ–°é è¦½
                requestAnimationFrame(() => {
                    const img = previewItem.querySelector('img');
                    if (img) {
                        img.src = downloadURL;
                    }
                    const progress = previewItem.querySelector('.upload-progress');
                    if (progress) {
                        progress.style.display = 'none';
                    }
                });
                
                showAlert('success', `åœ–ç‰‡ä¸Šå‚³æˆåŠŸ: ${file.name}`);
                
                // é‡ç½®ä¸Šå‚³ç‹€æ…‹
                isUploading = false;
                isFileDialogOpen = false;
            } catch (error) {
                console.error('âŒ ä¸Šå‚³éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error);
                previewItem.remove();
                let errorMsg = `åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ${file.name}`;
                if (error.message) {
                    errorMsg += ` - ${error.message}`;
                }
                showAlert('error', errorMsg);
            }
        }
        
        // å»ºç«‹åœ–ç‰‡é è¦½é …ç›®ï¼ˆæœ¬åœ°é è¦½ç‰ˆæœ¬ï¼Œä¸ä¸Šå‚³ï¼‰
        function createImagePreviewItemForLocal(imageId, previewURL, fileName, isCover = false) {
            const item = document.createElement('div');
            item.className = 'image-preview-item';
            if (isCover) {
                item.classList.add('cover-image');
            }
            item.dataset.imageId = imageId;
            item.draggable = true;
            item.style.position = 'relative';
            
            const img = document.createElement('img');
            img.setAttribute('loading', 'lazy');
            img.setAttribute('decoding', 'async');
            img.src = previewURL;
            img.alt = fileName;
            img.style.backgroundColor = '#f8f9fa';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.onload = function() {
                this.style.backgroundColor = 'transparent';
            };
            img.onerror = function() {
                console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', previewURL);
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+PC9zdmc+';
            };
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'image-remove';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center; z-index: 10;';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeImage(item, imageId);
            };
            
            // é¡¯ç¤ºå¾…ä¸Šå‚³æ¨™ç±¤
            const statusBadge = document.createElement('div');
            statusBadge.className = 'image-status-badge';
            statusBadge.textContent = 'å¾…ä¸Šå‚³';
            statusBadge.style.cssText = 'position: absolute; top: 2px; left: 2px; background: #ffc107; color: #000; padding: 1px 4px; border-radius: 2px; font-size: 9px; font-weight: bold; z-index: 10; line-height: 1.2;';
            
            // å°é¢æ¨™ç±¤ï¼ˆå¦‚æœæ˜¯æŒ‡å®šçš„å°é¢ï¼‰
            let coverBadge = null;
            if (isCover) {
                coverBadge = document.createElement('div');
                coverBadge.className = 'image-cover-badge';
                coverBadge.innerHTML = 'â­ å°é¢';
                coverBadge.style.cssText = 'position: absolute; top: 2px; left: 2px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; z-index: 11; display: flex; align-items: center; gap: 2px;';
                // å¦‚æœæ˜¯æŒ‡å®šå°é¢ï¼Œéš±è—å¾…ä¸Šå‚³æ¨™ç±¤
                statusBadge.style.display = 'none';
            }
            
            // è¨­ç‚ºå°é¢æŒ‰éˆ•
            const coverBtn = document.createElement('button');
            coverBtn.className = 'image-cover-btn';
            if (isCover) {
                coverBtn.classList.add('is-cover');
                coverBtn.innerHTML = 'âœ“ å°é¢';
            } else {
                coverBtn.innerHTML = 'â­ è¨­ç‚ºå°é¢';
            }
            coverBtn.onclick = (e) => {
                e.stopPropagation();
                setAsCoverImage(imageId);
            };
            
            item.appendChild(img);
            item.appendChild(removeBtn);
            item.appendChild(statusBadge);
            if (coverBadge) {
                item.appendChild(coverBadge);
            }
            item.appendChild(coverBtn);
            
            return item;
        }
        
        // å»ºç«‹åœ–ç‰‡é è¦½é …ç›®ï¼ˆä¸Šå‚³ç‰ˆæœ¬ï¼Œå¸¶é€²åº¦æ¢ï¼‰
        function createImagePreviewItem(imageId, file) {
            const item = document.createElement('div');
            item.className = 'image-preview-item';
            item.dataset.imageId = imageId;
            item.draggable = true;
            
            const img = document.createElement('img');
            // ä½¿ç”¨ç•°æ­¥è¼‰å…¥åœ–ç‰‡
            img.setAttribute('loading', 'lazy');
            img.setAttribute('decoding', 'async');
            // å…ˆå»ºç«‹å ä½ç¬¦ï¼Œé¿å…ä½ˆå±€è·³å‹•
            img.style.backgroundColor = '#f8f9fa';
            const objectUrl = URL.createObjectURL(file);
            img.src = objectUrl;
            // åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œå„ªåŒ–
            img.onload = function() {
                this.style.backgroundColor = 'transparent';
            };
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'image-remove';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.onclick = () => {
                URL.revokeObjectURL(objectUrl); // æ¸…ç†è¨˜æ†¶é«”
                removeImage(item, imageId);
            };
            
            const progress = document.createElement('div');
            progress.className = 'upload-progress';
            const progressBar = document.createElement('div');
            progressBar.className = 'upload-progress-bar';
            progressBar.style.width = '0%';
            progress.appendChild(progressBar);
            
            item.appendChild(img);
            item.appendChild(removeBtn);
            item.appendChild(progress);
            
            return item;
        }
        
        // è¨­ç‚ºå°é¢åœ–ç‰‡
        function setAsCoverImage(imageId) {
            // æ¸…é™¤æ‰€æœ‰åœ–ç‰‡çš„å°é¢æ¨™è¨˜
            uploadedImages.forEach(img => {
                img.isCover = false;
            });
            
            // è¨­ç½®æŒ‡å®šåœ–ç‰‡ç‚ºå°é¢
            const imageIndex = uploadedImages.findIndex(img => img.imageId === imageId);
            if (imageIndex !== -1) {
                uploadedImages[imageIndex].isCover = true;
                console.log(`â­ å·²è¨­ç½®å°é¢åœ–ç‰‡: ${uploadedImages[imageIndex].originalName || 'æœªçŸ¥'}`);
                
                // æ›´æ–°æ‰€æœ‰åœ–ç‰‡é è¦½çš„è¦–è¦ºæ•ˆæœ
                updateImagePreviewDisplay();
                
                showAlert('success', 'å·²è¨­ç½®ç‚ºå°é¢åœ–ç‰‡ï¼');
            } else {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°æŒ‡å®šçš„åœ–ç‰‡:', imageId);
            }
        }
        
        // æ›´æ–°åœ–ç‰‡é è¦½é¡¯ç¤ºï¼ˆæ›´æ–°å°é¢æ¨™è¨˜ï¼‰
        function updateImagePreviewDisplay() {
            const imagePreviewGrid = document.getElementById('image-preview-grid');
            if (!imagePreviewGrid) return;
            
            // ç²å–æ‰€æœ‰åœ–ç‰‡é …ç›®
            const items = imagePreviewGrid.querySelectorAll('.image-preview-item');
            items.forEach(item => {
                const imageId = item.dataset.imageId;
                const imageData = uploadedImages.find(img => img.imageId === imageId);
                
                if (imageData && imageData.isCover) {
                    // æ·»åŠ å°é¢æ¨£å¼
                    item.classList.add('cover-image');
                    
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    const coverBtn = item.querySelector('.image-cover-btn');
                    if (coverBtn) {
                        coverBtn.classList.add('is-cover');
                        coverBtn.innerHTML = 'âœ“ å°é¢';
                    }
                    
                    // é¡¯ç¤ºå°é¢æ¨™ç±¤
                    let coverBadge = item.querySelector('.image-cover-badge');
                    if (!coverBadge) {
                        coverBadge = document.createElement('div');
                        coverBadge.className = 'image-cover-badge';
                        coverBadge.innerHTML = 'â­ å°é¢';
                        coverBadge.style.cssText = 'position: absolute; top: 2px; left: 2px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; z-index: 11; display: flex; align-items: center; gap: 2px;';
                        item.appendChild(coverBadge);
                    }
                    
                    // éš±è—å¾…ä¸Šå‚³æ¨™ç±¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const statusBadge = item.querySelector('.image-status-badge');
                    if (statusBadge) {
                        statusBadge.style.display = 'none';
                    }
                } else {
                    // ç§»é™¤å°é¢æ¨£å¼
                    item.classList.remove('cover-image');
                    
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    const coverBtn = item.querySelector('.image-cover-btn');
                    if (coverBtn) {
                        coverBtn.classList.remove('is-cover');
                        coverBtn.innerHTML = 'â­ è¨­ç‚ºå°é¢';
                    }
                    
                    // ç§»é™¤å°é¢æ¨™ç±¤
                    const coverBadge = item.querySelector('.image-cover-badge');
                    if (coverBadge) {
                        coverBadge.remove();
                    }
                    
                    // é¡¯ç¤ºå¾…ä¸Šå‚³æ¨™ç±¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const statusBadge = item.querySelector('.image-status-badge');
                    if (statusBadge) {
                        statusBadge.style.display = 'block';
                    }
                }
            });
        }
        
        // ç§»é™¤åœ–ç‰‡
        async function removeImage(item, imageId) {
            // å¾ uploadedImages ä¸­ç§»é™¤ï¼ˆæ ¹æ“š imageIdï¼‰
            const index = uploadedImages.findIndex(img => img.imageId === imageId);
            if (index !== -1) {
                const imgData = uploadedImages[index];
                const wasCover = imgData.isCover;
                
                // å¦‚æœåœ–ç‰‡å·²ç¶“ä¸Šå‚³åˆ° Storageï¼Œå˜—è©¦åˆªé™¤è‡¨æ™‚æª”æ¡ˆ
                if (imgData.tempKey && storage) {
                    try {
                        const tempRef = storage.ref(imgData.tempKey);
                        await tempRef.delete();
                        console.log('ğŸ—‘ï¸ å·²åˆªé™¤è‡¨æ™‚åœ–ç‰‡:', imgData.tempKey);
                    } catch (error) {
                        console.warn('âš ï¸ åˆªé™¤è‡¨æ™‚åœ–ç‰‡å¤±æ•—:', error);
                    }
                }
                
                // æ¸…ç†æœ¬åœ°é è¦½ URL
                if (imgData.previewURL) {
                    URL.revokeObjectURL(imgData.previewURL);
                }
                
                uploadedImages.splice(index, 1);
                console.log(`ğŸ—‘ï¸ å·²ç§»é™¤åœ–ç‰‡: ${imgData.originalName || 'æœªçŸ¥'}`);
                
                // å¦‚æœåˆªé™¤çš„æ˜¯å°é¢åœ–ç‰‡ï¼Œå°‡ç¬¬ä¸€å¼µåœ–ç‰‡è¨­ç‚ºå°é¢
                if (wasCover && uploadedImages.length > 0) {
                    uploadedImages[0].isCover = true;
                    updateImagePreviewDisplay();
                }
            }
            item.remove();
        }
        
        // åœ–ç‰‡æ‹–æ›³æ’åºï¼šçµ²æ»‘æ‹–æ›³ + å³æ™‚é è¦½æ”¾ç½®ä½ç½®
        let sortDragPlaceholder = null;
        let sortDraggedId = null;
        let sortDraggedEl = null;
        let sortDropIndex = -1;
        
        // ä½¿ç”¨æ··åˆæ¨¡å¼ï¼šdocument ç´šåˆ¥ + grid ç´šåˆ¥äº‹ä»¶
        let imageSortableInitialized = false;
        let gridEventHandlers = null;
        
        function initImageSortable() {
            // å…ˆç¶å®š document ç´šåˆ¥çš„ dragstartï¼ˆç”¨æ–¼æ•ç²æ‰€æœ‰æ‹–æ›³é–‹å§‹ï¼‰
            if (!imageSortableInitialized) {
                document.addEventListener('dragstart', function(e) {
                    const item = e.target.closest('.image-preview-item');
                    if (item && item.dataset.imageId && (item.draggable === true || item.getAttribute('draggable') === 'true')) {
                        console.log('ğŸ–±ï¸ æª¢æ¸¬åˆ°æ‹–æ›³é–‹å§‹:', item.dataset.imageId);
                        onImageDragStart(e);
                    }
                }, false);
                
                document.addEventListener('dragend', function(e) {
                    if (sortDraggedEl) {
                        onImageDragEnd(e);
                    }
                }, false);
                
                imageSortableInitialized = true;
            }
            
            // ç‚º grid ç¶å®š dragover å’Œ dropï¼ˆå¿…é ˆåœ¨ grid ä¸Šæ‰èƒ½æ­£ç¢ºè§¸ç™¼ï¼‰
            const grid = document.getElementById('image-preview-grid');
            if (!grid) {
                console.warn('âš ï¸ image-preview-grid å°šæœªå­˜åœ¨');
                return;
            }
            
            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (gridEventHandlers) {
                grid.removeEventListener('dragover', gridEventHandlers.dragover);
                grid.removeEventListener('drop', gridEventHandlers.drop);
            }
            
            // å‰µå»ºæ–°çš„äº‹ä»¶è™•ç†å™¨
            gridEventHandlers = {
                dragover: function(e) {
                    if (!sortDraggedEl) return;
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'move';
                    // æ·»åŠ èª¿è©¦ä¿¡æ¯ï¼ˆæ¯ 10 æ¬¡è¼¸å‡ºä¸€æ¬¡ï¼Œé¿å…éå¤šæ—¥èªŒï¼‰
                    if (!gridEventHandlers.dragoverCount) gridEventHandlers.dragoverCount = 0;
                    gridEventHandlers.dragoverCount++;
                    if (gridEventHandlers.dragoverCount % 10 === 0) {
                        console.log('ğŸ”„ dragover è§¸ç™¼ä¸­...', gridEventHandlers.dragoverCount);
                    }
                    onImageDragOver(e);
                },
                drop: function(e) {
                    if (!sortDraggedEl) return;
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ğŸ“¦ æª¢æ¸¬åˆ° drop äº‹ä»¶åœ¨ grid ä¸Š');
                    gridEventHandlers.dragoverCount = 0; // é‡ç½®è¨ˆæ•¸
                    onImageDrop(e);
                }
            };
            gridEventHandlers.dragoverCount = 0;
            
            // ç¶å®šåˆ° grid
            grid.addEventListener('dragover', gridEventHandlers.dragover, false);
            grid.addEventListener('drop', gridEventHandlers.drop, false);
            
            console.log('âœ… åœ–ç‰‡æ‹–æ›³æ’åºåŠŸèƒ½å·²åˆå§‹åŒ–ï¼ˆgrid ç¶å®šæ¨¡å¼ï¼‰');
            
            // é©—è­‰ç¾æœ‰åœ–ç‰‡é …ç›®æ˜¯å¦å¯æ‹–æ›³
            setTimeout(() => {
                const items = grid.querySelectorAll('.image-preview-item');
                console.log(`ğŸ“Š æª¢æŸ¥åœ–ç‰‡é …ç›®: å…± ${items.length} å€‹`);
                items.forEach((item, idx) => {
                    const hasDraggable = item.draggable === true || item.getAttribute('draggable') === 'true';
                    const hasImageId = !!item.dataset.imageId;
                    if (!hasDraggable) {
                        console.warn(`âš ï¸ é …ç›® ${idx + 1} ç¼ºå°‘ draggable å±¬æ€§ï¼Œæ­£åœ¨ä¿®å¾©...`);
                        item.draggable = true;
                    }
                    if (!hasImageId) {
                        console.warn(`âš ï¸ é …ç›® ${idx + 1} ç¼ºå°‘ imageId`);
                    }
                });
            }, 500);
        }
        
        function onImageDragStart(e) {
            // ç¢ºä¿äº‹ä»¶åœ¨æ­£ç¢ºçš„å…ƒç´ ä¸Šè§¸ç™¼
            let item = e.target;
            if (!item.classList.contains('image-preview-item')) {
                item = e.target.closest('.image-preview-item');
            }
            
            if (!item || !item.dataset.imageId) {
                console.log('âš ï¸ æ‹–æ›³é–‹å§‹ï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆçš„åœ–ç‰‡é …ç›®', e.target);
                return;
            }
            
            // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œä¸è§¸ç™¼æ‹–æ›³
            if (e.target.closest('button')) {
                console.log('âš ï¸ æ‹–æ›³é–‹å§‹ï¼šé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œå–æ¶ˆæ‹–æ›³');
                return;
            }
            
            const grid = document.getElementById('image-preview-grid');
            if (!grid) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ° image-preview-grid');
                return;
            }
            
            const id = item.dataset.imageId;
            const items = [].slice.call(grid.querySelectorAll('.image-preview-item'));
            const idx = items.indexOf(item);
            if (idx === -1) {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°åœ–ç‰‡é …ç›®çš„ç´¢å¼•');
                return;
            }
            
            console.log('ğŸ–±ï¸ é–‹å§‹æ‹–æ›³åœ–ç‰‡:', id, 'ç´¢å¼•:', idx);
            
            e.dataTransfer.setData('application/x-image-sort', id);
            e.dataTransfer.effectAllowed = 'move';
            
            // å‰µå»ºè‡ªè¨‚æ‹–æ›³åœ–ç‰‡
            try {
                e.dataTransfer.setDragImage(item, item.offsetWidth / 2, item.offsetHeight / 2);
            } catch (err) {
                console.warn('âš ï¸ ç„¡æ³•è¨­ç½®è‡ªè¨‚æ‹–æ›³åœ–ç‰‡:', err);
            }
            
            sortDraggedId = id;
            sortDraggedEl = item;
            sortDropIndex = idx;
            item.classList.add('dragging');
            
            // å‰µå»ºæ”¾ç½®é è¦½ä½ç½®
            sortDragPlaceholder = document.createElement('div');
            sortDragPlaceholder.className = 'image-drag-placeholder';
            const itemsOrdered = [].slice.call(grid.querySelectorAll('.image-preview-item'));
            const insertBefore = itemsOrdered[idx + 1] || null;
            if (insertBefore) {
                grid.insertBefore(sortDragPlaceholder, insertBefore);
            } else {
                grid.appendChild(sortDragPlaceholder);
            }
            
            console.log('âœ… æ‹–æ›³åˆå§‹åŒ–å®Œæˆ');
        }
        
        function onImageDragOver(e) {
            const grid = document.getElementById('image-preview-grid');
            if (!sortDraggedEl || !sortDragPlaceholder || !grid) {
                return; // éœé»˜è¿”å›ï¼Œé¿å…éå¤šæ—¥èªŒ
            }
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // ä½¿ç”¨ document.elementFromPoint ä¾†ç²å–ç•¶å‰æ»‘é¼ ä½ç½®ä¸‹çš„å…ƒç´ 
            let targetElement = document.elementFromPoint(e.clientX, e.clientY);
            if (!targetElement) {
                // å¦‚æœ elementFromPoint å¤±æ•—ï¼Œä½¿ç”¨ e.target
                targetElement = e.target;
            }
            
            const item = targetElement.closest('.image-preview-item');
            const overPlaceholder = targetElement.closest('.image-drag-placeholder');
            const itemsOrdered = [].slice.call(grid.querySelectorAll('.image-preview-item'));
            
            // æ¸…é™¤æ‰€æœ‰ drag-over ç‹€æ…‹
            itemsOrdered.forEach(el => el.classList.remove('drag-over'));
            
            // å¦‚æœæ»‘é¼ åœ¨å…¶ä»–é …ç›®ä¸Šï¼Œæ·»åŠ  drag-over æ•ˆæœ
            if (item && item !== sortDraggedEl && !overPlaceholder) {
                item.classList.add('drag-over');
            }
            
            let newIndex;
            if (overPlaceholder) {
                // æ»‘é¼ åœ¨ placeholder ä¸Š
                let count = 0;
                for (let i = 0; i < grid.children.length; i++) {
                    const ch = grid.children[i];
                    if (ch === sortDragPlaceholder) {
                        newIndex = count;
                        break;
                    }
                    if (ch.classList.contains('image-preview-item')) count++;
                }
                if (newIndex === undefined) newIndex = itemsOrdered.length;
            } else if (item && item !== sortDraggedEl) {
                // æ»‘é¼ åœ¨å…¶ä»–åœ–ç‰‡é …ç›®ä¸Šï¼Œæ ¹æ“šä½ç½®æ±ºå®šæ’å…¥é»
                const rect = item.getBoundingClientRect();
                const mid = rect.left + rect.width / 2;
                const i = itemsOrdered.indexOf(item);
                newIndex = e.clientX < mid ? i : i + 1;
            } else {
                // æ»‘é¼ åœ¨ grid ç©ºç™½å€åŸŸï¼Œè¨ˆç®—æœ€æ¥è¿‘çš„ä½ç½®
                const gridRect = grid.getBoundingClientRect();
                const items = grid.querySelectorAll('.image-preview-item:not(.dragging)');
                
                if (items.length === 0) {
                    newIndex = 0;
                } else {
                    // æ‰¾åˆ°æœ€æ¥è¿‘çš„é …ç›®
                    let closestItem = null;
                    let minDistance = Infinity;
                    
                    items.forEach((it) => {
                        const itRect = it.getBoundingClientRect();
                        const centerX = itRect.left + itRect.width / 2;
                        const centerY = itRect.top + itRect.height / 2;
                        const distance = Math.sqrt(
                            Math.pow(e.clientX - centerX, 2) + 
                            Math.pow(e.clientY - centerY, 2)
                        );
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestItem = it;
                        }
                    });
                    
                    if (closestItem) {
                        const i = itemsOrdered.indexOf(closestItem);
                        const rect = closestItem.getBoundingClientRect();
                        newIndex = e.clientX < rect.left + rect.width / 2 ? i : i + 1;
                    } else {
                        newIndex = itemsOrdered.length;
                    }
                }
            }
            
            newIndex = Math.max(0, Math.min(newIndex, itemsOrdered.length));
            
            // åªåœ¨ç´¢å¼•æ”¹è®Šæ™‚æ›´æ–° placeholder ä½ç½®ï¼ˆé¿å…é »ç¹ DOM æ“ä½œï¼‰
            if (newIndex !== sortDropIndex) {
                sortDropIndex = newIndex;
                
                const insertBefore = itemsOrdered[newIndex] || null;
                if (insertBefore && insertBefore !== sortDragPlaceholder) {
                    grid.insertBefore(sortDragPlaceholder, insertBefore);
                } else if (!insertBefore && sortDragPlaceholder.parentNode !== grid) {
                    grid.appendChild(sortDragPlaceholder);
                } else if (insertBefore && sortDragPlaceholder.nextSibling !== insertBefore) {
                    grid.insertBefore(sortDragPlaceholder, insertBefore);
                }
            }
        }
        
        function onImageDrop(e) {
            const grid = document.getElementById('image-preview-grid');
            if (!sortDraggedId || !sortDraggedEl || !sortDragPlaceholder || !grid) {
                console.warn('âš ï¸ drop æ¢ä»¶ä¸æ»¿è¶³:', {
                    hasDraggedId: !!sortDraggedId,
                    hasDraggedEl: !!sortDraggedEl,
                    hasPlaceholder: !!sortDragPlaceholder,
                    hasGrid: !!grid
                });
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ğŸ“¦ åŸ·è¡Œ dropï¼Œå¾ç´¢å¼•', sortDropIndex, 'ç§»å‹•åˆ°', sortDropIndex);
            
            const fromIdx = uploadedImages.findIndex(img => img.imageId === sortDraggedId);
            if (fromIdx === -1) {
                console.error('âŒ æ‰¾ä¸åˆ°è¦ç§»å‹•çš„åœ–ç‰‡:', sortDraggedId);
                return;
            }
            
            const entry = uploadedImages.splice(fromIdx, 1)[0];
            let toIdx = sortDropIndex;
            if (toIdx > fromIdx) toIdx--;
            uploadedImages.splice(toIdx, 0, entry);
            
            console.log('âœ… å·²é‡æ–°æ’åº uploadedImagesï¼Œå¾', fromIdx, 'åˆ°', toIdx);
            
            // ç§»é™¤ placeholder
            if (sortDragPlaceholder && sortDragPlaceholder.parentNode) {
                sortDragPlaceholder.remove();
            }
            sortDragPlaceholder = null;
            
            // ç§»é™¤ dragging ç‹€æ…‹
            sortDraggedEl.classList.remove('dragging');
            
            // æ¸…é™¤æ‰€æœ‰ drag-over ç‹€æ…‹
            grid.querySelectorAll('.image-preview-item.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            // é‡æ–°æ’åˆ— DOM ä»¥åŒ¹é…æ–°çš„é †åº
            const itemsOrdered = [].slice.call(grid.querySelectorAll('.image-preview-item'));
            const moved = itemsOrdered.find(el => el.dataset.imageId === sortDraggedId);
            
            if (moved) {
                // æ‰¾åˆ°æ–°ä½ç½®æ‡‰è©²æ’å…¥åœ¨å“ªå€‹å…ƒç´ ä¹‹å‰
                const afterId = uploadedImages[toIdx + 1] && uploadedImages[toIdx + 1].imageId;
                const before = afterId
                    ? itemsOrdered.find(el => el.dataset.imageId === afterId && el !== moved)
                    : null;
                
                if (before && moved.nextSibling !== before) {
                    grid.insertBefore(moved, before);
                    console.log('âœ… å·²ç§»å‹• DOM å…ƒç´ åˆ°æ–°ä½ç½®ï¼ˆbeforeï¼‰');
                } else if (!before && moved.nextSibling !== null) {
                    grid.appendChild(moved);
                    console.log('âœ… å·²ç§»å‹• DOM å…ƒç´ åˆ°æ–°ä½ç½®ï¼ˆappendï¼‰');
                } else {
                    console.log('â„¹ï¸ DOM å…ƒç´ å·²åœ¨æ­£ç¢ºä½ç½®');
                }
            }
            
            // æ›´æ–°å°é¢ï¼ˆç¬¬ä¸€å¼µç‚ºå°é¢ï¼‰
            uploadedImages.forEach((img, i) => { 
                img.isCover = i === 0; 
            });
            updateImagePreviewDisplay();
            
            console.log('âœ… æ‹–æ›³æ’åºå®Œæˆï¼æ–°é †åº:', uploadedImages.map((img, i) => `${i}: ${img.imageId}`).join(', '));
            
            // æ¸…ç†ç‹€æ…‹
            sortDraggedId = null;
            sortDraggedEl = null;
            sortDropIndex = -1;
        }
        
        function onImageDragEnd(e) {
            if (sortDragPlaceholder && sortDragPlaceholder.parentNode) {
                sortDragPlaceholder.remove();
            }
            sortDragPlaceholder = null;
            if (sortDraggedEl) {
                sortDraggedEl.classList.remove('dragging');
            }
            const grid = document.getElementById('image-preview-grid');
            if (grid) {
                grid.querySelectorAll('.image-preview-item.drag-over').forEach(el => el.classList.remove('drag-over'));
            }
            sortDraggedId = null;
            sortDraggedEl = null;
            sortDropIndex = -1;
        }
        
        // ä¸Šå‚³ä¸¦æ•´ç†åœ–ç‰‡ï¼šå°‡æœ¬åœ°é è¦½çš„åœ–ç‰‡ä¸Šå‚³åˆ°æ­£ç¢ºçš„ç‰©ä»¶è³‡æ–™å¤¾
        async function uploadAndOrganizeImages(propertyNumber, progressCallback = null) {
            console.log('ğŸ“ é–‹å§‹ä¸Šå‚³ä¸¦æ•´ç†åœ–ç‰‡ï¼Œç‰©ä»¶ç·¨è™Ÿ:', propertyNumber);
            console.log('ğŸ“Š ç›®å‰ uploadedImages:', uploadedImages);
            
            if (!uploadedImages || uploadedImages.length === 0) {
                console.log('âš ï¸ æ²’æœ‰åœ–ç‰‡éœ€è¦ä¸Šå‚³');
                return [];
            }
            
            if (!supabaseClient) {
                console.error('âŒ Supabase æœªåˆå§‹åŒ–');
                throw new Error('Supabase æœªåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥ Supabase è¨­å®š');
            }
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºåº—å¤–ç‰©ä»¶ï¼ˆç·¨è™Ÿä»¥ EX é–‹é ­ï¼‰
            const isExternal = propertyNumber.startsWith('EX');
            
            // å¾ç·¨è™Ÿæå–é¡å‹ä»£ç¢¼ï¼ˆåº—å…§ï¼šSU00001 -> SUï¼Œåº—å¤–ï¼šEXSU0001 -> SUï¼‰
            let typeCode = '';
            if (isExternal) {
                // åº—å¤–ï¼šEXSU0001 -> SU
                typeCode = propertyNumber.substring(2, 4); // EX å¾Œé¢çš„ 2 å€‹å­—æ¯
            } else {
                // åº—å…§ï¼šSU00001 -> SU
                typeCode = propertyNumber.substring(0, 2); // å‰ 2 å€‹å­—æ¯
            }
            
            // ç”Ÿæˆåœ–ç‰‡å„²å­˜è·¯å¾‘ï¼ˆæ–°çµæ§‹ï¼šæŒ‰ä¾†æºå’Œæˆ¿å‹åˆ†é¡ï¼‰
            let basePath;
            if (isExternal) {
                // åº—å¤–ç‰©ä»¶ï¼šproperties/external/{æˆ¿å‹ä»£ç¢¼}/{ç‰©ä»¶ç·¨è™Ÿ}/image_1.jpg
                basePath = `properties/external/${typeCode}/${propertyNumber}`;
            } else {
                // åº—å…§ç‰©ä»¶ï¼šproperties/internal/{æˆ¿å‹ä»£ç¢¼}/{ç‰©ä»¶ç·¨è™Ÿ}/image_1.jpg
                basePath = `properties/internal/${typeCode}/${propertyNumber}`;
            }
            
            const organizedImages = [];
            const uploadedUrls = [];
            
            console.log(`ğŸ“ é–‹å§‹è™•ç† ${uploadedImages.length} å¼µåœ–ç‰‡åˆ°è³‡æ–™å¤¾: ${basePath}/`);
            
            for (let i = 0; i < uploadedImages.length; i++) {
                const img = uploadedImages[i];
                console.log(`\nğŸ–¼ï¸ è™•ç†åœ–ç‰‡ ${i + 1}/${uploadedImages.length}:`, {
                    hasFile: !!img.file,
                    hasUrl: !!img.url,
                    hasTempKey: !!img.tempKey,
                    fileName: img.file?.name || img.originalName || 'æœªçŸ¥'
                });
                
                try {
                    // å¦‚æœåœ–ç‰‡å·²ç¶“ä¸Šå‚³éï¼ˆæœ‰ URL ä¸”æ²’æœ‰ fileï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                    if (img.url && !img.file && !img.tempKey) {
                        console.log(`âœ… åœ–ç‰‡å·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨: ${img.url}`);
                        uploadedUrls.push(img.url);
                        organizedImages.push({
                            url: img.url,
                            key: img.key || img.url
                        });
                        continue;
                    }
                    
                    // å¦‚æœæœ‰æª”æ¡ˆç‰©ä»¶ï¼Œéœ€è¦ä¸Šå‚³ï¼ˆæœ€å¸¸è¦‹çš„æƒ…æ³ï¼‰
                    if (img.file) {
                        const file = img.file;
                        
                        // ç¢ºä¿æª”æ¡ˆæœ‰æ•ˆ
                        if (!file || !file.name) {
                            console.warn(`âš ï¸ åœ–ç‰‡ ${i + 1} æª”æ¡ˆç„¡æ•ˆï¼Œè·³é`);
                            continue;
                        }
                        
                        const fileExt = file.name.split('.').pop().toLowerCase();
                        // ä½¿ç”¨ç°¡å–®çš„åºè™Ÿå‘½åï¼šimage_1.jpg, image_2.jpg, ...
                        const fileName = `image_${i + 1}.${fileExt}`;
                        const newPath = `${basePath}/${fileName}`;
                        
                        console.log(`ğŸ“¤ [${i + 1}/${uploadedImages.length}] ä¸Šå‚³åœ–ç‰‡: ${file.name} (${(file.size / 1024).toFixed(2)}KB) â†’ ${newPath}`);
                        
                        // ä¸Šå‚³åˆ° Supabase Storage
                        const { data: uploadData, error: uploadError } = await supabaseClient
                            .storage
                            .from('junyang666')
                            .upload(newPath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (uploadError) {
                            throw uploadError;
                        }
                        
                        // å–å¾—å…¬é–‹ URL
                        const { data: urlData } = supabaseClient
                            .storage
                            .from('junyang666')
                            .getPublicUrl(newPath);
                        
                        const downloadURL = urlData.publicUrl;
                        
                        console.log(`âœ… [${i + 1}/${uploadedImages.length}] åœ–ç‰‡ä¸Šå‚³å®Œæˆ: ${fileName}`);
                        
                        uploadedUrls.push(downloadURL);
                        organizedImages.push({
                            url: downloadURL,
                            key: newPath
                        });
                        
                        // æ¸…ç†æœ¬åœ°é è¦½ URL
                        if (img.previewURL) {
                            URL.revokeObjectURL(img.previewURL);
                        }
                    } else if (img.tempKey) {
                        // å¦‚æœæ˜¯å¾è‡¨æ™‚ä½ç½®ç§»å‹•ï¼ˆä½¿ç”¨ Supabase Storageï¼‰
                        try {
                            const fileExt = img.tempKey.split('.').pop() || 'jpg';
                            // ä½¿ç”¨ç°¡å–®çš„åºè™Ÿå‘½åï¼šimage_1.jpg, image_2.jpg, ...
                            const fileName = `image_${i + 1}.${fileExt}`;
                            const newPath = `${basePath}/${fileName}`;
                            
                            // å¾è‡¨æ™‚ä½ç½®ä¸‹è¼‰æª”æ¡ˆ
                            const { data: downloadData, error: downloadError } = await supabaseClient
                                .storage
                                .from('junyang666')
                                .download(img.tempKey);
                            
                            if (downloadError) throw downloadError;
                            
                            // ä¸Šå‚³åˆ°æ–°ä½ç½®
                            const { data: uploadData, error: uploadError } = await supabaseClient
                                .storage
                                .from('junyang666')
                                .upload(newPath, downloadData, {
                                    cacheControl: '3600',
                                    upsert: false
                                });
                            
                            if (uploadError) throw uploadError;
                            
                            // å–å¾—æ–°ä½ç½®çš„å…¬é–‹ URL
                            const { data: urlData } = supabaseClient
                                .storage
                                .from('junyang666')
                                .getPublicUrl(newPath);
                            
                            const newDownloadURL = urlData.publicUrl;
                            
                            // åˆªé™¤è‡¨æ™‚æª”æ¡ˆ
                            try {
                                await supabaseClient
                                    .storage
                                    .from('junyang666')
                                    .remove([img.tempKey]);
                            } catch (deleteError) {
                                console.warn('âš ï¸ åˆªé™¤è‡¨æ™‚æª”æ¡ˆå¤±æ•—ï¼ˆå¯å¿½ç•¥ï¼‰:', deleteError);
                            }
                            
                            uploadedUrls.push(newDownloadURL);
                            organizedImages.push({
                                url: newDownloadURL,
                                key: newPath
                            });
                            
                            console.log(`âœ… åœ–ç‰‡å·²ç§»å‹•: ${img.tempKey} â†’ ${newPath}`);
                        } catch (moveError) {
                            console.error(`âŒ ç§»å‹•åœ–ç‰‡å¤±æ•— (${img.tempKey}):`, moveError);
                            // å¦‚æœç§»å‹•å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹ URLï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                            if (img.url) {
                                console.log(`ğŸ“ ä½¿ç”¨åŸå§‹ URL: ${img.url}`);
                                uploadedUrls.push(img.url);
                                organizedImages.push({
                                    url: img.url,
                                    key: img.key || img.tempKey
                                });
                            } else {
                                // å¦‚æœæ²’æœ‰åŸå§‹ URLï¼Œè¨˜éŒ„éŒ¯èª¤ä½†ç¹¼çºŒè™•ç†å…¶ä»–åœ–ç‰‡
                                console.warn(`âš ï¸ è·³éåœ–ç‰‡: ${img.tempKey}ï¼ˆç„¡æ³•ç§»å‹•ä¸”ç„¡åŸå§‹ URLï¼‰`);
                            }
                        }
                    } else {
                        // å¦‚æœéƒ½æ²’æœ‰ï¼ˆfileã€urlã€tempKeyï¼‰ï¼Œè¨˜éŒ„è­¦å‘Š
                        console.warn(`âš ï¸ åœ–ç‰‡ ${i + 1} ç„¡æœ‰æ•ˆè³‡æ–™ï¼ˆç„¡ fileã€url æˆ– tempKeyï¼‰ï¼Œè·³é`);
                    }
                } catch (error) {
                    console.error(`âŒ è™•ç†åœ–ç‰‡ ${i + 1} å¤±æ•—:`, error);
                    console.error('  éŒ¯èª¤è©³æƒ…:', {
                        message: error.message,
                        code: error.code,
                        fileName: img.file?.name || img.originalName || 'æœªçŸ¥'
                    });
                    
                    // å¦‚æœè™•ç†å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹ URLï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    if (img.url) {
                        console.log(`  ğŸ“ å˜—è©¦ä½¿ç”¨åŸå§‹ URL: ${img.url}`);
                        uploadedUrls.push(img.url);
                        organizedImages.push({
                            url: img.url,
                            key: img.tempKey || img.key || img.url
                        });
                    } else {
                        console.warn(`  âš ï¸ åœ–ç‰‡ ${i + 1} è™•ç†å¤±æ•—ä¸”ç„¡å‚™ç”¨ URLï¼Œå°‡è·³éæ­¤åœ–ç‰‡`);
                    }
                }
            }
            
            console.log(`\nğŸ“Š åœ–ç‰‡è™•ç†å®Œæˆ:`);
            console.log(`  âœ… æˆåŠŸ: ${uploadedUrls.length}/${uploadedImages.length}`);
            console.log(`  ğŸ“‹ æœ€çµ‚ URL åˆ—è¡¨:`, uploadedUrls);
            
            if (uploadedUrls.length === 0 && uploadedImages.length > 0) {
                console.warn('âš ï¸ è­¦å‘Šï¼šæ‰€æœ‰åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œä½†ä»æœƒç¹¼çºŒå„²å­˜ç‰©ä»¶è³‡æ–™');
            }
            
            return uploadedUrls;
        }
        
        // æ•´ç†åœ–ç‰‡ï¼šå°‡è‡¨æ™‚ä½ç½®çš„åœ–ç‰‡ç§»å‹•åˆ°æ­£ç¢ºçš„ç‰©ä»¶è³‡æ–™å¤¾ï¼ˆä¿ç•™ä½œç‚ºå‚™ç”¨ï¼‰
        async function organizeImages(propertyNumber) {
            if (!uploadedImages || uploadedImages.length === 0) {
                return [];
            }
            
            const organizedImages = [];
            
            // ç”Ÿæˆæ–°è·¯å¾‘ï¼ˆæŒ‰ä¾†æºå’Œæˆ¿å‹åˆ†é¡ï¼‰
            const isExternal = propertyNumber.startsWith('EX');
            let typeCode = '';
            if (isExternal) {
                typeCode = propertyNumber.substring(2, 4);
            } else {
                typeCode = propertyNumber.substring(0, 2);
            }
            const source = isExternal ? 'external' : 'internal';
            const basePath = `properties/${source}/${typeCode}/${propertyNumber}`;
            
            console.log('ğŸ“ é–‹å§‹æ•´ç†åœ–ç‰‡åˆ°è³‡æ–™å¤¾:', `${basePath}/`);
            
            for (let i = 0; i < uploadedImages.length; i++) {
                const img = uploadedImages[i];
                
                // æ›´æ–°é€²åº¦
                if (progressCallback) {
                    progressCallback(i + 1, uploadedImages.length);
                }
                
                try {
                    if (img.tempKey) {
                        // åœ–ç‰‡åœ¨è‡¨æ™‚ä½ç½®ï¼Œéœ€è¦ç§»å‹•åˆ°æ­£ç¢ºä½ç½®ï¼ˆä½¿ç”¨ Supabase Storageï¼‰
                        try {
                            const fileName = img.tempKey.split('/').pop();
                            const newPath = `${basePath}/${fileName}`;
                            
                            // å¾è‡¨æ™‚ä½ç½®ä¸‹è¼‰æª”æ¡ˆ
                            const { data: downloadData, error: downloadError } = await supabaseClient
                                .storage
                                .from('junyang666')
                                .download(img.tempKey);
                            
                            if (downloadError) throw downloadError;
                            
                            // ä¸Šå‚³åˆ°æ–°ä½ç½®
                            const { data: uploadData, error: uploadError } = await supabaseClient
                                .storage
                                .from('junyang666')
                                .upload(newPath, downloadData, {
                                    cacheControl: '3600',
                                    upsert: false
                                });
                            
                            if (uploadError) throw uploadError;
                            
                            // å–å¾—æ–°ä½ç½®çš„å…¬é–‹ URL
                            const { data: urlData } = supabaseClient
                                .storage
                                .from('junyang666')
                                .getPublicUrl(newPath);
                            
                            const newDownloadURL = urlData.publicUrl;
                            
                            // åˆªé™¤è‡¨æ™‚æª”æ¡ˆ
                            try {
                                await supabaseClient
                                    .storage
                                    .from('junyang666')
                                    .remove([img.tempKey]);
                            } catch (deleteError) {
                                console.warn('âš ï¸ åˆªé™¤è‡¨æ™‚æª”æ¡ˆå¤±æ•—ï¼ˆå¯å¿½ç•¥ï¼‰:', deleteError);
                            }
                            
                            console.log(`âœ… åœ–ç‰‡å·²ç§»å‹•: ${img.tempKey} â†’ ${newPath}`);
                            
                            organizedImages.push({
                                url: newDownloadURL,
                                key: newPath
                            });
                        } catch (moveError) {
                            console.error(`âŒ ç§»å‹•åœ–ç‰‡å¤±æ•— (${img.tempKey}):`, moveError);
                            // å¦‚æœç§»å‹•å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹ URLï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                            if (img.url) {
                                organizedImages.push({
                                    url: img.url,
                                    key: img.key || img.tempKey
                                });
                            }
                        }
                    } else if (img.url) {
                        // å¦‚æœå·²ç¶“æ˜¯æ­£ç¢ºä½ç½®çš„åœ–ç‰‡ï¼Œç›´æ¥ä½¿ç”¨
                        organizedImages.push({
                            url: img.url,
                            key: img.key || img.url
                        });
                    }
                } catch (error) {
                    console.error(`âŒ æ•´ç†åœ–ç‰‡å¤±æ•— (${img.originalName || 'æœªçŸ¥'}):`, error);
                    // å¦‚æœç§»å‹•å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹ URL
                    if (img.url) {
                        organizedImages.push({
                            url: img.url,
                            key: img.tempKey || img.key || img.url
                        });
                    }
                }
            }
            
            // æ¸…ç†æ‰€æœ‰è‡¨æ™‚è³‡æ–™å¤¾
            try {
                const tempFolders = [...new Set(uploadedImages.map(img => img.tempFolder).filter(f => f))];
                for (const folder of tempFolders) {
                    try {
                        // åˆ—å‡ºè‡¨æ™‚è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰æª”æ¡ˆ
                        const { data: files, error: listError } = await supabaseClient
                            .storage
                            .from('junyang666')
                            .list(`temp/${folder}`);
                        
                        if (listError) throw listError;
                        
                        // åˆªé™¤æ‰€æœ‰æª”æ¡ˆ
                        if (files && files.length > 0) {
                            const filePaths = files.map(file => `temp/${folder}/${file.name}`);
                            const { error: removeError } = await supabaseClient
                                .storage
                                .from('junyang666')
                                .remove(filePaths);
                            
                            if (removeError) throw removeError;
                            console.log(`ğŸ—‘ï¸ å·²æ¸…ç†è‡¨æ™‚è³‡æ–™å¤¾: temp/${folder}`);
                        }
                    } catch (error) {
                        console.warn(`âš ï¸ æ¸…ç†è‡¨æ™‚è³‡æ–™å¤¾å¤±æ•—: temp/${folder}`, error);
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ æ¸…ç†è‡¨æ™‚è³‡æ–™å¤¾æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
            
            // å°‡å°é¢åœ–ç‰‡ç§»åˆ°ç¬¬ä¸€ä½
            const imageUrls = organizedImages.map(img => img.url);
            const coverImageIndex = uploadedImages.findIndex(img => img.isCover);
            
            if (coverImageIndex !== -1 && coverImageIndex !== 0) {
                // æ‰¾åˆ°å°é¢åœ–ç‰‡åœ¨æœ€çµ‚ URL é™£åˆ—ä¸­çš„ä½ç½®
                // å› ç‚º uploadedImages å’Œ organizedImages çš„é †åºæ‡‰è©²ä¸€è‡´
                const coverUrl = imageUrls[coverImageIndex];
                // ç§»é™¤åŸä½ç½®çš„å°é¢åœ–ç‰‡
                imageUrls.splice(coverImageIndex, 1);
                // å°‡å°é¢åœ–ç‰‡æ’å…¥åˆ°ç¬¬ä¸€ä½
                imageUrls.unshift(coverUrl);
                console.log('â­ å·²å°‡å°é¢åœ–ç‰‡ç§»åˆ°ç¬¬ä¸€ä½');
            } else if (coverImageIndex === -1 && imageUrls.length > 0) {
                // å¦‚æœæ²’æœ‰æŒ‡å®šå°é¢ï¼Œç¬¬ä¸€å¼µåœ–ç‰‡è‡ªå‹•ä½œç‚ºå°é¢
                console.log('â„¹ï¸ æœªæŒ‡å®šå°é¢åœ–ç‰‡ï¼Œä½¿ç”¨ç¬¬ä¸€å¼µåœ–ç‰‡ä½œç‚ºå°é¢');
            }
            
            return imageUrls;
        }
        
        // å„²å­˜ç‰©ä»¶
        async function saveProperty() {
            // æª¢æŸ¥ Supabase æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                showAlert('error', 'è«‹å…ˆè¨­å®š Supabase é…ç½®ï¼Œæ­£åœ¨è·³è½‰åˆ°è¨­å®šé é¢...');
                // è‡ªå‹•è·³è½‰åˆ°è¨­å®šé é¢
                setTimeout(() => {
                    const configTab = document.querySelector('.tab[onclick*="config"]');
                    if (configTab) {
                        switchTab('config', configTab);
                    }
                }, 1000);
                return;
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'â³ æº–å‚™ä¸­...';
            
            try {
                // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆå¾ URL åƒæ•¸æˆ– editingPropertyId è®Šæ•¸ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const urlId = urlParams.get('id');
                const isEditMode = editingPropertyId || urlId;
                
                // å¦‚æœ URL ä¸­æœ‰ ID ä½† editingPropertyId æœªè¨­ç½®ï¼Œè¨­ç½®å®ƒ
                if (urlId && !editingPropertyId) {
                    editingPropertyId = urlId;
                    console.log('ğŸ”§ å¾ URL åƒæ•¸è¨­ç½®ç·¨è¼¯æ¨¡å¼ï¼ŒID:', urlId);
                }
                
                // è‡ªå‹•ç”Ÿæˆç‰©ä»¶ç·¨è™Ÿï¼ˆåƒ…åœ¨æ–°å¢æ¨¡å¼æ™‚ç”Ÿæˆï¼‰
                let propertyNumber = document.getElementById('number').value.trim();
                if (!isEditMode && !propertyNumber) {
                    // åªæœ‰åœ¨æ–°å¢æ¨¡å¼ä¸”æ²’æœ‰ç·¨è™Ÿæ™‚ï¼Œæ‰ç”Ÿæˆæ–°ç·¨è™Ÿ
                    const type = document.getElementById('type').value.trim();
                    if (!type) {
                        throw new Error('è«‹å…ˆé¸æ“‡æˆ¿å‹ä»¥è‡ªå‹•ç”Ÿæˆç‰©ä»¶ç·¨è™Ÿ');
                    }
                    await generatePropertyNumber();
                    propertyNumber = document.getElementById('number').value.trim();
                    if (!propertyNumber) {
                        throw new Error('ç„¡æ³•ç”Ÿæˆç‰©ä»¶ç·¨è™Ÿï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                } else if (isEditMode && !propertyNumber) {
                    // ç·¨è¼¯æ¨¡å¼å¿…é ˆæœ‰ç·¨è™Ÿ
                    throw new Error('ç·¨è¼¯æ¨¡å¼å¿…é ˆæœ‰ç‰©ä»¶ç·¨è™Ÿï¼Œè«‹æª¢æŸ¥è¡¨å–®è³‡æ–™');
                }
                
                // é©—è­‰ä¸¦è½‰æ›ç·¨è™Ÿæ ¼å¼ï¼ˆç¢ºä¿ç¬¦åˆã€Œå…©å€‹è‹±æ–‡å­—æ¯+äº”å€‹æ•¸å­—ã€çš„æ ¼å¼ï¼‰
                if (propertyNumber) {
                    propertyNumber = normalizePropertyNumber(propertyNumber, document.getElementById('type').value.trim(), document.getElementById('is_external')?.value === 'true');
                    // æ›´æ–°è¼¸å…¥æ¡†ä¸­çš„ç·¨è™Ÿ
                    document.getElementById('number').value = propertyNumber;
                }
                
                // å„ªåŒ–ï¼šåªæª¢æŸ¥ç‰¹å®šç·¨è™Ÿæ˜¯å¦å·²å­˜åœ¨ï¼ˆè€Œä¸æ˜¯ç²å–æ‰€æœ‰ç·¨è™Ÿï¼‰
                saveBtn.textContent = 'â³ æª¢æŸ¥ç·¨è™Ÿä¸­...';
                const currentEditId = editingPropertyId || urlId;
                
                // åªåœ¨æ–°å¢æ¨¡å¼æˆ–ç·¨è™Ÿæ”¹è®Šæ™‚æª¢æŸ¥
                let needCheckNumber = true;
                if (currentEditId) {
                    // ç·¨è¼¯æ¨¡å¼ï¼šæª¢æŸ¥ç·¨è™Ÿæ˜¯å¦æ”¹è®Š
                    try {
                        const { data: currentData, error } = await supabaseClient
                            .from('properties')
                            .select('number')
                            .eq('id', currentEditId)
                            .single();
                        
                        if (!error && currentData && currentData.number === propertyNumber) {
                            // ç·¨è™Ÿæ²’æœ‰æ”¹è®Šï¼Œä¸éœ€è¦æª¢æŸ¥
                            needCheckNumber = false;
                        }
                    } catch (error) {
                        console.warn('âš ï¸ ç„¡æ³•ç²å–ç•¶å‰ç‰©ä»¶ç·¨è™Ÿï¼Œå°‡é€²è¡Œç·¨è™Ÿæª¢æŸ¥:', error);
                    }
                }
                
                if (needCheckNumber) {
                    // åªæŸ¥è©¢ç‰¹å®šç·¨è™Ÿæ˜¯å¦å­˜åœ¨
                    const { data: existingProperty, error: checkError } = await supabaseClient
                        .from('properties')
                        .select('id, number')
                        .eq('number', propertyNumber)
                        .limit(1);
                    
                    if (checkError) {
                        console.warn('âš ï¸ æª¢æŸ¥ç·¨è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤:', checkError);
                        // ä¸é˜»æ­¢å„²å­˜ï¼Œç¹¼çºŒåŸ·è¡Œ
                    } else if (existingProperty && existingProperty.length > 0) {
                        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰ç‰©ä»¶
                        if (currentEditId && existingProperty[0].id === currentEditId) {
                            // æ˜¯ç•¶å‰ç‰©ä»¶ï¼Œå…è¨±ä½¿ç”¨ç›¸åŒç·¨è™Ÿ
                        } else {
                            throw new Error(`ç‰©ä»¶ç·¨è™Ÿ "${propertyNumber}" å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ç·¨è™Ÿ`);
                        }
                    }
                }
                
                // ç²å–ç¸£å¸‚å’Œå€åŸŸ
                const city = document.getElementById('city').value.trim();
                const district = document.getElementById('district').value.trim();
                const address = document.getElementById('address').value.trim();
                const hideAddressNumber = document.getElementById('hide_address_number').checked;
                
                // çµ„åˆå®Œæ•´åœ°å€ï¼ˆå„²å­˜å®Œæ•´åœ°å€ï¼Œä¸è™•ç†éš±è—é–€ç‰Œè™Ÿç¢¼ï¼‰
                // å‰ç«¯æœƒæ ¹æ“š hide_address_number ä¾†æ±ºå®šæ˜¯å¦é¡¯ç¤ºé–€ç‰Œè™Ÿç¢¼
                let fullAddress = '';
                if (city && district) {
                    fullAddress = city + district;
                    if (address) {
                        fullAddress += address;
                    }
                } else if (address) {
                    fullAddress = address;
                }
                
                // æ”¶é›†è¡¨å–®è³‡æ–™
                const propertyData = {
                    number: propertyNumber,
                    title: document.getElementById('title').value.trim(),
                    type: document.getElementById('type').value.trim(),
                    city: city,
                    district: district,
                    address: fullAddress, // å„²å­˜å®Œæ•´åœ°å€ï¼ˆåŒ…å«é–€ç‰Œè™Ÿç¢¼ï¼‰
                    address_detail: address, // å„²å­˜è©³ç´°åœ°å€ï¼ˆä¸å«ç¸£å¸‚å€åŸŸï¼ŒåŒ…å«é–€ç‰Œè™Ÿç¢¼ï¼‰
                    hide_address_number: hideAddressNumber,
                    price: document.getElementById('price').value.trim(),
                    layout: (() => {
                        let layoutValue = document.getElementById('layout').value.trim();
                        // å¦‚æœè¼¸å…¥çš„æ˜¯ 3/2/2 æ ¼å¼ï¼Œè½‰æ›ç‚º 3æˆ¿2å»³2è¡›
                        const layoutPattern = /^(\d+)\/(\d+)\/(\d+)$/;
                        const match = layoutValue.match(layoutPattern);
                        if (match) {
                            const room = parseInt(match[1], 10);
                            const living = parseInt(match[2], 10);
                            const bath = parseInt(match[3], 10);
                            
                            // è™•ç†ç‰¹æ®Šæ ¼å±€
                            if (room === 0 && living > 0) {
                                layoutValue = `0æˆ¿${living}å»³${bath}è¡›ï¼ˆé–‹æ”¾å¼ï¼‰`;
                            } else if (room === 0 && living === 0 && bath > 0) {
                                layoutValue = `0æˆ¿0å»³${bath}è¡›ï¼ˆé–‹æ”¾å¼ï¼‰`;
                            } else if (room === 1 && living === 0 && bath === 1) {
                                layoutValue = `1æˆ¿0å»³1è¡›ï¼ˆå¥—æˆ¿ï¼‰`;
                            } else {
                                layoutValue = `${room}æˆ¿${living}å»³${bath}è¡›`;
                            }
                        }
                        return layoutValue;
                    })(),
                    total_area: (() => {
                        let areaValue = document.getElementById('total_area').value.trim();
                        if (!areaValue) return '';
                        // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                        if (areaValue.includes('åª')) {
                            areaValue = areaValue.replace(/åª+/g, '');
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        // å¦‚æœæ²’æœ‰ã€Œåªã€å­—ï¼Œä¸”æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+$/.test(areaValue)) {
                            areaValue = areaValue + 'åª';
                        }
                        // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+/.test(areaValue)) {
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        return areaValue;
                    })(),
                    is_published: document.getElementById('is_published').value === 'true',
                    is_external: document.getElementById('is_external').value === 'true',
                    status: document.getElementById('status').value.trim() || null,
                    status_text: (() => {
                        const statusTextSelect = document.getElementById('statusText');
                        const statusTextInput = document.getElementById('statusTextInput');
                        if (!statusTextSelect) return null;
                        
                        const selectedValue = statusTextSelect.value;
                        if (selectedValue === 'custom' && statusTextInput) {
                            // å¦‚æœé¸æ“‡ã€Œè‡ªè¨‚ã€ï¼Œä½¿ç”¨è¼¸å…¥æ¡†çš„å€¼
                            return statusTextInput.value.trim() || null;
                        } else if (selectedValue && selectedValue !== 'custom') {
                            // å¦‚æœé¸æ“‡äº†å…¶ä»–é¸é …ï¼Œä½¿ç”¨é¸é …çš„å€¼
                            return selectedValue.trim() || null;
                        }
                        return null;
                    })(),
                    community: document.getElementById('community').value.trim(),
                    main_area: (() => {
                        let areaValue = document.getElementById('main_area').value.trim();
                        if (!areaValue) return '';
                        // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                        if (areaValue.includes('åª')) {
                            areaValue = areaValue.replace(/åª+/g, '');
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        // å¦‚æœæ²’æœ‰ã€Œåªã€å­—ï¼Œä¸”æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+$/.test(areaValue)) {
                            areaValue = areaValue + 'åª';
                        }
                        // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+/.test(areaValue)) {
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        return areaValue;
                    })(),
                    auxiliary_area: (() => {
                        let areaValue = document.getElementById('auxiliary_area').value.trim();
                        if (!areaValue) return '';
                        // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                        if (areaValue.includes('åª')) {
                            areaValue = areaValue.replace(/åª+/g, '');
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        // å¦‚æœæ²’æœ‰ã€Œåªã€å­—ï¼Œä¸”æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+$/.test(areaValue)) {
                            areaValue = areaValue + 'åª';
                        }
                        // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+/.test(areaValue)) {
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        return areaValue;
                    })(),
                    common_area: (() => {
                        let areaValue = document.getElementById('common_area').value.trim();
                        if (!areaValue) return '';
                        // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                        if (areaValue.includes('åª')) {
                            areaValue = areaValue.replace(/åª+/g, '');
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        // å¦‚æœæ²’æœ‰ã€Œåªã€å­—ï¼Œä¸”æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+$/.test(areaValue)) {
                            areaValue = areaValue + 'åª';
                        }
                        // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+/.test(areaValue)) {
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        return areaValue;
                    })(),
                    land_area: (() => {
                        let areaValue = document.getElementById('land_area').value.trim();
                        if (!areaValue) return '';
                        // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                        if (areaValue.includes('åª')) {
                            areaValue = areaValue.replace(/åª+/g, '');
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        // å¦‚æœæ²’æœ‰ã€Œåªã€å­—ï¼Œä¸”æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+$/.test(areaValue)) {
                            areaValue = areaValue + 'åª';
                        }
                        // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+/.test(areaValue)) {
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        return areaValue;
                    })(),
                    parking_area: (() => {
                        let areaValue = document.getElementById('parking_area').value.trim();
                        if (!areaValue) return '';
                        // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                        if (areaValue.includes('åª')) {
                            areaValue = areaValue.replace(/åª+/g, '');
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        // å¦‚æœæ²’æœ‰ã€Œåªã€å­—ï¼Œä¸”æ˜¯ç´”æ•¸å­—ï¼ŒåŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+$/.test(areaValue)) {
                            areaValue = areaValue + 'åª';
                        }
                        // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                        else if (/^[\d.]+/.test(areaValue)) {
                            const numberMatch = areaValue.match(/^[\d.]+/);
                            if (numberMatch) {
                                areaValue = numberMatch[0] + 'åª';
                            }
                        }
                        return areaValue;
                    })(),
                    age: (() => {
                        let ageValue = document.getElementById('age').value.trim();
                        // å¦‚æœè¼¸å…¥çš„æ˜¯ç´”æ•¸å­—ï¼Œè‡ªå‹•åŠ ä¸Šã€Œå¹´ã€ï¼ˆä½†ä¸è¦é‡è¤‡åŠ ä¸Šï¼‰
                        if (ageValue && /^\d+$/.test(ageValue)) {
                            ageValue = ageValue + 'å¹´';
                        }
                        // å¦‚æœå·²ç¶“æœ‰ã€Œå¹´ã€å­—ï¼Œç¢ºä¿åªæœ‰ä¸€å€‹ï¼ˆç§»é™¤å¤šé¤˜çš„ã€Œå¹´ã€ï¼‰
                        else if (ageValue && ageValue.includes('å¹´')) {
                            // ç§»é™¤æ‰€æœ‰ã€Œå¹´ã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                            ageValue = ageValue.replace(/å¹´+/g, '');
                            const numberMatch = ageValue.match(/^\d+/);
                            if (numberMatch) {
                                ageValue = numberMatch[0] + 'å¹´';
                            }
                        }
                        return ageValue;
                    })(),
                    floor: (() => {
                        const floor = document.getElementById('floor').value.trim();
                        const extensionFloor = document.getElementById('extension_floor').value.trim();
                        if (extensionFloor) {
                            // å¦‚æœæœ‰å¢å»ºæ¨“å±¤ï¼Œçµ„åˆé¡¯ç¤ºï¼šåŸå§‹æ¨“å±¤ï¼ˆå¢å»ºæ¨“å±¤ï¼‰
                            return `${floor}ï¼ˆå¢å»º${extensionFloor}ï¼‰`;
                        }
                        return floor;
                    })(),
                    building_type: (() => {
                        let buildingType = document.getElementById('building_type').value.trim();
                        // å°æ‡‰èˆŠå€¼åˆ°æ–°å€¼ï¼ˆç¢ºä¿ä¸€è‡´æ€§ï¼‰
                        const buildingTypeMap = {
                            'è¯å»ˆå…¬å¯“': 'è¯å»ˆ',
                            'é€å¤©åˆ¥å¢…': 'é€å¤©',
                            'é€å¤©å': 'é€å¤©',
                            'å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                            'ä½å®…å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                            'å•†æ¥­å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                            'ä½å•†å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                            'å¤§å»ˆ': 'é›»æ¢¯å¤§æ¨“'
                        };
                        return buildingTypeMap[buildingType] || buildingType;
                    })(),
                    orientation: document.getElementById('orientation').value.trim(),
                    management_fee: document.getElementById('management_fee').value.trim(),
                    parking_type: document.getElementById('parking_type').value.trim(),
                    parking_space: document.getElementById('parking_space').value.trim(),
                    current_status: document.getElementById('current_status').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    google_maps: (() => {
                        let googleMapsValue = document.getElementById('google_maps').value.trim();
                        // å¦‚æœè¼¸å…¥çš„æ˜¯å®Œæ•´çš„ iframe HTMLï¼Œæå– src å±¬æ€§å€¼
                        if (googleMapsValue && googleMapsValue.includes('<iframe')) {
                            const srcMatch = googleMapsValue.match(/src=["']([^"']+)["']/i);
                            if (srcMatch && srcMatch[1]) {
                                googleMapsValue = srcMatch[1];
                            } else {
                                googleMapsValue = ''; // å¦‚æœç„¡æ³•æå–ï¼Œè¨­ç‚ºç©º
                            }
                        }
                        return googleMapsValue;
                    })(),
                    tiktok_video_id: document.getElementById('tiktok_video_id').value.trim(),
                    tiktok_username: document.getElementById('tiktok_username').value.trim(),
                    reference_link: document.getElementById('reference_link').value.trim()
                };
                
                // è™•ç†æ¨™ç±¤é¸æ“‡æ¬„ä½
                if (selectedTags.facilities.length > 0) {
                    propertyData.facilities = [...selectedTags.facilities];
                }
                
                if (selectedTags.transport.length > 0) {
                    propertyData.transport = [...selectedTags.transport];
                }
                
                if (selectedTags.schools.length > 0) {
                    propertyData.schools = [...selectedTags.schools];
                }
                
                const market = document.getElementById('market').value.trim();
                if (market) propertyData.market = market;
                
                const park = document.getElementById('park').value.trim();
                if (park) propertyData.park = park;
                
                // è™•ç† transportation ç‰©ä»¶
                if (propertyData.facilities || propertyData.transport || propertyData.schools || propertyData.market || propertyData.park) {
                    propertyData.transportation = {
                        facilities: propertyData.facilities || [],
                        transport: propertyData.transport || [],
                        schools: propertyData.schools || [],
                        market: propertyData.market || '',
                        park: propertyData.park || ''
                    };
                    delete propertyData.facilities;
                    delete propertyData.transport;
                    delete propertyData.schools;
                    delete propertyData.market;
                    delete propertyData.park;
                }
                
                // è™•ç† featuresï¼šå³ä½¿ç‚ºç©ºä¹Ÿè¦è¨­ç½®ç‚ºç©ºé™£åˆ—ï¼Œç¢ºä¿å¯ä»¥æ¸…ç©º
                const featuresText = document.getElementById('features').value.trim();
                if (featuresText) {
                    propertyData.features = featuresText.split('\n').map(line => line.trim()).filter(line => line);
                } else {
                    // æ˜ç¢ºè¨­ç½®ç‚ºç©ºé™£åˆ—ï¼Œç¢ºä¿å¯ä»¥æ¸…ç©ºç¾æœ‰çš„ features
                    propertyData.features = [];
                }
                
                // æ•´ç†åœ–ç‰‡ï¼šå°‡æœ¬åœ°é è¦½çš„åœ–ç‰‡ä¸Šå‚³åˆ°æ­£ç¢ºçš„ç‰©ä»¶è³‡æ–™å¤¾
                let organizedImageUrls = [];
                if (uploadedImages && uploadedImages.length > 0) {
                    // æª¢æŸ¥æ˜¯å¦æœ‰æ–°ä¸Šå‚³çš„åœ–ç‰‡ï¼ˆæœ‰ file å±¬æ€§çš„ï¼‰
                    const hasNewImages = uploadedImages.some(img => img.file);
                    const hasOnlyExistingImages = uploadedImages.every(img => img.url && !img.file && !img.tempKey);
                    
                    if (hasOnlyExistingImages) {
                        // åªæœ‰å·²ä¸Šå‚³çš„åœ–ç‰‡ï¼Œç›´æ¥ä½¿ç”¨é‡æ–°æ’åºå¾Œçš„é †åº
                        console.log('ğŸ“‹ ä½¿ç”¨å·²ä¸Šå‚³åœ–ç‰‡ï¼ˆå·²é‡æ–°æ’åºï¼‰:', uploadedImages.length, 'å¼µ');
                        saveBtn.textContent = `â³ å„²å­˜åœ–ç‰‡é †åºä¸­...`;
                        organizedImageUrls = uploadedImages.map(img => img.url || img);
                        console.log('âœ… åœ–ç‰‡é †åºå·²æ›´æ–°');
                    } else {
                        // æœ‰æ–°åœ–ç‰‡éœ€è¦ä¸Šå‚³ï¼Œæˆ–æ··åˆæƒ…æ³
                        saveBtn.textContent = `â³ ä¸Šå‚³åœ–ç‰‡ä¸­ (0/${uploadedImages.length})...`;
                        console.log('ğŸ“¤ é–‹å§‹ä¸Šå‚³åœ–ç‰‡ï¼Œç‰©ä»¶ç·¨è™Ÿ:', propertyNumber);
                        console.log('ğŸ“Š å¾…ä¸Šå‚³åœ–ç‰‡æ•¸é‡:', uploadedImages.length);
                        
                        try {
                            // é¡¯ç¤ºä¸Šå‚³é€²åº¦
                            const progressCallback = (current, total) => {
                                saveBtn.textContent = `â³ ä¸Šå‚³åœ–ç‰‡ä¸­ (${current}/${total})...`;
                            };
                            
                            organizedImageUrls = await uploadAndOrganizeImages(propertyNumber, progressCallback);
                            console.log('âœ… åœ–ç‰‡ä¸Šå‚³å®Œæˆï¼ŒæˆåŠŸä¸Šå‚³:', organizedImageUrls.length, 'å¼µ');
                        } catch (imageError) {
                            console.error('âŒ åœ–ç‰‡ä¸Šå‚³éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', imageError);
                            // å³ä½¿åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œä¹Ÿç¹¼çºŒå„²å­˜å…¶ä»–è³‡æ–™ï¼ˆä½†è¨˜éŒ„è­¦å‘Šï¼‰
                            organizedImageUrls = [];
                            showAlert('warning', `åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œä½†å°‡ç¹¼çºŒå„²å­˜ç‰©ä»¶è³‡æ–™ã€‚éŒ¯èª¤: ${imageError.message}`);
                        }
                    }
                    
                    propertyData.images = organizedImageUrls;
                } else {
                    // æ²’æœ‰åœ–ç‰‡
                    propertyData.images = [];
                }
                
                // æ·»åŠ æ™‚é–“æˆ³
                propertyData.updated_at = new Date().toISOString();
                
                // æ¸…ç†ç©ºå­—ä¸²æ¬„ä½ï¼ˆä½†ä¿ç•™ features å’Œ descriptionï¼Œå³ä½¿ç‚ºç©ºä¹Ÿè¦æ›´æ–°ï¼‰
                Object.keys(propertyData).forEach(key => {
                    // features å’Œ description å³ä½¿ç‚ºç©ºä¹Ÿè¦ä¿ç•™ï¼Œç¢ºä¿å¯ä»¥æ¸…ç©ºç¾æœ‰å€¼
                    if (key === 'features' || key === 'description') {
                        return; // è·³éæ¸…ç†
                    }
                    if (propertyData[key] === '' || propertyData[key] === null) {
                        delete propertyData[key];
                    }
                });
                
                // ç¢ºä¿ description å³ä½¿ç‚ºç©ºå­—ä¸²ä¹Ÿè¦è¨­ç½®ï¼ˆç”¨æ–¼æ¸…ç©ºç¾æœ‰å€¼ï¼‰
                if (!('description' in propertyData)) {
                    const descriptionValue = document.getElementById('description').value.trim();
                    propertyData.description = descriptionValue || null;
                }
                
                console.log('ğŸ’¾ æº–å‚™å„²å­˜ç‰©ä»¶è³‡æ–™:', {
                    number: propertyData.number,
                    title: propertyData.title,
                    type: propertyData.type,
                    is_published: propertyData.is_published,
                    imagesCount: propertyData.images?.length || 0,
                    images: propertyData.images
                });
                
                // ç¢ºä¿ images æ˜¯é™£åˆ—æ ¼å¼ï¼ˆSupabase JSONB éœ€è¦ï¼‰
                if (propertyData.images && !Array.isArray(propertyData.images)) {
                    console.warn('âš ï¸ images ä¸æ˜¯é™£åˆ—æ ¼å¼ï¼Œè½‰æ›ç‚ºé™£åˆ—');
                    propertyData.images = Array.isArray(propertyData.images) ? propertyData.images : [propertyData.images];
                }
                
                let result;
                
                saveBtn.textContent = 'â³ å„²å­˜è³‡æ–™ä¸­...';
                
                // ç¢ºå®šæœ€çµ‚çš„ç·¨è¼¯ IDï¼ˆå„ªå…ˆä½¿ç”¨ editingPropertyIdï¼Œå…¶æ¬¡ä½¿ç”¨ URL åƒæ•¸ï¼‰
                const finalEditId = editingPropertyId || urlId;
                
                // å¦‚æœæœ‰ç·¨è¼¯ IDï¼ŒåŸ·è¡Œæ›´æ–°
                if (finalEditId) {
                    console.log('ğŸ”„ æ›´æ–°ç‰©ä»¶ï¼ŒID:', finalEditId);
                    console.log('ğŸ“‹ ç·¨è¼¯æ¨¡å¼æª¢æŸ¥:', {
                        editingPropertyId,
                        urlId,
                        finalEditId,
                        propertyNumber
                    });
                    
                    const { data, error } = await supabaseClient
                        .from('properties')
                        .update(propertyData)
                        .eq('id', finalEditId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    result = data;
                    console.log('âœ… ç‰©ä»¶æ›´æ–°æˆåŠŸ:', result.id);
                    showAlert('success', 'ç‰©ä»¶å·²æ›´æ–°ï¼');
                    
                    // ç¢ºä¿ editingPropertyId ä¿æŒè¨­ç½®ï¼ˆä¸è¦æ¸…é™¤ï¼Œå› ç‚ºå¯èƒ½é‚„éœ€è¦ç¹¼çºŒç·¨è¼¯ï¼‰
                    editingPropertyId = finalEditId;
                    
                    // é€šçŸ¥çˆ¶é é¢åˆ‡æ›åˆ°ç‰©ä»¶åˆ—è¡¨ï¼ˆç¸®çŸ­å»¶é²ï¼Œæå‡éŸ¿æ‡‰é€Ÿåº¦ï¼‰
                    setTimeout(() => {
                        if (window.parent && window.parent !== window) {
                            window.parent.postMessage({
                                type: 'propertySaved',
                                action: 'switchToList',
                                propertyId: result.id
                            }, '*');
                            console.log('ğŸ“¤ å·²é€šçŸ¥çˆ¶é é¢åˆ‡æ›åˆ°ç‰©ä»¶åˆ—è¡¨');
                        }
                    }, 800);
                } else {
                    // æ–°å¢ç‰©ä»¶
                    console.log('â• æ–°å¢ç‰©ä»¶åˆ°è³‡æ–™åº«...');
                    propertyData.created_at = new Date().toISOString();
                    
                    const { data: insertData, error } = await supabaseClient
                        .from('properties')
                        .insert([propertyData])
                        .select();
                    
                    if (error) throw error;
                    
                    // å–å¾—æ–°å¢çš„è³‡æ–™ï¼ˆä¸ä½¿ç”¨ .single()ï¼Œå› ç‚ºå¯èƒ½æœƒæœ‰å•é¡Œï¼‰
                    result = insertData && insertData.length > 0 ? insertData[0] : null;
                    if (!result) {
                        throw new Error('æ–°å¢æˆåŠŸä½†ç„¡æ³•å–å¾—è³‡æ–™');
                    }
                    console.log('âœ… ç‰©ä»¶æ–°å¢æˆåŠŸ:', {
                        id: result.id,
                        number: propertyNumber
                    });
                    showAlert('success', `ç‰©ä»¶å·²æ–°å¢ï¼ç·¨è™Ÿ: ${propertyNumber}ï¼ŒID: ${result.id}`);
                    
                    // é€šçŸ¥çˆ¶é é¢åˆ‡æ›åˆ°ç‰©ä»¶åˆ—è¡¨ï¼ˆç¸®çŸ­å»¶é²ï¼Œæå‡éŸ¿æ‡‰é€Ÿåº¦ï¼‰
                    setTimeout(() => {
                        if (window.parent && window.parent !== window) {
                            window.parent.postMessage({
                                type: 'propertySaved',
                                action: 'switchToList',
                                propertyId: result.id
                            }, '*');
                            console.log('ğŸ“¤ å·²é€šçŸ¥çˆ¶é é¢åˆ‡æ›åˆ°ç‰©ä»¶åˆ—è¡¨');
                        }
                    }, 800);
                }
                
                // æ›´æ–° uploadedImages ç‚ºæ•´ç†å¾Œçš„è·¯å¾‘
                uploadedImages = organizedImageUrls.map(url => ({ url, key: url }));
                
                // é‡è¨­è¡¨å–®ï¼ˆåƒ…åœ¨æ–°å¢æ¨¡å¼æ™‚ï¼‰
                if (!finalEditId) {
                    resetForm();
                }
                // ç·¨è¼¯æ¨¡å¼ä¸é‡ç½® editingPropertyIdï¼Œä¿æŒç·¨è¼¯ç‹€æ…‹
                
                // æ›´æ–°åˆ—è¡¨
                if (document.getElementById('list-tab').classList.contains('active')) {
                    loadProperties();
                }
            } catch (error) {
                console.error('âŒ å„²å­˜ç‰©ä»¶å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack,
                    name: error.name
                });
                
                let errorMessage = 'å„²å­˜å¤±æ•—ï¼š';
                if (error.message) {
                    errorMessage += error.message;
                } else if (error.code) {
                    errorMessage += `éŒ¯èª¤ä»£ç¢¼: ${error.code}`;
                } else {
                    errorMessage += 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°';
                }
                
                // å¦‚æœæ˜¯ç¶²è·¯éŒ¯èª¤æˆ– CORS éŒ¯èª¤ï¼Œæä¾›æ›´è©³ç´°çš„èªªæ˜
                if (error.message && error.message.includes('CORS')) {
                    errorMessage += 'ã€‚é€™å¯èƒ½æ˜¯ Supabase Storage è¦å‰‡è¨­å®šå•é¡Œï¼Œè«‹æª¢æŸ¥ Storage Policiesã€‚';
                }
                
                showAlert('error', errorMessage);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ å„²å­˜åˆ°è³‡æ–™åº«';
                console.log('ğŸ”„ å„²å­˜æµç¨‹å®Œæˆï¼ŒæŒ‰éˆ•å·²æ¢å¾©');
            }
        }
        
        // æ¸¬è©¦åŠŸèƒ½ï¼šæ¸¬è©¦æ–°å¢ç‰©ä»¶æµç¨‹ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
        async function testSaveProperty() {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦æ–°å¢ç‰©ä»¶æµç¨‹...');
            
            // æª¢æŸ¥å¿…è¦æ¬„ä½
            const requiredFields = {
                title: document.getElementById('title'),
                type: document.getElementById('type'),
                address: document.getElementById('address'),
                price: document.getElementById('price'),
                layout: document.getElementById('layout'),
                total_area: document.getElementById('total_area')
            };
            
            const missingFields = [];
            for (const [key, element] of Object.entries(requiredFields)) {
                if (!element || !element.value.trim()) {
                    missingFields.push(key);
                }
            }
            
            if (missingFields.length > 0) {
                console.error('âŒ ç¼ºå°‘å¿…è¦æ¬„ä½:', missingFields);
                showAlert('error', `è«‹å¡«å¯«å¿…è¦æ¬„ä½: ${missingFields.join(', ')}`);
                return;
            }
            
            // æª¢æŸ¥ Supabase
            if (!supabaseClient) {
                console.error('âŒ Supabase æœªåˆå§‹åŒ–');
                showAlert('error', 'Supabase æœªåˆå§‹åŒ–');
                return;
            }
            
            // æª¢æŸ¥åœ–ç‰‡
            console.log('ğŸ“Š æª¢æŸ¥åœ–ç‰‡:', {
                uploadedImagesCount: uploadedImages.length,
                hasImages: uploadedImages.length > 0
            });
            
            // ç”Ÿæˆæ¸¬è©¦ç·¨è™Ÿ
            const testNumber = `TEST-${Date.now()}`;
            document.getElementById('number').value = testNumber;
            
            console.log('âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼Œé–‹å§‹å„²å­˜...');
            
            // åŸ·è¡Œå„²å­˜
            await saveProperty();
        }
        
        // å°‡æ¸¬è©¦å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸ
        window.testSaveProperty = testSaveProperty;
        
        // è¼‰å…¥ç‰©ä»¶åˆ—è¡¨
        async function loadProperties() {
            // æª¢æŸ¥ Supabase æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                const listContainer = document.getElementById('property-list');
                listContainer.innerHTML = 
                    '<p style="text-align: center; color: #dc3545; padding: 2rem;">è«‹å…ˆè¨­å®š Supabase é…ç½®<br><button class="btn btn-primary" id="go-to-config-btn" style="margin-top: 1rem;">å‰å¾€è¨­å®š</button></p>';
                // ç‚ºæŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const configBtn = document.getElementById('go-to-config-btn');
                if (configBtn) {
                    configBtn.addEventListener('click', function() {
                        const configTab = document.querySelector('.tab[onclick*="config"]');
                        if (configTab) {
                            switchTab('config', configTab);
                        }
                    });
                }
                return;
            }
            
            try {
                const { data: properties, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const listContainer = document.getElementById('property-list');
                
                if (!properties || properties.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">ç›®å‰æ²’æœ‰ç‰©ä»¶è³‡æ–™</p>';
                    return;
                }
                
                listContainer.innerHTML = properties.map((prop, index) => {
                    // è™•ç† imagesï¼ˆå¯èƒ½æ˜¯é™£åˆ—æˆ– JSONBï¼‰
                    let images = [];
                    if (prop.images) {
                        if (typeof prop.images === 'string') {
                            try {
                                images = JSON.parse(prop.images);
                            } catch (e) {
                                images = [];
                            }
                        } else if (Array.isArray(prop.images)) {
                            images = prop.images;
                        }
                    }
                    
                    const publishedStatus = prop.is_published ? 'âœ… ä¸Šæ¶' : 'âŒ ä¸‹æ¶';
                    const publishedColor = prop.is_published ? '#28a745' : '#dc3545';
                    
                    // ç‰©ä»¶ä¾†æºæ¨™ç±¤
                    const isExternal = prop.is_external === true || prop.is_external === 'true';
                    const sourceLabel = isExternal 
                        ? '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.5rem;">ğŸ¢ éæœ¬åº—</span>' 
                        : '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 0.5rem;">ğŸ  æœ¬åº—</span>';
                    
                    return `
                    <div class="property-item">
                        <div class="property-info">
                            <h4>${sourceLabel}${prop.title || 'æœªå‘½åç‰©ä»¶'}</h4>
                            <p>ç·¨è™Ÿ: ${prop.number || 'N/A'} | æˆ¿å‹: ${prop.type || 'N/A'} | åƒ¹æ ¼: ${prop.price || 'N/A'}</p>
                            <p style="color: ${publishedColor}; font-weight: bold; margin-top: 0.25rem;">${publishedStatus}</p>
                            ${images && images.length > 0 ? `
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${images.slice(0, 3).map(img => {
                                        const imgUrl = typeof img === 'string' ? img : (img.url || img);
                                        return `<img src="${imgUrl}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #e9ecef;">`;
                                    }).join('')}
                                    ${images.length > 3 ? `<span style="color: #666; font-size: 0.85rem;">+${images.length - 3} å¼µ</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="property-actions">
                            <button class="btn-small btn-primary" onclick="editProperty('${prop.id}')">âœï¸ ç·¨è¼¯</button>
                            <button class="btn-small ${prop.is_published ? 'btn-warning' : 'btn-success'}" onclick="togglePublishStatus('${prop.id}', ${!prop.is_published})">
                                ${prop.is_published ? 'â¬‡ï¸ ä¸‹æ¶' : 'â¬†ï¸ ä¸Šæ¶'}
                            </button>
                            <button class="btn-small btn-danger" onclick="deleteProperty('${prop.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('è¼‰å…¥éŒ¯èª¤:', error);
                document.getElementById('property-list').innerHTML = 
                    `<p style="text-align: center; color: #dc3545; padding: 2rem;">è¼‰å…¥å¤±æ•—ï¼š${error.message || 'è«‹ç¢ºèª Supabase è¨­å®šæ˜¯å¦æ­£ç¢º'}</p>`;
            }
        }
        
        // åˆ‡æ›ä¸Šæ¶/ä¸‹æ¶ç‹€æ…‹ï¼ˆå„ªåŒ–ç‰ˆï¼šæ¸›å°‘å»¶é²ï¼‰
        async function togglePublishStatus(id, newStatus) {
            if (!supabaseClient) {
                showAlert('error', 'è«‹å…ˆè¨­å®š Supabase é…ç½®');
                return;
            }
            
            try {
                // å…ˆæ›´æ–° UIï¼ˆæ¨‚è§€æ›´æ–°ï¼‰
                const listContainer = document.getElementById('property-list');
                const propertyItems = listContainer.querySelectorAll('.property-item');
                propertyItems.forEach(item => {
                    const editBtn = item.querySelector(`button[onclick*="'${id}'"]`);
                    if (editBtn) {
                        const parentItem = editBtn.closest('.property-item');
                        if (parentItem) {
                            // ç«‹å³æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                            const toggleBtn = parentItem.querySelector(`button[onclick*="togglePublishStatus('${id}'"]`);
                            if (toggleBtn) {
                                toggleBtn.textContent = newStatus ? 'â¬‡ï¸ ä¸‹æ¶' : 'â¬†ï¸ ä¸Šæ¶';
                                toggleBtn.className = `btn-small ${newStatus ? 'btn-warning' : 'btn-success'}`;
                            }
                            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                            const statusP = parentItem.querySelector('p[style*="color"]');
                            if (statusP) {
                                statusP.textContent = newStatus ? 'âœ… ä¸Šæ¶' : 'âŒ ä¸‹æ¶';
                                statusP.style.color = newStatus ? '#28a745' : '#dc3545';
                            }
                        }
                    }
                });
                
                // ç•°æ­¥æ›´æ–°è³‡æ–™åº«
                const { error } = await supabaseClient
                    .from('properties')
                    .update({ is_published: newStatus })
                    .eq('id', id);
                
                if (error) {
                    // å¦‚æœå¤±æ•—ï¼Œé‡æ–°è¼‰å…¥æ¢å¾©åŸç‹€æ…‹
                    loadProperties();
                    throw error;
                }
                
                showAlert('success', newStatus ? 'ç‰©ä»¶å·²ä¸Šæ¶ï¼' : 'ç‰©ä»¶å·²ä¸‹æ¶ï¼');
                // ä¸éœ€è¦é‡æ–°è¼‰å…¥æ•´å€‹åˆ—è¡¨ï¼Œå› ç‚ºå·²ç¶“æ¨‚è§€æ›´æ–°äº†
            } catch (error) {
                console.error('åˆ‡æ›ç‹€æ…‹éŒ¯èª¤:', error);
                showAlert('error', `æ“ä½œå¤±æ•—ï¼š${error.message}`);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚é‡æ–°è¼‰å…¥ä»¥ç¢ºä¿è³‡æ–™ä¸€è‡´
                loadProperties();
            }
        }
        
        // ç·¨è¼¯ç‰©ä»¶
        async function editProperty(id) {
            // æª¢æŸ¥ Supabase æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                showAlert('error', 'è«‹å…ˆè¨­å®š Supabase é…ç½®ï¼Œæ­£åœ¨è·³è½‰åˆ°è¨­å®šé é¢...');
                setTimeout(() => {
                    const configTab = document.querySelector('.tab[onclick*="config"]');
                    if (configTab) {
                        switchTab('config', configTab);
                    }
                }, 1000);
                return;
            }
            
            try {
                const { data: prop, error } = await supabaseClient
                    .from('properties')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                if (!prop) {
                    throw new Error('ç‰©ä»¶ä¸å­˜åœ¨');
                }
                editingPropertyId = id;
                
                // å¡«å…¥è¡¨å–®
                Object.keys(prop).forEach(key => {
                    // è·³éä¸éœ€è¦å¡«å…¥è¡¨å–®çš„æ¬„ä½
                    if (['id', 'created_at', 'updated_at'].includes(key)) {
                        return;
                    }
                    
                    const element = document.getElementById(key);
                    if (element) {
                        if (key === 'is_published') {
                            // è™•ç†ä¸Šæ¶ç‹€æ…‹
                            element.value = prop.is_published ? 'true' : 'false';
                        } else if (key === 'is_external') {
                            // è™•ç†ç‰©ä»¶ä¾†æº
                            element.value = prop.is_external ? 'true' : 'false';
                        } else if (key === 'status_text' || key === 'statusText') {
                            // è™•ç† status_text æ¬„ä½ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰
                            const statusTextSelect = document.getElementById('statusText');
                            const statusTextInput = document.getElementById('statusTextInput');
                            const statusText = prop.status_text || prop.statusText || '';
                            
                            if (statusTextSelect) {
                                // æª¢æŸ¥ä¸‹æ‹‰é¸å–®ä¸­æ˜¯å¦æœ‰å°æ‡‰çš„é¸é …
                                const optionExists = Array.from(statusTextSelect.options).some(option => option.value === statusText);
                                
                                if (optionExists) {
                                    // å¦‚æœæœ‰å°æ‡‰é¸é …ï¼Œé¸æ“‡å®ƒ
                                    statusTextSelect.value = statusText;
                                    if (statusTextInput) {
                                        statusTextInput.style.display = 'none';
                                        statusTextInput.value = '';
                                    }
                                } else if (statusText) {
                                    // å¦‚æœæ²’æœ‰å°æ‡‰é¸é …ï¼Œä½¿ç”¨è‡ªè¨‚è¼¸å…¥
                                    statusTextSelect.value = 'custom';
                                    if (statusTextInput) {
                                        statusTextInput.style.display = 'block';
                                        statusTextInput.value = statusText;
                                    }
                                } else {
                                    // å¦‚æœæ²’æœ‰ç‹€æ…‹æ–‡å­—ï¼Œé‡ç½®ç‚ºé è¨­
                                    statusTextSelect.value = '';
                                    if (statusTextInput) {
                                        statusTextInput.style.display = 'none';
                                        statusTextInput.value = '';
                                    }
                                }
                            }
                        } else if (key === 'city') {
                            // è™•ç†ç¸£å¸‚
                            element.value = prop.city || '';
                            if (prop.city) {
                                updateDistricts();
                                // ç­‰å¾…å€åŸŸé¸é …æ›´æ–°å¾Œå†è¨­å®šå€åŸŸ
                                setTimeout(() => {
                                    const districtElement = document.getElementById('district');
                                    if (districtElement && prop.district) {
                                        districtElement.value = prop.district;
                                    }
                                }, 100);
                            }
                        } else if (key === 'district') {
                            // å€åŸŸæœƒåœ¨ city è¨­å®šå¾Œè‡ªå‹•è™•ç†
                            // é€™è£¡ä¸éœ€è¦å–®ç¨è™•ç†
                        } else if (key === 'address') {
                            // è™•ç†åœ°å€ï¼šå¦‚æœæœ‰ city å’Œ districtï¼Œåªé¡¯ç¤ºè©³ç´°åœ°å€éƒ¨åˆ†
                            if (prop.city && prop.district && prop.address) {
                                // ç§»é™¤ç¸£å¸‚å’Œå€åŸŸéƒ¨åˆ†
                                let detailAddress = prop.address;
                                detailAddress = detailAddress.replace(prop.city, '');
                                detailAddress = detailAddress.replace(prop.district, '');
                                element.value = detailAddress.trim();
                            } else {
                                element.value = prop.address || '';
                            }
                        } else if (key === 'address_detail') {
                            // å¦‚æœæœ‰è©³ç´°åœ°å€ï¼Œä½¿ç”¨å®ƒ
                            if (prop.address_detail) {
                                const addressElement = document.getElementById('address');
                                if (addressElement) {
                                    addressElement.value = prop.address_detail;
                                }
                            }
                        } else if (key === 'features') {
                            // ç‰¹æ®Šè™•ç† featuresï¼šç¢ºä¿æ˜¯é™£åˆ—æ ¼å¼
                            if (Array.isArray(prop[key])) {
                                element.value = prop[key].join('\n');
                            } else {
                                element.value = '';
                            }
                        } else if (key === 'description') {
                            // ç‰¹æ®Šè™•ç† descriptionï¼šç¢ºä¿æ­£ç¢ºé¡¯ç¤º
                            element.value = prop[key] || '';
                        } else if (Array.isArray(prop[key])) {
                            element.value = prop[key].join('\n');
                        } else if (typeof prop[key] === 'object' && prop[key] !== null) {
                            // è™•ç† JSONB æ¬„ä½
                            if (key === 'transportation') {
                                const trans = prop[key];
                                if (trans.facilities) {
                                    loadTagsToSelector('facilities', Array.isArray(trans.facilities) ? trans.facilities : []);
                                }
                                if (trans.transport) {
                                    loadTagsToSelector('transport', Array.isArray(trans.transport) ? trans.transport : []);
                                }
                                if (trans.schools) {
                                    loadTagsToSelector('schools', Array.isArray(trans.schools) ? trans.schools : []);
                                }
                                if (trans.market) {
                                    document.getElementById('market').value = trans.market;
                                }
                                if (trans.park) {
                                    document.getElementById('park').value = trans.park;
                                }
                            }
                        } else {
                            let value = prop[key] || '';
                            // ç‰¹æ®Šè™•ç† google_mapsï¼šå¦‚æœæ˜¯å®Œæ•´çš„ iframe HTMLï¼Œæå– src å±¬æ€§å€¼
                            if (key === 'google_maps' && value && value.includes('<iframe')) {
                                const srcMatch = value.match(/src=["']([^"']+)["']/i);
                                if (srcMatch && srcMatch[1]) {
                                    value = srcMatch[1];
                                } else {
                                    value = '';
                                }
                            }
                            // ç‰¹æ®Šè™•ç† ageï¼šç¢ºä¿æœ‰ã€Œå¹´ã€å­—ï¼Œä½†é¿å…é‡è¤‡
                            if (key === 'age' && value) {
                                // å¦‚æœå·²ç¶“æœ‰ã€Œå¹´ã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œå¹´ã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                                if (value.includes('å¹´')) {
                                    value = value.replace(/å¹´+/g, '');
                                    const numberMatch = value.match(/^\d+/);
                                    if (numberMatch) {
                                        value = numberMatch[0] + 'å¹´';
                                    }
                                }
                                // å¦‚æœåªæœ‰æ•¸å­—ï¼ŒåŠ ä¸Šã€Œå¹´ã€
                                else if (/^\d+$/.test(value)) {
                                    value = value + 'å¹´';
                                }
                                // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œå¹´ã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œå¹´ã€
                                else if (/^\d+/.test(value)) {
                                    const numberMatch = value.match(/^\d+/);
                                    if (numberMatch) {
                                        value = numberMatch[0] + 'å¹´';
                                    }
                                }
                            }
                            // ç‰¹æ®Šè™•ç†åªæ•¸æ¬„ä½ï¼šç¢ºä¿æœ‰ã€Œåªã€å­—ï¼Œä½†é¿å…é‡è¤‡
                            const areaFields = ['total_area', 'main_area', 'auxiliary_area', 'common_area', 'land_area', 'parking_area'];
                            if (areaFields.includes(key) && value) {
                                // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
                                if (value.includes('åª')) {
                                    value = value.replace(/åª+/g, '');
                                    const numberMatch = value.match(/^[\d.]+/);
                                    if (numberMatch) {
                                        value = numberMatch[0] + 'åª';
                                    }
                                }
                                // å¦‚æœåªæœ‰æ•¸å­—ï¼ˆå¯èƒ½åŒ…å«å°æ•¸é»ï¼‰ï¼ŒåŠ ä¸Šã€Œåªã€
                                else if (/^[\d.]+$/.test(value)) {
                                    value = value + 'åª';
                                }
                                // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
                                else if (/^[\d.]+/.test(value)) {
                                    const numberMatch = value.match(/^[\d.]+/);
                                    if (numberMatch) {
                                        value = numberMatch[0] + 'åª';
                                    }
                                }
                            }
                            // ç‰¹æ®Šè™•ç†å»ºç¯‰é¡å‹ï¼šå°æ‡‰èˆŠå€¼åˆ°æ–°å€¼
                            if (key === 'building_type' && value) {
                                const buildingTypeMap = {
                                    'è¯å»ˆå…¬å¯“': 'è¯å»ˆ',
                                    'é€å¤©åˆ¥å¢…': 'é€å¤©',
                                    'é€å¤©å': 'é€å¤©',
                                    'å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                                    'ä½å®…å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                                    'å•†æ¥­å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                                    'ä½å•†å¤§æ¨“': 'é›»æ¢¯å¤§æ¨“',
                                    'å¤§å»ˆ': 'é›»æ¢¯å¤§æ¨“'
                                };
                                if (buildingTypeMap[value]) {
                                    value = buildingTypeMap[value];
                                }
                            }
                            element.value = value;
                        }
                    }
                });
                
                // è™•ç†å¢å»ºæ¨“å±¤ï¼šå¦‚æœ floor æ¬„ä½åŒ…å«ã€Œï¼ˆå¢å»ºã€ï¼Œåˆ†é›¢å‡ºä¾†
                const floorValue = prop.floor || '';
                if (floorValue.includes('ï¼ˆå¢å»º') || floorValue.includes('(å¢å»º')) {
                    const match = floorValue.match(/^(.+?)[ï¼ˆ(]å¢å»º(.+?)[ï¼‰)]/);
                    if (match) {
                        const originalFloor = match[1].trim();
                        const extensionFloor = match[2].trim();
                        const floorInput = document.getElementById('floor');
                        const extensionInput = document.getElementById('extension_floor');
                        if (floorInput) floorInput.value = originalFloor;
                        if (extensionInput) extensionInput.value = extensionFloor;
                    }
                }
                
                // æ ¹æ“šç‰©ä»¶é¡å‹é¡¯ç¤º/éš±è—å¢å»ºæ¨“å±¤æ¬„ä½
                const propertyType = prop.type || '';
                checkAndShowExtensionFloor();
                
                // è¼‰å…¥éš±è—é–€ç‰Œè™Ÿç¢¼é¸é …
                const hideAddressCheckbox = document.getElementById('hide_address_number');
                if (hideAddressCheckbox) {
                    hideAddressCheckbox.checked = prop.hide_address_number || false;
                }
                
                
                // è¼‰å…¥åœ–ç‰‡
                uploadedImages = [];
                let images = [];
                if (prop.images) {
                    if (typeof prop.images === 'string') {
                        try {
                            images = JSON.parse(prop.images);
                        } catch (e) {
                            images = [];
                        }
                    } else if (Array.isArray(prop.images)) {
                        images = prop.images;
                    }
                }
                
                if (images && images.length > 0) {
                    uploadedImages = images.map((img, index) => {
                        const imgUrl = typeof img === 'string' ? img : (img.url || img);
                        const imageId = 'edit_' + Date.now() + '_' + index;
                        return { url: imgUrl, key: typeof img === 'object' ? img.key : null, imageId };
                    });
                    
                    const imagePreviewGrid = document.getElementById('image-preview-grid');
                    if (imagePreviewGrid) {
                        imagePreviewGrid.innerHTML = '';
                        uploadedImages.forEach((imgData, index) => {
                            const item = document.createElement('div');
                            item.className = 'image-preview-item';
                            item.dataset.imageId = imgData.imageId;
                            item.draggable = true;
                            item.style.position = 'relative';
                            const img = document.createElement('img');
                            img.src = imgData.url || imgData;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.pointerEvents = 'none';
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'image-remove';
                            removeBtn.innerHTML = 'Ã—';
                            removeBtn.onclick = () => removeImage(item, imgData.imageId);
                            item.appendChild(img);
                            item.appendChild(removeBtn);
                            imagePreviewGrid.appendChild(item);
                            console.log('âœ… å·²è¼‰å…¥åœ–ç‰‡é …ç›®ï¼ˆå¯æ‹–æ›³ï¼‰:', imgData.imageId);
                        });
                        
                        // ç¢ºä¿æ‹–æ›³åŠŸèƒ½å·²åˆå§‹åŒ–
                        initImageSortable();
                    }
                }
                
                // åˆ‡æ›åˆ°æ–°å¢æ¨™ç±¤
                const addTab = document.querySelectorAll('.tab')[1];
                if (addTab) {
                    switchTab('add', addTab);
                }
                
                // æ»¾å‹•åˆ°é ‚éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('ç·¨è¼¯éŒ¯èª¤:', error);
                showAlert('error', `è¼‰å…¥ç‰©ä»¶è³‡æ–™å¤±æ•—ï¼š${error.message}`);
            }
        }
        
        // é¡¯ç¤ºç¢ºèªå½ˆè·³è¦–çª—
        function showConfirmModal(options) {
            return new Promise((resolve) => {
                const {
                    title = 'ç¢ºèªæ“ä½œ',
                    message = 'ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ',
                    icon = 'warning',
                    confirmText = 'ç¢ºå®š',
                    cancelText = 'å–æ¶ˆ',
                    confirmClass = 'modal-btn-danger'
                } = options;
                
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const iconEmoji = icon === 'danger' ? 'âš ï¸' : 'â“';
                const iconClass = icon === 'danger' ? 'danger' : 'warning';
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-icon ${iconClass}">${iconEmoji}</div>
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn modal-btn-cancel" onclick="this.closest('.modal-overlay').remove(); arguments[0].stopPropagation();">${cancelText}</button>
                            <button class="modal-btn ${confirmClass}" onclick="this.closest('.modal-overlay').remove(); arguments[0].stopPropagation();">${confirmText}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // è™•ç†ç¢ºèªæŒ‰éˆ•
                const confirmBtn = overlay.querySelector(`.${confirmClass}`);
                confirmBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                // è™•ç†å–æ¶ˆæŒ‰éˆ•
                const cancelBtn = overlay.querySelector('.modal-btn-cancel');
                cancelBtn.addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                // è™•ç† ESC éµ
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // é»æ“ŠèƒŒæ™¯é—œé–‰
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                });
            });
        }
        
        // åˆªé™¤ç‰©ä»¶
        async function deleteProperty(id) {
            // æª¢æŸ¥ Supabase æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                showAlert('error', 'è«‹å…ˆè¨­å®š Supabase é…ç½®ï¼Œæ­£åœ¨è·³è½‰åˆ°è¨­å®šé é¢...');
                setTimeout(() => {
                    const configTab = document.querySelector('.tab[onclick*="config"]');
                    if (configTab) {
                        switchTab('config', configTab);
                    }
                }, 1000);
                return;
            }
            
            // å…ˆå–å¾—ç‰©ä»¶è³‡è¨Šä»¥é¡¯ç¤ºåœ¨ç¢ºèªè¦–çª—ä¸­
            let propertyInfo = '';
            try {
                const { data: prop } = await supabaseClient
                    .from('properties')
                    .select('title, number')
                    .eq('id', id)
                    .single();
                
                if (prop) {
                    propertyInfo = `<strong>${prop.title || prop.number || 'æ­¤ç‰©ä»¶'}</strong>`;
                }
            } catch (e) {
                // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒé¡¯ç¤ºç¢ºèªè¦–çª—
            }
            
            const confirmed = await showConfirmModal({
                title: 'åˆªé™¤ç‰©ä»¶',
                message: `ç¢ºå®šè¦åˆªé™¤ ${propertyInfo || 'æ­¤ç‰©ä»¶'} å—ï¼Ÿ<br><br>æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œã€‚`,
                icon: 'danger',
                confirmText: 'ğŸ—‘ï¸ åˆªé™¤',
                cancelText: 'å–æ¶ˆ'
            });
            
            if (!confirmed) {
                return;
            }
            
            try {
                // å…ˆå–å¾—ç‰©ä»¶è³‡æ–™ï¼ˆç”¨æ–¼åˆªé™¤ç›¸é—œåœ–ç‰‡ï¼‰
                const { data: prop } = await supabaseClient
                    .from('properties')
                    .select('number')
                    .eq('id', id)
                    .single();
                
                // åˆªé™¤è³‡æ–™åº«è¨˜éŒ„
                const { error } = await supabaseClient
                    .from('properties')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // å¯é¸ï¼šåˆªé™¤ç›¸é—œåœ–ç‰‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // æ³¨æ„ï¼šé€™è£¡åªæ˜¯ç¤ºç¯„ï¼Œå¯¦éš›ä½¿ç”¨æ™‚å¯ä»¥æ ¹æ“šéœ€è¦æ±ºå®šæ˜¯å¦åˆªé™¤åœ–ç‰‡
                
                showAlert('success', 'ç‰©ä»¶å·²åˆªé™¤ï¼');
                loadProperties();
            } catch (error) {
                console.error('åˆªé™¤éŒ¯èª¤:', error);
                showAlert('error', `åˆªé™¤å¤±æ•—ï¼š${error.message}`);
            }
        }
        
        // é‡è¨­è¡¨å–®
        // æ¨™ç±¤é¸æ“‡ç³»çµ±
        const selectedTags = {
            facilities: [],
            transport: [],
            schools: []
        };
        
        // åˆ‡æ›æ¨™ç±¤é¸æ“‡ç‹€æ…‹
        function toggleTag(type, tagName) {
            // å¦‚æœé»æ“Šçš„æ˜¯ç·¨è¼¯æˆ–åˆªé™¤æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œåˆ‡æ›
            if (event && (event.target.classList.contains('tag-option-edit') || event.target.classList.contains('tag-option-delete'))) {
                return;
            }
            
            const index = selectedTags[type].indexOf(tagName);
            const optionElement = event.target.closest('.tag-option') || event.target;
            
            if (index > -1) {
                // å–æ¶ˆé¸æ“‡
                selectedTags[type].splice(index, 1);
                optionElement.classList.remove('selected');
            } else {
                // é¸æ“‡
                selectedTags[type].push(tagName);
                optionElement.classList.add('selected');
            }
            
            updateSelectedTagsDisplay(type);
        }
        
        // æ·»åŠ è‡ªè¨‚æ¨™ç±¤
        function addCustomTag(type) {
            const input = document.getElementById(`${type}-input`);
            const tagName = input.value.trim();
            
            if (!tagName) {
                showAlert('warning', 'è«‹è¼¸å…¥æ¨™ç±¤åç¨±');
                return;
            }
            
            if (selectedTags[type].includes(tagName)) {
                showAlert('warning', 'æ­¤æ¨™ç±¤å·²ç¶“è¢«é¸ä¸­äº†');
                return;
            }
            
            // æ·»åŠ åˆ°é¸ä¸­åˆ—è¡¨
            selectedTags[type].push(tagName);
            input.value = '';
            updateSelectedTagsDisplay(type);
            
            // å¦‚æœæ¨™ç±¤ä¸åœ¨é¸é …åˆ—è¡¨ä¸­ï¼Œæ·»åŠ åˆ°é¸é …åˆ—è¡¨ï¼ˆæ–¹ä¾¿ä»¥å¾Œä½¿ç”¨ï¼‰
            const optionsContainer = document.getElementById(`${type}-options`);
            if (optionsContainer) {
                const existingOption = Array.from(optionsContainer.children).find(
                    el => {
                        const text = el.querySelector('.tag-option-text') || el;
                        return text.textContent.trim() === tagName;
                    }
                );
                
                if (!existingOption) {
                    // å‰µå»ºæ–°çš„é¸é …å…ƒç´ 
                    const newOption = document.createElement('span');
                    newOption.className = 'tag-option selected';
                    newOption.setAttribute('onclick', `toggleTag('${type}', '${tagName}')`);
                    newOption.innerHTML = `
                        <span class="tag-option-text">${tagName}</span>
                        <button class="tag-option-edit" onclick="editTagOption('${type}', '${tagName}', event)" title="ç·¨è¼¯">âœï¸</button>
                        <button class="tag-option-delete" onclick="deleteTagOption('${type}', '${tagName}', event)" title="åˆªé™¤">Ã—</button>
                    `;
                    optionsContainer.appendChild(newOption);
                } else {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œæ¨™è¨˜ç‚ºé¸ä¸­
                    existingOption.classList.add('selected');
                }
            }
        }
        
        // æ›´æ–°å·²é¸æ“‡æ¨™ç±¤çš„é¡¯ç¤º
        function updateSelectedTagsDisplay(type) {
            const container = document.getElementById(`${type}-selected`);
            if (!container) return;
            
            container.innerHTML = '';
            
            selectedTags[type].forEach(tagName => {
                const tag = document.createElement('span');
                tag.className = 'selected-tag';
                tag.dataset.tagName = tagName;
                tag.innerHTML = `
                    <span class="tag-text">${tagName}</span>
                    <button type="button" class="tag-edit" onclick="editSelectedTag('${type}', '${tagName}', event)" aria-label="ç·¨è¼¯æ¨™ç±¤" title="é›™æ“Šæˆ–é»æ“Šç·¨è¼¯">âœï¸</button>
                    <button type="button" class="tag-remove" onclick="removeTag('${type}', '${tagName}')" aria-label="ç§»é™¤æ¨™ç±¤" title="åˆªé™¤æ¨™ç±¤">Ã—</button>
                `;
                
                // æ·»åŠ é›™æ“Šç·¨è¼¯åŠŸèƒ½
                tag.addEventListener('dblclick', () => {
                    editSelectedTag(type, tagName);
                });
                
                container.appendChild(tag);
                
                // åŒæ­¥æ›´æ–°é¸é …ä¸­çš„é¸ä¸­ç‹€æ…‹
                const optionsContainer = document.getElementById(`${type}-options`);
                if (optionsContainer) {
                    const option = Array.from(optionsContainer.children).find(
                        el => {
                            const text = el.querySelector('.tag-option-text') || el;
                            return text.textContent.trim() === tagName;
                        }
                    );
                    if (option) {
                        option.classList.add('selected');
                    }
                }
            });
        }
        
        // ç·¨è¼¯å·²é¸æ“‡çš„æ¨™ç±¤
        function editSelectedTag(type, oldTagName, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const container = document.getElementById(`${type}-selected`);
            if (!container) return;
            
            const tagElement = container.querySelector(`[data-tag-name="${oldTagName}"]`);
            if (!tagElement) return;
            
            // å¦‚æœæ­£åœ¨ç·¨è¼¯ï¼Œå…ˆä¿å­˜
            if (tagElement.classList.contains('editing')) {
                return;
            }
            
            tagElement.classList.add('editing');
            const tagText = tagElement.querySelector('.tag-text');
            const currentText = tagText.textContent;
            
            // å‰µå»ºç·¨è¼¯è¼¸å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'tag-edit-input';
            input.value = currentText;
            input.style.width = Math.max(currentText.length * 10, 80) + 'px';
            
            // æ›¿æ›æ–‡å­—ç‚ºè¼¸å…¥æ¡†
            tagText.style.display = 'none';
            tagElement.insertBefore(input, tagText);
            
            // èšç„¦ä¸¦é¸ä¸­æ–‡å­—
            input.focus();
            input.select();
            
            // ä¿å­˜ç·¨è¼¯
            const saveEdit = () => {
                const newTagName = input.value.trim();
                if (newTagName && newTagName !== oldTagName) {
                    // æ›´æ–°æ¨™ç±¤åç¨±
                    const index = selectedTags[type].indexOf(oldTagName);
                    if (index > -1) {
                        selectedTags[type][index] = newTagName;
                        
                        // æ›´æ–°é¸é …åˆ—è¡¨ä¸­çš„æ¨™ç±¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        updateTagOption(type, oldTagName, newTagName);
                        
                        // é‡æ–°é¡¯ç¤ºæ¨™ç±¤
                        updateSelectedTagsDisplay(type);
                    }
                } else if (newTagName === '') {
                    // å¦‚æœç‚ºç©ºï¼Œåˆªé™¤æ¨™ç±¤
                    removeTag(type, oldTagName);
                } else {
                    // å–æ¶ˆç·¨è¼¯
                    tagElement.classList.remove('editing');
                    input.remove();
                    tagText.style.display = '';
                }
            };
            
            // æŒ‰ Enter ä¿å­˜
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    tagElement.classList.remove('editing');
                    input.remove();
                    tagText.style.display = '';
                }
            });
            
            // å¤±å»ç„¦é»æ™‚ä¿å­˜
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    if (tagElement.classList.contains('editing')) {
                        saveEdit();
                    }
                }, 200);
            });
        }
        
        // æ›´æ–°é¸é …åˆ—è¡¨ä¸­çš„æ¨™ç±¤åç¨±
        function updateTagOption(type, oldName, newName) {
            const optionsContainer = document.getElementById(`${type}-options`);
            if (!optionsContainer) return;
            
            const option = Array.from(optionsContainer.children).find(
                el => {
                    const text = el.querySelector('.tag-option-text') || el;
                    return text.textContent.trim() === oldName;
                }
            );
            
            if (option) {
                const textElement = option.querySelector('.tag-option-text') || option;
                textElement.textContent = newName;
                
                // æ›´æ–° onclick äº‹ä»¶
                option.setAttribute('onclick', `toggleTag('${type}', '${newName}')`);
                
                // å¦‚æœæ¨™ç±¤è¢«é¸ä¸­ï¼Œæ›´æ–°é¸ä¸­ç‹€æ…‹
                if (option.classList.contains('selected')) {
                    const index = selectedTags[type].indexOf(newName);
                    if (index === -1) {
                        option.classList.remove('selected');
                    }
                }
            }
        }
        
        // ç§»é™¤æ¨™ç±¤
        function removeTag(type, tagName) {
            const index = selectedTags[type].indexOf(tagName);
            if (index > -1) {
                selectedTags[type].splice(index, 1);
                updateSelectedTagsDisplay(type);
                
                // å–æ¶ˆé¸é …ä¸­çš„é¸ä¸­ç‹€æ…‹
                const optionsContainer = document.getElementById(`${type}-options`);
                if (optionsContainer) {
                    const option = Array.from(optionsContainer.children).find(
                        el => {
                            const text = el.querySelector('.tag-option-text') || el;
                            return text.textContent.trim() === tagName;
                        }
                    );
                    if (option) {
                        option.classList.remove('selected');
                    }
                }
            }
        }
        
        // ç·¨è¼¯æ¨™ç±¤é¸é …ï¼ˆåœ¨é¸é …åˆ—è¡¨ä¸­ï¼‰
        function editTagOption(type, oldName, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const optionsContainer = document.getElementById(`${type}-options`);
            if (!optionsContainer) return;
            
            const option = Array.from(optionsContainer.children).find(
                el => {
                    const text = el.querySelector('.tag-option-text') || el;
                    return text.textContent.trim() === oldName;
                }
            );
            
            if (!option) return;
            
            // å¦‚æœæ­£åœ¨ç·¨è¼¯ï¼Œå…ˆä¿å­˜
            if (option.classList.contains('editing')) {
                return;
            }
            
            option.classList.add('editing');
            const textElement = option.querySelector('.tag-option-text') || option;
            const currentText = textElement.textContent.trim();
            
            // å‰µå»ºç·¨è¼¯è¼¸å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'tag-edit-input';
            input.value = currentText;
            input.style.width = Math.max(currentText.length * 10, 80) + 'px';
            
            // æ›¿æ›æ–‡å­—ç‚ºè¼¸å…¥æ¡†
            const originalDisplay = textElement.style.display;
            textElement.style.display = 'none';
            option.insertBefore(input, textElement);
            
            // èšç„¦ä¸¦é¸ä¸­æ–‡å­—
            input.focus();
            input.select();
            
            // ä¿å­˜ç·¨è¼¯
            const saveEdit = () => {
                const newName = input.value.trim();
                if (newName && newName !== oldName) {
                    // æ›´æ–°é¸é …æ–‡å­—
                    textElement.textContent = newName;
                    textElement.style.display = originalDisplay;
                    
                    // æ›´æ–° onclick äº‹ä»¶
                    option.setAttribute('onclick', `toggleTag('${type}', '${newName}')`);
                    
                    // å¦‚æœæ¨™ç±¤è¢«é¸ä¸­ï¼Œæ›´æ–°é¸ä¸­çš„æ¨™ç±¤åç¨±
                    if (selectedTags[type].includes(oldName)) {
                        const index = selectedTags[type].indexOf(oldName);
                        selectedTags[type][index] = newName;
                        updateSelectedTagsDisplay(type);
                    }
                } else if (newName === '') {
                    // å¦‚æœç‚ºç©ºï¼Œåˆªé™¤é¸é …
                    deleteTagOption(type, oldName);
                    return;
                } else {
                    // å–æ¶ˆç·¨è¼¯
                    textElement.style.display = originalDisplay;
                }
                
                option.classList.remove('editing');
                input.remove();
            };
            
            // æŒ‰ Enter ä¿å­˜
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    option.classList.remove('editing');
                    textElement.style.display = originalDisplay;
                    input.remove();
                }
            });
            
            // å¤±å»ç„¦é»æ™‚ä¿å­˜
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    if (option.classList.contains('editing')) {
                        saveEdit();
                    }
                }, 200);
            });
        }
        
        // åˆªé™¤æ¨™ç±¤é¸é …ï¼ˆå¾é¸é …åˆ—è¡¨ä¸­ï¼‰
        function deleteTagOption(type, tagName, event) {
            if (event) {
                event.stopPropagation();
            }
            
            // ç¢ºèªåˆªé™¤
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¨™ç±¤é¸é …ã€Œ${tagName}ã€å—ï¼Ÿ\n\nå¦‚æœæ­¤æ¨™ç±¤å·²è¢«é¸ä¸­ï¼Œä¹Ÿæœƒä¸€ä½µç§»é™¤ã€‚`)) {
                return;
            }
            
            const optionsContainer = document.getElementById(`${type}-options`);
            if (!optionsContainer) return;
            
            const option = Array.from(optionsContainer.children).find(
                el => {
                    const text = el.querySelector('.tag-option-text') || el;
                    return text.textContent.trim() === tagName;
                }
            );
            
            if (option) {
                // å¦‚æœæ¨™ç±¤è¢«é¸ä¸­ï¼Œå…ˆç§»é™¤
                if (selectedTags[type].includes(tagName)) {
                    removeTag(type, tagName);
                }
                
                // åˆªé™¤é¸é …å…ƒç´ 
                option.remove();
            }
        }
        
        // è¼‰å…¥æ¨™ç±¤åˆ°é¸æ“‡å™¨
        function loadTagsToSelector(type, tags) {
            if (!Array.isArray(tags)) return;
            
            selectedTags[type] = [...tags];
            updateSelectedTagsDisplay(type);
        }
        
        // æ¸…é™¤æ‰€æœ‰æ¨™ç±¤
        function clearAllTags(type) {
            selectedTags[type] = [];
            updateSelectedTagsDisplay(type);
            
            // æ¸…é™¤é¸é …ä¸­çš„é¸ä¸­ç‹€æ…‹
            const optionsContainer = document.getElementById(`${type}-options`);
            if (optionsContainer) {
                optionsContainer.querySelectorAll('.tag-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });
            }
        }
        
        // ç²å–æ‰€æœ‰ç¾æœ‰çš„ç‰©ä»¶ç·¨è™Ÿï¼ˆç”¨æ–¼æª¢æŸ¥é‡è¤‡ï¼‰
        async function getAllPropertyNumbers() {
            if (!supabaseClient) {
                return [];
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('id, number');
                
                if (error) throw error;
                
                return (data || [])
                    .filter(item => item.number)
                    .map(item => item.number);
            } catch (error) {
                console.error('âŒ ç²å–ç‰©ä»¶ç·¨è™Ÿå¤±æ•—:', error);
                return [];
            }
        }
        
        // æ ¹æ“šé¡åˆ¥ç²å–ç·¨è™Ÿå‰ç¶´ï¼ˆæ–°æ ¼å¼ï¼š2å­—æ¯ï¼‰
        function getTypePrefix(type) {
            const typeMap = {
                'å¥—æˆ¿': 'SU',
                '2æˆ¿': 'TW',
                '3æˆ¿': 'TH',
                '4æˆ¿': 'FO',
                'è¯å»ˆ': 'HS',
                'å…¬å¯“': 'AP',
                'é€å¤©': 'TT',
                'åº—é¢': 'ST',
                'åˆ¥å¢…': 'VH'
            };
            return typeMap[type] || 'XX';
        }
        
        // æ¡ƒåœ’å¸‚å€åŸŸåˆ—è¡¨
        const taoyuanDistricts = [
            'æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¤§æºªå€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§åœ’å€', 
            'é¾œå±±å€', 'å…«å¾·å€', 'é¾æ½­å€', 'å¹³é®å€', 'æ–°å±‹å€', 'è§€éŸ³å€',
            'å¾©èˆˆå€'
        ];
        
        // å„ç¸£å¸‚å€åŸŸå°æ‡‰è¡¨
        const cityDistricts = {
            'æ¡ƒåœ’å¸‚': taoyuanDistricts,
            'å°åŒ—å¸‚': ['ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'],
            'æ–°åŒ—å¸‚': ['æ¿æ©‹å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'æ–°èŠå€', 'æ–°åº—å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'ä¸‰å³½å€', 'æ·¡æ°´å€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'åœŸåŸå€', 'è˜†æ´²å€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'å…«é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'çƒä¾†å€'],
            'å°ä¸­å¸‚': ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'åŒ—å±¯å€', 'è±åŸå€', 'æ±å‹¢å€', 'å¤§ç”²å€', 'æ¸…æ°´å€', 'æ²™é¹¿å€', 'æ¢§æ£²å€', 'åé‡Œå€', 'ç¥å²¡å€', 'æ½­å­å€', 'å¤§é›…å€', 'æ–°ç¤¾å€', 'çŸ³å²¡å€', 'å¤–åŸ”å€', 'å¤§å®‰å€', 'çƒæ—¥å€', 'å¤§è‚šå€', 'é¾äº•å€', 'éœ§å³°å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'å’Œå¹³å€'],
            'å°å—å¸‚': ['ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'å·¦é®å€', 'ç‰äº•å€', 'æ¥ è¥¿å€', 'å—åŒ–å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'é¾å´å€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'è¥¿æ¸¯å€', 'ä¸ƒè‚¡å€', 'å°‡è»å€', 'å­¸ç”²å€', 'åŒ—é–€å€', 'æ–°ç‡Ÿå€', 'å¾Œå£å€', 'ç™½æ²³å€', 'æ±å±±å€', 'å…­ç”²å€', 'ä¸‹ç‡Ÿå€', 'æŸ³ç‡Ÿå€', 'é¹½æ°´å€', 'å–„åŒ–å€', 'å¤§å…§å€', 'å±±ä¸Šå€', 'æ–°å¸‚å€', 'å®‰å®šå€'],
            'é«˜é›„å¸‚': ['æ–°èˆˆå€', 'å‰é‡‘å€', 'è‹“é›…å€', 'é¹½åŸ•å€', 'é¼“å±±å€', 'æ——æ´¥å€', 'å‰é®å€', 'ä¸‰æ°‘å€', 'å·¦ç‡Ÿå€', 'æ¥ æ¢“å€', 'å°æ¸¯å€', 'é³³å±±å€', 'æ—åœ’å€', 'å¤§å¯®å€', 'å¤§æ¨¹å€', 'å¤§ç¤¾å€', 'ä»æ­¦å€', 'é³¥æ¾å€', 'å²¡å±±å€', 'æ©‹é ­å€', 'ç‡•å·¢å€', 'ç”°å¯®å€', 'é˜¿è“®å€', 'è·¯ç«¹å€', 'æ¹–å…§å€', 'èŒ„è£å€', 'æ°¸å®‰å€', 'å½Œé™€å€', 'æ¢“å®˜å€', 'æ——å±±å€', 'ç¾æ¿ƒå€', 'å…­é¾œå€', 'ç”²ä»™å€', 'æ‰æ—å€', 'å…§é–€å€', 'èŒ‚æ—å€', 'æ¡ƒæºå€', 'é‚£ç‘ªå¤å€']
        };
        
        // æ›´æ–°å€åŸŸé¸é …
        function updateDistricts() {
            const citySelect = document.getElementById('city');
            const districtSelect = document.getElementById('district');
            const selectedCity = citySelect.value;
            
            // æ¸…ç©ºå€åŸŸé¸é …
            districtSelect.innerHTML = '<option value="">è«‹é¸æ“‡å€åŸŸ</option>';
            
            if (selectedCity && cityDistricts[selectedCity]) {
                cityDistricts[selectedCity].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }
        
        // ç”Ÿæˆä¸‹ä¸€å€‹åºè™Ÿï¼ˆåº—å…§ç‰©ä»¶ï¼š7ä½æ•¸æ ¼å¼ SU00001ï¼‰
        function getNextInternalSequenceNumber(existingNumbers, prefix) {
            // æ‰¾å‡ºæ‰€æœ‰å±¬æ–¼è©²é¡åˆ¥çš„åº—å…§ç‰©ä»¶ç·¨è™Ÿï¼ˆæ ¼å¼ï¼šSU00001, TW00001ï¼‰
            // åŒæ™‚éæ¿¾æ‰èˆŠæ ¼å¼çš„ç·¨è™Ÿï¼ˆå¦‚ï¼š2-1, 3-6ç­‰ï¼‰å’Œå…¶ä»–ä¸ç¬¦åˆæ¨™æº–æ ¼å¼çš„ç·¨è™Ÿ
            const typeNumbers = existingNumbers
                .filter(num => {
                    // åªè™•ç†ç¬¦åˆæ–°æ ¼å¼çš„ç·¨è™Ÿï¼š{2å­—æ¯å‰ç¶´}{5ä½æ•¸å­—}
                    // æ’é™¤ä»¥ EX é–‹é ­çš„ï¼ˆåº—å¤–ç‰©ä»¶ï¼‰
                    // æ’é™¤åŒ…å«é€£å­—è™Ÿçš„èˆŠæ ¼å¼ï¼ˆå¦‚ï¼š2-1, 3-6ï¼‰
                    // æ’é™¤å…¶ä»–ä¸ç¬¦åˆæ¨™æº–æ ¼å¼çš„ç·¨è™Ÿ
                    if (!num || typeof num !== 'string') return false;
                    if (num.startsWith('EX')) return false;
                    if (num.includes('-')) return false; // æ’é™¤èˆŠæ ¼å¼
                    // æª¢æŸ¥æ˜¯å¦ç¬¦åˆæ¨™æº–æ ¼å¼ï¼š2å­—æ¯ + 5ä½æ•¸å­—
                    const standardFormat = new RegExp(`^${prefix}\\d{5}$`);
                    return standardFormat.test(num);
                })
                .map(num => {
                    // æå–åºè™Ÿéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼šSU00001 -> 1ï¼‰
                    const match = num.match(new RegExp(`^${prefix}(\\d+)$`));
                    return match ? parseInt(match[1], 10) : 0;
                })
                .filter(num => !isNaN(num) && num > 0)
                .sort((a, b) => b - a); // é™åºæ’åˆ—
            
            // å¦‚æœæ²’æœ‰è©²é¡åˆ¥çš„ç·¨è™Ÿï¼Œå¾ 1 é–‹å§‹
            if (typeNumbers.length === 0) {
                return 1;
            }
            
            // è¿”å›æœ€å¤§åºè™Ÿ + 1
            return typeNumbers[0] + 1;
        }
        
        // ç”Ÿæˆä¸‹ä¸€å€‹åºè™Ÿï¼ˆåº—å¤–ç‰©ä»¶ï¼š8ä½æ•¸æ ¼å¼ EXSU0001ï¼‰
        function getNextExternalSequenceNumber(existingNumbers, prefix) {
            // æ‰¾å‡ºæ‰€æœ‰å±¬æ–¼è©²é¡åˆ¥çš„åº—å¤–ç‰©ä»¶ç·¨è™Ÿï¼ˆæ ¼å¼ï¼šEXSU0001, EXTW0001ï¼‰
            const externalPrefix = `EX${prefix}`;
            const typeNumbers = existingNumbers
                .filter(num => {
                    // åªè™•ç†ç¬¦åˆæ¨™æº–æ ¼å¼çš„ç·¨è™Ÿï¼šEX{2å­—æ¯å‰ç¶´}{4ä½æ•¸å­—}
                    // æ’é™¤åŒ…å«é€£å­—è™Ÿçš„èˆŠæ ¼å¼
                    if (!num || typeof num !== 'string') return false;
                    if (!num.startsWith(externalPrefix)) return false;
                    if (num.includes('-')) return false; // æ’é™¤èˆŠæ ¼å¼
                    // æª¢æŸ¥æ˜¯å¦ç¬¦åˆæ¨™æº–æ ¼å¼ï¼šEX + 2å­—æ¯ + 4ä½æ•¸å­—
                    const standardFormat = new RegExp(`^EX${prefix}\\d{4}$`);
                    return standardFormat.test(num);
                })
                .map(num => {
                    // æå–åºè™Ÿéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼šEXSU0001 -> 1ï¼‰
                    const match = num.match(new RegExp(`^EX${prefix}(\\d+)$`));
                    return match ? parseInt(match[1], 10) : 0;
                })
                .filter(num => !isNaN(num) && num > 0)
                .sort((a, b) => b - a); // é™åºæ’åˆ—
            
            // å¦‚æœæ²’æœ‰è©²é¡åˆ¥çš„ç·¨è™Ÿï¼Œå¾ 1 é–‹å§‹
            if (typeNumbers.length === 0) {
                return 1;
            }
            
            // è¿”å›æœ€å¤§åºè™Ÿ + 1
            return typeNumbers[0] + 1;
        }
        
        // æ ¼å¼åŒ–åºè™Ÿï¼ˆåº—å…§ï¼š5ä½æ•¸ï¼Œåº—å¤–ï¼š4ä½æ•¸ï¼‰
        function formatSequenceNumber(seq, digits) {
            return String(seq).padStart(digits, '0');
        }
        
        // æ¨™æº–åŒ–ç‰©ä»¶ç·¨è™Ÿæ ¼å¼ï¼ˆå°‡èˆŠæ ¼å¼è½‰æ›ç‚ºæ–°æ ¼å¼ï¼‰
        function normalizePropertyNumber(number, type, isExternal) {
            if (!number || typeof number !== 'string') {
                return number;
            }
            
            const trimmedNumber = number.trim();
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æ­£ç¢ºçš„æ–°æ ¼å¼
            // åº—å…§ç‰©ä»¶ï¼š{2å­—æ¯}{5æ•¸å­—}ï¼Œä¾‹å¦‚ TT00012
            // åº—å¤–ç‰©ä»¶ï¼šEX{2å­—æ¯}{4æ•¸å­—}ï¼Œä¾‹å¦‚ EXTT0001
            if (isExternal) {
                const newFormatPattern = /^EX[A-Z]{2}\d{4}$/;
                if (newFormatPattern.test(trimmedNumber)) {
                    return trimmedNumber; // å·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼
                }
            } else {
                const newFormatPattern = /^[A-Z]{2}\d{5}$/;
                if (newFormatPattern.test(trimmedNumber)) {
                    return trimmedNumber; // å·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼
                }
            }
            
            // å˜—è©¦è½‰æ›èˆŠæ ¼å¼ï¼ˆä¾‹å¦‚ï¼šTT-012 â†’ TT00012ï¼‰
            // åŒ¹é…æ¨¡å¼ï¼š{å­—æ¯}-{æ•¸å­—} æˆ– {å­—æ¯}{æ•¸å­—}
            const oldFormatMatch = trimmedNumber.match(/^([A-Z]{2})[-]?(\d+)$/i);
            if (oldFormatMatch) {
                const prefix = oldFormatMatch[1].toUpperCase();
                const seq = parseInt(oldFormatMatch[2], 10);
                
                if (!isNaN(seq) && seq > 0) {
                    if (isExternal) {
                        // åº—å¤–ç‰©ä»¶ï¼šEX{2å­—æ¯}{4æ•¸å­—}
                        return `EX${prefix}${formatSequenceNumber(seq, 4)}`;
                    } else {
                        // åº—å…§ç‰©ä»¶ï¼š{2å­—æ¯}{5æ•¸å­—}
                        return `${prefix}${formatSequenceNumber(seq, 5)}`;
                    }
                }
            }
            
            // å¦‚æœç„¡æ³•è½‰æ›ï¼Œè¿”å›åŸå€¼ï¼ˆè®“å¾ŒçºŒé©—è­‰è™•ç†ï¼‰
            return trimmedNumber;
        }
        
        // ç”Ÿæˆç‰©ä»¶ç·¨è™Ÿï¼ˆæ”¯æ´åº—å…§/åº—å¤–ç‰©ä»¶ï¼‰
        async function generatePropertyNumber() {
            const typeSelect = document.getElementById('type');
            const numberInput = document.getElementById('number');
            const isExternalSelect = document.getElementById('is_external');
            
            if (!typeSelect || !numberInput) {
                showAlert('error', 'æ‰¾ä¸åˆ°æˆ¿å‹æˆ–ç·¨è™Ÿæ¬„ä½');
                return;
            }
            
            const type = typeSelect.value.trim();
            if (!type) {
                showAlert('warning', 'è«‹å…ˆé¸æ“‡æˆ¿å‹');
                return;
            }
            
            const isExternal = isExternalSelect ? isExternalSelect.value === 'true' : false;
            
            try {
                // ç²å–æ‰€æœ‰ç¾æœ‰ç·¨è™Ÿ
                const existingNumbers = await getAllPropertyNumbers();
                
                // å¦‚æœæ­£åœ¨ç·¨è¼¯ï¼Œæ’é™¤ç•¶å‰ç‰©ä»¶çš„ç·¨è™Ÿ
                if (editingPropertyId) {
                    try {
                        const { data: currentData, error } = await supabaseClient
                            .from('properties')
                            .select('number')
                            .eq('id', editingPropertyId)
                            .single();
                        
                        if (!error && currentData && currentData.number) {
                            const index = existingNumbers.indexOf(currentData.number);
                            if (index > -1) {
                                existingNumbers.splice(index, 1);
                            }
                        }
                    } catch (error) {
                        console.warn('âš ï¸ ç„¡æ³•ç²å–ç•¶å‰ç‰©ä»¶ç·¨è™Ÿ:', error);
                    }
                }
                
                // ç”Ÿæˆæ–°ç·¨è™Ÿ
                const prefix = getTypePrefix(type);
                let newNumber;
                
                if (isExternal) {
                    // åº—å¤–ç‰©ä»¶ï¼šEXSU0001ï¼ˆ8ä½æ•¸ï¼‰
                    const nextSeq = getNextExternalSequenceNumber(existingNumbers, prefix);
                    const formattedSeq = formatSequenceNumber(nextSeq, 4);
                    newNumber = `EX${prefix}${formattedSeq}`;
                } else {
                    // åº—å…§ç‰©ä»¶ï¼šSU00001ï¼ˆ7ä½æ•¸ï¼‰
                    const nextSeq = getNextInternalSequenceNumber(existingNumbers, prefix);
                    const formattedSeq = formatSequenceNumber(nextSeq, 5);
                    newNumber = `${prefix}${formattedSeq}`;
                }
                
                // æª¢æŸ¥æ˜¯å¦ä»ç„¶é‡è¤‡ï¼ˆä»¥é˜²è¬ä¸€ï¼‰
                if (existingNumbers.includes(newNumber)) {
                    // å¦‚æœé‡è¤‡ï¼Œå˜—è©¦ä¸‹ä¸€å€‹åºè™Ÿ
                    let seq = isExternal 
                        ? getNextExternalSequenceNumber(existingNumbers, prefix) + 1
                        : getNextInternalSequenceNumber(existingNumbers, prefix) + 1;
                    let candidate;
                    const maxSeq = isExternal ? 9999 : 99999;
                    
                    while (seq < maxSeq) {
                        if (isExternal) {
                            candidate = `EX${prefix}${formatSequenceNumber(seq, 4)}`;
                        } else {
                            candidate = `${prefix}${formatSequenceNumber(seq, 5)}`;
                        }
                        
                        if (!existingNumbers.includes(candidate)) {
                            newNumber = candidate;
                            break;
                        }
                        seq++;
                    }
                }
                
                numberInput.value = newNumber;
                showAlert('success', `å·²ç”Ÿæˆç‰©ä»¶ç·¨è™Ÿ: ${newNumber}`);
            } catch (error) {
                console.error('âŒ ç”Ÿæˆç·¨è™Ÿå¤±æ•—:', error);
                showAlert('error', 'ç”Ÿæˆç·¨è™Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        
        // ç•¶ç‰©ä»¶ä¾†æºæ”¹è®Šæ™‚çš„è™•ç†
        function onExternalSourceChange() {
            const isExternalSelect = document.getElementById('is_external');
            const typeSelect = document.getElementById('type');
            const numberInput = document.getElementById('number');
            
            if (!isExternalSelect || !typeSelect || !numberInput) {
                return;
            }
            
            const isExternal = isExternalSelect.value === 'true';
            const type = typeSelect.value.trim();
            
            // å¦‚æœå·²é¸æ“‡æˆ¿å‹ä¸”ä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œé‡æ–°ç”Ÿæˆç·¨è™Ÿ
            if (type && !editingPropertyId) {
                numberInput.value = '';
                generatePropertyNumber();
            } else if (type && editingPropertyId) {
                // ç·¨è¼¯æ¨¡å¼ï¼šæª¢æŸ¥ç¾æœ‰ç·¨è™Ÿæ˜¯å¦ç¬¦åˆç•¶å‰ä¾†æºé¡å‹
                const currentNumber = numberInput.value.trim();
                if (currentNumber) {
                    const isCurrentExternal = currentNumber.startsWith('EX');
                    if (isCurrentExternal !== isExternal) {
                        // ä¾†æºé¡å‹æ”¹è®Šï¼Œé‡æ–°ç”Ÿæˆç·¨è™Ÿ
                        numberInput.value = '';
                        generatePropertyNumber();
                    }
                }
            }
        }
        
        // ç•¶æˆ¿å‹æ”¹è®Šæ™‚çš„è™•ç†
        // ç‹€æ…‹æ”¹è®Šæ™‚çš„è™•ç†
        function onStatusChange() {
            const statusSelect = document.getElementById('status');
            const statusTextSelect = document.getElementById('statusText');
            
            if (!statusSelect || !statusTextSelect) return;
            
            const statusValue = statusSelect.value;
            
            // ç‹€æ…‹å€¼å’Œå°æ‡‰çš„é è¨­æ–‡å­—
            const statusTextMap = {
                'new': 'æ–°ä¸Šæ¶',
                'urgent': 'æ€¥å”®',
                'selling': 'ç†±éŠ·ä¸­',
                'below-appraisal': 'ä½æ–¼é‘‘åƒ¹',
                'sold': 'å·²å”®å‡º'
            };
            
            // å¦‚æœç‹€æ…‹æ–‡å­—ä¸‹æ‹‰é¸å–®æ˜¯ç©ºçš„ï¼Œæˆ–é¸æ“‡äº†é è¨­é¸é …ï¼Œå‰‡è‡ªå‹•å¡«å……
            const currentText = statusTextSelect.value;
            const suggestedText = statusTextMap[statusValue];
            
            if (suggestedText) {
                // å¦‚æœç‹€æ…‹æ–‡å­—ä¸‹æ‹‰é¸å–®ç‚ºç©ºï¼Œæˆ–é¸æ“‡äº†é è¨­é¸é …ï¼Œå‰‡è‡ªå‹•é¸æ“‡å°æ‡‰é¸é …
                if (!currentText || currentText === '') {
                    statusTextSelect.value = suggestedText;
                    // éš±è—è‡ªè¨‚è¼¸å…¥æ¡†
                    const statusTextInput = document.getElementById('statusTextInput');
                    if (statusTextInput) {
                        statusTextInput.style.display = 'none';
                    }
                }
            } else {
                // å¦‚æœé¸æ“‡ã€Œä¸€èˆ¬ç‰©ä»¶ã€ï¼Œé‡ç½®ç‚ºé è¨­é¸é …
                if (!statusValue) {
                    statusTextSelect.value = '';
                    const statusTextInput = document.getElementById('statusTextInput');
                    if (statusTextInput) {
                        statusTextInput.style.display = 'none';
                        statusTextInput.value = '';
                    }
                }
            }
        }
        
        // ç‹€æ…‹æ–‡å­—ä¸‹æ‹‰é¸å–®æ”¹è®Šæ™‚çš„è™•ç†
        function onStatusTextChange() {
            const statusTextSelect = document.getElementById('statusText');
            const statusTextInput = document.getElementById('statusTextInput');
            
            if (!statusTextSelect || !statusTextInput) return;
            
            const selectedValue = statusTextSelect.value;
            
            if (selectedValue === 'custom') {
                // å¦‚æœé¸æ“‡ã€Œè‡ªè¨‚ã€ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
                statusTextInput.style.display = 'block';
                statusTextInput.focus();
            } else {
                // å…¶ä»–é¸é …ï¼Œéš±è—è¼¸å…¥æ¡†
                statusTextInput.style.display = 'none';
                statusTextInput.value = '';
            }
        }
        
        // å¾æ¨™ç±¤æŒ‰éˆ•è¨­ç½®ç‹€æ…‹æ–‡å­—
        function setStatusTextFromTag(text) {
            const statusTextSelect = document.getElementById('statusText');
            const statusTextInput = document.getElementById('statusTextInput');
            
            if (statusTextSelect) {
                // æª¢æŸ¥ä¸‹æ‹‰é¸å–®ä¸­æ˜¯å¦æœ‰å°æ‡‰çš„é¸é …
                const optionExists = Array.from(statusTextSelect.options).some(option => option.value === text);
                
                if (optionExists) {
                    // å¦‚æœæœ‰å°æ‡‰é¸é …ï¼Œé¸æ“‡å®ƒ
                    statusTextSelect.value = text;
                    if (statusTextInput) {
                        statusTextInput.style.display = 'none';
                        statusTextInput.value = '';
                    }
                } else {
                    // å¦‚æœæ²’æœ‰å°æ‡‰é¸é …ï¼Œä½¿ç”¨è‡ªè¨‚è¼¸å…¥
                    statusTextSelect.value = 'custom';
                    if (statusTextInput) {
                        statusTextInput.style.display = 'block';
                        statusTextInput.value = text;
                        statusTextInput.focus();
                    }
                }
            }
        }
        
        function onTypeChange() {
            const typeSelect = document.getElementById('type');
            const numberInput = document.getElementById('number');
            const isExternalSelect = document.getElementById('is_external');
            
            if (!typeSelect || !numberInput) {
                return;
            }
            
            const type = typeSelect.value.trim();
            const isExternal = isExternalSelect ? isExternalSelect.value === 'true' : false;
            
            // å¦‚æœä¸åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œä¸”å·²é¸æ“‡æˆ¿å‹ï¼Œè‡ªå‹•ç”Ÿæˆç·¨è™Ÿ
            if (type && !editingPropertyId) {
                // æ¸…é™¤ç¾æœ‰ç·¨è™Ÿï¼Œå¼·åˆ¶é‡æ–°ç”Ÿæˆ
                numberInput.value = '';
                generatePropertyNumber();
            } else if (type && editingPropertyId) {
                // ç·¨è¼¯æ¨¡å¼ï¼šæª¢æŸ¥ç¾æœ‰ç·¨è™Ÿæ˜¯å¦ç¬¦åˆç•¶å‰æˆ¿å‹å’Œä¾†æºé¡å‹
                const currentNumber = numberInput.value.trim();
                if (currentNumber) {
                    const prefix = getTypePrefix(type);
                    const isCurrentExternal = currentNumber.startsWith('EX');
                    const currentPrefix = isCurrentExternal 
                        ? currentNumber.substring(2, 4)  // EXSU0001 -> SU
                        : currentNumber.substring(0, 2);  // SU00001 -> SU
                    
                    // å¦‚æœæˆ¿å‹æ”¹è®Šæˆ–ä¾†æºé¡å‹æ”¹è®Šï¼Œé‡æ–°ç”Ÿæˆç·¨è™Ÿ
                    if (currentPrefix !== prefix || isCurrentExternal !== isExternal) {
                        numberInput.value = '';
                        generatePropertyNumber();
                    }
                }
            }
        }
        
        // Google è¡—æ™¯ç›¸é—œå‡½æ•¸
        // æ‰“é–‹ Google è¡—æ™¯ï¼ˆæ–¹æ³•ä¸€ï¼šæœ€ç°¡å–®çš„æ–¹å¼ï¼‰
        function openGoogleStreetView() {
            const addressInput = document.getElementById('address');
            if (!addressInput) {
                showAlert('error', 'æ‰¾ä¸åˆ°åœ°å€è¼¸å…¥æ¡†');
                return;
            }
            
            const address = addressInput.value.trim();
            if (!address) {
                showAlert('warning', 'è«‹å…ˆè¼¸å…¥åœ°å€');
                addressInput.focus();
                return;
            }
            
            // ç·¨ç¢¼åœ°å€
            const encodedAddress = encodeURIComponent(address);
            // æ‰“é–‹ Google è¡—æ™¯é é¢ï¼ˆä½¿ç”¨è¡—æ™¯æ¨¡å¼ï¼‰
            // å…ˆæœå°‹åœ°å€ï¼Œç„¶å¾Œåœ¨ Google Maps ä¸­å¯ä»¥ç›´æ¥åˆ‡æ›åˆ°è¡—æ™¯æ¨¡å¼
            const streetViewUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            window.open(streetViewUrl, '_blank');
            
            // é¡¯ç¤ºè©³ç´°çš„æ“ä½œèªªæ˜
            const alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-info show';
                alert.innerHTML = `
                    <strong>âœ… å·²åœ¨æ–°è¦–çª—æ‰“é–‹ Google Maps</strong><br>
                    è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š<br>
                    1. åœ¨é–‹å•Ÿçš„åœ°åœ–é é¢ä¸­ï¼Œæ‹–å‹•å³ä¸‹è§’çš„ã€Œå°é»ƒäººã€åˆ°åœ°åœ–ä¸Šçš„ä½ç½®<br>
                    2. é€²å…¥è¡—æ™¯å¾Œï¼Œé»æ“Šå·¦ä¸Šè§’çš„ã€Œé¸å–®ã€â†’ã€Œåˆ†äº«æˆ–åµŒå…¥åœ°åœ–ã€â†’ã€ŒåµŒå…¥åœ°åœ–ã€<br>
                    3. è¤‡è£½åµŒå…¥ç¶²å€ä¸¦è²¼åˆ°ã€ŒGoogle è¡—æ™¯ç¶²å€ã€æ¬„ä½
                `;
                alertContainer.innerHTML = '';
                alertContainer.appendChild(alert);
                
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 5000);
                }, 8000);
            }
        }
        
        // æ ¼å¼åŒ–å±‹é½¡è¼¸å…¥ï¼ˆè‡ªå‹•åŠ ä¸Šã€Œå¹´ã€å­—ï¼Œä½†é¿å…é‡è¤‡ï¼‰
        function formatAgeInput(input) {
            if (!input) return;
            let value = input.value.trim();
            if (!value) return;
            
            // å¦‚æœå·²ç¶“æœ‰ã€Œå¹´ã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œå¹´ã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
            if (value.includes('å¹´')) {
                value = value.replace(/å¹´+/g, '');
                const numberMatch = value.match(/^\d+/);
                if (numberMatch) {
                    input.value = numberMatch[0] + 'å¹´';
                }
            }
            // å¦‚æœè¼¸å…¥çš„æ˜¯ç´”æ•¸å­—ï¼Œè‡ªå‹•åŠ ä¸Šã€Œå¹´ã€
            else if (/^\d+$/.test(value)) {
                input.value = value + 'å¹´';
            }
            // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œå¹´ã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œå¹´ã€
            else if (/^\d+/.test(value)) {
                const numberMatch = value.match(/^\d+/);
                if (numberMatch) {
                    input.value = numberMatch[0] + 'å¹´';
                }
            }
        }
        
        // æ ¼å¼åŒ–æ ¼å±€è¼¸å…¥ï¼ˆä¾‹å¦‚ï¼š3/2/2 â†’ 3æˆ¿2å»³2è¡›ï¼Œ0/4/3 â†’ 0æˆ¿4å»³3è¡›ï¼‰
        function formatLayoutInput(input) {
            if (!input) return;
            let value = input.value.trim();
            if (!value) return;
            
            // å¦‚æœå·²ç¶“åŒ…å«ã€Œæˆ¿ã€ã€ã€Œå»³ã€ã€ã€Œè¡›ã€ï¼Œä¸éœ€è¦è½‰æ›
            if (value.includes('æˆ¿') || value.includes('å»³') || value.includes('è¡›')) {
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç¬¦åˆ æ•¸å­—/æ•¸å­—/æ•¸å­— æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š3/2/2 æˆ– 0/4/3ï¼‰
            const layoutPattern = /^(\d+)\/(\d+)\/(\d+)$/;
            const match = value.match(layoutPattern);
            
            if (match) {
                const room = parseInt(match[1], 10);
                const living = parseInt(match[2], 10);
                const bath = parseInt(match[3], 10);
                
                // è™•ç†ç‰¹æ®Šæ ¼å±€
                if (room === 0 && living > 0) {
                    // 0æˆ¿ä½†æœ‰å»³ï¼Œå¯èƒ½æ˜¯é–‹æ”¾å¼æ ¼å±€
                    input.value = `0æˆ¿${living}å»³${bath}è¡›ï¼ˆé–‹æ”¾å¼ï¼‰`;
                } else if (room === 0 && living === 0 && bath > 0) {
                    // åªæœ‰è¡›æµ´ï¼Œå¯èƒ½æ˜¯ç‰¹æ®Šæ ¼å±€
                    input.value = `0æˆ¿0å»³${bath}è¡›ï¼ˆé–‹æ”¾å¼ï¼‰`;
                } else if (room === 1 && living === 0 && bath === 1) {
                    // 1æˆ¿1è¡›ï¼Œå¯èƒ½æ˜¯å¥—æˆ¿
                    input.value = `1æˆ¿0å»³1è¡›ï¼ˆå¥—æˆ¿ï¼‰`;
                } else {
                    // ä¸€èˆ¬æ ¼å±€
                    input.value = `${room}æˆ¿${living}å»³${bath}è¡›`;
                }
            }
        }
        
        // æ ¼å¼åŒ–åªæ•¸è¼¸å…¥ï¼ˆè‡ªå‹•åŠ ä¸Šã€Œåªã€å­—ï¼‰
        function formatAreaInput(input) {
            if (!input) return;
            let value = input.value.trim();
            if (!value) return;
            
            // å¦‚æœå·²ç¶“æœ‰ã€Œåªã€å­—ï¼Œå…ˆç§»é™¤æ‰€æœ‰ã€Œåªã€å­—ï¼Œç„¶å¾ŒåªåŠ ä¸€å€‹
            if (value.includes('åª')) {
                value = value.replace(/åª+/g, '');
                // æå–æ•¸å­—ï¼ˆå¯èƒ½åŒ…å«å°æ•¸é»ï¼‰
                const numberMatch = value.match(/^[\d.]+/);
                if (numberMatch) {
                    input.value = numberMatch[0] + 'åª';
                }
            }
            // å¦‚æœè¼¸å…¥çš„æ˜¯ç´”æ•¸å­—ï¼ˆå¯èƒ½åŒ…å«å°æ•¸é»ï¼‰ï¼Œè‡ªå‹•åŠ ä¸Šã€Œåªã€
            else if (/^[\d.]+$/.test(value)) {
                input.value = value + 'åª';
            }
            // å¦‚æœæœ‰æ•¸å­—ä½†æ²’æœ‰ã€Œåªã€å­—ï¼Œæå–æ•¸å­—ä¸¦åŠ ä¸Šã€Œåªã€
            else if (/^[\d.]+/.test(value)) {
                const numberMatch = value.match(/^[\d.]+/);
                if (numberMatch) {
                    input.value = numberMatch[0] + 'åª';
                }
            }
        }
        
        // ç•¶ç‰©ä»¶é¡å‹æ”¹è®Šæ™‚ï¼Œé¡¯ç¤º/éš±è—å¢å»ºæ¨“å±¤æ¬„ä½
        function onTypeChange() {
            const typeSelect = document.getElementById('type');
            const extensionGroup = document.getElementById('extension-floor-group');
            
            if (!typeSelect || !extensionGroup) return;
            
            const selectedType = typeSelect.value.trim();
            // åªæœ‰é€å¤©é¡å‹æ‰é¡¯ç¤ºå¢å»ºæ¨“å±¤æ¬„ä½
            if (selectedType === 'é€å¤©') {
                extensionGroup.style.display = 'block';
            } else {
                extensionGroup.style.display = 'none';
                // æ¸…ç©ºå¢å»ºæ¨“å±¤æ¬„ä½
                const extensionInput = document.getElementById('extension_floor');
                if (extensionInput) {
                    extensionInput.value = '';
                }
            }
        }
        
        // ç•¶æ¨“å±¤æ”¹è®Šæ™‚ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºå¢å»ºæ¬„ä½æç¤º
        function onFloorChange() {
            const typeSelect = document.getElementById('type');
            const extensionGroup = document.getElementById('extension-floor-group');
            
            if (!typeSelect || !extensionGroup) return;
            
            const selectedType = typeSelect.value.trim();
            // å¦‚æœæ˜¯é€å¤©ï¼Œç¢ºä¿å¢å»ºæ¬„ä½é¡¯ç¤º
            if (selectedType === 'é€å¤©') {
                extensionGroup.style.display = 'block';
            }
        }
        
        // æª¢æŸ¥ä¸¦é¡¯ç¤ºå¢å»ºæ¨“å±¤æ¬„ä½ï¼ˆç”¨æ–¼ç·¨è¼¯æ¨¡å¼è¼‰å…¥æ™‚ï¼‰
        function checkAndShowExtensionFloor() {
            const typeSelect = document.getElementById('type');
            const extensionGroup = document.getElementById('extension-floor-group');
            
            if (!typeSelect || !extensionGroup) return;
            
            const selectedType = typeSelect.value.trim();
            if (selectedType === 'é€å¤©') {
                extensionGroup.style.display = 'block';
            }
        }
        
        function resetForm() {
            document.getElementById('property-form').reset();
            uploadedImages = [];
            const imagePreviewGrid = document.getElementById('image-preview-grid');
            if (imagePreviewGrid) {
                imagePreviewGrid.innerHTML = '';
            }
            editingPropertyId = null;
            
            // æ¸…é™¤ç‰©ä»¶ç·¨è™Ÿ
            const numberInput = document.getElementById('number');
            if (numberInput) {
                numberInput.value = '';
            }
            
            // æ¸…é™¤æ‰€æœ‰æ¨™ç±¤
            clearAllTags('facilities');
            clearAllTags('transport');
            clearAllTags('schools');
            
            // æ¸…é™¤éš±è—é–€ç‰Œè™Ÿç¢¼çš„å‹¾é¸
            const hideAddressCheckbox = document.getElementById('hide_address_number');
            if (hideAddressCheckbox) {
                hideAddressCheckbox.checked = false;
            }
            
        }
        
        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(type, message) {
            // æ–¹æ³•1ï¼šåœ¨ alert-container ä¸­é¡¯ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
            const alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} show`;
                alert.textContent = message;
                alertContainer.innerHTML = '';
                alertContainer.appendChild(alert);
                
                // ä¸è‡ªå‹•æ»¾å‹•åˆ° alert ä½ç½®ï¼Œä¿æŒé é¢åœ¨ç•¶å‰ä½ç½®
                // ç§»é™¤ scrollIntoView èª¿ç”¨ï¼Œé¿å…ä¸Šå‚³åœ–ç‰‡æ™‚é é¢è·³è½‰
                
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }, 5000); // å¢åŠ åˆ° 5 ç§’
            }
            
            // æ–¹æ³•2ï¼šåŒæ™‚é¡¯ç¤ºå›ºå®šä½ç½®çš„ toast é€šçŸ¥ï¼ˆæ›´æ˜é¡¯ï¼‰
            const toast = document.createElement('div');
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.className = `toast-alert alert-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            // ç§»é™¤ç¾æœ‰çš„ toastï¼ˆé¿å…é‡ç–Šï¼‰
            const existingToast = document.querySelector('.toast-alert');
            if (existingToast) {
                existingToast.remove();
            }
            
            document.body.appendChild(toast);
            
            // è‡ªå‹•ç§»é™¤ï¼ˆ5 ç§’å¾Œï¼‰
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
            
            // æ§åˆ¶å°æ—¥èªŒï¼ˆæ–¹ä¾¿é™¤éŒ¯ï¼‰
            console.log(`[Alert ${type.toUpperCase()}]`, message);
        }
        
        // é é¢è¼‰å…¥æ™‚
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆå¾ localStorage è‡ªå‹•è¼‰å…¥è¨­å®šä¸¦åˆå§‹åŒ– Supabaseï¼ˆä¸éœ€è¦æ‰“é–‹è¨­å®šé é¢ï¼‰
            const savedAnonKey = localStorage.getItem('supabase-anon-key');
            if (savedAnonKey) {
                console.log('ğŸ“¥ è‡ªå‹•è¼‰å…¥å·²ä¿å­˜çš„ Supabase è¨­å®š');
                // ç›´æ¥åˆå§‹åŒ– Supabaseï¼ˆä¸éœ€è¦å¡«å¯«è¡¨å–®ï¼‰
                initSupabase();
                
                // å¦‚æœæœ‰è¨­å®šæ¨™ç±¤ï¼Œä¹Ÿè¦å¡«å…¥å€¼ï¼ˆå³ä½¿éš±è—äº†ï¼‰
                loadSupabaseConfig();
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦éš±è—è¨­å®šæ¨™ç±¤
                setTimeout(() => {
                    checkConfigTabVisibility();
                }, 100);
                
                // æª¢æŸ¥ URL åƒæ•¸ï¼Œå¦‚æœæœ‰ id å‰‡è¼‰å…¥è©²ç‰©ä»¶
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('id');
                if (propertyId) {
                    // çŸ­å»¶é²ç­‰ DOM èˆ‡ Supabase å°±ç·’å¾Œå†è¼‰å…¥
                    setTimeout(() => {
                        if (supabaseClient) {
                            editProperty(propertyId);
                        }
                    }, 150);
                }
            } else {
                // å¦‚æœæ²’æœ‰ä¿å­˜çš„è¨­å®šï¼Œè¼‰å…¥è¡¨å–®é è¨­å€¼
                loadSupabaseConfig();
                
                // å³ä½¿ Supabase æœªåˆå§‹åŒ–ï¼Œä¹Ÿå…ˆä¿å­˜ IDï¼Œç­‰åˆå§‹åŒ–å®Œæˆå¾Œå†è¼‰å…¥
                const urlParams = new URLSearchParams(window.location.search);
                const propertyId = urlParams.get('id');
                if (propertyId) {
                    const checkInterval = setInterval(() => {
                        if (supabaseClient) {
                            clearInterval(checkInterval);
                            editProperty(propertyId);
                        }
                    }, 200);
                    setTimeout(() => clearInterval(checkInterval), 10000);
                }
            }
            
            // åˆå§‹åŒ–ç¸£å¸‚å€åŸŸé¸æ“‡ï¼ˆé è¨­ç‚ºæ¡ƒåœ’å¸‚ï¼‰
            const citySelect = document.getElementById('city');
            if (citySelect) {
                citySelect.value = 'æ¡ƒåœ’å¸‚';
                updateDistricts();
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š Supabase
            setTimeout(() => {
                if (!supabaseClient && !savedAnonKey) {
                    // æª¢æŸ¥ç•¶å‰æ˜¯å¦åœ¨æ–°å¢ç‰©ä»¶é é¢
                    const addTab = document.getElementById('add-tab');
                    if (addTab && addTab.classList.contains('active')) {
                        // åªé¡¯ç¤ºæç¤ºï¼Œä¸å¼·åˆ¶è·³è½‰ï¼ˆè®“ç”¨æˆ¶å¯ä»¥é¸æ“‡ï¼‰
                        console.warn('âš ï¸ Supabase æœªè¨­å®šï¼Œè«‹å‰å¾€ã€Œâš™ï¸ API è¨­å®šã€æ¨™ç±¤é€²è¡Œè¨­å®š');
                    }
                    // å¦‚æœ Supabase æœªè¨­å®šï¼Œé¡¯ç¤ºè¨­å®šæ¨™ç±¤
                    showConfigTab();
                } else if (supabaseClient) {
                    // å¦‚æœ Supabase å·²æˆåŠŸåˆå§‹åŒ–ï¼Œéš±è—è¨­å®šæ¨™ç±¤
                    checkConfigTabVisibility();
                }
                    testSupabaseConnection();
            }, 500);
            
            // æ”¯æ´ Enter éµæ–°å¢æ¨™ç±¤
            ['facilities', 'transport', 'schools'].forEach(type => {
                const input = document.getElementById(`${type}-input`);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addCustomTag(type);
                        }
                    });
                }
            });
            
        });
        
        // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°èª¿ç”¨
        window.showConfigTab = showConfigTab;
        window.hideConfigTab = hideConfigTab;
        
        // æ¸¬è©¦ Supabase é€£æ¥ï¼ˆå¸¶ UI é¡¯ç¤ºï¼‰
        async function testSupabaseConnection() {
            const statusDiv = document.getElementById('supabase-status');
            const statusContent = document.getElementById('supabase-status-content');
            
            if (!statusDiv || !statusContent) {
                // å¦‚æœæ²’æœ‰ç‹€æ…‹é¡¯ç¤ºå€åŸŸï¼Œç›´æ¥æ¸¬è©¦
                await testSupabaseConnectionInternal();
                return;
            }
            
            statusDiv.style.display = 'block';
            statusContent.innerHTML = '<p>ğŸ”„ æ­£åœ¨æ¸¬è©¦é€£æ¥...</p>';
            
            const results = await testSupabaseConnectionInternal();
            
            // é¡¯ç¤ºçµæœ
            let html = '<div style="display: grid; gap: 0.5rem;">';
            
            if (results.sdkLoaded) {
                html += '<p style="color: green;">âœ… Supabase SDK å·²è¼‰å…¥</p>';
            } else {
                html += '<p style="color: red;">âŒ Supabase SDK æœªè¼‰å…¥</p>';
            }
            
            if (results.supabaseInitialized) {
                html += '<p style="color: green;">âœ… Supabase å·²åˆå§‹åŒ–</p>';
            } else {
                html += '<p style="color: red;">âŒ Supabase åˆå§‹åŒ–å¤±æ•—</p>';
                if (results.initError) {
                    html += `<p style="color: orange; font-size: 0.9rem;">âš ï¸ ${results.initError}</p>`;
                }
            }
            
            if (results.databaseTest) {
                html += `<p style="color: green;">âœ… è³‡æ–™åº«é€£æ¥æˆåŠŸ</p>`;
            } else if (results.databaseError) {
                html += `<p style="color: red;">âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—</p>`;
                html += `<p style="color: orange; font-size: 0.9rem; margin: 0.5rem 0;">âš ï¸ ${results.databaseError}</p>`;
            }
            
            if (results.storageTest) {
                html += '<p style="color: green;">âœ… Storage é€£æ¥æˆåŠŸ</p>';
            } else if (results.storageError) {
                html += '<p style="color: orange;">âš ï¸ Storage é€£æ¥å¤±æ•—</p>';
                html += `<p style="color: orange; font-size: 0.9rem; margin: 0.5rem 0;">âš ï¸ ${results.storageError}</p>`;
            }
            
            html += '</div>';
            statusContent.innerHTML = html;
        }
        
        // å…§éƒ¨æ¸¬è©¦å‡½æ•¸
        async function testSupabaseConnectionInternal() {
            const results = {
                sdkLoaded: false,
                supabaseInitialized: false,
                initError: null,
                databaseTest: false,
                databaseError: null,
                storageTest: false,
                storageError: null
            };
            
            // æª¢æŸ¥ SDK æ˜¯å¦è¼‰å…¥
            if (typeof supabase === 'undefined') {
                console.error('âŒ Supabase SDK æœªè¼‰å…¥');
                results.initError = 'Supabase SDK æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥';
                return results;
            }
            results.sdkLoaded = true;
            console.log('âœ… Supabase SDK å·²è¼‰å…¥');
            
            // æª¢æŸ¥æ˜¯å¦åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('âš ï¸ Supabase æœªåˆå§‹åŒ–');
                console.log('ğŸ’¡ æç¤ºï¼šè«‹å‰å¾€ã€Œâš™ï¸ API è¨­å®šã€æ¨™ç±¤å¡«å¯« Supabase è¨­å®š');
                results.initError = 'Supabase æœªåˆå§‹åŒ–ï¼Œè«‹å…ˆå„²å­˜è¨­å®š';
                return results;
            }
            results.supabaseInitialized = true;
            
            // æ¸¬è©¦è³‡æ–™åº«é€£æ¥
            try {
                const { data, error } = await supabaseClient
                    .from('properties')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                console.log('âœ… Supabase è³‡æ–™åº«é€£æ¥æ­£å¸¸');
                results.databaseTest = true;
            } catch (error) {
                console.error('âŒ Supabase è³‡æ–™åº«é€£æ¥å¤±æ•—:', error);
                results.databaseError = error.message || 'é€£æ¥å¤±æ•—';
            }
            
            // æ¸¬è©¦ Storage é€£æ¥
            try {
                const { data, error } = await supabaseClient
                    .storage
                    .from('junyang666')
                    .list('', { limit: 1 });
                
                if (error) throw error;
                
                console.log('âœ… Supabase Storage é€£æ¥æ­£å¸¸');
                results.storageTest = true;
            } catch (error) {
                console.error('âŒ Supabase Storage é€£æ¥å¤±æ•—:', error);
                results.storageError = error.message || 'é€£æ¥å¤±æ•—';
            }
            
            return results;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Permissions Policy: å…è¨± Google Maps ä½¿ç”¨æ„Ÿæ¸¬å™¨åŠŸèƒ½ -->
    <meta http-equiv="Permissions-Policy" content="accelerometer=*, gyroscope=*, geolocation=*">
    <title>ç‰©ä»¶è©³ç´°è³‡è¨Š | ä½å•†ä¸å‹•ç”¢</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 4rem 2rem;
            color: #dc3545;
        }
        
        .property-page {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .property-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
        }
        
        .property-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .property-address {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }
        
        .property-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .property-content {
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .info-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        /* å”®åƒ¹ç‰¹æ®Šæ¨£å¼ */
        .info-item.price-item .info-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e74c3c;
        }
        
        /* å…¶ä»–è³‡æ–™å€å¡Šæ¨£å¼ */
        .other-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .other-info-item {
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .other-info-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.2rem;
        }
        
        .other-info-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
        }
        
        .image-main-container {
            position: relative;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .image-main {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
            position: relative;
        }
        
        .image-main img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .image-nav-btn:hover {
            background: rgba(0,0,0,0.8);
        }
        
        .image-nav-btn.prev {
            left: 10px;
        }
        
        .image-nav-btn.next {
            right: 10px;
        }
        
        .image-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .image-close-btn:hover {
            background: rgba(0,0,0,0.8);
        }
        
        .image-thumbnails {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }
        
        .image-thumbnails::-webkit-scrollbar {
            height: 6px;
        }
        
        .image-thumbnails::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .image-thumbnails::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
        
        .image-thumbnail {
            flex-shrink: 0;
            width: 80px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            background: #f0f0f0;
        }
        
        .image-thumbnail.active {
            border-color: #667eea;
        }
        
        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-thumbnail:hover {
            transform: scale(1.05);
            border-color: #764ba2;
        }
        
        @media (max-width: 768px) {
            .image-thumbnail {
                width: 60px;
                height: 45px;
            }
            
            .image-nav-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .image-close-btn {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }
        }
        
        .description {
            line-height: 1.8;
            color: #555;
            white-space: pre-line;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .property-header {
                padding: 1.5rem;
            }
            
            .property-title {
                font-size: 1.4rem;
            }
            
            .property-content {
                padding: 1.5rem;
            }
            
            /* åŸºæœ¬è³‡è¨Šæ‰‹æ©Ÿç‰ˆ - ä¸‰æ¬„ä½ˆå±€ */
            .info-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.5rem !important;
            }
            
            .info-item {
                padding: 0.6rem 0.4rem !important;
            }
            
            .info-label {
                font-size: 0.7rem !important;
                margin-bottom: 0.15rem !important;
            }
            
            .info-value {
                font-size: 0.9rem !important;
            }
            
            /* æ‰‹æ©Ÿç‰ˆå”®åƒ¹ç‰¹æ®Šæ¨£å¼ */
            .info-item.price-item .info-value {
                font-size: 1.1rem !important;
                font-weight: 700 !important;
            }
            
            /* å…¶ä»–è³‡æ–™å€å¡Šæ‰‹æ©Ÿç‰ˆ */
            .other-info-grid {
                grid-template-columns: 1fr !important;
                gap: 0.6rem !important;
            }
            
            .other-info-item {
                padding: 0.6rem 0.5rem !important;
            }
            
            .other-info-label {
                font-size: 0.75rem !important;
                margin-bottom: 0.15rem !important;
            }
            
            .other-info-value {
                font-size: 0.85rem !important;
            }
            
            /* è¯çµ¡æ–¹å¼å€å¡Šæ‰‹æ©Ÿç‰ˆ */
            .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            /* ç›¸é—œé€£çµæŒ‰éˆ•æ‰‹æ©Ÿç‰ˆ */
            .section a[style*="min-width: 180px"] {
                min-width: calc(50% - 0.4rem) !important;
                font-size: 0.85rem !important;
                padding: 0.5rem 0.8rem !important;
            }
            
            /* å€å¡Šæ¨™é¡Œæ‰‹æ©Ÿç‰ˆ */
            .section-title {
                font-size: 1.1rem !important;
                margin-bottom: 0.8rem !important;
            }
            
            /* å€å¡Šé–“è·æ‰‹æ©Ÿç‰ˆ */
            .section {
                margin-bottom: 1.5rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i> è¿”å›é¦–é 
            </a>
            <h1 style="font-size: 1.2rem; margin: 0;">ç‰©ä»¶è©³ç´°è³‡è¨Š</h1>
        </div>
    </div>
    
    <div class="container">
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p id="error-message">æ‰¾ä¸åˆ°ç‰©ä»¶</p>
        </div>
        
        <div id="property-page" class="property-page" style="display: none;">
            <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <!-- ç›¸é—œé€£çµè¼‰å…¥å™¨ -->
    <!-- ç›¸é—œé€£çµå‰ç«¯é¡¯ç¤ºæ¨¡çµ„ï¼ˆå¾å¾Œç«¯ API è¼‰å…¥ï¼‰ -->
    <!-- Supabase é…ç½®ï¼ˆåŒ…å«é è¨­é€£çµè³‡æ–™ï¼‰ -->
    <script src="supabase-config.js"></script>
    
    <!-- ç›¸é—œé€£çµå‰ç«¯é¡¯ç¤ºæ¨¡çµ„ï¼ˆå¾å¾Œç«¯ API è¼‰å…¥ï¼‰ -->
    <script src="modules/related-links/frontend.js"></script>
    
    <script>
        // Supabase è¨­å®šï¼ˆç¨ç«‹é é¢ä¸éœ€è¦è¼‰å…¥æ‰€æœ‰ç‰©ä»¶è³‡æ–™ï¼Œç›´æ¥ä½¿ç”¨è¨­å®šå€¼ï¼‰
        const SUPABASE_URL_VALUE = 'https://cnzqtuuegdqwkgvletaa.supabase.co';
        const SUPABASE_ANON_KEY_VALUE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuenF0dXVlZ2Rxd2tndmxldGFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjUxMTksImV4cCI6MjA4MzcwMTExOX0.gsO3RKdMu2bUXW4b5aHseouIkjXtJyIqqP_0x3Y6trE';
        
        // è™•ç†åœ°å€é¡¯ç¤ºçš„è¼”åŠ©å‡½æ•¸ï¼ˆèˆ‡å‰ç«¯ä¸€è‡´ï¼‰
        function formatAddressForDisplay(address, hideAddressNumber, propertyType) {
            if (!address) return '';
            
            const typesToShowOnlyRoad = ['é€å¤©', 'åˆ¥å¢…', 'åº—é¢'];
            const shouldShowOnlyRoad = propertyType && typesToShowOnlyRoad.includes(propertyType);
            
            if (!hideAddressNumber && !shouldShowOnlyRoad) {
                return address;
            }
            
            let displayAddress = address;
            const cityDistrictMatch = displayAddress.match(/^([^è·¯è¡—é“]+[å¸‚ç¸£å€é„‰é®])/i);
            const cityDistrict = cityDistrictMatch ? cityDistrictMatch[1] : '';
            
            displayAddress = displayAddress.replace(/^[^è·¯è¡—é“]+[å¸‚ç¸£å€é„‰é®]/i, '');
            const roadPattern = /([^è·¯è¡—é“]+(?:[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ®µ)?[è·¯è¡—é“å¤§é“])/;
            const roadMatch = displayAddress.match(roadPattern);
            
            if (roadMatch) {
                displayAddress = (cityDistrict + roadMatch[1]).trim();
            } else {
                const simpleRoadMatch = displayAddress.match(/([^è·¯è¡—é“]*[è·¯è¡—é“])/);
                if (simpleRoadMatch) {
                    displayAddress = (cityDistrict + simpleRoadMatch[1]).trim();
                } else {
                    displayAddress = displayAddress.replace(/[\d]+[å··å¼„è™Ÿ].*$/i, '');
                    displayAddress = displayAddress.replace(/[å··å¼„è™Ÿ][\d\w\-\s]*.*$/i, '');
                    displayAddress = (cityDistrict + displayAddress).trim();
                }
            }
            
            return displayAddress.replace(/[\s\-]+$/, '').trim();
        }
        
        // æ­£è¦åŒ–ç‰©ä»¶ç·¨è™Ÿï¼ˆè™•ç†èˆŠæ ¼å¼ï¼Œä¾‹å¦‚ TT-012 â†’ TT00012ï¼‰
        function normalizePropertyNumber(number) {
            if (!number || typeof number !== 'string') {
                return number;
            }
            
            const trimmedNumber = number.trim().toUpperCase();
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æ­£ç¢ºçš„æ–°æ ¼å¼
            // åº—å…§ç‰©ä»¶ï¼š{2å­—æ¯}{5æ•¸å­—}ï¼Œä¾‹å¦‚ TT00012
            // åº—å¤–ç‰©ä»¶ï¼šEX{2å­—æ¯}{4æ•¸å­—}ï¼Œä¾‹å¦‚ EXTT0001
            const newFormatPattern = /^([A-Z]{2}\d{5}|EX[A-Z]{2}\d{4})$/;
            if (newFormatPattern.test(trimmedNumber)) {
                return trimmedNumber; // å·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼
            }
            
            // å˜—è©¦è½‰æ›èˆŠæ ¼å¼ï¼ˆä¾‹å¦‚ï¼šTT-012 â†’ TT00012ï¼‰
            // åŒ¹é…æ¨¡å¼ï¼š{å­—æ¯}-{æ•¸å­—} æˆ– {å­—æ¯}{æ•¸å­—}
            const oldFormatMatch = trimmedNumber.match(/^([A-Z]{2})[-]?(\d+)$/i);
            if (oldFormatMatch) {
                const prefix = oldFormatMatch[1].toUpperCase();
                const seq = parseInt(oldFormatMatch[2], 10);
                
                if (!isNaN(seq) && seq > 0) {
                    // åº—å…§ç‰©ä»¶ï¼š{2å­—æ¯}{5æ•¸å­—}
                    return `${prefix}${String(seq).padStart(5, '0')}`;
                }
            }
            
            // å¦‚æœç„¡æ³•è½‰æ›ï¼Œè¿”å›æ¸…ç†å¾Œçš„åŸå§‹å€¼
            return trimmedNumber;
        }
        
        // å¾ URL åƒæ•¸ç²å–ç‰©ä»¶ç·¨è™Ÿæˆ– IDï¼ˆå„ªå…ˆä½¿ç”¨ç·¨è™Ÿï¼‰
        function getPropertyIdentifier() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                number: urlParams.get('number'),
                id: urlParams.get('id')
            };
        }
        
        // è¼‰å…¥ç‰©ä»¶è³‡æ–™
        async function loadProperty() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const pageEl = document.getElementById('property-page');
            
            try {
                const { number, id } = getPropertyIdentifier();
                
                if (!number && !id) {
                    throw new Error('è«‹æä¾›ç‰©ä»¶ç·¨è™Ÿæˆ– ID');
                }
                
                // ä½¿ç”¨ Supabase è¨­å®šå€¼
                const supabaseClient = supabase.createClient(SUPABASE_URL_VALUE, SUPABASE_ANON_KEY_VALUE);
                
                let query = supabaseClient
                    .from('properties')
                    .select('*');
                
                // å„ªå…ˆä½¿ç”¨ç·¨è™ŸæŸ¥è©¢ï¼Œå¦‚æœæ²’æœ‰ç·¨è™Ÿå‰‡ä½¿ç”¨ ID
                if (number) {
                    // æ­£è¦åŒ–ç·¨è™Ÿï¼ˆè™•ç†èˆŠæ ¼å¼ï¼‰
                    const normalizedNumber = normalizePropertyNumber(number);
                    const originalNumber = number.trim().toUpperCase();
                    console.log('ğŸ” æŸ¥è©¢ç‰©ä»¶ç·¨è™Ÿ:', {
                        original: number,
                        cleaned: originalNumber,
                        normalized: normalizedNumber
                    });
                    
                    let propertyData = null;
                    let lastError = null;
                    
                    // å˜—è©¦å¤šç¨®ç·¨è™Ÿæ ¼å¼æŸ¥è©¢
                    const numberVariants = [
                        normalizedNumber,
                        originalNumber
                    ];
                    
                    // å¦‚æœæ­£è¦åŒ–å¾Œçš„ç·¨è™Ÿèˆ‡åŸå§‹ä¸åŒï¼Œä¹Ÿå˜—è©¦åŸå§‹ç·¨è™Ÿ
                    if (normalizedNumber !== originalNumber) {
                        numberVariants.push(originalNumber);
                    }
                    
                    // ç§»é™¤é‡è¤‡çš„ç·¨è™Ÿ
                    const uniqueVariants = [...new Set(numberVariants)];
                    console.log('ğŸ”„ å˜—è©¦æŸ¥è©¢çš„ç·¨è™Ÿè®Šé«”:', uniqueVariants);
                    
                    for (const numVariant of uniqueVariants) {
                        try {
                            console.log(`  ğŸ” å˜—è©¦ç·¨è™Ÿ: "${numVariant}"`);
                            const { data, error } = await supabaseClient
                                .from('properties')
                                .select('*')
                                .eq('number', numVariant)
                                .maybeSingle();
                            
                            if (error && error.code !== 'PGRST116') {
                                console.error(`  âŒ æŸ¥è©¢éŒ¯èª¤:`, error);
                                lastError = error;
                                continue;
                            }
                            
                            if (data) {
                                console.log(`  âœ… æ‰¾åˆ°ç‰©ä»¶:`, {
                                    number: data.number,
                                    title: data.title,
                                    is_published: data.is_published
                                });
                                propertyData = data;
                                break;
                            } else {
                                console.log(`  âš ï¸ ç·¨è™Ÿ "${numVariant}" æœªæ‰¾åˆ°`);
                            }
                        } catch (err) {
                            console.error(`  âŒ æŸ¥è©¢ç•°å¸¸:`, err);
                            lastError = err;
                        }
                    }
                    
                    if (!propertyData) {
                        // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå˜—è©¦æŸ¥è©¢æ‰€æœ‰ç·¨è™Ÿï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
                        console.log('ğŸ” æŸ¥è©¢æ‰€æœ‰ç‰©ä»¶ç·¨è™Ÿï¼ˆç”¨æ–¼èª¿è©¦ï¼‰...');
                        const { data: allProperties, error: listError } = await supabaseClient
                            .from('properties')
                            .select('number, title, is_published')
                            .limit(10);
                        
                        if (!listError && allProperties) {
                            console.log('ğŸ“‹ è³‡æ–™åº«ä¸­çš„å‰ 10 å€‹ç‰©ä»¶ç·¨è™Ÿ:', allProperties.map(p => ({
                                number: p.number,
                                title: p.title,
                                is_published: p.is_published
                            })));
                        }
                        
                        throw new Error(`æ‰¾ä¸åˆ°ç·¨è™Ÿç‚º "${number}" çš„ç‰©ä»¶ã€‚å·²å˜—è©¦: ${uniqueVariants.join(', ')}`);
                    }
                    
                    // éš±è—è¼‰å…¥æç¤ºï¼Œé¡¯ç¤ºé é¢
                    loadingEl.style.display = 'none';
                    pageEl.style.display = 'block';
                    
                    // æ¸²æŸ“ç‰©ä»¶è©³ç´°è³‡è¨Š
                    renderProperty(propertyData);
                    
                    // æ›´æ–°é é¢æ¨™é¡Œï¼šç‰©ä»¶æ¨™é¡Œ + åƒ¹æ ¼ï¼ˆå¦‚æœæœ‰ï¼‰
                    const pageTitle = propertyData.title 
                        ? (propertyData.price ? `${propertyData.title} - ${propertyData.price} | ä½å•†ä¸å‹•ç”¢` : `${propertyData.title} | ä½å•†ä¸å‹•ç”¢`)
                        : 'ç‰©ä»¶è©³ç´°è³‡è¨Š | ä½å•†ä¸å‹•ç”¢';
                    document.title = pageTitle;
                    return;
                } else if (id) {
                    console.log('ğŸ” æŸ¥è©¢ç‰©ä»¶ ID:', id);
                    query = query.eq('id', id);
                } else {
                    throw new Error('è«‹æä¾›ç‰©ä»¶ç·¨è™Ÿæˆ– ID');
                }
                
                const { data, error } = await query.single();
                
                if (error) {
                    console.error('âŒ æŸ¥è©¢ç‰©ä»¶å¤±æ•—:', error);
                    // å¦‚æœæ˜¯ "PGRST116" éŒ¯èª¤ï¼ˆæ‰¾ä¸åˆ°å–®ä¸€çµæœï¼‰ï¼Œå˜—è©¦ä½¿ç”¨ maybeSingle
                    if (error.code === 'PGRST116') {
                        const { data: dataArray, error: arrayError } = await query.maybeSingle();
                        if (arrayError) throw arrayError;
                        if (!dataArray) {
                            throw new Error(`æ‰¾ä¸åˆ° ID ç‚º "${id}" çš„ç‰©ä»¶`);
                        }
                        // ä½¿ç”¨ maybeSingle çš„çµæœ
                        const propertyData = dataArray;
                        loadingEl.style.display = 'none';
                        pageEl.style.display = 'block';
                        renderProperty(propertyData);
                        // è¨­ç½®å¸å¼•äººçš„æ¨™é¡Œï¼šç‰©ä»¶æ¨™é¡Œ + åƒ¹æ ¼ï¼ˆå¦‚æœæœ‰ï¼‰
                        const pageTitle = propertyData.title 
                            ? (propertyData.price ? `${propertyData.title} - ${propertyData.price} | ä½å•†ä¸å‹•ç”¢` : `${propertyData.title} | ä½å•†ä¸å‹•ç”¢`)
                            : 'ç‰©ä»¶è©³ç´°è³‡è¨Š | ä½å•†ä¸å‹•ç”¢';
                        document.title = pageTitle;
                        return;
                    }
                    throw error;
                }
                if (!data) {
                    throw new Error(`æ‰¾ä¸åˆ° ID ç‚º "${id}" çš„ç‰©ä»¶`);
                }
                
                // éš±è—è¼‰å…¥æç¤ºï¼Œé¡¯ç¤ºé é¢
                loadingEl.style.display = 'none';
                pageEl.style.display = 'block';
                
                // æ¸²æŸ“ç‰©ä»¶è©³ç´°è³‡è¨Š
                renderProperty(data);
                
                // æ›´æ–°é é¢æ¨™é¡Œï¼šç‰©ä»¶æ¨™é¡Œ + åƒ¹æ ¼ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œè®“æ¨™é¡Œæ›´å¸å¼•äºº
                const pageTitle = data.title 
                    ? (data.price ? `${data.title} - ${data.price} | ä½å•†ä¸å‹•ç”¢` : `${data.title} | ä½å•†ä¸å‹•ç”¢`)
                    : 'ç‰©ä»¶è©³ç´°è³‡è¨Š | ä½å•†ä¸å‹•ç”¢';
                document.title = pageTitle;
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥ç‰©ä»¶å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                let errorMessage = error.message || 'è¼‰å…¥å¤±æ•—';
                if (error.code === 'PGRST116') {
                    errorMessage = 'æ‰¾ä¸åˆ°æŒ‡å®šçš„ç‰©ä»¶ï¼Œè«‹ç¢ºèªç‰©ä»¶ç·¨è™Ÿæˆ– ID æ˜¯å¦æ­£ç¢º';
                } else if (error.message && error.message.includes('æ‰¾ä¸åˆ°')) {
                    errorMessage = error.message;
                } else {
                    errorMessage = `è¼‰å…¥å¤±æ•—ï¼š${errorMessage}`;
                }
                document.getElementById('error-message').textContent = errorMessage;
            }
        }
        
        // æ¸²æŸ“ç‰©ä»¶è©³ç´°è³‡è¨Š
        function renderProperty(property) {
            const pageEl = document.getElementById('property-page');
            
            // è™•ç†åœ–ç‰‡
            let images = [];
            if (property.images) {
                if (typeof property.images === 'string') {
                    try {
                        images = JSON.parse(property.images);
                    } catch (e) {
                        images = [];
                    }
                } else if (Array.isArray(property.images)) {
                    images = property.images;
                }
            }
            
            // è™•ç†åœ°å€é¡¯ç¤º
            const displayAddress = formatAddressForDisplay(
                property.address, 
                property.hide_address_number, 
                property.type
            );
            
            // è™•ç†å±‹é½¡é¡¯ç¤º
            const displayAge = property.age 
                ? (property.age.includes('å¹´') ? property.age : property.age + 'å¹´')
                : 'æœªè¨­å®š';
            
            // è™•ç† transportation
            let transportation = {};
            if (property.transportation) {
                if (typeof property.transportation === 'string') {
                    try {
                        transportation = JSON.parse(property.transportation);
                    } catch (e) {
                        transportation = {};
                    }
                } else {
                    transportation = property.transportation;
                }
            }
            
            // è™•ç† features
            let features = [];
            if (property.features) {
                if (typeof property.features === 'string') {
                    try {
                        features = JSON.parse(property.features);
                    } catch (e) {
                        features = [];
                    }
                } else if (Array.isArray(property.features)) {
                    features = property.features;
                }
            }
            
            // è™•ç† Google Maps URL
            let mapUrl = property.google_maps || '';
            if (mapUrl && mapUrl.includes('<iframe')) {
                const srcMatch = mapUrl.match(/src=["']([^"']+)["']/i);
                if (srcMatch && srcMatch[1]) {
                    mapUrl = srcMatch[1];
                } else {
                    mapUrl = '';
                }
            }
            if (!mapUrl && property.address) {
                const encodedAddress = encodeURIComponent(property.address);
                mapUrl = `https://www.google.com/maps?q=${encodedAddress}&output=embed`;
            }
            
            pageEl.innerHTML = `
                <div class="property-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                        <div style="flex: 1; min-width: 200px;">
                            <h1 class="property-title">${property.title || 'æœªå‘½åç‰©ä»¶'}</h1>
                            ${displayAddress ? `<p class="property-address">ğŸ“ ${displayAddress}</p>` : property.address ? `<p class="property-address">ğŸ“ ${property.address}</p>` : ''}
                        </div>
                        ${property.price ? `
                        <div style="text-align: right; min-width: 150px;">
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">å”®åƒ¹</div>
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea; line-height: 1.2;">${property.price}</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="property-meta">
                        <div class="meta-item">
                            <i class="fas fa-tag"></i>
                            <span>ç·¨è™Ÿï¼š${property.number || 'N/A'}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-home"></i>
                            <span>${property.type || 'N/A'}</span>
                        </div>
                        ${property.status_text ? `
                        <div class="meta-item">
                            <i class="fas fa-info-circle"></i>
                            <span>${property.status_text}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="property-content">
                    <!-- åœ–ç‰‡å±•ç¤ºï¼ˆç§»åˆ°æœ€ä¸Šæ–¹ï¼‰ -->
                    ${images.length > 0 ? `
                    <div class="section" id="image-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 class="section-title" style="margin: 0;">ğŸ“¸ ç‰©ä»¶ç…§ç‰‡</h2>
                            <button onclick="toggleImageGallery()" 
                                    id="image-toggle-btn"
                                    style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chevron-up" id="image-toggle-icon"></i>
                                <span id="image-toggle-text">æ”¶èµ·</span>
                            </button>
                        </div>
                        <div class="image-main-container" id="image-main-container">
                            <div class="image-main" id="image-main-display">
                                <img id="main-image" src="${images[0]}" alt="ç‰©ä»¶ç…§ç‰‡ 1">
                                ${images.length > 1 ? `
                                <button class="image-nav-btn prev" onclick="changeImage(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="image-nav-btn next" onclick="changeImage(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                ` : ''}
                            </div>
                            <div class="image-thumbnails" id="image-thumbnails">
                                ${images.map((img, index) => `
                                    <div class="image-thumbnail ${index === 0 ? 'active' : ''}" 
                                         onclick="selectImage(${index})"
                                         data-index="${index}">
                                        <img src="${img}" alt="ç¸®åœ– ${index + 1}" loading="lazy">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ä¸»è¦è³‡è¨Š -->
                    <div class="section">
                        <h2 class="section-title">ğŸ’° åŸºæœ¬è³‡è¨Š</h2>
                        <div class="info-grid">
                            <div class="info-item price-item">
                                <div class="info-label">å”®åƒ¹</div>
                                <div class="info-value">${property.price || 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ç¸½åªæ•¸</div>
                                <div class="info-value">${property.total_area ? (property.total_area.includes('åª') ? property.total_area : property.total_area + 'åª') : 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">æ ¼å±€</div>
                                <div class="info-value">${property.layout || 'æœªè¨­å®š'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å±‹é½¡</div>
                                <div class="info-value">${displayAge}</div>
                            </div>
                            ${property.main_area ? `
                            <div class="info-item">
                                <div class="info-label">ä¸»å»ºç‰©</div>
                                <div class="info-value">${property.main_area.includes('åª') ? property.main_area : property.main_area + 'åª'}</div>
                            </div>
                            ` : ''}
                            ${property.land_area ? `
                            <div class="info-item">
                                <div class="info-label">åœ°åª</div>
                                <div class="info-value">${property.land_area.includes('åª') ? property.land_area : property.land_area + 'åª'}</div>
                            </div>
                            ` : ''}
                            ${property.floor ? `
                            <div class="info-item">
                                <div class="info-label">æ¨“å±¤</div>
                                <div class="info-value">${(() => {
                                    let floorDisplay = property.floor;
                                    // å¦‚æœæœ‰å¢å»ºè³‡è¨Šï¼Œç‰¹åˆ¥æ¨™ç¤º
                                    if (floorDisplay.includes('ï¼ˆå¢å»º') || floorDisplay.includes('(å¢å»º')) {
                                        // ä½¿ç”¨ä¸åŒé¡è‰²æ¨™ç¤ºå¢å»ºéƒ¨åˆ†
                                        floorDisplay = floorDisplay.replace(
                                            /[ï¼ˆ(]å¢å»º(.+?)[ï¼‰)]/g, 
                                            '<span style="color: #e74c3c; font-weight: 600;">ï¼ˆå¢å»º$1ï¼‰</span>'
                                        );
                                    }
                                    return floorDisplay;
                                })()}</div>
                            </div>
                            ` : ''}
                            ${property.parking_type ? `
                            <div class="info-item">
                                <div class="info-label">è»Šä½é¡å‹</div>
                                <div class="info-value">${property.parking_type}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- è©³ç´°æè¿° -->
                    ${property.description ? `
                    <div class="section">
                        <h2 class="section-title">ğŸ“ ç‰©ä»¶æè¿°</h2>
                        <div class="description">${property.description}</div>
                    </div>
                    ` : ''}
                    
                    <!-- äº¤é€šèˆ‡è¨­æ–½ -->
                    ${(transportation.transport && transportation.transport.length > 0) || 
                      (transportation.schools && transportation.schools.length > 0) || 
                      (transportation.facilities && transportation.facilities.length > 0) ||
                      transportation.market || transportation.park ? `
                    <div class="section">
                        <h2 class="section-title">ğŸš— äº¤é€šèˆ‡ç”Ÿæ´»æ©Ÿèƒ½</h2>
                        <div class="other-info-grid">
                            ${transportation.transport && transportation.transport.length > 0 ? `
                            <div class="other-info-item">
                                <div class="other-info-label">äº¤é€š</div>
                                <div class="other-info-value">${transportation.transport.join('ã€')}</div>
                            </div>
                            ` : ''}
                            ${transportation.schools && transportation.schools.length > 0 ? `
                            <div class="other-info-item">
                                <div class="other-info-label">å­¸æ ¡</div>
                                <div class="other-info-value">${transportation.schools.join('ã€')}</div>
                            </div>
                            ` : ''}
                            ${transportation.market ? `
                            <div class="other-info-item">
                                <div class="other-info-label">å¸‚å ´</div>
                                <div class="other-info-value">${transportation.market}</div>
                            </div>
                            ` : ''}
                            ${transportation.park ? `
                            <div class="other-info-item">
                                <div class="other-info-label">å…¬åœ’</div>
                                <div class="other-info-value">${transportation.park}</div>
                            </div>
                            ` : ''}
                            ${transportation.facilities && transportation.facilities.length > 0 ? `
                            <div class="other-info-item">
                                <div class="other-info-label">é„°è¿‘è¨­æ–½</div>
                                <div class="other-info-value">${transportation.facilities.join('ã€')}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ç‰©ä»¶ç‰¹è‰² -->
                    ${features.length > 0 ? `
                    <div class="section">
                        <h2 class="section-title">âœ¨ ç‰©ä»¶ç‰¹è‰²</h2>
                        <ul style="list-style: none; padding: 0;">
                            ${features.map(feature => `
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                                    <i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>
                                    ${feature}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <!-- åœ°åœ– -->
                    ${mapUrl ? `
                    <div class="section">
                        <h2 class="section-title">ğŸ—ºï¸ ä½ç½®åœ°åœ–</h2>
                        <div style="width: 100%; height: 400px; border-radius: 8px; overflow: hidden; margin-top: 1rem;">
                            <iframe 
                                src="${mapUrl}" 
                                width="100%" 
                                height="100%" 
                                style="border:0;" 
                                allowfullscreen="" 
                                allow="accelerometer; gyroscope; geolocation"
                                loading="lazy" 
                                referrerpolicy="no-referrer-when-downgrade">
                            </iframe>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(property.address)}" 
                               target="_blank" 
                               style="background: #4285f4; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-external-link-alt"></i> åœ¨ Google Maps ä¸­é–‹å•Ÿ
                            </a>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(property.address)}" 
                               target="_blank" 
                               style="background: #ff6b6b; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-route"></i> è¦åŠƒè·¯ç·š
                            </a>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- ç›¸é—œé€£çµå€å¡Šï¼ˆå¾ Supabase å‹•æ…‹è¼‰å…¥ï¼‰ -->
                <div class="section" style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 1.5rem;">ğŸ“ ç›¸é—œè³‡æ–™é€£çµ</h2>
                    <div id="related-links-container-detail" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.8rem;">
                        <p style="text-align: center; color: #666; padding: 1rem; width: 100%;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
                
                <!-- è¯çµ¡æ–¹å¼å€å¡Š -->
                <div class="section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 2rem; border-radius: 12px; margin-top: 2rem;">
                    <h2 class="section-title" style="text-align: center; margin-bottom: 1.5rem;">
                        <span style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ“ è¯çµ¡æ–¹å¼</span>
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.8rem; max-width: 1200px; margin: 0 auto;">
                        <!-- è¯çµ¡æ–¹å¼å¡ç‰‡ -->
                        <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(102, 126, 234, 0.1); position: relative; overflow: hidden; display: flex; flex-direction: column; height: 100%;">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                            <h3 style="color: #2c3e50; margin-bottom: 1.2rem; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 0.4rem;">
                                <span style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ‘¥ è¯çµ¡æ–¹å¼</span>
                            </h3>
                            <div style="flex: 1;">
                                <p style="margin-bottom: 0.8rem; font-size: 1rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
                                    <i class="bi bi-person-fill" style="color: #667eea; font-size: 1.1rem;"></i>
                                    <span style="font-weight: 600;">åŠ‰å­è²</span>
                                    <a href="tel:0925666597" style="color: #e74c3c; text-decoration: none; font-weight: bold; margin-left: auto; display: flex; align-items: center; gap: 0.25rem;">
                                        <i class="bi bi-phone-fill"></i> 0925-666-597
                                    </a>
                                </p>
                                <p style="margin-bottom: 0.8rem; font-size: 1rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
                                    <i class="bi bi-person-fill" style="color: #667eea; font-size: 1.1rem;"></i>
                                    <span style="font-weight: 600;">è”¡æ¿¬ç‘’</span>
                                    <a href="tel:0928776755" style="color: #e74c3c; text-decoration: none; font-weight: bold; margin-left: auto; display: flex; align-items: center; gap: 0.25rem;">
                                        <i class="bi bi-phone-fill"></i> 0928-776-755
                                    </a>
                                </p>
                                <p style="margin-bottom: 1.2rem; font-size: 1rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: rgba(0, 200, 81, 0.05); border-radius: 8px; border-left: 3px solid #00c851;">
                                    <i class="bi bi-chat-dots-fill" style="color: #00c851; font-size: 1.1rem;"></i>
                                    <span style="font-weight: 600;">LINEï¼š@931aeinu</span>
                                    <button onclick="copyLineId()" style="background: linear-gradient(45deg, #00c851, #00a085); color: white; border: none; padding: 0.3rem 0.7rem; border-radius: 12px; cursor: pointer; font-size: 0.8rem; margin-left: auto; transition: all 0.3s ease;" title="è¤‡è£½ LINE ID">
                                        <i class="bi bi-copy"></i> è¤‡è£½
                                    </button>
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; margin-top: auto; padding-top: 1rem;">
                                <a href="tel:0928776755" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3); flex: 1; justify-content: center; font-size: 0.85rem;"
                                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(102, 126, 234, 0.4)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'">
                                    <i class="bi bi-telephone-outbound-fill"></i> ç«‹å³ä¾†é›»
                                </a>
                                <a href="https://lin.ee/Lax7jMka" target="_blank" style="background: linear-gradient(45deg, #00c851, #00a085); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 3px 12px rgba(0, 200, 81, 0.3); flex: 1; justify-content: center; font-size: 0.85rem;"
                                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0, 200, 81, 0.4)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 12px rgba(0, 200, 81, 0.3)'">
                                    <i class="fa-brands fa-line"></i> LINEè¯çµ¡
                                </a>
                            </div>
                        </div>
                        <!-- ç¶“ç´€æ¥­è³‡è¨Šå¡ç‰‡ -->
                        <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 1.8rem; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(102, 126, 234, 0.1); position: relative; overflow: hidden; display: flex; flex-direction: column; height: 100%;">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                            <h3 style="color: #2c3e50; margin-bottom: 1.2rem; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 0.4rem;">
                                <span style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸ¢ ç¶“ç´€æ¥­è³‡è¨Š</span>
                            </h3>
                            <div style="flex: 1;">
                                <p style="margin-bottom: 0.6rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <i class="bi bi-buildings" style="color: #667eea; font-size: 1rem;"></i>
                                    <span style="font-weight: 600;">å…¬å¸ï¼šå¸¸é´»æ‚¦è±ä¼æ¥­ç¤¾</span>
                                </p>
                                <p style="margin-bottom: 0.6rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <i class="bi bi-person-badge-fill" style="color: #667eea; font-size: 1rem;"></i>
                                    <span style="font-weight: 600;">ç‡Ÿæ¥­å“¡ï¼šè”¡æ¿¬ç‘’ï¼ˆ112ï¼‰æ¡ƒå¸‚å­—ç¬¬432900è™Ÿ</span>
                                </p>
                                <p style="margin-bottom: 0.6rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <i class="bi bi-person-badge-fill" style="color: #667eea; font-size: 1rem;"></i>
                                    <span style="font-weight: 600;">ç‡Ÿæ¥­å“¡ï¼šåŠ‰å­è²ï¼ˆ113ï¼‰æ¡ƒå¸‚å­—ç¬¬467056è™Ÿ</span>
                                </p>
                                <p style="margin-bottom: 0.6rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <i class="bi bi-person-vcard-fill" style="color: #667eea; font-size: 1rem;"></i>
                                    <span style="font-weight: 600;">ç¶“ç´€äººï¼šè‘‰éœè“‰ï¼ˆ104ï¼‰æ–°åŒ—ç¶“è­‰å­—ç¬¬003119è™Ÿ</span>
                                </p>
                                <p style="margin-bottom: 0.6rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <i class="bi bi-geo-alt-fill" style="color: #667eea; font-size: 1rem;"></i>
                                    <span style="font-weight: 600;">æœå‹™æ“šé»ï¼šä½å•†ä¸å‹•ç”¢æ¥Šæ¢…å¤§é †åº—</span>
                                </p>
                                <p style="margin-bottom: 0.6rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                                    <i class="bi bi-clock-fill" style="color: #667eea; font-size: 1rem;"></i>
                                    <span style="font-weight: 600;">ç‡Ÿæ¥­æ™‚é–“ï¼š09:00â€“21:00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // å„²å­˜åœ–ç‰‡é™£åˆ—ä¾›ç‡ˆç®±ä½¿ç”¨
            window.propertyImages = images;
            
            // è¨­ç½®åœ–ç‰‡äº’å‹•åŠŸèƒ½
            setupImageInteractions();
            
            // è¼‰å…¥ç›¸é—œé€£çµï¼ˆå¾å¾Œç«¯ APIï¼Œä½¿ç”¨èˆ‡å‚™ä»½æª”æ¡ˆä¸€è‡´çš„æ¨£å¼ï¼‰
            function loadRelatedLinksOnPage() {
                const maxRetries = 30; // æœ€å¤šé‡è©¦ 15 ç§’
                let retries = 0;
                
                function tryLoad() {
                    // æª¢æŸ¥æ–°æ¨¡çµ„æ˜¯å¦å·²è¼‰å…¥
                    const hasModule = typeof RelatedLinksFrontend !== 'undefined' && 
                                     typeof RelatedLinksFrontend.renderRelatedLinks === 'function';
                    
                    if (hasModule) {
                        console.log('âœ… é–‹å§‹è¼‰å…¥ç›¸é—œé€£çµï¼ˆå¾å¾Œç«¯ APIï¼Œä½¿ç”¨ contact-button æ¨£å¼ï¼‰');
                        RelatedLinksFrontend.renderRelatedLinks('related-links-container-detail').catch(error => {
                            console.error('âŒ è¼‰å…¥ç›¸é—œé€£çµå¤±æ•—:', error);
                            const container = document.getElementById('related-links-container-detail');
                            if (container) {
                                container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 1rem;">è¼‰å…¥é€£çµå¤±æ•—</p>';
                            }
                        });
                    } else if (retries < maxRetries) {
                        retries++;
                        if (retries % 5 === 0) {
                            console.warn(`âš ï¸ RelatedLinksFrontend å°šæœªè¼‰å…¥ (${retries}/${maxRetries})`, {
                                RelatedLinksFrontend: typeof RelatedLinksFrontend,
                                renderRelatedLinks: typeof RelatedLinksFrontend?.renderRelatedLinks
                            });
                        }
                        setTimeout(tryLoad, 500);
                    } else {
                        console.error('âŒ è¼‰å…¥ç›¸é—œé€£çµè¶…æ™‚');
                        const container = document.getElementById('related-links-container-detail');
                        if (container) {
                            container.innerHTML = `
                                <div style="text-align: center; color: #dc3545; padding: 1rem;">
                                    <p>è¼‰å…¥é€£çµå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
                                    <button onclick="location.reload()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡æ–°æ•´ç†</button>
                                </div>
                            `;
                        }
                    }
                }
                
                // ç›£è½è‡ªå®šç¾©äº‹ä»¶ï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰
                window.addEventListener('relatedLinksFrontendReady', function handler() {
                    console.log('ğŸ“¢ æ”¶åˆ° relatedLinksFrontendReady äº‹ä»¶');
                    window.removeEventListener('relatedLinksFrontendReady', handler);
                    setTimeout(tryLoad, 100);
                }, { once: true });
                
                // ç«‹å³æª¢æŸ¥ä¸€æ¬¡ï¼ˆè…³æœ¬å¯èƒ½å·²ç¶“è¼‰å…¥ï¼‰
                setTimeout(tryLoad, 100);
                
                // é é¢è¼‰å…¥å®Œæˆå¾Œä¹Ÿå˜—è©¦è¼‰å…¥
                if (document.readyState === 'complete') {
                    setTimeout(tryLoad, 500);
                } else {
                    window.addEventListener('load', () => {
                        setTimeout(tryLoad, 500);
                    });
                }
            }
            
            loadRelatedLinksOnPage();
        }
        
        // åˆ‡æ›æˆ¿ç”¢è³‡è¨Šé¸å–®
        function togglePropertyInfoMenu() {
            const menu = document.getElementById('propertyInfoMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('propertyInfoDropdown');
            const menu = document.getElementById('propertyInfoMenu');
            if (dropdown && menu && !dropdown.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });
        
        // è¤‡è£½ LINE ID
        function copyLineId() {
            const lineId = '@931aeinu';
            navigator.clipboard.writeText(lineId).then(() => {
                alert('LINE ID å·²è¤‡è£½ï¼š' + lineId);
            }).catch(() => {
                // å‚™ç”¨æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = lineId;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('LINE ID å·²è¤‡è£½ï¼š' + lineId);
            });
        }
        
        // ç•¶å‰é¡¯ç¤ºçš„åœ–ç‰‡ç´¢å¼•
        let currentImageIndex = 0;
        
        // é¸æ“‡åœ–ç‰‡
        function selectImage(index) {
            if (!window.propertyImages || index < 0 || index >= window.propertyImages.length) return;
            
            currentImageIndex = index;
            const mainImage = document.getElementById('main-image');
            if (mainImage) {
                mainImage.src = window.propertyImages[index];
            }
            
            // æ›´æ–°ç¸®åœ–æ´»å‹•ç‹€æ…‹
            const thumbnails = document.querySelectorAll('.image-thumbnail');
            thumbnails.forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }
        
        // åˆ‡æ›åœ–ç‰‡ï¼ˆå·¦å³åˆ‡æ›ï¼‰
        function changeImage(direction) {
            if (!window.propertyImages || window.propertyImages.length === 0) return;
            
            const newIndex = currentImageIndex + direction;
            if (newIndex < 0) {
                selectImage(window.propertyImages.length - 1);
            } else if (newIndex >= window.propertyImages.length) {
                selectImage(0);
            } else {
                selectImage(newIndex);
            }
        }
        
        // åˆ‡æ›åœ–ç‰‡å±•ç¤ºå€åŸŸï¼ˆå±•é–‹/æ”¶èµ·ï¼‰
        function toggleImageGallery() {
            const mainContainer = document.getElementById('image-main-container');
            const toggleIcon = document.getElementById('image-toggle-icon');
            const toggleText = document.getElementById('image-toggle-text');
            
            if (mainContainer) {
                if (mainContainer.style.display === 'none') {
                    mainContainer.style.display = 'block';
                    if (toggleIcon) toggleIcon.className = 'fas fa-chevron-up';
                    if (toggleText) toggleText.textContent = 'æ”¶èµ·';
                } else {
                    mainContainer.style.display = 'none';
                    if (toggleIcon) toggleIcon.className = 'fas fa-chevron-down';
                    if (toggleText) toggleText.textContent = 'å±•é–‹';
                }
            }
        }
        
        // åœ–ç‰‡ç‡ˆç®±åŠŸèƒ½ï¼ˆé»æ“Šä¸»åœ–æ™‚é–‹å•Ÿå…¨å±ï¼‰
        function openImageLightbox(index) {
            if (!window.propertyImages || window.propertyImages.length === 0) return;
            
            const lightbox = document.createElement('div');
            lightbox.id = 'image-lightbox';
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = window.propertyImages[index];
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            lightbox.appendChild(img);
            document.body.appendChild(lightbox);
            
            lightbox.onclick = () => lightbox.remove();
            
            // éµç›¤å°èˆª
            const handleKey = (e) => {
                if (e.key === 'Escape') {
                    lightbox.remove();
                    document.removeEventListener('keydown', handleKey);
                } else if (e.key === 'ArrowLeft' && index > 0) {
                    lightbox.remove();
                    document.removeEventListener('keydown', handleKey);
                    openImageLightbox(index - 1);
                } else if (e.key === 'ArrowRight' && index < window.propertyImages.length - 1) {
                    lightbox.remove();
                    document.removeEventListener('keydown', handleKey);
                    openImageLightbox(index + 1);
                }
            };
            document.addEventListener('keydown', handleKey);
        }
        
        // é»æ“Šä¸»åœ–æ™‚é–‹å•Ÿç‡ˆç®±
        // æ³¨æ„ï¼šé€™å€‹å‡½æ•¸æœƒåœ¨ renderProperty å®Œæˆå¾Œè¢«èª¿ç”¨
        function setupImageInteractions() {
            setTimeout(() => {
                const mainImage = document.getElementById('main-image');
                if (mainImage) {
                    mainImage.style.cursor = 'pointer';
                    mainImage.addEventListener('click', () => {
                        openImageLightbox(currentImageIndex);
                    });
                }
            }, 100);
        }
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', loadProperty);
    </script>
</body>
</html>

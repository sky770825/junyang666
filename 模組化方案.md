# 程式碼模組化方案

> 以資深工程師視角規劃，便於日後維護、除錯與功能擴充。  
> 實施採**分階段**進行，每階段可獨立驗證，降低風險。

---

## 一、現況簡述

| 檔案 | 行數 | 主要問題 |
|------|------|----------|
| `index.html` | 3,104 | 內嵌 ~2,250 行 CSS、~170 行 JS，難以搜尋與重用 |
| `admin-dashboard.html` | 4,803 | 內嵌 ~1,600 行 CSS、~2,800 行 JS，單檔過大 |
| `property-admin-db.html` | 6,657 | 內嵌 ~1,385 行 CSS、~4,500 行 JS，表單與邏輯混在一起 |
| `property-detail.html` | ~1,750 | 內嵌 ~485 行 CSS、~600 行 JS |
| `main-script.js` | 1,597 | 燈箱、地圖、TikTok、貸款試算、工具、初始化混在同一檔 |
| `pagination-system.js` | 2,715 | `EmbeddedPropertyPaginationSystem` 與 `SoldPropertyPaginationSystem` 合併，單檔過長 |

---

## 二、目標目錄結構（模組化後）

```
專案根目錄/
├── css/                          # 樣式（依頁面與用途切分）
│   ├── theme.css                 # 共用：reset、變數、按鈕/表單基礎
│   ├── index.css                 # 首頁專用
│   ├── admin-dashboard.css       # 後台儀表板
│   ├── property-detail.css       # 物件詳情頁
│   └── property-admin-db.css     # 後台新增/編輯表單
│
├── js/                           # 腳本（依功能與頁面切分）
│   ├── lib/                      # 共用元件（多頁使用）
│   │   ├── lightbox.js           # 照片燈箱
│   │   ├── map-modal.js          # 地圖彈窗
│   │   ├── tiktok-modal.js       # TikTok 彈窗
│   │   ├── loan-calculator.js    # 貸款試算
│   │   └── utils.js              # 工具：adjustTitleFontSize、escapeHtml 等
│   │
│   ├── index-init.js             # 首頁：收合、已售分頁、相關連結載入、除錯
│   ├── admin/
│   │   ├── qrcode-loader.js      # QR 函式庫載入（從 admin-dashboard 抽出）
│   │   └── dashboard.js          # 後台：Tab、物件列表、重複檢測、連結後台邏輯
│   │
│   ├── property-detail.js        # 物件詳情頁：載入、渲染、basePath、related-links
│   └── property-admin-db.js      # 後台表單：新增/編輯、圖片、驗證、送出
│
├── modules/                      # 既有模組（維持）
│   └── related-links/
│       ├── backend.js
│       └── frontend.js
│
├── index.html                     # 精簡：只保留結構與 <link> / <script> 引用
├── admin-dashboard.html
├── property-detail.html
├── property-admin-db.html
├── supabase-config.js
├── supabase-data-loader.js
├── api-data-loader.js
├── property-modals.js            # 保留，負責物件浮框
├── pagination-system.js          # 可選：再拆成 embedded / sold 兩檔
└── main-script.js                #  Phase 3 後可精簡為只做「載入與初始化」或移除
```

---

## 三、各階段說明

### Phase 1：CSS 抽取（優先、風險低）

**目的**：把 HTML 內嵌的 `<style>` 搬出為獨立 `.css`，方便查找、修改、共用。

| 步驟 | 內容 |
|------|------|
| 1.1 | 新增 `css/`，建立 `css/theme.css`：`*` reset、`html/body` 基礎、`:root` 品牌色變數（如 `--color-primary: #667eea`）。 |
| 1.2 | 從 `index.html` 抽出內嵌 CSS → `css/index.css`，改為 `<link rel="stylesheet" href="css/theme.css">`、`<link rel="stylesheet" href="css/index.css">`。 |
| 1.3 | 從 `admin-dashboard.html` 抽出 → `css/admin-dashboard.css`。 |
| 1.4 | 從 `property-detail.html` 抽出 → `css/property-detail.css`。 |
| 1.5 | 從 `property-admin-db.html` 抽出 → `css/property-admin-db.css`。 |

**注意**：`theme.css` 若有與各頁重複的 reset，各頁 CSS 可逐步刪掉重複部分，避免樣式被覆蓋。

---

### Phase 2：首頁 inline JS 抽取

**目的**：將 `index.html` 底部的 inline `<script>` 移到獨立檔，方便版本管理與除錯。

| 步驟 | 內容 |
|------|------|
| 2.1 | 新增 `js/index-init.js`，搬入：`toggleCollapsible`、`loadCollapsibleStates`、`DOMContentLoaded` 內：已售分頁初始化、`relatedLinksLoading`、`loadRelatedLinksOnPage`、開發除錯等。 |
| 2.2 | 在 `index.html` 將該 inline 區塊改為：`<script src="js/index-init.js"></script>`（放在 `main-script.js` 之後）。 |

**注意**：`index-init.js` 仍依賴 `RelatedLinksFrontend`、`SoldPropertyPaginationSystem`、`embeddedPropertiesData`、`supabaseDataLoaded` / `apiDataLoaded` 等，載入順序維持不變。

---

### Phase 3：main-script.js 拆分

**目的**：把「燈箱、地圖、TikTok、貸款試算、工具、初始化」拆成小模組，每個檔案職責單一。

| 新檔案 | 職責 | 從 main-script 移出的內容 |
|--------|------|---------------------------|
| `js/lib/lightbox.js` | 照片燈箱 | `closeLightbox`、`openLightbox`、`changeMainImage`、`updateLightboxImage`、`scrollThumbnails`、`handleTouchStart`、`handleTouchEnd` |
| `js/lib/map-modal.js` | 地圖彈窗 | `closeMapModal`、`showMapModal`、`mapIframeCache` |
| `js/lib/tiktok-modal.js` | TikTok 彈窗 | `showTikTokModal`、`loadTikTokEmbed`、`closeTikTokModal`、`tiktokEmbedCache`、`tiktokScriptLoaded`、`tiktokScriptLoading` |
| `js/lib/loan-calculator.js` | 貸款試算 | `showLoanCalculator`、`openLoanModal`、`closeLoanModal`、`bindSliderEvents`、`bindInputEvents`、`adjustLoanConditions`、`calculateModalLoan`、`sliderHandlers` |
| `js/lib/utils.js` | 工具 | `adjustTitleFontSize`、`resize` 監聽 |
| `main-script.js` 精簡 | 初始化與串接 | `DOMContentLoaded`：建立 `EmbeddedPropertyPaginationSystem`、掛事件、`window.closeLightbox` 等、F5 攔截；其餘刪除 |

**重要**：

- 上述函式與變數需**繼續掛在 `window`**，以配合現有 `onclick="closeLightbox()"`、`openLoanModal()` 等。
- 載入順序範例：  
  `property-modals` → `supabase-data-loader` → `lightbox`、`map-modal`、`tiktok-modal`、`loan-calculator`、`utils` → `pagination-system` → `main-script` → `index-init`。
- 若 `loan-calculator` 使用 `#modalHousePrice` 等 ID，需確認 `index.html` 的貸款 modal 已存在。

---

### Phase 4：pagination-system.js 拆分（可選）

**目的**：將 2,700+ 行的分頁邏輯拆成「主分頁」與「已售分頁」，便於維護。

| 新檔案 | 職責 |
|--------|------|
| `js/pagination-embedded.js` | `class EmbeddedPropertyPaginationSystem` |
| `js/pagination-sold.js` | `class SoldPropertyPaginationSystem` |

若兩者共用 helper，可放在 `pagination-embedded.js` 或另建 `pagination-shared.js`。  
**注意**：`SoldPropertyPaginationSystem` 是否依賴 `EmbeddedPropertyPaginationSystem` 的符號，需先確認再拆。

---

### Phase 5：admin-dashboard 拆分

**目的**：減輕 `admin-dashboard.html` 體積，將 QR 載入與邏輯搬出。

| 步驟 | 內容 |
|------|------|
| 5.1 | 將 head 內 QR 多 CDN 載入邏輯 → `js/admin/qrcode-loader.js`，在 `admin-dashboard.html` 改為 `<script src="js/admin/qrcode-loader.js"></script>`。 |
| 5.2 | 將 `</style>` 之後到 `</body>` 之前的 inline `<script>`（`escapeHtml`、`initSupabaseClient`、`switchTab`、`filterProperties`、`loadProperties`、`checkDuplicates`、`cleanDuplicates`、連結後台 fallback 等）→ `js/admin/dashboard.js`。 |
| 5.3 | `admin-dashboard.html` 改為引用 `css/admin-dashboard.css`、`js/admin/dashboard.js`。 |

**注意**：`dashboard.js` 內若使用 `RelatedLinksBackend` 的 `showAddLinkModal`、`closeLinkModal` 等，需在 `modules/related-links/backend.js` 之後載入。

---

### Phase 6：property-admin-db 拆分

**目的**：表單頁的樣式與邏輯獨立，方便維護與在 iframe 中重用。

| 步驟 | 內容 |
|------|------|
| 6.1 | 內嵌 CSS 已於 Phase 1 移至 `css/property-admin-db.css`。 |
| 6.2 | 將內嵌的 property-admin-db 專用 JS（表單欄位、圖片預覽、驗證、送出、Supabase 寫入等）→ `js/property-admin-db.js`。 |
| 6.3 | `property-admin-db.html` 改為引用 `css/property-admin-db.css`、`js/property-admin-db.js`。 |

**注意**：此頁會以 iframe 嵌入 `admin-dashboard` 的「新增物件」，需確認獨立開啟、iframe 內開啟兩種情境都正常。

---

### Phase 7：property-detail 拆分

**目的**：詳情頁的樣式與邏輯獨立，並理清 basePath、動態載入。

| 步驟 | 內容 |
|------|------|
| 7.1 | 內嵌 CSS 已於 Phase 1 移至 `css/property-detail.css`。 |
| 7.2 | 將 inline script（basePath 計算、動態載入 `supabase-config.js`、`modules/related-links/frontend.js`、詳情渲染、燈箱、返回按鈕等）→ `js/property-detail.js`。 |
| 7.3 | `property-detail.html` 在適當順序引用 `css/property-detail.css`、`js/property-detail.js`。 |

**注意**：`property-detail.js` 內對 `supabase-config`、`frontend.js` 的動態 `script.src` 要一併搬過去，路徑需隨 `basePath` 正確設定。

---

## 四、實施優先順序與風險

| 階段 | 風險 | 預期效益 | 建議順序 |
|------|------|----------|----------|
| Phase 1 CSS | 低 | 立即縮小 HTML、集中改版型 | 1 |
| Phase 2 index-init | 低 | 首頁邏輯可單獨測試、diff | 2 |
| Phase 3 main-script | 中 | 燈箱/地圖/貸款等可單獨維護 | 3 |
| Phase 4 pagination | 中 | 分頁邏輯可讀性提升 | 4（可選） |
| Phase 5 admin | 中 | 後台 4,803 行顯著下降 | 5 |
| Phase 6 property-admin-db | 中 | 表單 6,657 行顯著下降 | 6 |
| Phase 7 property-detail | 中 | 詳情頁結構清晰 | 7 |

---

## 五、共通注意事項

1. **全域與 `onclick`**  
   拆出之函式（如 `closeLightbox`、`openLoanModal`）需保留 `window.xxx`，以配合既有 `onclick` 與其它 script。

2. **載入順序**  
   新 JS 的順序需與相依關係一致：例如 `supabase-config` → `supabase-data-loader` → `property-modals` → 各 `lib/*` → `pagination-system` → `main-script` → `index-init`。

3. **除錯**  
   每完成一階段，請在桌面與手機驗證：首頁、列表、篩選、分頁、燈箱、地圖、TikTok、貸款試算、後台儀表板、新增/編輯、物件詳情、相關連結、iframe 嵌入。

4. **版控**  
   建議每 Phase 单独 commit，方便回溯。

5. **向後相容**  
   若暫不調整 `main-script.js` 或 `pagination-system.js` 的對外介面，可先只做「抽 CSS、抽 index-init、抽 admin / property-* 的 JS」，再逐步拆 main-script 與 pagination。

---

## 六、Phase 1 具體操作對照（index.html）

- **抽出**：`index.html` 中 `<!-- 手機響應式優化 -->` 到 `</style>` 的整段（含 `<style>`、`</style>`）。  
- **新增**：`css/index.css`，內容為上述區塊中原本在 `<style>` 與 `</style>` 之間的程式碼。  
- **替換**：原區塊改為一行：  
  `<link rel="stylesheet" href="css/index.css">`  
  （若已建 `theme.css`，可在其前加  
  `<link rel="stylesheet" href="css/theme.css">`。）

---

*文件版本：1.0 | 建立日期：2025-01-25*

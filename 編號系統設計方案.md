# 物件編號系統設計方案

## 📋 編號格式設計

### 格式規範
- **總長度**：7 位數
- **組成**：2 個英文字母 + 5 個數字
- **範例**：`SU00001`, `TW00001`, `TH00001`, `FO00001`

### 房型代碼對應表

| 房型 | 代碼 | 範例編號 | 說明 |
|------|------|----------|------|
| 套房 | SU | SU00001, SU00002, ... | Studio Unit |
| 2房 | TW | TW00001, TW00002, ... | Two Room |
| 3房 | TH | TH00001, TH00002, ... | Three Room |
| 4房 | FO | FO00001, FO00002, ... | Four Room |

### 編號生成規則

1. **自動生成邏輯**：
   - 選擇房型後，系統自動生成編號
   - 查詢所有現有編號，找出同類型最大序號
   - 新序號 = 最大序號 + 1
   - 格式化為 5 位數（00001, 00002, ..., 99999）

2. **編號唯一性**：
   - 每個編號在資料庫中必須唯一
   - 儲存前檢查重複
   - 編輯時排除當前物件的編號

## 📁 圖片儲存路徑設計

### 資料夾結構

```
junyang666/
└── properties/
    ├── SU/                    # 套房類型資料夾
    │   ├── SU00001/          # 物件編號資料夾
    │   │   ├── image_1.jpg
    │   │   ├── image_2.jpg
    │   │   └── ...
    │   ├── SU00002/
    │   │   └── ...
    │   └── ...
    ├── TW/                    # 2房類型資料夾
    │   ├── TW00001/
    │   │   └── ...
    │   └── ...
    ├── TH/                    # 3房類型資料夾
    │   ├── TH00001/
    │   │   └── ...
    │   └── ...
    └── FO/                    # 4房類型資料夾
        ├── FO00001/
        │   └── ...
        └── ...
```

### 路徑格式

**完整路徑**：`properties/{類型代碼}/{物件編號}/image_{序號}.{副檔名}`

**範例**：
- `properties/SU/SU00001/image_1.jpg`
- `properties/TW/TW00001/image_1.jpg`
- `properties/TH/TH00001/image_1.jpg`
- `properties/FO/FO00001/image_1.jpg`

### 圖片命名規則

1. **檔案名稱格式**：`image_{序號}.{副檔名}`
   - 序號從 1 開始，依上傳順序遞增
   - 例如：`image_1.jpg`, `image_2.jpg`, `image_3.jpg`

2. **路徑生成邏輯**：
   ```javascript
   // 從物件編號提取類型代碼（前2個字母）
   const typeCode = propertyNumber.substring(0, 2); // SU, TW, TH, FO
   
   // 生成完整路徑
   const imagePath = `properties/${typeCode}/${propertyNumber}/image_${index}.jpg`;
   ```

## 🎨 UI/UX 設計

### 前端卡片
- **不顯示編號**：移除卡片上的編號標籤
- **保留 data 屬性**：`data-property-number="{編號}"` 用於內部識別

### 詳細資訊彈窗
- **顯示位置**：標題區域下方，地址上方
- **顯示格式**：`物件編號：SU00001`
- **樣式**：小字體，灰色，不搶眼

## 🔧 技術實作規劃

### 1. 編號生成函數改進

**位置**：`property-admin-db.html` 的 `generatePropertyNumber()` 函數

**改進點**：
- 使用新的 7 位數格式（2字母+5數字）
- 自動觸發（選擇房型後立即生成）
- 更嚴謹的重複檢查

### 2. 圖片上傳邏輯改進

**位置**：`property-admin-db.html` 的 `uploadAndOrganizeImages()` 函數

**改進點**：
- 從物件編號提取類型代碼
- 按照類型代碼分類儲存
- 路徑格式：`properties/{類型代碼}/{物件編號}/image_{序號}.jpg`

### 3. 前端卡片修改

**位置**：`pagination-system.js` 的 `createPropertyCard()` 函數

**修改**：
- 移除編號顯示（第 565-569 行）
- 添加 `data-property-number` 屬性

### 4. 詳細資訊彈窗修改

**位置**：`property-modals.js` 的 `showPropertyDetails()` 函數

**修改**：
- 在標題區域添加編號顯示
- 格式：`物件編號：{編號}`

## 📊 排序邏輯

### 排序規則

1. **第一優先級**：房型（type）
   - 套房（SU）→ 2房（TW）→ 3房（B）→ 4房（FO）

2. **第二優先級**：編號序號（number 的數字部分）
   - 解析編號：SU00001 → 序號 1
   - 數值排序：1 < 2 < 10 < 100

3. **第三優先級**：建立時間（created_at）

### 排序實作

**Supabase 查詢層**：
```sql
ORDER BY 
  CASE 
    WHEN number LIKE 'SU%' THEN 1
    WHEN number LIKE 'TW%' THEN 2
    WHEN number LIKE 'TH%' THEN 3
    WHEN number LIKE 'FO%' THEN 4
    ELSE 5
  END,
  CAST(SUBSTRING(number FROM 3) AS INTEGER),
  created_at DESC
```

## ⚠️ 注意事項

### 1. 現有編號遷移
- 現有編號可能是舊格式（如 `2-1`, `3-2`）
- 需要提供遷移工具或支援雙格式解析

### 2. 圖片路徑變更
- 舊圖片可能儲存在 `properties/{舊編號}/` 路徑
- 需要處理路徑遷移或相容性

### 3. 編號唯一性
- 必須確保編號在資料庫中唯一
- 儲存前檢查重複

### 4. 圖片上傳順序
- 圖片按照上傳順序命名（image_1, image_2, ...）
- 刪除圖片後需要重新排序

## 📝 實作步驟

### 階段一：編號格式改進
1. 修改 `getTypePrefix()` 函數，返回 2 字母代碼
2. 修改 `generatePropertyNumber()` 函數，生成 7 位數編號
3. 添加自動觸發機制

### 階段二：圖片上傳改進
1. 修改 `uploadAndOrganizeImages()` 函數
2. 添加類型代碼提取邏輯
3. 修改路徑生成邏輯

### 階段三：前端顯示修改
1. 移除卡片上的編號顯示
2. 在詳細資訊彈窗中添加編號顯示
3. 添加 `data-property-number` 屬性

### 階段四：排序邏輯實作
1. 修改 Supabase 查詢，添加排序
2. 實作前端排序邏輯（備用）

### 階段五：測試與優化
1. 測試編號生成
2. 測試圖片上傳路徑
3. 測試排序邏輯
4. 效能優化

## ✅ 確認事項

請確認以下設計是否符合需求：

1. **編號格式**：`SU00001`（2字母+5數字）是否符合需求？
2. **圖片路徑**：`properties/SU/SU00001/image_1.jpg` 是否符合需求？
3. **前端顯示**：卡片不顯示編號，詳細資訊中顯示，是否符合需求？
4. **自動生成**：選擇房型後自動生成編號，是否符合需求？

確認後我將開始實作。

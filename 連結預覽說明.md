# 連結預覽說明（Open Graph / LINE / Facebook）

## 問題說明

把**單一物件頁**的連結（例如 `property-detail.html?number=TH00001`）貼到 LINE、Facebook、Discord 時，預覽沒有圖片、標題與描述也不對。

**原因**：這些平台的爬蟲**不會執行 JavaScript**，只讀取 HTML 裡的 `<meta property="og:image">`、`og:title`、`og:description` 等。  
物件頁的內容是載入後用 JS 從 Supabase 拿資料再寫入 meta，爬蟲看不到 → 顯示空白或預設文案。

---

## 目前已做的調整

### 1. 靜態預設圖（`property-detail.html`）

- `og:image`、`twitter:image` 已設成一個**預設圖**（`https://placehold.co/1200x630/...`）。
- 就算沒有 Edge Function、或爬蟲拿不到物件資料，至少會有一張預覽圖，不會完全空白。

### 2. Cloudflare Pages Function（`functions/property-detail.html.js`）

- 只處理 `property-detail.html` 的 **GET**。
- 從網址讀 `?number=xxx` 或 `?id=xxx`，向 Supabase 查詢該物件的 `images, title, price, address`。
- 從 ASSETS 讀取靜態的 `property-detail.html`，把下面這些 meta 替換成該物件的實際內容後回傳（詳見下方「Meta 標籤一覽」）。

這樣一來，同一個網址在**瀏覽器**仍是原本的 SPA 行為，在**爬蟲**則會拿到已填入正確預覽的 HTML。

### 3. Meta 標籤一覽

| 標籤 | 用途 | 依物件動態 |
|------|------|------------|
| **Open Graph** | | |
| `og:type` | 固定 `website` | 否 |
| `og:url` | 本頁完整網址 | 是 |
| `og:title` | 預覽標題（案名 - 售價／住商不動產） | 是 |
| `og:description` | 預覽描述（案名、售價、地址） | 是 |
| `og:image` | 預覽圖（物件第一張圖或預設圖） | 是 |
| `og:image:width` | 建議 1200 | 否 |
| `og:image:height` | 建議 630 | 否 |
| `og:image:alt` | 圖片替代文字（案名） | 是 |
| `og:site_name` | 住商不動產 濬瑒｜子菲 | 否 |
| `og:locale` | `zh_TW` | 否 |
| **Twitter Card** | | |
| `twitter:card` | 固定 `summary_large_image` | 否 |
| `twitter:url` | 同 og:url | 是 |
| `twitter:title` | 同 og:title | 是 |
| `twitter:description` | 同 og:description | 是 |
| `twitter:image` | 同 og:image | 是 |
| `twitter:image:alt` | 同 og:image:alt | 是 |
| **一般** | | |
| `meta name="description"` | 搜尋與預覽用描述 | 是 |
| `<title>` | 瀏覽器分頁標題 | 是 |

- **依物件動態**：由 Function 與頁面 JS 的 `updateMetaTags()` 寫入該物件的 title、price、address、images。
- **否**：寫死在 HTML，不需替換。

---

## 使用與部署

### 部署到 Cloudflare Pages

- 根目錄有 `functions/` 且內含 `property-detail.html.js` 時，Pages 會自動把對 `property-detail.html` 的 GET 交給這個 Function。
- 照一般方式部署（Git 推送或 `wrangler pages deploy`）即可，無需在 `wrangler.toml` 多加設定。

### 環境變數（可選）

- `SUPABASE_URL`、`SUPABASE_ANON_KEY`：若沒設，Function 會用與 `supabase-config.js` 相同的預設值。
- 在 Cloudflare Dashboard：**Pages → 專案 → Settings → Environment variables** 中新增即可。

---

## 自訂預設預覽圖

不想用 placehold.co 的預設圖時：

1. **放自己的圖**  
   - 例：`images/og-default.png`，建議尺寸 **1200×630**。
   - 在 `property-detail.html` 裡，把 `og:image`、`twitter:image` 的 `content` 改成：
     - 絕對網址：`https://你的網域/images/og-default.png`  
     - 或根路徑：`/images/og-default.png`（需確認爬蟲能正確解析）。

2. **改 Function 的預設圖**  
   - 在 `functions/property-detail.html.js` 開頭，把 `DEFAULT_OG_IMAGE` 改成你的圖片網址。

---

## 爬蟲快取與重新擷取

- **Facebook**：用 [Sharing Debugger](https://developers.facebook.com/tools/debug/) 輸入網址，可「再次擷取」更新預覽。
- **LINE**：多會依網址快取，可過一陣子再試，或換一個沒被快取過的網址測試。
- 修改 meta 或圖片後，若預覽沒更新，通常是快取；可等幾小時或到各平台工具強制重新擷取。

---

## 若 Function 未生效（沒有依物件換圖）

可能情況：

1. **路徑對應**  
   - Function 檔名為 `property-detail.html.js`，對應路徑為 `/property-detail.html`。  
   - 若網站有加 base path（例如 `/junyang666/`），要確認實際請求路徑是否仍為 `.../property-detail.html`，必要時再調整 Function 的 route 或 ASSETS 路徑。

2. **ASSETS 讀不到 HTML**  
   - Function 會用 `env.ASSETS.fetch(...)` 讀 `property-detail.html`。  
   - 若部署後該檔不在 ASSETS 裡（例如被 build 排除），會改走 `context.next()`，等於回到靜態檔，此時只會有「預設圖」的預覽。

3. **非 Cloudflare Pages**  
   - Function 只在 **Cloudflare Pages** 下執行。  
   - 若 host 在別的平台（Netlify、Vercel、自己的 server），不會跑這個 Function，但 `property-detail.html` 裡的**靜態預設 og:image** 仍會作用，至少有一張預覽圖。

---

## 建議尺寸

| 用途       | 建議尺寸   |
|------------|------------|
| og:image   | 1200×630   |
| 自訂預設圖 | 同上 1200×630 |

---

*文件版本：1.0 | 建立日期：2025-01-25*

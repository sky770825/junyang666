# 非本店物件功能設計方案

## 📋 需求分析

### 1. 欄位屬性與標示
- **欄位定義**：`is_external`（非本店物件）
- **標示位置**：物件列表、後台系統
- **顯示方式**：隱藏式標示（不影響主要顯示，但可識別）

### 2. 篩選與分類
- **篩選功能**：後台支援篩選「非店內物件」
- **介面位置**：物件列表的篩選區域

### 3. 編號系統設計
- **店外物件編號**：獨立編號系統，與店內編號完全分開
- **編號格式**：使用不同前綴區分店內/店外物件

## 🎯 設計方案

### 一、資料庫欄位設計

#### 1. 新增欄位
```sql
ALTER TABLE properties 
ADD COLUMN IF NOT EXISTS is_external BOOLEAN DEFAULT FALSE;

-- 添加註解
COMMENT ON COLUMN properties.is_external IS '是否為非本店物件（其他家房仲的物件）';
```

#### 2. 欄位說明
- **欄位名稱**：`is_external`
- **資料類型**：`BOOLEAN`
- **預設值**：`FALSE`（預設為本店物件）
- **說明**：
  - `TRUE`：非本店物件（其他家房仲的物件）
  - `FALSE`：本店物件（預設）

### 二、編號系統設計

#### 1. 店內物件編號（現有系統）
- **格式**：`{房型代碼}{序號}`（7位數）
  - 套房：`SU00001`, `SU00002`, ...
  - 2房：`TW00001`, `TW00002`, ...
  - 3房：`TH00001`, `TH00002`, ...
  - 4房：`FO00001`, `FO00002`, ...

#### 2. 店外物件編號（新增系統）
- **格式**：`{外部代碼}{房型代碼}{序號}`（8位數）
  - 外部代碼：`EX`（External）
  - 套房：`EXSU0001`, `EXSU0002`, ...
  - 2房：`EXTW0001`, `EXTW0002`, ...
  - 3房：`EXTH0001`, `EXTH0002`, ...
  - 4房：`EXFO0001`, `EXFO0002`, ...

#### 3. 編號生成邏輯
```javascript
// 店內物件編號生成（現有）
function generateInternalNumber(type) {
  // SU00001, TW00001, ...
  const prefix = getTypePrefix(type); // SU, TW, TH, FO
  const nextSeq = getNextSequenceNumber(existingNumbers, prefix);
  return `${prefix}${formatSequenceNumber(nextSeq, 5)}`; // 7位數
}

// 店外物件編號生成（新增）
function generateExternalNumber(type) {
  // EXSU0001, EXTW0001, ...
  const prefix = getTypePrefix(type); // SU, TW, TH, FO
  const nextSeq = getNextExternalSequenceNumber(existingExternalNumbers, prefix);
  return `EX${prefix}${formatSequenceNumber(nextSeq, 4)}`; // 8位數
}
```

### 三、介面設計

#### 1. 新增物件表單

**位置**：`property-admin-db.html` 的「基本資訊」區塊

**新增欄位**：
```html
<div class="form-group">
    <label>物件來源 *</label>
    <select id="is_external" required onchange="onExternalSourceChange()">
        <option value="false">🏠 本店物件</option>
        <option value="true">🏢 非本店物件（其他房仲）</option>
    </select>
    <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
        非本店物件將使用獨立的編號系統，不會與本店物件編號混在一起
    </small>
</div>
```

**位置建議**：放在「物件編號」欄位下方，「物件標題」上方

#### 2. 物件列表顯示

**位置**：`admin-dashboard.html` 的物件列表表格

**新增欄位**：
- 在表格中新增「來源」欄位
- 顯示圖示：
  - 🏠 本店物件（綠色標籤）
  - 🏢 非本店物件（橙色標籤）

**表格欄位調整**：
```html
<tr>
    <th>物件</th>
    <th>來源</th>  <!-- 新增 -->
    <th>房型</th>
    <th>價格</th>
    <th>上架狀態</th>
    <th>操作</th>
</tr>
```

#### 3. 篩選功能

**位置**：物件列表的篩選按鈕區域

**新增篩選按鈕**：
```html
<div class="filter-buttons">
    <button class="filter-btn active" onclick="setFilter('all', this)">全部</button>
    <button class="filter-btn" onclick="setFilter('published', this)">已上架</button>
    <button class="filter-btn" onclick="setFilter('unpublished', this)">已下架</button>
    <button class="filter-btn" onclick="setFilter('sold', this)">已售出</button>
    <button class="filter-btn" onclick="setFilter('internal', this)">🏠 本店物件</button>  <!-- 新增 -->
    <button class="filter-btn" onclick="setFilter('external', this)">🏢 非本店物件</button>  <!-- 新增 -->
</div>
```

### 四、圖片儲存路徑設計

#### 1. 店內物件（現有）
```
junyang666/
└── properties/
    ├── SU/
    │   ├── SU00001/
    │   │   └── image_1.jpg
    └── TW/
        └── TW00001/
            └── image_1.jpg
```

#### 2. 店外物件（新增）
```
junyang666/
└── properties/
    └── external/          # 店外物件專用資料夾
        ├── SU/
        │   ├── EXSU0001/
        │   │   └── image_1.jpg
        └── TW/
            └── EXTW0001/
                └── image_1.jpg
```

**路徑格式**：
- 店內：`properties/{類型代碼}/{物件編號}/image_{序號}.jpg`
- 店外：`properties/external/{類型代碼}/{物件編號}/image_{序號}.jpg`

### 五、功能實作規劃

#### 1. 資料庫層面
- [ ] 添加 `is_external` 欄位
- [ ] 添加索引以優化篩選效能
  ```sql
  CREATE INDEX IF NOT EXISTS idx_properties_is_external 
  ON properties(is_external);
  ```

#### 2. 後端查詢層面
- [ ] 修改 `supabase-data-loader.js`，支援篩選店外物件
- [ ] 修改 `admin-dashboard.html` 的 `loadProperties()` 函數

#### 3. 前端顯示層面
- [ ] 修改 `admin-dashboard.html` 的物件列表表格
- [ ] 添加「來源」欄位顯示
- [ ] 添加篩選按鈕

#### 4. 後台管理層面
- [ ] 修改 `property-admin-db.html` 的新增表單
- [ ] 添加「物件來源」選擇欄位
- [ ] 修改編號生成邏輯，支援店外物件編號
- [ ] 修改圖片上傳邏輯，按店內/店外分類儲存

### 六、編號生成邏輯詳細設計

#### 1. 店內物件編號（現有，保持不變）
```javascript
// 格式：SU00001（7位數）
function generateInternalPropertyNumber(type) {
  const prefix = getTypePrefix(type); // SU, TW, TH, FO
  const existingNumbers = await getAllInternalPropertyNumbers(); // 只查詢店內物件
  const nextSeq = getNextSequenceNumber(existingNumbers, prefix);
  return `${prefix}${formatSequenceNumber(nextSeq, 5)}`; // 7位數
}
```

#### 2. 店外物件編號（新增）
```javascript
// 格式：EXSU0001（8位數）
function generateExternalPropertyNumber(type) {
  const prefix = getTypePrefix(type); // SU, TW, TH, FO
  const existingNumbers = await getAllExternalPropertyNumbers(); // 只查詢店外物件
  const nextSeq = getNextSequenceNumber(existingNumbers, `EX${prefix}`);
  return `EX${prefix}${formatSequenceNumber(nextSeq, 4)}`; // 8位數
}
```

#### 3. 統一編號生成函數
```javascript
async function generatePropertyNumber() {
  const type = document.getElementById('type').value;
  const isExternal = document.getElementById('is_external').value === 'true';
  
  if (!type) {
    showAlert('warning', '請先選擇房型');
    return;
  }
  
  if (isExternal) {
    // 生成店外物件編號
    const number = await generateExternalPropertyNumber(type);
    document.getElementById('number').value = number;
  } else {
    // 生成店內物件編號
    const number = await generateInternalPropertyNumber(type);
    document.getElementById('number').value = number;
  }
}
```

### 七、篩選邏輯設計

#### 1. 篩選函數修改
```javascript
function renderProperties() {
  let filtered = allProperties;
  
  // 應用狀態篩選
  if (currentFilter === 'published') {
    filtered = filtered.filter(p => p.is_published);
  } else if (currentFilter === 'unpublished') {
    filtered = filtered.filter(p => !p.is_published);
  } else if (currentFilter === 'sold') {
    filtered = filtered.filter(p => p.status === 'sold');
  } else if (currentFilter === 'internal') {
    // 新增：篩選本店物件
    filtered = filtered.filter(p => !p.is_external);
  } else if (currentFilter === 'external') {
    // 新增：篩選非本店物件
    filtered = filtered.filter(p => p.is_external);
  }
  
  // ... 其他篩選邏輯
}
```

### 八、UI/UX 設計建議

#### 1. 標示樣式
- **本店物件**：🏠 綠色標籤，背景色 `#28a745`
- **非本店物件**：🏢 橙色標籤，背景色 `#ff9800`

#### 2. 列表顯示
- 在物件標題旁顯示小圖示
- 或在「來源」欄位中顯示完整標籤

#### 3. 表單設計
- 「物件來源」選擇器放在「物件編號」下方
- 選擇「非本店物件」時，編號欄位自動生成店外編號
- 添加提示文字說明編號系統差異

### 九、注意事項

#### 1. 資料遷移
- 現有物件預設為 `is_external = FALSE`（本店物件）
- 不需要手動遷移現有資料

#### 2. 編號唯一性
- 店內和店外編號系統完全獨立
- 不會產生編號衝突

#### 3. 圖片路徑
- 店外物件的圖片儲存在 `properties/external/` 資料夾
- 與店內物件完全分開，便於管理

#### 4. 前端顯示
- 前端（`index.html`）預設只顯示本店物件（`is_external = FALSE`）
- 如需顯示店外物件，可添加篩選選項

### 十、實作步驟

#### 階段一：資料庫與欄位
1. 添加 `is_external` 欄位到 `properties` 表
2. 添加索引以優化查詢

#### 階段二：編號系統
1. 實作店外物件編號生成函數
2. 修改統一編號生成函數
3. 測試編號生成邏輯

#### 階段三：表單與介面
1. 在新增表單中添加「物件來源」欄位
2. 修改物件列表顯示，添加「來源」欄位
3. 添加篩選按鈕

#### 階段四：圖片上傳
1. 修改圖片上傳邏輯，按店內/店外分類
2. 測試圖片路徑生成

#### 階段五：測試與優化
1. 測試新增店內/店外物件
2. 測試編號生成
3. 測試篩選功能
4. 測試圖片上傳路徑

## ✅ 確認事項

請確認以下設計是否符合需求：

1. **欄位名稱**：`is_external`（是否為非本店物件）是否符合需求？
2. **編號格式**：
   - 店內：`SU00001`（7位數）
   - 店外：`EXSU0001`（8位數）
   是否符合需求？
3. **圖片路徑**：
   - 店內：`properties/SU/SU00001/image_1.jpg`
   - 店外：`properties/external/SU/EXSU0001/image_1.jpg`
   是否符合需求？
4. **介面位置**：
   - 表單：放在「物件編號」下方
   - 列表：新增「來源」欄位
   - 篩選：新增「本店物件」和「非本店物件」按鈕
   是否符合需求？

確認後我將開始實作。
